# 物藏录 - 订阅管理功能设计方案

## 📋 需求确认汇总

### 用户确认的功能需求

| 需求项 | 确认内容 |
|-------|---------|
| 增删改查 | ✅ 增删改订阅信息 |
| 分类管理 | ✅ 独立的订阅分类管理 |
| 搜索筛选排序 | ❌ 不需要 |
| 扣费日期规则 | ✅ 按用户指定的扣费日期为准 |
| 不规则周期 | ✅ 支持每2周、每3个月、每6个月等 |
| 提醒方式 | ✅ 仅系统通知 |
| 提醒设置 | ✅ 用户设置提前几天，默认1天 |
| 多级提醒 | ❌ 不需要 |
| 提醒检查 | ✅ uTools 启动时检查 |
| 统计功能 | ✅ 月度/年度支出统计、即将到期列表 |
| 物品模块关联 | ❌ 不需要 |
| UI 位置 | ✅ 新增"订阅"标签在"物品"与"分析"之间 |
| 日历视图 | ✅ 需要日历视图展示订阅扣费计划 |

---

## 🗄️ 数据模型设计

### 1. 订阅数据模型（Subscription）

```javascript
{
    // 基本信息
    id: string,                  // 订阅ID（时间戳 + 随机数）
    name: string,                // 订阅名称（如：Netflix、Spotify、Adobe CC）
    icon: string,                // 图标（emoji）
    category: string,            // 分类名称

    // 价格信息
    price: number,               // 价格
    currency: string,            // 货币代码（CNY/USD/EUR等），默认 CNY

    // 周期信息
    cycleType: string,           // 周期类型：day/week/month/quarter/year/lifetime
    cycleValue: number,          // 周期数值（默认1，支持2、3、6等不规则周期）

    // 日期信息
    firstBillingDate: string,    // 首次扣费日期（YYYY-MM-DD）
    nextBillingDate: string,     // 下次扣费日期（YYYY-MM-DD，自动计算）

    // 提醒信息
    reminderEnabled: boolean,    // 是否启用提醒（默认 true）
    reminderDays: number,        // 提前提醒天数（默认 1）

    // 状态信息
    status: string,              // 状态：active/paused/cancelled/expired（默认 active）

    // 元数据
    createdAt: string,           // 创建时间（ISO 8601）
    updatedAt: string,           // 更新时间（ISO 8601）
    notes: string,               // 备注（可选）
    website: string,             // 官网链接（可选）
}
```

### 2. 订阅分类数据模型（SubscriptionCategory）

```javascript
{
    id: string,                  // 分类ID
    name: string,                // 分类名称（如：娱乐、办公、教育、工具）
    icon: string,                // 分类图标（emoji）
    createdAt: string            // 创建时间
}
```

### 3. 提醒记录数据模型（ReminderLog）

```javascript
{
    id: string,                  // 记录ID
    subscriptionId: string,      // 关联的订阅ID
    reminderDate: string,        // 提醒日期（YYYY-MM-DD）
    billingDate: string,         // 扣费日期（YYYY-MM-DD）
    notified: boolean,           // 是否已发送通知
    notifiedAt: string,          // 通知发送时间（ISO 8601）
}
```

---

## 🎨 UI/UX 设计

### 1. 标签页结构

```
原有：物品 | 分析 | 我的
修改为：物品 | 订阅 | 分析 | 我的
```

### 2. 订阅标签页面布局

```
┌─────────────────────────────────────────────────────┐
│ [订阅管理]                                          │
├─────────────────────────────────────────────────────┤
│                                                      │
│ ┌────────────────────────────────────────────────┐ │
│ │ 📊 快速统计                                    │ │
│ │ ┌─────────┐ ┌─────────┐ ┌─────────┐          │ │
│ │ │ 月度支出│ │ 年度支出│ │ 即将到期│          │ │
│ │ │ ¥XXX.XX│ │ ¥XXX.XX │ │ X个订阅 │          │ │
│ │ └─────────┘ └─────────┘ └─────────┘          │ │
│ └────────────────────────────────────────────────┘ │
│                                                      │
│ ┌────────────────────────────────────────────────┐ │
│ │ 分类: [全部] [娱乐] [办公] [教育] [...]       │ │
│ └────────────────────────────────────────────────┘ │
│                                                      │
│ ┌────────────────────────────────────────────────┐ │
│ │ 订阅列表                                      │ │
│ │ ┌──────────────────────────────────────────┐  │ │
│ │ │ 🎬 Netflix                        ¥45/月 │  │ │
│ │ │ 下次扣费: 2025-02-15 (3天后)            │  │ │
│ │ │ [编辑] [删除]                            │  │ │
│ │ └──────────────────────────────────────────┘  │ │
│ │ ┌──────────────────────────────────────────┐  │ │
│ │ │ 🎵 Spotify                        ¥15/月 │  │ │
│ │ │ 下次扣费: 2025-02-20 (8天后)            │  │ │
│ │ │ [编辑] [删除]                            │  │ │
│ │ └──────────────────────────────────────────┘  │ │
│ │ ...                                          │ │
│ └────────────────────────────────────────────────┘ │
│                                                      │
│ [+ 添加订阅]                                        │
│                                                      │
│ ┌────────────────────────────────────────────────┐ │
│ │ 📅 日历视图（月度扣费计划）                    │ │
│ │ 2025年2月                                      │ │
│ │ ┌───┬───┬───┬───┬───┬───┬───┐              │ │
│ │ │日 │一 │二 │三 │四 │五 │六 │              │ │
│ │ ├───┼───┼───┼───┼───┼───┼───┤              │ │
│ │ │   │   │   │   │   │   │ 1 │              │ │
│ │ │ 2 │ 3 │ 4 │ 5 │ 6 │ 7 │ 8 │              │ │
│ │ │ 9 │10 │11 │12 │13 │14 │15│              │ │
│ │ │   │   │   │   │   │   │● │              │ │
│ │ │16 │17 │18 │19 │20 │21 │22│              │ │
│ │ │   │   │   │   │   │●  │   │              │ │
│ │ │23 │24 │25 │26 │27 │28 │  │              │ │
│ │ └───┴───┴───┴───┴───┴───┴───┘              │ │
│ │ ● = 扣费日期                                  │ │
│ └────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

### 3. 添加/编辑订阅对话框

```
┌────────────────────────────────────────┐
│ 添加订阅                               │
├────────────────────────────────────────┤
│                                        │
│ 订阅名称: [________________]           │
│                                        │
│ 分类: [娱乐 ▼]                         │
│                                        │
│ 图标: [🎬] (选择图标)                  │
│                                        │
│ 价格: [____] 元                        │
│                                        │
│ 周期类型: [按月 ▼]                     │
│                                        │
│ 周期数值: [1] (每?月，支持2、3、6等)   │
│                                        │
│ 首次扣费日期: [2025-02-15]             │
│                                        │
│ 提醒设置:                              │
│   ☑ 启用到期提醒                       │
│   提前 [1] 天提醒                      │
│                                        │
│ 备注: [________________]               │
│                                        │
│ 官网: [________________]               │
│                                        │
│         [取消]  [保存]                 │
└────────────────────────────────────────┘
```

### 4. 统计视图

```
┌─────────────────────────────────────────────────────┐
│ 订阅统计                                            │
├─────────────────────────────────────────────────────┤
│                                                      │
│ 📊 支出统计                                         │
│ ┌────────────────────────────────────────────────┐ │
│ │ 本月支出: ¥XXX.XX                              │ │
│ │ 本年支出: ¥XXX.XX                              │ │
│ │ 预计下月: ¥XXX.XX                              │ │
│ └────────────────────────────────────────────────┘ │
│                                                      │
│ 📈 月度支出趋势图                                   │
│ [折线图/柱状图]                                     │
│                                                      │
│ 📦 分类支出占比                                     │
│ [饼图]                                              │
│                                                      │
│ ⏰ 即将到期订阅（7天内）                            │
│ ┌────────────────────────────────────────────────┐ │
│ │ • Netflix - 3天后扣费 ¥45                      │ │
│ │ • Adobe CC - 5天后扣费 ¥298                    │ │
│ │ • Spotify - 8天后扣费 ¥15                      │ │
│ └────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
```

---

## 🔧 功能模块设计

### 1. 存储模块（SubscriptionStorage）

```javascript
class SubscriptionStorage {
    // 存储键名
    subscriptionsKey = 'wucanglu_subscriptions';
    subscriptionCategoriesKey = 'wucanglu_subscription_categories';
    reminderLogKey = 'wucanglu_reminder_log';

    // 订阅管理
    getSubscriptions(): Subscription[]
    addSubscription(subscription: Subscription): Subscription
    updateSubscription(id: string, updates: object): boolean
    deleteSubscription(id: string): boolean
    getSubscriptionById(id: string): Subscription | null

    // 订阅分类管理
    getSubscriptionCategories(): SubscriptionCategory[]
    addSubscriptionCategory(category: SubscriptionCategory): SubscriptionCategory
    updateSubscriptionCategory(id: string, updates: object): boolean
    deleteSubscriptionCategory(id: string): boolean

    // 提醒日志管理
    getReminderLog(): ReminderLog[]
    addReminderLog(log: ReminderLog): ReminderLog
    updateReminderLog(id: string, updates: object): boolean
    clearOldReminderLog(): void
}
```

### 2. 订阅管理模块（SubscriptionManager）

```javascript
class SubscriptionManager {
    // 订阅管理
    addSubscription(data: object): Subscription
    updateSubscription(id: string, data: object): boolean
    deleteSubscription(id: string): boolean

    // 日期计算
    calculateNextBillingDate(subscription: Subscription): string
    updateAllNextBillingDates(): void

    // 提醒检查
    checkReminders(): void
    sendReminder(subscription: Subscription): void

    // 统计数据
    getMonthlyExpense(year: number, month: number): number
    getYearlyExpense(year: number): number
    getUpcomingSubscriptions(days: number): Subscription[]
    getCategoryExpenses(year: number, month: number): object[]
}
```

### 3. UI 渲染模块（SubscriptionUI）

```javascript
class SubscriptionUI {
    // 页面渲染
    renderSubscriptionPanel(): void
    renderSubscriptionList(subscriptions: Subscription[]): void
    renderQuickStats(): void
    renderCalendarView(year: number, month: number): void
    renderStatsView(): void

    // 对话框
    showAddSubscriptionDialog(): void
    showEditSubscriptionDialog(subscription: Subscription): void
    showCategoryManageDialog(): void

    // 事件绑定
    bindEvents(): void
}
```

---

## 🔔 提醒机制设计

### 1. 提醒触发时机

- **uTools 启动时**：使用 `utools.onPluginEnter` 回调
- **切换到订阅标签时**：每次打开订阅页面检查

### 2. 提醒逻辑

```javascript
function checkReminders() {
    const today = new Date();
    const subscriptions = storage.getSubscriptions();

    subscriptions.forEach(sub => {
        if (sub.status !== 'active' || !sub.reminderEnabled) return;

        const nextBillingDate = new Date(sub.nextBillingDate);
        const daysUntilBilling = Math.ceil((nextBillingDate - today) / (1000 * 60 * 60 * 24));

        // 检查是否在提醒范围内
        if (daysUntilBilling <= sub.reminderDays && daysUntilBilling >= 0) {
            // 检查是否已发送过提醒
            const reminderLog = storage.getReminderLog();
            const alreadyNotified = reminderLog.some(log =>
                log.subscriptionId === sub.id &&
                log.billingDate === sub.nextBillingDate &&
                log.notified
            );

            if (!alreadyNotified) {
                // 发送通知
                const message = `🔔 ${sub.name} 将在 ${daysUntilBilling} 天后扣费 ¥${sub.price}`;
                utools.showNotification(message);

                // 记录提醒日志
                storage.addReminderLog({
                    id: Date.now().toString(),
                    subscriptionId: sub.id,
                    reminderDate: today.toISOString().split('T')[0],
                    billingDate: sub.nextBillingDate,
                    notified: true,
                    notifiedAt: new Date().toISOString()
                });
            }
        }
    });
}
```

### 3. 日期计算逻辑

```javascript
function calculateNextBillingDate(subscription) {
    const { firstBillingDate, cycleType, cycleValue } = subscription;
    const baseDate = new Date(firstBillingDate);
    const today = new Date();

    let nextDate = new Date(baseDate);

    // 循环计算下一个扣费日期，直到超过今天
    while (nextDate <= today) {
        switch (cycleType) {
            case 'day':
                nextDate.setDate(nextDate.getDate() + cycleValue);
                break;
            case 'week':
                nextDate.setDate(nextDate.getDate() + (7 * cycleValue));
                break;
            case 'month':
                nextDate.setMonth(nextDate.getMonth() + cycleValue);
                break;
            case 'quarter':
                nextDate.setMonth(nextDate.getMonth() + (3 * cycleValue));
                break;
            case 'year':
                nextDate.setFullYear(nextDate.getFullYear() + cycleValue);
                break;
            case 'lifetime':
                return null; // 终身有效无需计算
        }
    }

    return nextDate.toISOString().split('T')[0];
}
```

---

## 📅 日历视图设计

### 1. 日历组件结构

```html
<div class="calendar-container">
    <div class="calendar-header">
        <button class="calendar-nav" data-direction="prev">◀</button>
        <div class="calendar-title">2025年2月</div>
        <button class="calendar-nav" data-direction="next">▶</button>
    </div>
    <div class="calendar-weekdays">
        <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
    </div>
    <div class="calendar-days"></div>
</div>
```

### 2. 日历渲染逻辑

```javascript
function renderCalendar(year, month) {
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    const startWeekday = firstDay.getDay();
    const daysInMonth = lastDay.getDate();

    // 获取当月扣费日期
    const subscriptions = storage.getSubscriptions();
    const billingDates = subscriptions
        .filter(sub => sub.status === 'active')
        .map(sub => {
            const date = new Date(sub.nextBillingDate);
            return {
                day: date.getDate(),
                month: date.getMonth() + 1,
                year: date.getFullYear(),
                subscription: sub
            };
        })
        .filter(d => d.month === month && d.year === year);

    // 生成日历网格
    const container = document.querySelector('.calendar-days');
    container.innerHTML = '';

    // 填充空白
    for (let i = 0; i < startWeekday; i++) {
        container.innerHTML += '<div class="calendar-day empty"></div>';
    }

    // 填充日期
    for (let day = 1; day <= daysInMonth; day++) {
        const daySubscriptions = billingDates.filter(d => d.day === day);
        const hasBilling = daySubscriptions.length > 0;

        container.innerHTML += `
            <div class="calendar-day ${hasBilling ? 'has-billing' : ''}">
                <span class="day-number">${day}</span>
                ${hasBilling ? `
                    <div class="billing-dots">
                        ${daySubscriptions.map(s => `
                            <div class="billing-dot" title="${s.subscription.name} - ¥${s.subscription.price}">
                                ${s.subscription.icon}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
}
```

---

## 📊 统计功能设计

### 1. 月度/年度支出统计

```javascript
function calculateMonthlyExpense(year, month) {
    const subscriptions = storage.getSubscriptions().filter(sub => sub.status === 'active');

    // 计算当月实际扣费金额
    let total = 0;
    subscriptions.forEach(sub => {
        const nextDate = new Date(sub.nextBillingDate);
        if (nextDate.getFullYear() === year && nextDate.getMonth() + 1 === month) {
            total += sub.price;
        }
    });

    return total;
}
```

### 2. 分类支出统计

```javascript
function getCategoryExpenses(year, month) {
    const subscriptions = storage.getSubscriptions().filter(sub => sub.status === 'active');
    const expenses = {};

    subscriptions.forEach(sub => {
        const nextDate = new Date(sub.nextBillingDate);
        if (nextDate.getFullYear() === year && nextDate.getMonth() + 1 === month) {
            const category = sub.category || '未分类';
            expenses[category] = (expenses[category] || 0) + sub.price;
        }
    });

    return Object.entries(expenses).map(([category, amount]) => ({
        category,
        amount
    }));
}
```

---

## 🎯 实现计划

### 阶段一：基础数据结构和存储
1. ✅ 定义订阅数据模型
2. ✅ 创建 SubscriptionStorage 类
3. ✅ 实现订阅 CRUD 操作
4. ✅ 实现订阅分类 CRUD 操作
5. ✅ 实现提醒日志管理

### 阶段二：UI 基础框架
1. ✅ 在"物品"和"分析"之间添加"订阅"标签页
2. ✅ 创建订阅面板 HTML 结构
3. ✅ 实现订阅列表展示
4. ✅ 实现添加/编辑订阅对话框
5. ✅ 实现订阅分类管理对话框

### 阶段三：核心功能实现
1. ✅ 实现日期计算逻辑（calculateNextBillingDate）
2. ✅ 实现提醒检查机制
3. ✅ 集成 uTools 通知 API
4. ✅ 在 uTools 启动时触发提醒检查
5. ✅ 更新 nextBillingDate 的定时任务

### 阶段四：日历视图
1. ✅ 实现日历组件
2. ✅ 显示当月扣费日期标记
3. ✅ 支持月份切换
4. ✅ 点击日期显示详情

### 阶段五：统计功能
1. ✅ 实现快速统计卡片
2. ✅ 实现月度/年度支出统计
3. ✅ 实现即将到期订阅列表
4. ✅ 实现分类支出占比
5. ✅ 集成 Chart.js 图表展示

### 阶段六：测试和优化
1. ✅ 功能测试
2. ✅ 边界情况处理
3. ✅ 性能优化
4. ✅ UI/UX 优化

---

## ⚠️ 技术注意事项

### 1. 数据迁移和版本控制

- 使用 `_rev` 字段进行数据版本控制
- 首次使用时初始化默认订阅分类

### 2. 日期处理的时区问题

- 使用 YYYY-MM-DD 格式避免时区问题
- 所有日期计算使用本地时区

### 3. 提醒的去重

- 使用提醒日志避免重复通知
- 定期清理过期的提醒日志（保留最近3个月）

### 4. 性能优化

- 订阅列表懒加载（如果数量很大）
- 日历渲染优化（只渲染当前月份）

---

## 📁 代码组织

```
index.html 中的代码组织：

1. CSS 样式部分（添加在现有样式后）
   - 订阅相关样式
   - 日历组件样式
   - 对话框样式

2. HTML 结构部分（添加在现有 panel 后）
   - 订阅面板 (#subscription-panel)
   - 添加/编辑订阅对话框
   - 订阅分类管理对话框

3. JavaScript 部分（添加在现有类后）
   - SubscriptionStorage 类
   - SubscriptionManager 类
   - SubscriptionUI 类
   - 事件绑定和初始化
```

---

## 🤔 待确认问题

1. **订阅图标选择**：是否需要提供预设图标库供用户选择？
2. **默认分类**：是否需要预置一些默认订阅分类（如：娱乐、办公、教育等）？
3. **货币支持**：是否需要支持多种货币？还是只支持人民币？
4. **日历交互**：点击日历上的扣费日期，是否显示该日期的扣费详情？
5. **订阅状态**：是否需要"暂停"功能？（暂时不扣费但不删除）

---

**参考资料：**
- [uTools 开发者文档](https://www.u-tools.cn/docs/developer/welcome.html)
- [uTools 系统 API - 通知](https://www.u-tools.cn/docs/developer/utools-api/system.html)
