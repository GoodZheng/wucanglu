<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‰©è—å½•</title>
    <script src="chart.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* è‡ªå®šä¹‰å±æ€§ */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --success-color: #4ade80;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --background-primary: #ffffff;
            --background-secondary: #f9fafb;
            --background-tertiary: #f3f4f6;
            --border-color: #e5e7eb;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* åº”ç”¨å®¹å™¨ */
        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* å¤´éƒ¨ */
        .app-header {
            box-shadow: var(--box-shadow);
        }
        
        .app-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }
        
        /* å¤´éƒ¨æŒ‰é’®æ‚¬åœæ•ˆæœ */
        .header-action-btn:hover {
            background: rgba(255,255,255,0.25) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .header-action-btn:active {
            transform: translateY(0);
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .app-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* å¯¼èˆªæ ‡ç­¾ */
        .tab-container {
            display: flex;
            background-color: var(--background-primary);
            border-bottom: 2px solid var(--border-color);
            padding: 0 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .tab {
            padding: 18px 32px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            background: transparent;
        }
        
        .tab:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 3px 3px 0 0;
        }
        
        /* é¢æ¿å†…å®¹ */
        .panel {
            display: none;
            padding: 16px 24px;
            flex: 1;
            overflow-y: auto;
        }
        
        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æ ‡é¢˜æ ·å¼ */
        h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }
        
        /* åˆ†ç±»æ ‡ç­¾ */
        .category-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        
        .category-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .category-tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .category-tabs::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 2px;
        }
        
        .category-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--background-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: var(--transition);
        }
        
        .category-tab:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .category-tab.active {
            background: var(--primary-color);
            color: white !important;
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        /* æ·»åŠ ç‰©å“æŒ‰é’® */
        .add-item-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-size: 28px;
            border: none;
            cursor: pointer;
            box-shadow: var(--box-shadow-hover);
            transition: var(--transition);
            z-index: 100;
            display: none; /* é»˜è®¤éšè—ï¼Œç”± data-active-tab å±æ€§æ§åˆ¶æ˜¾ç¤º */
            align-items: center;
            justify-content: center;
        }
        
        .add-item-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px -5px rgba(67, 97, 238, 0.3);
        }

        /* æ·»åŠ è®¢é˜…æŒ‰é’® */
        .add-subscription-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-size: 28px;
            border: none;
            cursor: pointer;
            box-shadow: var(--box-shadow-hover);
            transition: var(--transition);
            z-index: 100;
            display: none; /* é»˜è®¤éšè— */
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .add-subscription-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px -5px rgba(67, 97, 238, 0.3);
        }

        /* æ ¹æ®æ ‡ç­¾é¡µæ§åˆ¶æ·»åŠ æŒ‰é’®æ˜¾ç¤º */
        body[data-active-tab="items"] .add-item-btn,
        body[data-active-tab="analytics"] .add-item-btn,
        body[data-active-tab="settings"] .add-item-btn {
            display: flex !important;
        }

        body[data-active-tab="subscription"] .add-item-btn {
            display: none !important;
        }

        body[data-active-tab="subscription"] .add-subscription-btn {
            display: flex !important;
        }
        
        /* ç‰©å“åˆ—è¡¨ */
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }
        
        /* ç½‘æ ¼å¸ƒå±€ï¼ˆé»˜è®¤ï¼‰ */
        .item-list.layout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }
        
        /* åˆ—è¡¨å¸ƒå±€ */
        .item-list.layout-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .item-list.layout-list .item-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 16px;
        }
        
        .item-list.layout-list .item-header {
            flex: 1;
            margin-bottom: 0;
        }
        
        .item-list.layout-list .item-footer {
            margin-top: 0;
            margin-left: 16px;
        }
        
        /* ç€‘å¸ƒæµå¸ƒå±€ */
        .item-list.layout-masonry {
            column-count: 3;
            column-gap: 16px;
        }
        
        .item-list.layout-masonry .item-card {
            break-inside: avoid;
            margin-bottom: 16px;
        }
        
        @media (max-width: 1024px) {
            .item-list.layout-masonry {
                column-count: 2;
            }
        }
        
        @media (max-width: 768px) {
            .item-list.layout-masonry {
                column-count: 1;
            }
        }
        
        /* ç‰©å“å¡ç‰‡ */
        .item-card {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }
        
        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            transition: left 0.5s ease;
        }
        
        .item-card:hover::before {
            left: 100%;
        }
        
        .item-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--box-shadow-hover);
            border-color: var(--primary-color);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            margin-right: 8px;
        }
        
        .item-days {
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(76, 201, 240, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }
        
        .item-category {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 6px;
            background: rgba(67, 97, 238, 0.1);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
        }
        
        .item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .item-price-unit {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 2px;
        }
        
        .item-price-info .price {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--background-primary);
        }
        
        /* è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†ç»„ä»¶ */
        .custom-select {
            position: relative;
            margin-bottom: 20px;
        }
        
        .custom-select select {
            display: none;
        }
        
        .custom-select-trigger {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--background-primary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-select-trigger::after {
            content: '';
            width: 12px;
            height: 6px;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" width="12" height="6" viewBox="0 0 12 6" fill="none"%3e%3cpath d="M1 1l5 4 5-4" stroke="%236b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/%3e%3c/svg%3e');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100% 100%;
            transition: transform 0.3s ease;
        }
        
        .custom-select.open .custom-select-trigger::after {
            transform: rotate(180deg);
        }
        
        .custom-select-trigger:hover {
            border-color: var(--primary-color);
        }
        
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: var(--background-primary);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .custom-select.open .custom-select-options {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        .custom-select-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .custom-select-option:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .custom-select-option.selected {
            background-color: rgba(67, 97, 238, 0.1);
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .custom-select-options::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-select-options::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-select-options::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .btn-secondary {
            background: var(--background-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #ef4444);
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3);
        }
        
        /* åˆ†ç±»åˆ—è¡¨ */
        .category-list {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* è´­ä¹°æ¸ é“åˆ—è¡¨ */
        .channel-list {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* å¿«æ·ç®¡ç†å¡ç‰‡ */
        .quick-manage-card {
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--box-shadow);
        }

        .quick-manage-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .quick-manage-card button {
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .quick-manage-card:hover button {
            opacity: 1;
        }

        /* ç®¡ç†å¼¹çª—æ ·å¼ */
        #category-manage-modal,
        #channel-manage-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #category-manage-modal.active,
        #channel-manage-modal.active {
            display: flex;
        }

        #category-manage-modal > div,
        #channel-manage-modal > div {
            background: var(--background-primary);
            border-radius: 16px;
            padding: 28px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* ç®¡ç†åˆ—è¡¨é¡¹æ ·å¼ */
        .manage-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .manage-item:last-child {
            border-bottom: none;
        }

        .manage-item:hover {
            background: var(--background-secondary);
            border-radius: 8px;
            margin: 0 -4px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .manage-item-name {
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .manage-item-actions {
            display: flex;
            gap: 8px;
        }

        .manage-item-actions button {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .manage-item-actions button.edit {
            background: var(--primary-color);
            color: white;
        }

        .manage-item-actions button.edit:hover {
            background: var(--primary-color);
            opacity: 0.8;
        }

        .manage-item-actions button.delete {
            background: #ef4444;
            color: white;
        }

        .manage-item-actions button.delete:hover {
            background: #dc3545;
        }

        /* è®¢é˜…ç®¡ç†å¼¹çª—æ ·å¼ */
        #subscription-modal,
        #icon-picker-modal,
        #subscription-category-manage-modal,
        #billing-date-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #subscription-modal.active,
        #icon-picker-modal.active,
        #subscription-category-manage-modal.active,
        #billing-date-detail-modal.active {
            display: flex;
        }

        /* è®¢é˜…å¡ç‰‡æ ·å¼ */
        .subscription-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }

        .subscription-card {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 16px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .subscription-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--box-shadow-hover);
            border-color: var(--primary-color);
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            flex: 1;
        }

        .subscription-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .subscription-icon {
            font-size: 24px;
        }

        .subscription-category {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 500;
            background: rgba(67, 97, 238, 0.1);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
        }

        .subscription-price {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 8px 0;
        }

        .subscription-price-unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 2px;
        }

        .subscription-billing {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        .subscription-billing.soon {
            color: #f59e0b;
            font-weight: 500;
        }

        .subscription-billing.urgent {
            color: #ef4444;
            font-weight: 600;
        }

        .subscription-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding-top: 12px;
        }

        .subscription-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .subscription-actions button.edit {
            background: var(--primary-color);
            color: white;
        }

        .subscription-actions button.delete {
            background: #ef4444;
            color: white;
        }

        /* æ—¥å†æ ·å¼ */
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            border-radius: 4px;
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .calendar-day:hover {
            border-color: var(--primary-color);
            background: var(--background-secondary);
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }

        .calendar-day.has-billing {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
        }

        .day-number {
            font-weight: 600;
            font-size: 11px;
            margin-bottom: 1px;
            line-height: 1.2;
        }

        .billing-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
            justify-content: center;
        }

        .billing-dot {
            font-size: 9px;
            cursor: pointer;
            transition: transform 0.2s ease;
            line-height: 1;
        }

        .billing-dot:hover {
            transform: scale(1.2);
        }

        /* å›¾æ ‡é€‰æ‹©å™¨æ ·å¼ */
        .icon-category-tab {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            border-radius: 16px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .icon-category-tab:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .icon-category-tab.active {
            background: var(--primary-color);
            color: white !important;
            border-color: var(--primary-color);
        }

        .icon-picker-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--background-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-picker-icon:hover {
            border-color: var(--primary-color);
            background: var(--background-tertiary);
        }

        .icon-picker-icon.selected {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }

        /* æ‰£è´¹è¯¦æƒ…åˆ—è¡¨ */
        .billing-detail-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .billing-detail-item:last-child {
            border-bottom: none;
        }

        .billing-detail-info {
            flex: 1;
        }

        .billing-detail-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .billing-detail-price {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .billing-detail-actions {
            display: flex;
            gap: 8px;
        }

        .billing-detail-actions button {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .billing-detail-actions button.edit {
            background: var(--primary-color);
            color: white;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 14px;
            color: var(--text-light);
        }

        .category-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }
        
        .category-item:hover {
            background: var(--background-secondary);
            border-radius: 8px;
            margin: 0 -8px;
            padding-left: 24px;
            padding-right: 24px;
        }
        
        .category-item:last-child {
            border-bottom: none;
        }
        
        .category-name {
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .category-icon {
            font-size: 24px;
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .action-btn.edit {
            background: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        
        .action-btn.edit:hover {
            background: rgba(33, 150, 243, 0.2);
        }
        
        .action-btn.delete {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }
        
        .action-btn.delete:hover {
            background: rgba(244, 67, 54, 0.2);
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        #add-item-modal,
        #item-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        #add-item-modal.active,
        #item-detail-modal.active {
            display: flex;
        }
        
        #add-item-modal > div,
        #item-detail-modal > div {
            background: var(--background-primary);
            border-radius: 16px;
            padding: 28px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        #add-item-modal > div::-webkit-scrollbar,
        #item-detail-modal > div::-webkit-scrollbar {
            width: 4px;
        }
        
        #add-item-modal > div::-webkit-scrollbar-track,
        #item-detail-modal > div::-webkit-scrollbar-track {
            background: transparent;
        }
        
        #add-item-modal > div::-webkit-scrollbar-thumb,
        #item-detail-modal > div::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }
        
        #add-item-modal > div::-webkit-scrollbar-thumb:hover,
        #item-detail-modal > div::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        #add-item-modal h3,
        #item-detail-modal h3 {
            margin-bottom: 24px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* è‡ªå®šä¹‰å¯¹è¯æ¡† */
        #custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        #custom-dialog > div {
            background: var(--background-primary);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        #dialog-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        #dialog-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 24px;
            transition: var(--transition);
        }
        
        #dialog-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        /* åº•éƒ¨æ“ä½œåŒº */
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* æ‹–æ‹½æ ·å¼ */
        .item-card {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease,
                        box-shadow 0.3s ease;
        }
        
        .item-card.dragging {
            opacity: 0.15;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .item-card.placeholder {
            opacity: 0.3;
            transform: scale(0.95);
        }
        
        .item-card.drag-over {
            transform: translateX(10px);
        }
        
        .item-card:hover {
            cursor: grab;
        }
        
        .item-card:active {
            cursor: grabbing;
        }
        
        /* è®¾ç½®é¡µé¢ */
        .settings-section {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        
        .settings-section h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .settings-section p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .panel {
                padding: 16px;
            }
            
            .tab-container {
                padding: 0 16px;
            }
            
            .tab {
                padding: 14px 20px;
                font-size: 14px;
            }
            
            h3 {
                font-size: 20px;
            }
            
            .item-list {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .add-item-btn {
                width: 56px;
                height: 56px;
                font-size: 24px;
                bottom: 24px;
                right: 24px;
            }
            
            #add-item-modal > div,
            #item-detail-modal > div,
            #custom-dialog > div {
                padding: 24px;
                width: 95%;
            }
            
            /* å¤´éƒ¨å“åº”å¼ */
            .app-header h1 {
                font-size: 18px !important;
            }
            
            .app-header > div {
                padding: 12px 16px !important;
            }
            
            .app-header > div > div:first-child {
                margin-bottom: 10px !important;
            }
        }
        
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }
        
        /* ç»ç’ƒæ‹Ÿæ€æ•ˆæœï¼ˆå¯é€‰ï¼‰ */
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* è¾“å…¥éªŒè¯é”™è¯¯æ ·å¼ */
        .input-error {
            border-color: #ef4444 !important;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-state h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .empty-state p {
            font-size: 14px;
        }
        
        /* å¸ƒå±€é€‰é¡¹æŒ‰é’® */
        .layout-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .layout-option:hover {
            border-color: #4361ee;
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .layout-option.active {
            border-color: #4361ee;
            background: #f0f4ff;
        }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-card {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: var(--transition);
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .stats-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }
        
        .stats-content {
            flex: 1;
            min-width: 0;
        }
        
        .stats-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        
        .stats-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }
        
        .chart-container canvas {
            max-height: 300px;
        }

        /* æ—¥å‡æˆæœ¬æç¤ºæ ·å¼ */
        .daily-cost-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .daily-cost-tooltip .tooltip-icon {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            margin-left: 4px;
            transition: all 0.2s;
        }

        .daily-cost-tooltip:hover .tooltip-icon {
            background: rgba(255,255,255,0.5);
        }

        .daily-cost-tooltip .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            transition: all 0.2s;
            pointer-events: none;
            line-height: 1.4;
        }

        .daily-cost-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        .daily-cost-tooltip .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0,0,0,0.85);
        }
    </style>
    
    <!-- è‡ªå®šä¹‰å¼¹å‡ºæ¡† -->
    <div id="custom-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 400px;">
            <h4 id="dialog-title" style="margin-top: 0; margin-bottom: 16px;"></h4>
            <p id="dialog-message" style="margin-bottom: 20px;"></p>
            <input type="text" id="dialog-input" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; display: none;">
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="dialog-cancel" class="btn btn-secondary">å–æ¶ˆ</button>
                <button id="dialog-confirm" class="btn btn-primary">ç¡®å®š</button>
            </div>
        </div>
    </div>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 14px 24px; color: white;">
                <!-- ç¬¬ä¸€è¡Œï¼šæ ‡é¢˜å’Œç‰©å“æ€»æ•° -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h1 style="margin: 0; font-size: 22px; font-weight: 700; letter-spacing: 0.5px;">ç‰©è—å½•</h1>
                        <div style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; backdrop-filter: blur(10px);">
                            å…± <span id="total-items-count" style="font-weight: 700;">0</span> ä»¶
                        </div>
                    </div>
                    
                    <!-- å³ä¾§æŒ‰é’® -->
                    <div style="display: flex; gap: 8px;">
                        <button class="header-action-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 12px; padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; backdrop-filter: blur(10px);">
                            <span style="margin-right: 3px;">ğŸ”</span>ç­›é€‰
                        </button>
                        <button class="header-action-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 12px; padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; backdrop-filter: blur(10px);">
                            <span style="margin-right: 3px;">ğŸ“Š</span>æ’åº
                        </button>
                    </div>
                </div>
                
                <!-- ç¬¬äºŒè¡Œï¼šç»Ÿè®¡å¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ’°</div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; opacity: 0.85; margin-bottom: 2px; font-weight: 500;">æ€»èµ„äº§</div>
                                <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.3px;" id="total-assets">Â¥0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“…</div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; opacity: 0.85; margin-bottom: 2px; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                                    <span class="daily-cost-tooltip">
                                        æ—¥å‡æˆæœ¬
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">åŒ…å«ç‰©å“å’Œè®¢é˜…é¡¹ç›®çš„æˆæœ¬</span>
                                    </span>
                                </div>
                                <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.3px;" id="daily-average">Â¥0.00/å¤©</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">ğŸ“Š</div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; opacity: 0.85; margin-bottom: 2px; font-weight: 500;">å¹³å‡ä»·æ ¼</div>
                                <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.3px;" id="avg-price">Â¥0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="app-content">
            <div class="tab-container">
                <div class="tab active" data-tab="items">ç‰©å“</div>
                <div class="tab" data-tab="subscription">è®¢é˜…</div>
                <div class="tab" data-tab="analytics">åˆ†æ</div>
                <div class="tab" data-tab="settings">æˆ‘çš„</div>
            </div>
            
            <div class="panel active" id="items-panel">
                <!-- åˆ†ç±»æ ‡ç­¾ -->
                <div class="category-tabs">
                    <button class="category-tab active" data-category="all">å…¨éƒ¨</button>
                    <!-- åˆ†ç±»æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
                <div class="item-stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ“¦</div>
                        <div class="stats-content">
                            <div class="stats-label">ç‰©å“æ€»æ•°</div>
                            <div class="stats-value" id="item-total-count">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">ğŸ“…</div>
                        <div class="stats-content">
                            <div class="stats-label">æœ¬æœˆæ–°å¢</div>
                            <div class="stats-value" id="item-monthly-new">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">ğŸ“†</div>
                        <div class="stats-content">
                            <div class="stats-label">å¹´åº¦æ–°å¢</div>
                            <div class="stats-value" id="item-yearly-new">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ’°</div>
                        <div class="stats-content">
                            <div class="stats-label">æ€»ä»·å€¼</div>
                            <div class="stats-value" id="item-total-value">Â¥0</div>
                        </div>
                    </div>
                </div>

                <div class="item-list" id="item-list">
                    <!-- ç‰©å“å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>

            <!-- è®¢é˜…ç®¡ç†é¢æ¿ -->
            <div class="panel" id="subscription-panel">
                <!-- å¿«é€Ÿç»Ÿè®¡å¡ç‰‡ -->
                <div class="subscription-stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ’°</div>
                        <div class="stats-content">
                            <div class="stats-label">æœ¬æœˆæ”¯å‡º</div>
                            <div class="stats-value" id="subscription-monthly-expense">Â¥0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ“Š</div>
                        <div class="stats-content">
                            <div class="stats-label">å¹´åº¦æ”¯å‡º</div>
                            <div class="stats-value" id="subscription-yearly-expense">Â¥0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">â°</div>
                        <div class="stats-content">
                            <div class="stats-label">å³å°†åˆ°æœŸ</div>
                            <div class="stats-value" id="subscription-upcoming-count">0ä¸ª</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">ğŸ“¦</div>
                        <div class="stats-content">
                            <div class="stats-label">è®¢é˜…æ€»æ•°</div>
                            <div class="stats-value" id="subscription-total-count">0</div>
                        </div>
                    </div>
                </div>

                <!-- è®¢é˜…åˆ†ç±»æ ‡ç­¾å’Œæ“ä½œ -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="subscription-category-tabs" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
                        <button class="category-tab active" data-category="all">å…¨éƒ¨</button>
                        <!-- åˆ†ç±»æ ‡ç­¾å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button id="manage-subscription-categories-btn" class="btn btn-secondary" style="padding: 8px 16px;">ğŸ“ ç®¡ç†åˆ†ç±»</button>
                    </div>
                </div>

                <!-- è®¢é˜…åˆ—è¡¨ -->
                <div class="subscription-list" id="subscription-list">
                    <!-- è®¢é˜…å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <!-- æ—¥å†è§†å›¾ -->
                <div style="margin-top: 32px; max-width: 50%;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">ğŸ“… æ‰£è´¹æ—¥å†</h3>
                    <div class="subscription-calendar-container">
                        <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <button class="calendar-nav-btn" data-direction="prev" style="padding: 8px 16px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 8px; cursor: pointer;">â—€</button>
                            <div class="calendar-title" style="font-size: 18px; font-weight: 600;">2025å¹´2æœˆ</div>
                            <button class="calendar-nav-btn" data-direction="next" style="padding: 8px 16px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 8px; cursor: pointer;">â–¶</button>
                        </div>
                        <div class="calendar-weekdays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin-bottom: 6px;">
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">æ—¥</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">ä¸€</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">äºŒ</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">ä¸‰</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">å››</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">äº”</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">å…­</div>
                        </div>
                        <div class="calendar-days" id="subscription-calendar-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;">
                            <!-- æ—¥å†æ—¥æœŸå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡å›¾è¡¨ -->
                <div style="margin-top: 32px;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">ğŸ“ˆ æ”¯å‡ºç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">æœˆåº¦æ”¯å‡ºè¶‹åŠ¿ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰</h4>
                            <canvas id="subscription-timeline-chart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">åˆ†ç±»æ”¯å‡ºå æ¯”</h4>
                            <canvas id="subscription-category-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ è®¢é˜…æŒ‰é’® -->
            <button id="add-subscription-btn" class="add-subscription-btn">+</button>

            <div class="panel" id="analytics-panel">
                <!-- æ¦‚è§ˆå¡ç‰‡ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ“¦</div>
                        <div class="stats-content">
                            <div class="stats-label">ç‰©å“æ€»æ•°</div>
                            <div class="stats-value" id="analytics-total-items">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">ğŸ’°</div>
                        <div class="stats-content">
                            <div class="stats-label">æ€»ä»·å€¼</div>
                            <div class="stats-value" id="analytics-total-value">Â¥0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">ğŸ“Š</div>
                        <div class="stats-content">
                            <div class="stats-label">å¹³å‡ä»·æ ¼</div>
                            <div class="stats-value" id="analytics-avg-price">Â¥0</div>
                        </div>
                    </div>

                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">â±ï¸</div>
                        <div class="stats-content">
                            <div class="stats-label">å¹³å‡æŒæœ‰</div>
                            <div class="stats-value" id="analytics-avg-days">0å¤©</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);">ï¿½</div>
                        <div class="stats-content">
                            <div class="stats-label" style="display: flex; align-items: center; gap: 4px;">
                                æ€»æ—¥å‡æˆæœ¬
                            </div>
                            <div class="stats-value" id="analytics-total-daily-cost">Â¥0/å¤©</div>
                        </div>
                    </div>

                </div>
                
                <!-- å›¾è¡¨åŒºåŸŸ -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <!-- åˆ†ç±»åˆ†å¸ƒé¥¼å›¾ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ“Š åˆ†ç±»åˆ†å¸ƒ</h4>
                        <canvas id="category-chart"></canvas>
                    </div>
                    
                    <!-- ä»·æ ¼åˆ†å¸ƒæŸ±çŠ¶å›¾ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ’µ ä»·æ ¼åŒºé—´åˆ†å¸ƒ</h4>
                        <canvas id="price-chart"></canvas>
                    </div>
                    
                    <!-- è´­ä¹°æ—¶é—´è¶‹åŠ¿å›¾ -->
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ“ˆ è´­ä¹°æ—¶é—´è¶‹åŠ¿ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰</h4>
                        <canvas id="timeline-chart"></canvas>
                    </div>
                    
                    <!-- å­£èŠ‚æ€§è´­ä¹°åˆ†æ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸŒ¸ å­£èŠ‚æ€§è´­ä¹°åˆ†æ</h4>
                        <canvas id="seasonal-chart"></canvas>
                    </div>
                    
                    <!-- æŒæœ‰æ—¶é•¿åˆ†å¸ƒ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">â³ æŒæœ‰æ—¶é•¿åˆ†å¸ƒ</h4>
                        <canvas id="duration-chart"></canvas>
                    </div>
                    
                    <!-- æ—¥å‡ä»·å€¼æ’è¡Œ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ† æ—¥å‡ä»·å€¼æ’è¡Œï¼ˆTop 10ï¼‰</h4>
                        <canvas id="daily-value-chart"></canvas>
                    </div>
                    
                    <!-- åˆ†ç±»ä»·å€¼å¯¹æ¯” -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ’ åˆ†ç±»æ€»ä»·å€¼å¯¹æ¯”</h4>
                        <canvas id="category-value-chart"></canvas>
                    </div>
                    
                    <!-- ä»·æ ¼vsæŒæœ‰æ—¶é•¿æ•£ç‚¹å›¾ -->
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ¯ ä»·æ ¼ä¸æŒæœ‰æ—¶é•¿å…³ç³»</h4>
                        <canvas id="scatter-chart"></canvas>
                    </div>
                    
                    <!-- åˆ†ç±»é›·è¾¾å›¾ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ•¸ï¸ åˆ†ç±»å¤šç»´åº¦åˆ†æ</h4>
                        <canvas id="radar-chart"></canvas>
                    </div>
                    
                    <!-- æœˆåº¦æ”¯å‡ºè¶‹åŠ¿ -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ’¸ æœˆåº¦æ”¯å‡ºè¶‹åŠ¿</h4>
                        <canvas id="spending-chart"></canvas>
                    </div>
                </div>
                
                <!-- TOPæ¦œå• -->
                <div style="margin-top: 24px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">ğŸ… TOPæ¦œå•</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        <!-- æœ€è´µç‰©å“TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">ğŸ’° æœ€è´µç‰©å“ TOP5</h5>
                            <div id="top-expensive-list"></div>
                        </div>
                        
                        <!-- æœ€å€¼ç‰©å“TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">â­ æœ€å€¼ç‰©å“ TOP5</h5>
                            <div id="top-value-list"></div>
                        </div>
                        
                        <!-- æ—¥å‡æˆæœ¬æœ€é«˜TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 6px;">
                                ğŸ’¸ æ—¥å‡æˆæœ¬æœ€é«˜ TOP5
                            </h5>
                            <div id="top-daily-cost-list"></div>
                        </div>
                        
                        <!-- æŒæœ‰æœ€ä¹…TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">ğŸ•°ï¸ æŒæœ‰æœ€ä¹… TOP5</h5>
                            <div id="top-oldest-list"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel" id="settings-panel">
                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="settings-section" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none;">
                    <h4 style="color: white; margin-bottom: 16px;">ç»Ÿè®¡æ¦‚è§ˆ</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">ç‰©å“æ€»æ•°</div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-items">0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">ä»¶</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">æ€»èµ„äº§</div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-assets">Â¥0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">å…ƒ</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">åˆ†ç±»æ•°é‡</div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-categories">0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">ä¸ª</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                <span class="daily-cost-tooltip">
                                    æ—¥å‡æˆæœ¬
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-content">åŒ…å«ç‰©å“å’Œè®¢é˜…é¡¹ç›®çš„æˆæœ¬</span>
                                </span>
                            </div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-daily-average">Â¥0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">å…ƒ/å¤©</div>
                        </div>
                    </div>
                </div>
                
                <!-- å¿«æ·ç®¡ç† -->
                <div class="settings-section">
                    <h4>å¿«æ·ç®¡ç†</h4>
                    <p>å¿«é€Ÿç®¡ç†åˆ†ç±»å’Œè´­ä¹°æ¸ é“</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                        <!-- åˆ†ç±»ç®¡ç†å¡ç‰‡ -->
                        <div class="quick-manage-card" id="category-manage-card">
                            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“</div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">åˆ†ç±»ç®¡ç†</div>
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                                å½“å‰ <span id="category-count">0</span> ä¸ªåˆ†ç±»
                            </div>
                            <button class="btn btn-secondary" style="width: 100%; font-size: 14px;">ç‚¹å‡»ç®¡ç† â†’</button>
                        </div>
                        <!-- è´­ä¹°æ¸ é“ç®¡ç†å¡ç‰‡ -->
                        <div class="quick-manage-card" id="channel-manage-card">
                            <div style="font-size: 32px; margin-bottom: 8px;">ğŸ›’</div>
                            <div style="font-weight: 600; font-size: 16px; margin-bottom: 4px;">è´­ä¹°æ¸ é“ç®¡ç†</div>
                            <div style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                                å½“å‰ <span id="channel-count">0</span> ä¸ªæ¸ é“
                            </div>
                            <button class="btn btn-secondary" style="width: 100%; font-size: 14px;">ç‚¹å‡»ç®¡ç† â†’</button>
                        </div>
                    </div>
                </div>

                <!-- ä¸»é¢˜é€‰æ‹© -->
                <div class="settings-section">
                    <h4>ä¸»é¢˜é…è‰²</h4>
                    <p>é€‰æ‹©é¢„è®¾ä¸»é¢˜æˆ–è‡ªå®šä¹‰é…è‰²æ–¹æ¡ˆ</p>
                    <div id="theme-presets" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <!-- ä¸»é¢˜å¡ç‰‡å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
                    </div>
                    <button id="custom-theme-btn" class="btn btn-secondary" style="width: 100%;">è‡ªå®šä¹‰ä¸»é¢˜</button>
                </div>
                
                <!-- å¸ƒå±€é€‰æ‹© -->
                <div class="settings-section">
                    <h4>å¡ç‰‡å¸ƒå±€</h4>
                    <p>é€‰æ‹©ç‰©å“å¡ç‰‡çš„æ˜¾ç¤ºæ–¹å¼</p>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <button class="layout-option active" data-layout="grid" style="flex: 1; padding: 12px; border: 2px solid #4361ee; border-radius: 8px; background: #f0f4ff; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 24px; margin-bottom: 4px;">â–¦</div>
                            <div style="font-size: 12px; font-weight: 500;">ç½‘æ ¼</div>
                        </button>
                        <button class="layout-option" data-layout="list" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 24px; margin-bottom: 4px;">â˜°</div>
                            <div style="font-size: 12px; font-weight: 500;">åˆ—è¡¨</div>
                        </button>
                        <button class="layout-option" data-layout="masonry" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 24px; margin-bottom: 4px;">â–¦â–¥</div>
                            <div style="font-size: 12px; font-weight: 500;">ç€‘å¸ƒæµ</div>
                        </button>
                    </div>
                </div>
                
                <!-- æ•°æ®ç®¡ç† -->
                <div class="settings-section">
                    <h4>æ•°æ®ç®¡ç†</h4>
                    <p>å¯¼å‡ºæˆ–å¯¼å…¥æ‚¨çš„æ•°æ®</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" id="export-data-btn" style="flex: 1;">å¯¼å‡ºæ•°æ®</button>
                        <button class="btn btn-primary" id="import-data-btn" style="flex: 1;">å¯¼å…¥æ•°æ®</button>
                    </div>
                </div>
                
                <!-- å…³äº -->
                <div class="settings-section">
                    <h4>å…³äº</h4>
                    <p style="margin-bottom: 4px;">ç‰©è—å½• v1.0.0</p>
                    <p style="margin-bottom: 0;">ä¸ªäººç‰©å“ç®¡ç†å·¥å…·</p>
                </div>
            </div>
        </div>
        
        <button class="add-item-btn" id="add-item-btn">+</button>
    </div>
    
    <!-- æ·»åŠ ç‰©å“æ¨¡æ€æ¡† -->
    <div id="add-item-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3>æ·»åŠ æ–°ç‰©å“</h3>
            <div class="form-group">
                <label>ç‰©å“åç§° <span style="color: #f5222d;">*</span></label>
                <input type="text" id="item-name" placeholder="è¯·è¾“å…¥ç‰©å“åç§°">
            </div>
            <div class="form-group">
                <label>åˆ†ç±» <span style="color: #f5222d;">*</span></label>
                <div class="custom-select" id="custom-category-select">
                    <div class="custom-select-trigger">è¯·é€‰æ‹©åˆ†ç±»</div>
                    <div class="custom-select-options"></div>
                    <input type="hidden" id="item-category" value="">
                </div>
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="item-desc" rows="3" placeholder="è¯·è¾“å…¥ç‰©å“æè¿°"></textarea>
            </div>
            <div class="form-group">
                <label>å­˜æ”¾ä½ç½®</label>
                <input type="text" id="item-location" placeholder="è¯·è¾“å…¥å­˜æ”¾ä½ç½®">
            </div>
            <div class="form-group">
                <label>ä»·æ ¼ (Â¥)</label>
                <input type="number" id="item-price" placeholder="è¯·è¾“å…¥ç‰©å“ä»·æ ¼" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>è´­ä¹°æ—¥æœŸ</label>
                <input type="date" id="item-purchase-date">
            </div>
            <div class="form-group">
                <label>è´­ä¹°æ¸ é“ <span style="color: #f5222d;">*</span></label>
                <select id="item-purchase-channel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <!-- è´­ä¹°æ¸ é“é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-add">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="save-item">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç‰©å“è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="item-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3>ç‰©å“è¯¦æƒ…</h3>
            <div class="form-group">
                <label>ç‰©å“åç§° <span style="color: #f5222d;">*</span></label>
                <input type="text" id="detail-item-name">
            </div>
            <div class="form-group">
                <label>åˆ†ç±» <span style="color: #f5222d;">*</span></label>
                <div class="custom-select" id="custom-detail-category-select">
                    <div class="custom-select-trigger">è¯·é€‰æ‹©åˆ†ç±»</div>
                    <div class="custom-select-options"></div>
                    <input type="hidden" id="detail-item-category" value="">
                </div>
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea id="detail-item-desc" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>å­˜æ”¾ä½ç½®</label>
                <input type="text" id="detail-item-location">
            </div>
            <div class="form-group">
                <label>ä»·æ ¼ (Â¥)</label>
                <input type="number" id="detail-item-price" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>è´­ä¹°æ—¥æœŸ</label>
                <input type="date" id="detail-item-purchase-date">
            </div>
            <div class="form-group">
                <label>æ—¥å‡ä»·å€¼ (Â¥)</label>
                <input type="number" id="detail-item-daily-value" readonly step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>è´­ä¹°æ¸ é“</label>
                <select id="detail-item-purchase-channel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <!-- è´­ä¹°æ¸ é“é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
                <button class="btn btn-danger" id="delete-item-detail" style="background-color: #dc3545; border-color: #dc3545;">åˆ é™¤ç‰©å“</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary" id="close-detail">å…³é—­</button>
                    <button class="btn btn-primary" id="save-item-detail">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†ç±»ç®¡ç†å¼¹çª— -->
    <div id="category-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“ åˆ†ç±»ç®¡ç†</h3>
            <div id="category-manage-list" style="margin-bottom: 20px;">
                <!-- åˆ†ç±»åˆ—è¡¨é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="add-category-in-modal" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px;">+ æ·»åŠ æ–°åˆ†ç±»</button>
            <button id="close-category-modal" class="btn btn-secondary" style="width: 100%; margin-top: 12px; padding: 12px; font-size: 14px;">å…³é—­</button>
        </div>
    </div>

    <!-- è´­ä¹°æ¸ é“ç®¡ç†å¼¹çª— -->
    <div id="channel-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ›’ è´­ä¹°æ¸ é“ç®¡ç†</h3>
            <div id="channel-manage-list" style="margin-bottom: 20px;">
                <!-- æ¸ é“åˆ—è¡¨é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="add-channel-in-modal" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px;">+ æ·»åŠ æ–°æ¸ é“</button>
            <button id="close-channel-modal" class="btn btn-secondary" style="width: 100%; margin-top: 12px; padding: 12px; font-size: 14px;">å…³é—­</button>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è®¢é˜…å¼¹çª— -->
    <div id="subscription-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 id="subscription-modal-title" style="margin-bottom: 20px; text-align: center; font-size: 18px;">æ·»åŠ è®¢é˜…</h3>
            <div class="form-group">
                <label>è®¢é˜…åç§° <span style="color: #f5222d;">*</span></label>
                <input type="text" id="subscription-name" placeholder="å¦‚ï¼šNetflixã€Spotify" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label>åˆ†ç±» <span style="color: #f5222d;">*</span></label>
                <select id="subscription-category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <!-- åˆ†ç±»é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </select>
            </div>
            <div class="form-group">
                <label>å›¾æ ‡</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div id="subscription-icon-preview" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--border-color);">ğŸ¬</div>
                    <button id="subscription-icon-picker-btn" type="button" class="btn btn-secondary" style="padding: 8px 16px;">é€‰æ‹©å›¾æ ‡</button>
                </div>
                <input type="hidden" id="subscription-icon" value="ğŸ¬">
            </div>
            <div class="form-group">
                <label>ä»·æ ¼ (Â¥) <span style="color: #f5222d;">*</span></label>
                <input type="number" id="subscription-price" placeholder="è¯·è¾“å…¥ä»·æ ¼" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label>å‘¨æœŸç±»å‹ <span style="color: #f5222d;">*</span></label>
                <select id="subscription-cycle-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <option value="day">æŒ‰å¤©</option>
                    <option value="week">æŒ‰å‘¨</option>
                    <option value="month" selected>æŒ‰æœˆ</option>
                    <option value="quarter">æŒ‰å­£</option>
                    <option value="year">æŒ‰å¹´</option>
                    <option value="lifetime">ç»ˆèº«æœ‰æ•ˆ</option>
                </select>
            </div>
            <div class="form-group" id="first-billing-date-group">
                <label id="billing-date-label">æ‰£è´¹æ—¥æœŸ <span style="color: #f5222d;">*</span></label>

                <!-- æŒ‰å‘¨ï¼šé€‰æ‹©æ˜ŸæœŸå‡  -->
                <div id="billing-day-of-week" style="display: none;">
                    <select id="subscription-day-of-week" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="1">å‘¨ä¸€</option>
                        <option value="2">å‘¨äºŒ</option>
                        <option value="3">å‘¨ä¸‰</option>
                        <option value="4">å‘¨å››</option>
                        <option value="5">å‘¨äº”</option>
                        <option value="6">å‘¨å…­</option>
                        <option value="0">å‘¨æ—¥</option>
                    </select>
                </div>

                <!-- æŒ‰æœˆï¼šé€‰æ‹©å‡ å· -->
                <div id="billing-day-of-month" style="display: none;">
                    <select id="subscription-day-of-month" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </select>
                </div>

                <!-- æŒ‰å­£ï¼šé€‰æ‹©æœˆä»½å’Œæ—¥æœŸ -->
                <div id="billing-day-of-quarter" style="display: none;">
                    <select id="subscription-quarter-month" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                        <option value="1">1æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="10">10æœˆ</option>
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">æœˆ</span>
                    <select id="subscription-quarter-day" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">æ—¥</span>
                </div>

                <!-- æŒ‰å¹´ï¼šé€‰æ‹©æœˆ-æ—¥ -->
                <div id="billing-day-of-year" style="display: none;">
                    <select id="subscription-month" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">æœˆ</span>
                    <select id="subscription-day-of-year-day" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">æ—¥</span>
                </div>

                <!-- æŒ‰å¤©ï¼šæç¤ºæ¯å¤©æ‰£è´¹ -->
                <div id="billing-day-hint" style="display: none;">
                    <div style="padding: 10px; background: var(--background-secondary); border-radius: 6px; color: var(--text-secondary);">
                        æ¯å¤©æ‰£è´¹ï¼Œæ— éœ€é€‰æ‹©æ—¥æœŸ
                    </div>
                </div>

                <small id="billing-date-hint" style="color: var(--text-secondary);">é€‰æ‹©ä¸‹æ¬¡æ‰£è´¹çš„æ—¥æœŸï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—åç»­æ‰£è´¹æ—¶é—´</small>
            </div>

            <!-- ç»ˆèº«è®¢é˜…çš„ç‰¹æ®Šé€‰é¡¹ -->
            <div class="form-group" id="lifetime-options-group" style="display: none;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <input type="checkbox" id="lifetime-include-daily" style="width: 18px; height: 18px;">
                    <label for="lifetime-include-daily" style="margin: 0;">è®¡å…¥æ—¥å‡æˆæœ¬</label>
                </div>
                <div id="lifetime-purchase-date-group" style="display: none;">
                    <label style="font-size: 14px; color: var(--text-primary); margin-bottom: 6px; display: block;">è´­ä¹°æ—¥æœŸ</label>
                    <input type="date" id="lifetime-purchase-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <small style="color: var(--text-secondary);">å°†æŒ‰è´­ä¹°æ—¥æœŸåˆ°ç°åœ¨çš„å¤©æ•°è®¡ç®—æ—¥å‡æˆæœ¬</small>
                </div>
            </div>

            <div class="form-group">
                <label>æé†’è®¾ç½®</label>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <input type="checkbox" id="subscription-reminder-enabled" checked style="width: 18px; height: 18px;">
                    <label for="subscription-reminder-enabled" style="margin: 0;">å¯ç”¨åˆ°æœŸæé†’</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="subscription-reminder-days" style="margin: 0;">æå‰</label>
                    <input type="number" id="subscription-reminder-days" value="1" min="0" max="30" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <label for="subscription-reminder-days" style="margin: 0;">å¤©æé†’</label>
                </div>
            </div>
            <div class="form-group">
                <label>å¤‡æ³¨</label>
                <textarea id="subscription-notes" rows="2" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></textarea>
            </div>
            <div class="form-group">
                <label>å®˜ç½‘</label>
                <input type="url" id="subscription-website" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-subscription">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="save-subscription">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- å›¾æ ‡é€‰æ‹©å™¨å¼¹çª— -->
    <div id="icon-picker-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1100; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">é€‰æ‹©å›¾æ ‡</h3>
            <div id="icon-picker-categories" style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px;">
                <button class="icon-category-tab active" data-category="common" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">å¸¸ç”¨</button>
                <button class="icon-category-tab" data-category="entertainment" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">å¨±ä¹</button>
                <button class="icon-category-tab" data-category="office" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">åŠå…¬</button>
                <button class="icon-category-tab" data-category="education" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">æ•™è‚²</button>
                <button class="icon-category-tab" data-category="tools" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">å·¥å…·</button>
                <button class="icon-category-tab" data-category="finance" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">é‡‘è</button>
                <button class="icon-category-tab" data-category="other" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">å…¶ä»–</button>
            </div>
            <div id="icon-picker-icons" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 20px;">
                <!-- å›¾æ ‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="close-icon-picker" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 14px;">å…³é—­</button>
        </div>
    </div>

    <!-- è®¢é˜…åˆ†ç±»ç®¡ç†å¼¹çª— -->
    <div id="subscription-category-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">ğŸ“ è®¢é˜…åˆ†ç±»ç®¡ç†</h3>
            <div id="subscription-category-manage-list" style="margin-bottom: 20px;">
                <!-- åˆ†ç±»åˆ—è¡¨é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="add-subscription-category-in-modal" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px;">+ æ·»åŠ æ–°åˆ†ç±»</button>
            <button id="close-subscription-category-modal" class="btn btn-secondary" style="width: 100%; margin-top: 12px; padding: 12px; font-size: 14px;">å…³é—­</button>
        </div>
    </div>

    <!-- æ‰£è´¹æ—¥æœŸè¯¦æƒ…å¼¹çª— -->
    <div id="billing-date-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 id="billing-date-detail-title" style="margin-bottom: 20px; text-align: center; font-size: 18px;">æ‰£è´¹è¯¦æƒ…</h3>
            <div id="billing-date-detail-list">
                <!-- æ‰£è´¹åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
            <button id="close-billing-date-detail" class="btn btn-secondary" style="width: 100%; margin-top: 20px; padding: 12px; font-size: 14px;">å…³é—­</button>
        </div>
    </div>

    <script>
        // å­˜å‚¨ç®¡ç†æ¨¡å—
        class Storage {
            constructor() {
                this.itemsKey = 'wucanglu_items';
                this.categoriesKey = 'wucanglu_categories';
                this.channelsKey = 'wucanglu_channels';
                this.settingsKey = 'wucanglu_settings';
                this.useUToolsDB = typeof utools !== 'undefined' && utools.db;
                console.log('å­˜å‚¨æ–¹å¼:', this.useUToolsDB ? 'uTools æœ¬åœ°æ•°æ®åº“' : 'localStorage');

                // æ£€æµ‹localStorageæ˜¯å¦å¯ç”¨
                this.localStorageAvailable = this.isLocalStorageAvailable();
                console.log('localStorageæ˜¯å¦å¯ç”¨:', this.localStorageAvailable);

                // å†…å­˜å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
                this.memoryStorage = {
                    items: [],
                    categories: [],
                    channels: [],
                    settings: {
                        theme: 'light',
                        autoBackup: false
                    }
                };
            }
            
            // æ£€æµ‹localStorageæ˜¯å¦å¯ç”¨
            isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // åˆå§‹åŒ–é»˜è®¤æ•°æ®
            initDefaultData() {
                console.log('å¼€å§‹åˆå§‹åŒ–é»˜è®¤æ•°æ®');
                
                // å…ˆæ£€æŸ¥å¹¶ä¿®å¤æ—§çš„ç¡¬ç¼–ç ID
                this.migrateOldData();
                
                const categories = this.getCategories();
                console.log('å½“å‰åˆ†ç±»æ•°é‡:', categories.length);
                if (!categories.length) {
                    console.log('åˆå§‹åŒ–é»˜è®¤åˆ†ç±»');
                    const defaultCategories = [
                        { id: Date.now().toString(), name: 'æ•°ç äº§å“', icon: 'ğŸ’»' },
                        { id: (Date.now() + 1).toString(), name: 'ç”Ÿæ´»ç”¨å“', icon: 'ğŸ ' },
                        { id: (Date.now() + 2).toString(), name: 'ä¹¦ç±', icon: 'ğŸ“š' },
                        { id: (Date.now() + 3).toString(), name: 'å…¶ä»–', icon: 'ğŸ“¦' }
                    ];
                    const result = this.saveCategories(defaultCategories);
                    console.log('åˆå§‹åŒ–é»˜è®¤åˆ†ç±»ç»“æœ:', result);
                }
                
                // åˆå§‹åŒ–é»˜è®¤è´­ä¹°æ¸ é“
                const channels = this.getChannels();
                console.log('å½“å‰è´­ä¹°æ¸ é“æ•°é‡:', channels.length);
                if (!channels.length) {
                    console.log('åˆå§‹åŒ–é»˜è®¤è´­ä¹°æ¸ é“');
                    const defaultChannels = [
                        { id: Date.now().toString(), name: 'æ·˜å®' },
                        { id: (Date.now() + 1).toString(), name: 'äº¬ä¸œ' },
                        { id: (Date.now() + 2).toString(), name: 'æŠ–éŸ³' },
                        { id: (Date.now() + 3).toString(), name: 'æ‹¼å¤šå¤š' },
                        { id: (Date.now() + 4).toString(), name: 'å…¶ä»–' }
                    ];
                    const result = this.saveChannels(defaultChannels);
                    console.log('åˆå§‹åŒ–é»˜è®¤è´­ä¹°æ¸ é“ç»“æœ:', result);
                }

                // ä¸å†åˆå§‹åŒ–é»˜è®¤ç‰©å“ï¼Œè®©ç”¨æˆ·ä»ç©ºç™½çŠ¶æ€å¼€å§‹
                console.log('åˆå§‹åŒ–é»˜è®¤æ•°æ®å®Œæˆ');
            }
            
            // è¿ç§»æ—§æ•°æ®ï¼ˆä¿®å¤ç¡¬ç¼–ç IDï¼‰
            migrateOldData() {
                console.log('æ£€æŸ¥æ˜¯å¦éœ€è¦è¿ç§»æ—§æ•°æ®');
                
                // ä¿®å¤ç‰©å“ID
                const items = this.getItems();
                let itemsNeedMigration = false;
                const migratedItems = items.map(item => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§çš„ç¡¬ç¼–ç IDï¼ˆå•ä¸ªæ•°å­—å­—ç¬¦ï¼‰
                    if (item.id && item.id.length <= 2 && /^\d+$/.test(item.id)) {
                        console.log(`è¿ç§»ç‰©å“ID: ${item.id} -> ${Date.now() + parseInt(item.id)}`);
                        itemsNeedMigration = true;
                        return { ...item, id: (Date.now() + parseInt(item.id)).toString() };
                    }
                    return item;
                });
                
                if (itemsNeedMigration) {
                    console.log('ä¿å­˜è¿ç§»åçš„ç‰©å“æ•°æ®');
                    this.saveItems(migratedItems);
                }

                // ä¿®å¤åˆ†ç±»ID
                const categories = this.getCategories();
                let categoriesNeedMigration = false;
                const migratedCategories = categories.map(category => {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ—§çš„ç¡¬ç¼–ç IDï¼ˆå•ä¸ªæ•°å­—å­—ç¬¦ï¼‰
                    if (category.id && category.id.length <= 2 && /^\d+$/.test(category.id)) {
                        console.log(`è¿ç§»åˆ†ç±»ID: ${category.id} -> ${Date.now() + parseInt(category.id)}`);
                        categoriesNeedMigration = true;
                        return { ...category, id: (Date.now() + parseInt(category.id) + 1000).toString() };
                    }
                    return category;
                });
                
                if (categoriesNeedMigration) {
                    console.log('ä¿å­˜è¿ç§»åçš„åˆ†ç±»æ•°æ®');
                    this.saveCategories(migratedCategories);
                }
                
                console.log('æ•°æ®è¿ç§»æ£€æŸ¥å®Œæˆ');
            }
            
            // è·å–æ‰€æœ‰ç‰©å“
            getItems() {
                try {
                    console.log('å¼€å§‹è·å–ç‰©å“æ•°æ®');
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.itemsKey);
                        console.log('ä»uToolsæ•°æ®åº“è·å–åˆ°çš„ç‰©å“æ•°æ®:', doc);
                        return doc ? doc.items : [];
                    } else if (this.localStorageAvailable) {
                        const items = localStorage.getItem(this.itemsKey);
                        console.log('ä»localStorageè·å–åˆ°çš„ç‰©å“æ•°æ®:', items);
                        return items ? JSON.parse(items) : [];
                    } else {
                        console.log('ä»å†…å­˜å­˜å‚¨è·å–ç‰©å“æ•°æ®');
                        return this.memoryStorage.items;
                    }
                } catch (error) {
                    console.error('è·å–ç‰©å“æ•°æ®å¤±è´¥:', error);
                    return this.memoryStorage.items;
                }
            }
            
            // ä¿å­˜ç‰©å“åˆ—è¡¨
            saveItems(items) {
                try {
                    console.log('å¼€å§‹ä¿å­˜ç‰©å“æ•°æ®:', items);
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.itemsKey);
                        const putDoc = {
                            _id: this.itemsKey,
                            items: items
                        };
                        // åªæœ‰åœ¨æ–‡æ¡£å·²å­˜åœ¨æ—¶æ‰æ·»åŠ  _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('ä¿å­˜ç‰©å“æ•°æ®ç»“æœ:', result);
                        if (result.error) {
                            console.error('uToolsæ•°æ®åº“ä¿å­˜å¤±è´¥:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.itemsKey, JSON.stringify(items));
                        console.log('ä¿å­˜ç‰©å“æ•°æ®æˆåŠŸ');
                        return true;
                    } else {
                        console.log('ä¿å­˜ç‰©å“æ•°æ®åˆ°å†…å­˜å­˜å‚¨');
                        this.memoryStorage.items = items;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜ç‰©å“æ•°æ®å¤±è´¥:', error);
                    console.log('ä¿å­˜ç‰©å“æ•°æ®åˆ°å†…å­˜å­˜å‚¨ä½œä¸ºåå¤‡');
                    this.memoryStorage.items = items;
                    return true;
                }
            }
            
            // æ·»åŠ ç‰©å“
            addItem(item) {
                const items = this.getItems();
                const newItem = {
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    ...item
                };
                items.push(newItem);
                return this.saveItems(items) ? newItem : null;
            }
            
            // æ›´æ–°ç‰©å“
            updateItem(id, updates) {
                const items = this.getItems();
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const index = items.findIndex(item => item.id == id || item.id.toString() === id.toString());
                if (index !== -1) {
                    items[index] = { ...items[index], ...updates };
                    return this.saveItems(items);
                }
                return false;
            }
            
            // åˆ é™¤ç‰©å“
            deleteItem(id) {
                const items = this.getItems();
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const filteredItems = items.filter(item => item.id != id && item.id.toString() !== id.toString());
                return this.saveItems(filteredItems);
            }
            
            // è·å–ç‰©å“è¯¦æƒ…
            getItemById(id) {
                const items = this.getItems();
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                return items.find(item => item.id == id || item.id.toString() === id.toString()) || null;
            }
            
            // è·å–æ‰€æœ‰åˆ†ç±»
            getCategories() {
                try {
                    console.log('å¼€å§‹è·å–åˆ†ç±»æ•°æ®');
                    if (this.useUToolsDB) {
                        console.log('ä½¿ç”¨uToolsæœ¬åœ°æ•°æ®åº“è·å–åˆ†ç±»æ•°æ®');
                        const doc = utools.db.get(this.categoriesKey);
                        console.log('ä»uToolsæ•°æ®åº“è·å–åˆ°çš„åˆ†ç±»æ•°æ®:', doc);
                        const categories = doc ? doc.categories : [];
                        console.log('è§£æåçš„åˆ†ç±»æ•°æ®:', categories);
                        return categories;
                    } else if (this.localStorageAvailable) {
                        console.log('ä½¿ç”¨localStorageè·å–åˆ†ç±»æ•°æ®');
                        const categories = localStorage.getItem(this.categoriesKey);
                        console.log('ä»localStorageè·å–åˆ°çš„åˆ†ç±»æ•°æ®:', categories);
                        const parsedCategories = categories ? JSON.parse(categories) : [];
                        console.log('è§£æåçš„åˆ†ç±»æ•°æ®:', parsedCategories);
                        return parsedCategories;
                    } else {
                        console.log('ä»å†…å­˜å­˜å‚¨è·å–åˆ†ç±»æ•°æ®');
                        return this.memoryStorage.categories;
                    }
                } catch (error) {
                    console.error('è·å–åˆ†ç±»æ•°æ®å¤±è´¥:', error);
                    return this.memoryStorage.categories;
                }
            }
            
            // ä¿å­˜åˆ†ç±»åˆ—è¡¨
            saveCategories(categories) {
                try {
                    console.log('å¼€å§‹ä¿å­˜åˆ†ç±»æ•°æ®:', categories);
                    if (this.useUToolsDB) {
                        console.log('ä½¿ç”¨uToolsæœ¬åœ°æ•°æ®åº“ä¿å­˜åˆ†ç±»æ•°æ®');
                        const doc = utools.db.get(this.categoriesKey);
                        console.log('è·å–åˆ°çš„åˆ†ç±»æ–‡æ¡£:', doc);
                        const putDoc = {
                            _id: this.categoriesKey,
                            categories: categories
                        };
                        // åªæœ‰åœ¨æ–‡æ¡£å·²å­˜åœ¨æ—¶æ‰æ·»åŠ  _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('ä¿å­˜åˆ†ç±»æ•°æ®ç»“æœ:', result);
                        if (result.error) {
                            console.error('uToolsæ•°æ®åº“ä¿å­˜å¤±è´¥:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        console.log('ä½¿ç”¨localStorageä¿å­˜åˆ†ç±»æ•°æ®');
                        localStorage.setItem(this.categoriesKey, JSON.stringify(categories));
                        console.log('ä¿å­˜åˆ†ç±»æ•°æ®æˆåŠŸ');
                        return true;
                    } else {
                        console.log('ä¿å­˜åˆ†ç±»æ•°æ®åˆ°å†…å­˜å­˜å‚¨');
                        this.memoryStorage.categories = categories;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜åˆ†ç±»æ•°æ®å¤±è´¥:', error);
                    console.log('ä¿å­˜åˆ†ç±»æ•°æ®åˆ°å†…å­˜å­˜å‚¨ä½œä¸ºåå¤‡');
                    this.memoryStorage.categories = categories;
                    return true;
                }
            }
            
            // æ·»åŠ åˆ†ç±»
            addCategory(category) {
                console.log('storage.addCategoryè¢«è°ƒç”¨:', category);
                const categories = this.getCategories();
                console.log('æ·»åŠ å‰çš„åˆ†ç±»æ•°é‡:', categories.length);
                const newCategory = {
                    id: Date.now().toString(),
                    ...category
                };
                console.log('æ–°åˆ†ç±»:', newCategory);
                categories.push(newCategory);
                console.log('æ·»åŠ åçš„åˆ†ç±»æ•°é‡:', categories.length);
                const result = this.saveCategories(categories);
                console.log('ä¿å­˜ç»“æœ:', result);
                return result;
            }
            
            // æ›´æ–°åˆ†ç±»
            updateCategory(id, updates) {
                console.log('æ›´æ–°åˆ†ç±»:', id, updates);
                const categories = this.getCategories();
                console.log('æ›´æ–°å‰çš„åˆ†ç±»:', categories);
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const index = categories.findIndex(category => category.id == id || category.id.toString() === id.toString());
                console.log('æ‰¾åˆ°åˆ†ç±»ç´¢å¼•:', index);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...updates };
                    console.log('æ›´æ–°åçš„åˆ†ç±»:', categories);
                    const result = this.saveCategories(categories);
                    console.log('æ›´æ–°åˆ†ç±»ç»“æœ:', result);
                    return result;
                }
                console.error('åˆ†ç±»ä¸å­˜åœ¨:', id);
                return false;
            }
            
            // åˆ é™¤åˆ†ç±»
            deleteCategory(id) {
                console.log('åˆ é™¤åˆ†ç±»:', id);
                const categories = this.getCategories();
                console.log('åˆ é™¤å‰çš„åˆ†ç±»:', categories);
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const filteredCategories = categories.filter(category => category.id != id && category.id.toString() !== id.toString());
                console.log('åˆ é™¤åçš„åˆ†ç±»:', filteredCategories);
                const result = this.saveCategories(filteredCategories);
                console.log('åˆ é™¤åˆ†ç±»ç»“æœ:', result);
                return result;
            }
            
            // è·å–åˆ†ç±»è¯¦æƒ…
            getCategoryById(id) {
                console.log('è·å–åˆ†ç±»è¯¦æƒ…:', id);
                const categories = this.getCategories();
                console.log('å½“å‰åˆ†ç±»åˆ—è¡¨:', categories);
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const category = categories.find(category => category.id == id || category.id.toString() === id.toString());
                console.log('æ‰¾åˆ°çš„åˆ†ç±»:', category);
                return category || null;
            }

            // è·å–æ‰€æœ‰è´­ä¹°æ¸ é“
            getChannels() {
                try {
                    console.log('å¼€å§‹è·å–è´­ä¹°æ¸ é“æ•°æ®');
                    if (this.useUToolsDB) {
                        console.log('ä½¿ç”¨uToolsæœ¬åœ°æ•°æ®åº“è·å–è´­ä¹°æ¸ é“æ•°æ®');
                        const doc = utools.db.get(this.channelsKey);
                        console.log('ä»uToolsæ•°æ®åº“è·å–åˆ°çš„è´­ä¹°æ¸ é“æ•°æ®:', doc);
                        const channels = doc ? doc.channels : [];
                        console.log('è§£æåçš„è´­ä¹°æ¸ é“æ•°æ®:', channels);
                        return channels;
                    } else if (this.localStorageAvailable) {
                        console.log('ä½¿ç”¨localStorageè·å–è´­ä¹°æ¸ é“æ•°æ®');
                        const channels = localStorage.getItem(this.channelsKey);
                        console.log('ä»localStorageè·å–åˆ°çš„è´­ä¹°æ¸ é“æ•°æ®:', channels);
                        const parsedChannels = channels ? JSON.parse(channels) : [];
                        console.log('è§£æåçš„è´­ä¹°æ¸ é“æ•°æ®:', parsedChannels);
                        return parsedChannels;
                    } else {
                        console.log('ä»å†…å­˜å­˜å‚¨è·å–è´­ä¹°æ¸ é“æ•°æ®');
                        return this.memoryStorage.channels;
                    }
                } catch (error) {
                    console.error('è·å–è´­ä¹°æ¸ é“æ•°æ®å¤±è´¥:', error);
                    return this.memoryStorage.channels;
                }
            }

            // ä¿å­˜è´­ä¹°æ¸ é“åˆ—è¡¨
            saveChannels(channels) {
                try {
                    console.log('å¼€å§‹ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®:', channels);
                    if (this.useUToolsDB) {
                        console.log('ä½¿ç”¨uToolsæœ¬åœ°æ•°æ®åº“ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®');
                        const doc = utools.db.get(this.channelsKey);
                        console.log('è·å–åˆ°çš„è´­ä¹°æ¸ é“æ–‡æ¡£:', doc);
                        const putDoc = {
                            _id: this.channelsKey,
                            channels: channels
                        };
                        // åªæœ‰åœ¨æ–‡æ¡£å·²å­˜åœ¨æ—¶æ‰æ·»åŠ  _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®ç»“æœ:', result);
                        if (result.error) {
                            console.error('uToolsæ•°æ®åº“ä¿å­˜å¤±è´¥:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        console.log('ä½¿ç”¨localStorageä¿å­˜è´­ä¹°æ¸ é“æ•°æ®');
                        localStorage.setItem(this.channelsKey, JSON.stringify(channels));
                        console.log('ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®æˆåŠŸ');
                        return true;
                    } else {
                        console.log('ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®åˆ°å†…å­˜å­˜å‚¨');
                        this.memoryStorage.channels = channels;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®å¤±è´¥:', error);
                    console.log('ä¿å­˜è´­ä¹°æ¸ é“æ•°æ®åˆ°å†…å­˜å­˜å‚¨ä½œä¸ºåå¤‡');
                    this.memoryStorage.channels = channels;
                    return true;
                }
            }

            // æ·»åŠ è´­ä¹°æ¸ é“
            addChannel(channel) {
                console.log('storage.addChannelè¢«è°ƒç”¨:', channel);
                const channels = this.getChannels();
                console.log('æ·»åŠ å‰çš„è´­ä¹°æ¸ é“æ•°é‡:', channels.length);
                const newChannel = {
                    id: Date.now().toString(),
                    ...channel
                };
                console.log('æ–°è´­ä¹°æ¸ é“:', newChannel);
                channels.push(newChannel);
                console.log('æ·»åŠ åçš„è´­ä¹°æ¸ é“æ•°é‡:', channels.length);
                const result = this.saveChannels(channels);
                console.log('ä¿å­˜ç»“æœ:', result);
                return result;
            }

            // æ›´æ–°è´­ä¹°æ¸ é“
            updateChannel(id, updates) {
                console.log('æ›´æ–°è´­ä¹°æ¸ é“:', id, updates);
                const channels = this.getChannels();
                console.log('æ›´æ–°å‰çš„è´­ä¹°æ¸ é“:', channels);
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const index = channels.findIndex(channel => channel.id == id || channel.id.toString() === id.toString());
                console.log('æ‰¾åˆ°è´­ä¹°æ¸ é“ç´¢å¼•:', index);
                if (index !== -1) {
                    channels[index] = { ...channels[index], ...updates };
                    console.log('æ›´æ–°åçš„è´­ä¹°æ¸ é“:', channels);
                    const result = this.saveChannels(channels);
                    console.log('æ›´æ–°è´­ä¹°æ¸ é“ç»“æœ:', result);
                    return result;
                }
                console.error('è´­ä¹°æ¸ é“ä¸å­˜åœ¨:', id);
                return false;
            }

            // åˆ é™¤è´­ä¹°æ¸ é“
            deleteChannel(id) {
                console.log('åˆ é™¤è´­ä¹°æ¸ é“:', id);
                const channels = this.getChannels();
                console.log('åˆ é™¤å‰çš„è´­ä¹°æ¸ é“:', channels);
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const filteredChannels = channels.filter(channel => channel.id != id && channel.id.toString() !== id.toString());
                console.log('åˆ é™¤åçš„è´­ä¹°æ¸ é“:', filteredChannels);
                const result = this.saveChannels(filteredChannels);
                console.log('åˆ é™¤è´­ä¹°æ¸ é“ç»“æœ:', result);
                return result;
            }

            // è·å–è´­ä¹°æ¸ é“è¯¦æƒ…
            getChannelById(id) {
                console.log('è·å–è´­ä¹°æ¸ é“è¯¦æƒ…:', id);
                const channels = this.getChannels();
                console.log('å½“å‰è´­ä¹°æ¸ é“åˆ—è¡¨:', channels);
                // ç¡®ä¿IDæ¯”è¾ƒæ—¶ç±»å‹ä¸€è‡´ï¼ŒåŒæ—¶æ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²
                const channel = channels.find(channel => channel.id == id || channel.id.toString() === id.toString());
                console.log('æ‰¾åˆ°çš„è´­ä¹°æ¸ é“:', channel);
                return channel || null;
            }

            // è·å–è®¾ç½®
            getSettings() {
                try {
                    console.log('å¼€å§‹è·å–è®¾ç½®æ•°æ®');
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.settingsKey);
                        console.log('ä»uToolsæ•°æ®åº“è·å–åˆ°çš„è®¾ç½®æ•°æ®:', doc);
                        return doc ? doc.settings : this.memoryStorage.settings;
                    } else if (this.localStorageAvailable) {
                        const settings = localStorage.getItem(this.settingsKey);
                        console.log('ä»localStorageè·å–åˆ°çš„è®¾ç½®æ•°æ®:', settings);
                        return settings ? JSON.parse(settings) : this.memoryStorage.settings;
                    } else {
                        console.log('ä»å†…å­˜å­˜å‚¨è·å–è®¾ç½®æ•°æ®');
                        return this.memoryStorage.settings;
                    }
                } catch (error) {
                    console.error('è·å–è®¾ç½®æ•°æ®å¤±è´¥:', error);
                    return this.memoryStorage.settings;
                }
            }
            
            // ä¿å­˜è®¾ç½®
            saveSettings(settings) {
                try {
                    console.log('å¼€å§‹ä¿å­˜è®¾ç½®æ•°æ®:', settings);
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.settingsKey);
                        const putDoc = {
                            _id: this.settingsKey,
                            settings: settings
                        };
                        // åªæœ‰åœ¨æ–‡æ¡£å·²å­˜åœ¨æ—¶æ‰æ·»åŠ  _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('ä¿å­˜è®¾ç½®æ•°æ®ç»“æœ:', result);
                        if (result.error) {
                            console.error('uToolsæ•°æ®åº“ä¿å­˜å¤±è´¥:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.settingsKey, JSON.stringify(settings));
                        console.log('ä¿å­˜è®¾ç½®æ•°æ®æˆåŠŸ');
                        return true;
                    } else {
                        console.log('ä¿å­˜è®¾ç½®æ•°æ®åˆ°å†…å­˜å­˜å‚¨');
                        this.memoryStorage.settings = settings;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜è®¾ç½®æ•°æ®å¤±è´¥:', error);
                    console.log('ä¿å­˜è®¾ç½®æ•°æ®åˆ°å†…å­˜å­˜å‚¨ä½œä¸ºåå¤‡');
                    this.memoryStorage.settings = settings;
                    return true;
                }
            }
            
            // å¯¼å‡ºæ‰€æœ‰æ•°æ®
            exportData() {
                const data = {
                    items: this.getItems(),
                    categories: this.getCategories(),
                    channels: this.getChannels(),
                    settings: this.getSettings(),
                    exportTime: new Date().toISOString()
                };
                return JSON.stringify(data, null, 2);
            }

            // å¯¼å…¥æ•°æ®
            importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.items) this.saveItems(data.items);
                    if (data.categories) this.saveCategories(data.categories);
                    if (data.channels) this.saveChannels(data.channels);
                    if (data.settings) this.saveSettings(data.settings);
                    return true;
                } catch (error) {
                    console.error('å¯¼å…¥æ•°æ®å¤±è´¥:', error);
                    return false;
                }
            }
            
            // æ¸…ç©ºæ‰€æœ‰æ•°æ®
            clearAllData() {
                try {
                    console.log('å¼€å§‹æ¸…ç©ºæ‰€æœ‰æ•°æ®');
                    if (this.useUToolsDB) {
                        utools.db.remove(this.itemsKey);
                        utools.db.remove(this.categoriesKey);
                        utools.db.remove(this.settingsKey);
                        console.log('ä»uToolsæ•°æ®åº“æ¸…ç©ºæ•°æ®æˆåŠŸ');
                    } else if (this.localStorageAvailable) {
                        localStorage.removeItem(this.itemsKey);
                        localStorage.removeItem(this.categoriesKey);
                        localStorage.removeItem(this.settingsKey);
                        console.log('ä»localStorageæ¸…ç©ºæ•°æ®æˆåŠŸ');
                    }
                    
                    // æ¸…ç©ºå†…å­˜å­˜å‚¨
                    this.memoryStorage = {
                        items: [],
                        categories: [],
                        settings: {
                            theme: 'light',
                            autoBackup: false
                        }
                    };
                    console.log('ä»å†…å­˜å­˜å‚¨æ¸…ç©ºæ•°æ®æˆåŠŸ');
                    
                    return true;
                } catch (error) {
                    console.error('æ¸…ç©ºæ•°æ®å¤±è´¥:', error);
                    
                    // å³ä½¿å‡ºé”™ï¼Œä¹Ÿè¦æ¸…ç©ºå†…å­˜å­˜å‚¨
                    this.memoryStorage = {
                        items: [],
                        categories: [],
                        settings: {
                            theme: 'light',
                            autoBackup: false
                        }
                    };
                    console.log('ä»å†…å­˜å­˜å‚¨æ¸…ç©ºæ•°æ®æˆåŠŸ');
                    
                    return true;
                }
            }
        }

        // ============================================================
        // è®¢é˜…ç®¡ç†å­˜å‚¨ç±»
        // ============================================================
        class SubscriptionStorage {
            constructor() {
                this.subscriptionsKey = 'wucanglu_subscriptions';
                this.subscriptionCategoriesKey = 'wucanglu_subscription_categories';
                this.reminderLogKey = 'wucanglu_reminder_log';
                this.useUToolsDB = typeof utools !== 'undefined' && utools.db;
                this.localStorageAvailable = this.isLocalStorageAvailable();
                this.memoryStorage = {
                    subscriptions: [],
                    subscriptionCategories: [],
                    reminderLog: []
                };

                // å›¾æ ‡åº“
                this.iconLibrary = {
                    common: ['ğŸ¬', 'ğŸµ', 'ğŸ“º', 'ğŸ®', 'ğŸ“±', 'ğŸ’»', 'ğŸ”§', 'ğŸ“¦', 'ğŸ›’', 'â­', 'ğŸ’¡', 'ğŸ””'],
                    entertainment: ['ğŸ¬', 'ğŸµ', 'ğŸ¤', 'ğŸ¨', 'ğŸ“º', 'ğŸ®', 'ğŸ¯', 'ğŸª', 'ğŸ­', 'ğŸª', 'ğŸ¸', 'ğŸ¹', 'ğŸ§', 'ğŸ“»', 'ğŸ“€', 'ğŸï¸', 'ğŸŸï¸', 'ğŸ«'],
                    office: ['ğŸ’¼', 'ğŸ“Š', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ“', 'ğŸ“‚', 'ğŸ—‚ï¸', 'ğŸ“', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ“', 'ğŸ”—', 'ğŸ”’', 'ğŸ”', 'ğŸ“§', 'âœ‰ï¸', 'ğŸ“¨'],
                    education: ['ğŸ“š', 'ğŸ“–', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“', 'ğŸ«', 'âœï¸', 'ğŸ–Šï¸', 'ğŸ“', 'ğŸ”¬', 'ğŸ”­', 'ğŸŒ', 'ğŸŒ', 'ğŸŒ'],
                    tools: ['ğŸ”§', 'ğŸ”¨', 'âš™ï¸', 'ğŸ› ï¸', 'ğŸ”©', 'ğŸ”®', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’»', 'ğŸ–¥ï¸', 'ğŸ“±', 'âŒš', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“¼'],
                    finance: ['ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§', 'ğŸ¦', 'ğŸ›ï¸', 'ğŸ¨', 'ğŸ’', 'ğŸ“ˆ', 'ğŸ“‰', 'ğŸ””', 'â°', 'ğŸ“Š', 'ğŸ’¹'],
                    other: ['ğŸ ', 'ğŸ¥', 'ğŸª', 'ğŸ«', 'ğŸ¢', 'â›½', 'ğŸ…¿ï¸', 'ğŸš—', 'ğŸš•', 'ğŸšŒ', 'ğŸš‡', 'âœˆï¸', 'ğŸš€', 'âš“', 'ğŸ', 'ğŸˆ', 'ğŸ‰', 'ğŸŠ', 'ğŸ†']
                };

                // é»˜è®¤è®¢é˜…åˆ†ç±»
                this.defaultCategories = [
                    { id: 'sub_cat_1', name: 'å¨±ä¹', icon: 'ğŸ¬' },
                    { id: 'sub_cat_2', name: 'åŠå…¬', icon: 'ğŸ’¼' },
                    { id: 'sub_cat_3', name: 'æ•™è‚²', icon: 'ğŸ“š' },
                    { id: 'sub_cat_4', name: 'å·¥å…·', icon: 'ğŸ”§' },
                    { id: 'sub_cat_5', name: 'å¥åº·', icon: 'ğŸ¥' },
                    { id: 'sub_cat_6', name: 'é‡‘è', icon: 'ğŸ’°' },
                    { id: 'sub_cat_7', name: 'å…¶ä»–', icon: 'ğŸ“¦' }
                ];
            }

            // æ£€æµ‹localStorageæ˜¯å¦å¯ç”¨
            isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // åˆå§‹åŒ–é»˜è®¤æ•°æ®
            initDefaultData() {
                console.log('å¼€å§‹åˆå§‹åŒ–è®¢é˜…é»˜è®¤æ•°æ®');

                const categories = this.getSubscriptionCategories();
                console.log('å½“å‰è®¢é˜…åˆ†ç±»æ•°é‡:', categories.length);
                if (!categories.length) {
                    console.log('åˆå§‹åŒ–é»˜è®¤è®¢é˜…åˆ†ç±»');
                    this.saveSubscriptionCategories(this.defaultCategories);
                }

                console.log('åˆå§‹åŒ–è®¢é˜…é»˜è®¤æ•°æ®å®Œæˆ');
            }

            // ============================================================
            // è®¢é˜…ç®¡ç†
            // ============================================================

            getSubscriptions() {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionsKey);
                        return doc && doc.subscriptions ? doc.subscriptions : [];
                    } else if (this.localStorageAvailable) {
                        const data = localStorage.getItem(this.subscriptionsKey);
                        return data ? JSON.parse(data) : [];
                    } else {
                        return this.memoryStorage.subscriptions;
                    }
                } catch (error) {
                    console.error('è·å–è®¢é˜…æ•°æ®å¤±è´¥:', error);
                    return this.memoryStorage.subscriptions;
                }
            }

            saveSubscriptions(subscriptions) {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionsKey);
                        const putDoc = {
                            _id: this.subscriptionsKey,
                            subscriptions: subscriptions
                        };
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.subscriptionsKey, JSON.stringify(subscriptions));
                        return true;
                    } else {
                        this.memoryStorage.subscriptions = subscriptions;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜è®¢é˜…æ•°æ®å¤±è´¥:', error);
                    this.memoryStorage.subscriptions = subscriptions;
                    return true;
                }
            }

            addSubscription(subscription) {
                const subscriptions = this.getSubscriptions();
                const newSubscription = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    reminderEnabled: true,
                    reminderDays: 1,
                    currency: 'CNY',
                    ...subscription
                };

                // è®¡ç®—ä¸‹æ¬¡æ‰£è´¹æ—¥æœŸ
                newSubscription.nextBillingDate = this.calculateNextBillingDate(newSubscription);

                subscriptions.push(newSubscription);
                return this.saveSubscriptions(subscriptions) ? newSubscription : null;
            }

            updateSubscription(id, updates) {
                const subscriptions = this.getSubscriptions();
                const index = subscriptions.findIndex(s => s.id === id);
                if (index !== -1) {
                    subscriptions[index] = {
                        ...subscriptions[index],
                        ...updates,
                        updatedAt: new Date().toISOString()
                    };

                    // å¦‚æœå‘¨æœŸæˆ–æ‰£è´¹æ—¥æœŸå‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è®¡ç®—ä¸‹æ¬¡æ‰£è´¹æ—¥æœŸ
                    if (updates.cycleType !== undefined || updates.cycleValue !== undefined || updates.firstBillingDate !== undefined) {
                        subscriptions[index].nextBillingDate = this.calculateNextBillingDate(subscriptions[index]);
                    }

                    return this.saveSubscriptions(subscriptions);
                }
                return false;
            }

            deleteSubscription(id) {
                const subscriptions = this.getSubscriptions();
                const filtered = subscriptions.filter(s => s.id !== id);
                return this.saveSubscriptions(filtered);
            }

            getSubscriptionById(id) {
                const subscriptions = this.getSubscriptions();
                return subscriptions.find(s => s.id === id) || null;
            }

            // è®¡ç®—ä¸‹æ¬¡æ‰£è´¹æ—¥æœŸ
            calculateNextBillingDate(subscription) {
                if (subscription.cycleType === 'lifetime') {
                    return null;
                }

                const { firstBillingDate, cycleType, cycleValue = 1 } = subscription;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let nextDate;

                switch (cycleType) {
                    case 'day':
                        // æŒ‰å¤©æ‰£è´¹ï¼Œä¸‹æ¬¡æ‰£è´¹æ—¥æœŸå°±æ˜¯æ˜å¤©
                        nextDate = new Date(today);
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;

                    case 'week':
                        // firstBillingDate æ˜¯æ˜ŸæœŸå‡  (0-6, 0=å‘¨æ—¥)
                        const dayOfWeek = parseInt(firstBillingDate);
                        nextDate = new Date(today);
                        const currentDayOfWeek = nextDate.getDay();
                        const daysUntilBilling = (dayOfWeek - currentDayOfWeek + 7) % 7;
                        // å¦‚æœä»Šå¤©å°±æ˜¯æ‰£è´¹æ—¥ï¼Œä¸‹æ¬¡æ˜¯7å¤©å
                        if (daysUntilBilling === 0) {
                            nextDate.setDate(nextDate.getDate() + 7);
                        } else {
                            nextDate.setDate(nextDate.getDate() + daysUntilBilling);
                        }
                        break;

                    case 'month':
                        // firstBillingDate æ˜¯å‡ å· (1-31)
                        const dayOfMonth = parseInt(firstBillingDate);
                        nextDate = new Date(today);
                        nextDate.setDate(1); // è®¾ä¸ºæœ¬æœˆç¬¬ä¸€å¤©
                        nextDate.setDate(dayOfMonth);
                        // å¦‚æœè¿™ä¸ªæ—¥æœŸå·²ç»è¿‡äº†ï¼Œè®¾ä¸ºä¸‹ä¸ªæœˆ
                        if (nextDate <= today) {
                            nextDate.setMonth(nextDate.getMonth() + 1);
                            // é‡æ–°è®¾ç½®æ—¥æœŸï¼Œå› ä¸ºå¯èƒ½è·¨æœˆ
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            nextDate.setDate(Math.min(dayOfMonth, lastDayOfMonth));
                        } else {
                            // å¤„ç†æœˆä»½æ²¡æœ‰31å¤©çš„æƒ…å†µ
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            if (dayOfMonth > lastDayOfMonth) {
                                nextDate.setDate(lastDayOfMonth);
                            }
                        }
                        break;

                    case 'quarter':
                        // firstBillingDate æ˜¯å­£åº¦èµ·å§‹æœˆ-æ—¥æ ¼å¼ (å¦‚ "1-15")
                        const [qMonth, qDay] = firstBillingDate.split('-').map(Number);
                        nextDate = new Date(today);

                        // æ‰¾å‡ºç”¨æˆ·é€‰æ‹©çš„å­£åº¦æœˆä»½å±äºå“ªä¸ªå­£åº¦ï¼ˆ1æœˆ=Q1, 4æœˆ=Q2, 7æœˆ=Q3, 10æœˆ=Q4ï¼‰
                        const quarterMonths = [1, 4, 7, 10];
                        const baseQuarterIndex = quarterMonths.indexOf(qMonth);

                        // æ‰¾å‡ºå½“å‰æ—¥æœŸå¯¹åº”çš„å­£åº¦
                        const currentMonth = nextDate.getMonth() + 1; // 1-12
                        const currentQuarterIndex = Math.floor((currentMonth - 1) / 3);

                        // è®¡ç®—ä»åŸºå‡†å­£åº¦åˆ°å½“å‰å­£åº¦çš„åç§»
                        let quartersSinceBase = currentQuarterIndex - baseQuarterIndex;
                        if (quartersSinceBase < 0) {
                            quartersSinceBase += 4;
                        }

                        // è®¾ç½®ä¸‹ä¸€ä¸ªæ‰£è´¹æ—¥æœŸ
                        nextDate.setMonth(qMonth - 1, 1);
                        nextDate.setDate(qDay);

                        // å¦‚æœå½“å‰åŸºå‡†å­£åº¦çš„æ—¥æœŸå·²ç»è¿‡äº†ï¼ŒåŠ ä¸€ä¸ªå­£åº¦ï¼ˆ3ä¸ªæœˆï¼‰
                        if (nextDate <= today) {
                            nextDate.setMonth(nextDate.getMonth() + 3);
                            // é‡æ–°è®¾ç½®æ—¥æœŸï¼Œå› ä¸ºå¯èƒ½è·¨æœˆ
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            nextDate.setDate(Math.min(qDay, lastDayOfMonth));
                        } else {
                            // å¤„ç†æœˆä»½æ²¡æœ‰è¯¥æ—¥æœŸçš„æƒ…å†µï¼ˆå¦‚2æœˆ30æ—¥ï¼‰
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            if (qDay > lastDayOfMonth) {
                                nextDate.setDate(lastDayOfMonth);
                            }
                        }
                        break;

                    case 'year':
                        // firstBillingDate æ˜¯æœˆ-æ—¥æ ¼å¼ (å¦‚ "3-15")
                        const [month, day] = firstBillingDate.split('-').map(Number);
                        nextDate = new Date(today);
                        nextDate.setMonth(month - 1, 1);
                        nextDate.setDate(day);
                        if (nextDate <= today) {
                            nextDate.setFullYear(nextDate.getFullYear() + 1);
                            // é‡æ–°è®¾ç½®æ—¥æœŸï¼Œå¤„ç†é—°å¹´ç­‰æƒ…å†µ
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            nextDate.setDate(Math.min(day, lastDayOfMonth));
                        } else {
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            if (day > lastDayOfMonth) {
                                nextDate.setDate(lastDayOfMonth);
                            }
                        }
                        break;

                    default:
                        return null;
                }

                return nextDate.toISOString().split('T')[0];
            }

            // æ›´æ–°æ‰€æœ‰è®¢é˜…çš„ä¸‹æ¬¡æ‰£è´¹æ—¥æœŸ
            updateAllNextBillingDates() {
                const subscriptions = this.getSubscriptions();
                let updated = false;
                subscriptions.forEach(sub => {
                    if (sub.cycleType !== 'lifetime') {
                        const oldNextBillingDate = sub.nextBillingDate;
                        sub.nextBillingDate = this.calculateNextBillingDate(sub);
                        if (oldNextBillingDate !== sub.nextBillingDate) {
                            updated = true;
                        }
                    }
                });
                if (updated) {
                    this.saveSubscriptions(subscriptions);
                }
            }

            // ============================================================
            // è®¢é˜…åˆ†ç±»ç®¡ç†
            // ============================================================

            getSubscriptionCategories() {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionCategoriesKey);
                        return doc && doc.categories ? doc.categories : [];
                    } else if (this.localStorageAvailable) {
                        const data = localStorage.getItem(this.subscriptionCategoriesKey);
                        return data ? JSON.parse(data) : [];
                    } else {
                        return this.memoryStorage.subscriptionCategories;
                    }
                } catch (error) {
                    console.error('è·å–è®¢é˜…åˆ†ç±»æ•°æ®å¤±è´¥:', error);
                    return this.memoryStorage.subscriptionCategories;
                }
            }

            saveSubscriptionCategories(categories) {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionCategoriesKey);
                        const putDoc = {
                            _id: this.subscriptionCategoriesKey,
                            categories: categories
                        };
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.subscriptionCategoriesKey, JSON.stringify(categories));
                        return true;
                    } else {
                        this.memoryStorage.subscriptionCategories = categories;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜è®¢é˜…åˆ†ç±»æ•°æ®å¤±è´¥:', error);
                    this.memoryStorage.subscriptionCategories = categories;
                    return true;
                }
            }

            addSubscriptionCategory(category) {
                const categories = this.getSubscriptionCategories();
                const newCategory = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    createdAt: new Date().toISOString(),
                    ...category
                };
                categories.push(newCategory);
                return this.saveSubscriptionCategories(categories) ? newCategory : null;
            }

            updateSubscriptionCategory(id, updates) {
                const categories = this.getSubscriptionCategories();
                const index = categories.findIndex(c => c.id === id);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...updates };
                    return this.saveSubscriptionCategories(categories);
                }
                return false;
            }

            deleteSubscriptionCategory(id) {
                const categories = this.getSubscriptionCategories();
                const filtered = categories.filter(c => c.id !== id);
                return this.saveSubscriptionCategories(filtered);
            }

            getSubscriptionCategoryById(id) {
                const categories = this.getSubscriptionCategories();
                return categories.find(c => c.id === id) || null;
            }

            // ============================================================
            // æé†’æ—¥å¿—ç®¡ç†
            // ============================================================

            getReminderLog() {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.reminderLogKey);
                        return doc && doc.logs ? doc.logs : [];
                    } else if (this.localStorageAvailable) {
                        const data = localStorage.getItem(this.reminderLogKey);
                        return data ? JSON.parse(data) : [];
                    } else {
                        return this.memoryStorage.reminderLog;
                    }
                } catch (error) {
                    console.error('è·å–æé†’æ—¥å¿—å¤±è´¥:', error);
                    return this.memoryStorage.reminderLog;
                }
            }

            saveReminderLog(logs) {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.reminderLogKey);
                        const putDoc = {
                            _id: this.reminderLogKey,
                            logs: logs
                        };
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.reminderLogKey, JSON.stringify(logs));
                        return true;
                    } else {
                        this.memoryStorage.reminderLog = logs;
                        return true;
                    }
                } catch (error) {
                    console.error('ä¿å­˜æé†’æ—¥å¿—å¤±è´¥:', error);
                    this.memoryStorage.reminderLog = logs;
                    return true;
                }
            }

            addReminderLog(log) {
                const logs = this.getReminderLog();
                const newLog = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    ...log
                };
                logs.push(newLog);

                // æ¸…ç†3ä¸ªæœˆå‰çš„æ—§æ—¥å¿—
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const filteredLogs = logs.filter(log => {
                    return new Date(log.reminderDate) >= threeMonthsAgo;
                });

                return this.saveReminderLog(filteredLogs) ? newLog : null;
            }

            hasReminder(subscriptionId, billingDate) {
                const logs = this.getReminderLog();
                return logs.some(log =>
                    log.subscriptionId === subscriptionId &&
                    log.billingDate === billingDate &&
                    log.notified
                );
            }
        }

        // ============================================================
        // è®¢é˜…ç®¡ç†ç±»
        // ============================================================
        class SubscriptionManager {
            constructor(storage) {
                this.storage = storage;
            }

            // æ£€æŸ¥æé†’
            checkReminders() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const subscriptions = this.storage.getSubscriptions();

                subscriptions.forEach(sub => {
                    if (sub.status !== 'active' || !sub.reminderEnabled || !sub.nextBillingDate) return;

                    const nextBillingDate = new Date(sub.nextBillingDate);
                    nextBillingDate.setHours(0, 0, 0, 0);
                    const daysUntilBilling = Math.ceil((nextBillingDate - today) / (1000 * 60 * 60 * 24));

                    // æ£€æŸ¥æ˜¯å¦åœ¨æé†’èŒƒå›´å†…
                    if (daysUntilBilling <= sub.reminderDays && daysUntilBilling >= 0) {
                        // æ£€æŸ¥æ˜¯å¦å·²å‘é€è¿‡æé†’
                        const alreadyNotified = this.storage.hasReminder(sub.id, sub.nextBillingDate);

                        if (!alreadyNotified) {
                            // å‘é€é€šçŸ¥
                            const cycleText = this.getCycleText(sub.cycleType, sub.cycleValue);
                            let message = `ğŸ”” ${sub.icon || 'ğŸ“¦'} ${sub.name}\n`;
                            message += `å°†åœ¨ ${daysUntilBilling === 0 ? 'ä»Šå¤©' : daysUntilBilling + ' å¤©å'}æ‰£è´¹ Â¥${sub.price}\n`;
                            message += `å‘¨æœŸï¼š${cycleText}`;

                            if (typeof utools !== 'undefined' && utools.showNotification) {
                                utools.showNotification(message);
                            }

                            // è®°å½•æé†’æ—¥å¿—
                            this.storage.addReminderLog({
                                subscriptionId: sub.id,
                                reminderDate: today.toISOString().split('T')[0],
                                billingDate: sub.nextBillingDate,
                                notified: true,
                                notifiedAt: new Date().toISOString()
                            });
                        }
                    }
                });
            }

            // è·å–å‘¨æœŸæ–‡æœ¬
            getCycleText(cycleType, cycleValue = 1) {
                const cycleTexts = {
                    day: cycleValue === 1 ? 'æ¯å¤©' : `æ¯${cycleValue}å¤©`,
                    week: cycleValue === 1 ? 'æ¯å‘¨' : `æ¯${cycleValue}å‘¨`,
                    month: cycleValue === 1 ? 'æ¯æœˆ' : `æ¯${cycleValue}ä¸ªæœˆ`,
                    quarter: cycleValue === 1 ? 'æ¯å­£åº¦' : `æ¯${cycleValue}å­£åº¦`,
                    year: cycleValue === 1 ? 'æ¯å¹´' : `æ¯${cycleValue}å¹´`,
                    lifetime: 'ç»ˆèº«æœ‰æ•ˆ'
                };
                return cycleTexts[cycleType] || cycleType;
            }

            // è·å–æœˆåº¦æ”¯å‡º
            getMonthlyExpense(year, month) {
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');
                let total = 0;

                subscriptions.forEach(sub => {
                    if (!sub.nextBillingDate) return;
                    const nextDate = new Date(sub.nextBillingDate);
                    if (nextDate.getFullYear() === year && nextDate.getMonth() + 1 === month) {
                        total += sub.price;
                    }
                });

                return total;
            }

            // è·å–å¹´åº¦æ”¯å‡º
            getYearlyExpense(year) {
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');
                let total = 0;

                subscriptions.forEach(sub => {
                    if (sub.cycleType === 'lifetime') return;

                    // ä¼°ç®—å¹´åº¦æ”¯å‡º
                    const yearlyMultiplier = this.getYearlyMultiplier(sub.cycleType, sub.cycleValue);
                    total += sub.price * yearlyMultiplier;
                });

                return total;
            }

            // è·å–å¹´åº¦å€æ•°
            getYearlyMultiplier(cycleType, cycleValue = 1) {
                const multipliers = {
                    day: 365 / cycleValue,
                    week: 52 / cycleValue,
                    month: 12 / cycleValue,
                    quarter: 4 / cycleValue,
                    year: 1 / cycleValue,
                    lifetime: 0
                };
                return Math.round(multipliers[cycleType] * 100) / 100;
            }

            // è·å–å³å°†åˆ°æœŸçš„è®¢é˜…
            getUpcomingSubscriptions(days = 7) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const futureDate = new Date(today);
                futureDate.setDate(futureDate.getDate() + days);

                const subscriptions = this.storage.getSubscriptions().filter(sub => {
                    if (sub.status !== 'active' || !sub.nextBillingDate) return false;
                    const nextDate = new Date(sub.nextBillingDate);
                    return nextDate >= today && nextDate <= futureDate;
                });

                return subscriptions.sort((a, b) => new Date(a.nextBillingDate) - new Date(b.nextBillingDate));
            }

            // è·å–åˆ†ç±»æ”¯å‡º
            getCategoryExpenses(year, month) {
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');
                const expenses = {};

                subscriptions.forEach(sub => {
                    if (!sub.nextBillingDate) return;
                    const nextDate = new Date(sub.nextBillingDate);
                    if (nextDate.getFullYear() === year && nextDate.getMonth() + 1 === month) {
                        const category = sub.category || 'æœªåˆ†ç±»';
                        expenses[category] = (expenses[category] || 0) + sub.price;
                    }
                });

                return Object.entries(expenses).map(([category, amount]) => ({ category, amount }));
            }

            // è·å–æœˆåº¦è¶‹åŠ¿æ•°æ®ï¼ˆæœ€è¿‘12ä¸ªæœˆï¼‰
            getMonthlyTrend() {
                const trend = [];
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;

                for (let i = 11; i >= 0; i--) {
                    const date = new Date(year, month - 1 - i, 1);
                    const trendYear = date.getFullYear();
                    const trendMonth = date.getMonth() + 1;
                    trend.push({
                        year: trendYear,
                        month: trendMonth,
                        label: `${trendYear}å¹´${trendMonth}æœˆ`,
                        amount: this.getMonthlyExpense(trendYear, trendMonth)
                    });
                }

                return trend;
            }
        }

        // ============================================================
        // è®¢é˜…UIç®¡ç†ç±»
        // ============================================================
        class SubscriptionUI {
            constructor(storage, manager) {
                this.storage = storage;
                this.manager = manager;
                this.currentEditingSubscription = null;
                this.currentCalendarDate = new Date();
                this.charts = {};
            }

            // æ¸²æŸ“è®¢é˜…é¢æ¿
            renderSubscriptionPanel() {
                this.updateQuickStats();
                this.renderSubscriptionCategoryTabs();
                this.renderSubscriptionList();
                this.renderCalendar();
                this.renderCharts();
            }

            // æ›´æ–°å¿«é€Ÿç»Ÿè®¡
            updateQuickStats() {
                const today = new Date();
                const monthlyExpense = this.manager.getMonthlyExpense(today.getFullYear(), today.getMonth() + 1);
                const yearlyExpense = this.manager.getYearlyExpense(today.getFullYear());
                const upcoming = this.manager.getUpcomingSubscriptions(7);
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');

                document.getElementById('subscription-monthly-expense').textContent = `Â¥${monthlyExpense.toFixed(2)}`;
                document.getElementById('subscription-yearly-expense').textContent = `Â¥${yearlyExpense.toFixed(2)}`;
                document.getElementById('subscription-upcoming-count').textContent = `${upcoming.length}ä¸ª`;
                document.getElementById('subscription-total-count').textContent = subscriptions.length;
            }

            // æ¸²æŸ“è®¢é˜…åˆ†ç±»æ ‡ç­¾
            renderSubscriptionCategoryTabs() {
                const container = document.querySelector('.subscription-category-tabs');
                if (!container) return;

                const categories = this.storage.getSubscriptionCategories();

                // ä¿ç•™"å…¨éƒ¨"æŒ‰é’®
                const allBtn = container.querySelector('button[data-category="all"]');
                container.innerHTML = '';
                if (allBtn) container.appendChild(allBtn);
                else {
                    const btn = document.createElement('button');
                    btn.className = 'category-tab active';
                    btn.dataset.category = 'all';
                    btn.textContent = 'å…¨éƒ¨';
                    container.appendChild(btn);
                }

                categories.forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = 'category-tab';
                    btn.dataset.category = category.name;
                    btn.textContent = `${category.icon} ${category.name}`;
                    container.appendChild(btn);
                });

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                container.querySelectorAll('.category-tab').forEach(tab => {
                    tab.onclick = () => {
                        container.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.renderSubscriptionList(tab.dataset.category);
                    };
                });
            }

            // æ¸²æŸ“è®¢é˜…åˆ—è¡¨
            renderSubscriptionList(category = 'all') {
                const container = document.getElementById('subscription-list');
                if (!container) return;

                let subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');

                if (category !== 'all') {
                    subscriptions = subscriptions.filter(sub => sub.category === category);
                }

                if (subscriptions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <div class="empty-state-text">æš‚æ— è®¢é˜…</div>
                            <div class="empty-state-hint">ç‚¹å‡»å³ä¸‹è§’çš„ + æŒ‰é’®æ·»åŠ æ‚¨çš„ç¬¬ä¸€ä¸ªè®¢é˜…</div>
                        </div>
                    `;
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                container.innerHTML = subscriptions.map(sub => {
                    const nextDate = new Date(sub.nextBillingDate);
                    nextDate.setHours(0, 0, 0, 0);
                    const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                    const cycleText = this.manager.getCycleText(sub.cycleType, sub.cycleValue);

                    let billingClass = '';
                    if (daysUntil <= 1) billingClass = 'urgent';
                    else if (daysUntil <= 7) billingClass = 'soon';

                    const billingText = sub.cycleType === 'lifetime'
                        ? 'ç»ˆèº«æœ‰æ•ˆ'
                        : daysUntil === 0
                        ? 'ä»Šå¤©æ‰£è´¹'
                        : daysUntil === 1
                        ? 'æ˜å¤©æ‰£è´¹'
                        : `${daysUntil}å¤©åæ‰£è´¹`;

                    return `
                        <div class="subscription-card" data-id="${sub.id}">
                            <div class="subscription-header">
                                <div class="subscription-name">
                                    <span class="subscription-icon">${sub.icon || 'ğŸ“¦'}</span>
                                    <span>${sub.name}</span>
                                </div>
                                <div class="subscription-category">${sub.category || 'æœªåˆ†ç±»'}</div>
                            </div>
                            <div class="subscription-price">Â¥${sub.price}<span class="subscription-price-unit">/${cycleText}</span></div>
                            <div class="subscription-billing ${billingClass}">ğŸ’° ${sub.nextBillingDate || 'æ— '} (${billingText})</div>
                            <div class="subscription-actions">
                                <button class="edit" data-id="${sub.id}">ç¼–è¾‘</button>
                                <button class="delete" data-id="${sub.id}">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // æ¸²æŸ“æ—¥å†
            renderCalendar() {
                const year = this.currentCalendarDate.getFullYear();
                const month = this.currentCalendarDate.getMonth();

                // æ›´æ–°æ ‡é¢˜
                const titleEl = document.querySelector('.calendar-title');
                if (titleEl) {
                    titleEl.textContent = `${year}å¹´${month + 1}æœˆ`;
                }

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startWeekday = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // è·å–å½“æœˆæ‰£è´¹è®¢é˜…
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active' && sub.nextBillingDate);
                const billingDates = {};
                subscriptions.forEach(sub => {
                    const date = new Date(sub.nextBillingDate);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        if (!billingDates[day]) billingDates[day] = [];
                        billingDates[day].push(sub);
                    }
                });

                // ç”Ÿæˆæ—¥å†
                const container = document.getElementById('subscription-calendar-days');
                if (!container) return;

                container.innerHTML = '';

                // å¡«å……ç©ºç™½
                for (let i = 0; i < startWeekday; i++) {
                    container.innerHTML += '<div class="calendar-day empty"></div>';
                }

                // å¡«å……æ—¥æœŸ
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const isToday = currentDate.getTime() === today.getTime();
                    const hasBilling = billingDates[day] && billingDates[day].length > 0;

                    let dotsHtml = '';
                    if (hasBilling) {
                        dotsHtml = '<div class="billing-dots">';
                        billingDates[day].forEach(sub => {
                            dotsHtml += `<span class="billing-dot" title="${sub.name} - Â¥${sub.price}">${sub.icon || 'ğŸ“¦'}</span>`;
                        });
                        dotsHtml += '</div>';
                    }

                    container.innerHTML += `
                        <div class="calendar-day ${isToday ? 'today' : ''} ${hasBilling ? 'has-billing' : ''}" data-day="${day}">
                            <span class="day-number">${day}</span>
                            ${dotsHtml}
                        </div>
                    `;
                }

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                container.querySelectorAll('.calendar-day:not(.empty)').forEach(dayEl => {
                    dayEl.onclick = () => {
                        const day = parseInt(dayEl.dataset.day);
                        if (billingDates[day] && billingDates[day].length > 0) {
                            this.showBillingDateDetail(year, month, day, billingDates[day]);
                        }
                    };
                });
            }

            // æ˜¾ç¤ºæ‰£è´¹æ—¥æœŸè¯¦æƒ…
            showBillingDateDetail(year, month, day, subscriptions) {
                const modal = document.getElementById('billing-date-detail-modal');
                const titleEl = document.getElementById('billing-date-detail-title');
                const listEl = document.getElementById('billing-date-detail-list');

                titleEl.textContent = `${year}å¹´${month + 1}æœˆ${day}æ—¥ æ‰£è´¹è¯¦æƒ…`;

                listEl.innerHTML = subscriptions.map(sub => `
                    <div class="billing-detail-item">
                        <div class="billing-detail-info">
                            <div class="billing-detail-name">
                                <span>${sub.icon || 'ğŸ“¦'}</span>
                                <span>${sub.name}</span>
                            </div>
                            <div class="billing-detail-price">Â¥${sub.price} Â· ${this.manager.getCycleText(sub.cycleType, sub.cycleValue)}</div>
                        </div>
                        <div class="billing-detail-actions">
                            <button class="edit" data-id="${sub.id}">ç¼–è¾‘</button>
                        </div>
                    </div>
                `).join('');

                modal.classList.add('active');
            }

            closeBillingDateDetail() {
                const modal = document.getElementById('billing-date-detail-modal');
                modal.classList.remove('active');
            }

            // æ¸²æŸ“å›¾è¡¨
            renderCharts() {
                this.renderTimelineChart();
                this.renderCategoryChart();
            }

            // æ¸²æŸ“æœˆåº¦è¶‹åŠ¿å›¾
            renderTimelineChart() {
                const canvas = document.getElementById('subscription-timeline-chart');
                if (!canvas) return;

                const trend = this.manager.getMonthlyTrend();
                const labels = trend.map(t => t.label);
                const data = trend.map(t => t.amount);

                if (this.charts.timeline) {
                    this.charts.timeline.destroy();
                }

                this.charts.timeline = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æœˆåº¦æ”¯å‡º',
                            data: data,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => 'Â¥' + value
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // æ¸²æŸ“åˆ†ç±»å æ¯”å›¾
            renderCategoryChart() {
                const canvas = document.getElementById('subscription-category-chart');
                if (!canvas) return;

                const today = new Date();
                const expenses = this.manager.getCategoryExpenses(today.getFullYear(), today.getMonth() + 1);

                if (expenses.length === 0) {
                    // æ²¡æœ‰æ•°æ®æ—¶æ˜¾ç¤ºç©ºçŠ¶æ€
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '14px sans-serif';
                    ctx.fillStyle = '#9ca3af';
                    ctx.textAlign = 'center';
                    ctx.fillText('æœ¬æœˆæš‚æ— æ‰£è´¹', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const labels = expenses.map(e => e.category);
                const data = expenses.map(e => e.amount);
                const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#4ade80', '#fbbf24', '#f87171'];

                if (this.charts.category) {
                    this.charts.category.destroy();
                }

                this.charts.category = new Chart(canvas, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }

            // æ‰“å¼€æ·»åŠ è®¢é˜…å¯¹è¯æ¡†
            openAddSubscriptionDialog() {
                console.log('openAddSubscriptionDialog è¢«è°ƒç”¨');
                this.currentEditingSubscription = null;
                const modal = document.getElementById('subscription-modal');
                console.log('æ‰¾åˆ°è®¢é˜…æ¨¡æ€æ¡†:', !!modal);
                document.getElementById('subscription-modal-title').textContent = 'æ·»åŠ è®¢é˜…';

                // é‡ç½®è¡¨å•
                document.getElementById('subscription-name').value = '';
                document.getElementById('subscription-price').value = '';
                document.getElementById('subscription-cycle-type').value = 'month';
                document.getElementById('subscription-reminder-enabled').checked = true;
                document.getElementById('subscription-reminder-days').value = '1';
                document.getElementById('subscription-notes').value = '';
                document.getElementById('subscription-website').value = '';
                document.getElementById('subscription-icon').value = 'ğŸ¬';
                document.getElementById('subscription-icon-preview').textContent = 'ğŸ¬';

                // é‡ç½®ç»ˆèº«è®¢é˜…é€‰é¡¹
                const lifetimeIncludeDailyCheckbox = document.getElementById('lifetime-include-daily');
                const lifetimePurchaseDateInput = document.getElementById('lifetime-purchase-date');
                const lifetimePurchaseDateGroup = document.getElementById('lifetime-purchase-date-group');
                if (lifetimeIncludeDailyCheckbox) lifetimeIncludeDailyCheckbox.checked = false;
                if (lifetimePurchaseDateInput) lifetimePurchaseDateInput.value = '';
                if (lifetimePurchaseDateGroup) lifetimePurchaseDateGroup.style.display = 'none';

                // å¡«å……åˆ†ç±»é€‰é¡¹
                this.fillSubscriptionCategories();

                // æ›´æ–°æ‰£è´¹æ—¥æœŸè¾“å…¥æ–¹å¼ä¸ºé»˜è®¤çš„"æŒ‰æœˆ"
                this.updateBillingDateInput('month');

                modal.classList.add('active');
            }

            // æ‰“å¼€ç¼–è¾‘è®¢é˜…å¯¹è¯æ¡†
            openEditSubscriptionDialog(id) {
                const sub = this.subscriptionStorage.getSubscriptionById(id);
                if (!sub) return;

                this.currentEditingSubscription = sub;
                const modal = document.getElementById('subscription-modal');
                document.getElementById('subscription-modal-title').textContent = 'ç¼–è¾‘è®¢é˜…';

                // å¡«å……è¡¨å•
                document.getElementById('subscription-name').value = sub.name || '';
                document.getElementById('subscription-price').value = sub.price || '';
                const cycleType = sub.cycleType || 'month';
                document.getElementById('subscription-cycle-type').value = cycleType;
                document.getElementById('subscription-reminder-enabled').checked = sub.reminderEnabled !== false;
                document.getElementById('subscription-reminder-days').value = sub.reminderDays || 1;
                document.getElementById('subscription-notes').value = sub.notes || '';
                document.getElementById('subscription-website').value = sub.website || '';
                document.getElementById('subscription-icon').value = sub.icon || 'ğŸ¬';
                document.getElementById('subscription-icon-preview').textContent = sub.icon || 'ğŸ¬';

                // å¡«å……åˆ†ç±»é€‰é¡¹
                this.fillSubscriptionCategories();
                document.getElementById('subscription-category').value = sub.category || '';

                // æ›´æ–°æ‰£è´¹æ—¥æœŸè¾“å…¥æ–¹å¼å¹¶è®¾ç½®å€¼
                this.updateBillingDateInput(cycleType);
                if (sub.firstBillingDate) {
                    this.setBillingDateValue(cycleType, sub.firstBillingDate);
                }

                // ç»ˆèº«è®¢é˜…çš„ç‰¹æ®Šé€‰é¡¹
                if (cycleType === 'lifetime') {
                    const lifetimeIncludeDailyCheckbox = document.getElementById('lifetime-include-daily');
                    const lifetimePurchaseDateInput = document.getElementById('lifetime-purchase-date');
                    const lifetimePurchaseDateGroup = document.getElementById('lifetime-purchase-date-group');

                    lifetimeIncludeDailyCheckbox.checked = sub.lifetimeIncludeDaily || false;
                    lifetimePurchaseDateInput.value = sub.lifetimePurchaseDate || '';
                    if (sub.lifetimeIncludeDaily && sub.lifetimePurchaseDate) {
                        lifetimePurchaseDateGroup.style.display = 'block';
                    }
                }

                modal.classList.add('active');
            }

            // å¡«å……è®¢é˜…åˆ†ç±»é€‰é¡¹
            fillSubscriptionCategories() {
                const select = document.getElementById('subscription-category');
                if (!select) return;

                const categories = this.subscriptionStorage.getSubscriptionCategories();
                select.innerHTML = categories.map(cat =>
                    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
                ).join('');
            }

            // å…³é—­è®¢é˜…å¯¹è¯æ¡†
            closeSubscriptionDialog() {
                const modal = document.getElementById('subscription-modal');
                modal.classList.remove('active');
            }

            // ä¿å­˜è®¢é˜…
            saveSubscription() {
                const name = document.getElementById('subscription-name').value.trim();
                const category = document.getElementById('subscription-category').value;
                const price = parseFloat(document.getElementById('subscription-price').value);
                const cycleType = document.getElementById('subscription-cycle-type').value;
                const cycleValue = 1; // å›ºå®šä¸º1ï¼Œè¡¨ç¤ºæŒ‰é€‰æ‹©çš„å‘¨æœŸæ‰£è´¹ä¸€æ¬¡
                const firstBillingDate = this.getBillingDateValue();
                const reminderEnabled = document.getElementById('subscription-reminder-enabled').checked;
                const reminderDays = parseInt(document.getElementById('subscription-reminder-days').value) || 1;
                const notes = document.getElementById('subscription-notes').value.trim();
                const website = document.getElementById('subscription-website').value.trim();
                const icon = document.getElementById('subscription-icon').value || 'ğŸ¬';

                // ç»ˆèº«è®¢é˜…çš„ç‰¹æ®Šé€‰é¡¹
                let lifetimeIncludeDaily = false;
                let lifetimePurchaseDate = null;
                if (cycleType === 'lifetime') {
                    lifetimeIncludeDaily = document.getElementById('lifetime-include-daily').checked;
                    if (lifetimeIncludeDaily) {
                        lifetimePurchaseDate = document.getElementById('lifetime-purchase-date').value;
                        if (!lifetimePurchaseDate) {
                            alert('è¯·é€‰æ‹©è´­ä¹°æ—¥æœŸ');
                            return;
                        }
                    }
                }

                // éªŒè¯å¿…å¡«å­—æ®µ
                if (!name) {
                    alert('è¯·è¾“å…¥è®¢é˜…åç§°');
                    return;
                }
                if (!category) {
                    alert('è¯·é€‰æ‹©åˆ†ç±»');
                    return;
                }
                if (isNaN(price) || price <= 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼');
                    return;
                }
                if (cycleType !== 'lifetime' && !firstBillingDate) {
                    alert('è¯·é€‰æ‹©æ‰£è´¹æ—¥æœŸ');
                    return;
                }
                if (cycleType === 'lifetime' && lifetimeIncludeDaily && !lifetimePurchaseDate) {
                    alert('è¯·é€‰æ‹©è´­ä¹°æ—¥æœŸ');
                    return;
                }

                const data = {
                    name,
                    category,
                    price,
                    cycleType,
                    cycleValue,
                    firstBillingDate: cycleType === 'lifetime' ? null : firstBillingDate,
                    reminderEnabled,
                    reminderDays,
                    notes,
                    website,
                    icon,
                    // ç»ˆèº«è®¢é˜…çš„é¢å¤–å­—æ®µ
                    lifetimeIncludeDaily: cycleType === 'lifetime' ? lifetimeIncludeDaily : undefined,
                    lifetimePurchaseDate: cycleType === 'lifetime' ? lifetimePurchaseDate : undefined
                };

                let result;
                if (this.currentEditingSubscription) {
                    result = this.storage.updateSubscription(this.currentEditingSubscription.id, data);
                } else {
                    result = this.storage.addSubscription(data);
                }

                if (result) {
                    this.closeSubscriptionDialog();
                    this.renderSubscriptionPanel();
                    alert(this.currentEditingSubscription ? 'è®¢é˜…æ›´æ–°æˆåŠŸï¼' : 'è®¢é˜…æ·»åŠ æˆåŠŸï¼');
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            }

            // åˆ é™¤è®¢é˜…
            deleteSubscription(id) {
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                    const result = this.storage.deleteSubscription(id);
                    if (result) {
                        this.renderSubscriptionPanel();
                        alert('è®¢é˜…åˆ é™¤æˆåŠŸï¼');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    }
                }
            }

            // ============================================================
            // æ‰£è´¹æ—¥æœŸå¤„ç†
            // ============================================================

            // åˆå§‹åŒ–æ‰£è´¹æ—¥æœŸé€‰é¡¹
            initBillingDateOptions() {
                try {
                    // åˆå§‹åŒ–æœˆä»½é€‰é¡¹
                    const monthSelect = document.getElementById('subscription-month');
                    if (monthSelect) {
                        const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
                        monthSelect.innerHTML = months.map((m, i) => `<option value="${i + 1}">${m}</option>`).join('');
                    }

                    // åˆå§‹åŒ–æ—¥æœŸé€‰é¡¹ï¼ˆ1-31æ—¥ï¼‰
                    const dayOfMonthSelect = document.getElementById('subscription-day-of-month');
                    if (dayOfMonthSelect) {
                        dayOfMonthSelect.innerHTML = Array.from({ length: 31 }, (_, i) =>
                            `<option value="${i + 1}">${i + 1}å·</option>`
                        ).join('');
                    }

                    // åˆå§‹åŒ–å­£åº¦æ—¥æœŸé€‰é¡¹ï¼ˆ1-31æ—¥ï¼‰
                    const quarterDaySelect = document.getElementById('subscription-quarter-day');
                    if (quarterDaySelect) {
                        quarterDaySelect.innerHTML = Array.from({ length: 31 }, (_, i) =>
                            `<option value="${i + 1}">${i + 1}æ—¥</option>`
                        ).join('');
                    }

                    // åˆå§‹åŒ–å¹´åº¦æ—¥æœŸé€‰é¡¹ï¼ˆ1-31æ—¥ï¼‰
                    const dayOfYearSelect = document.getElementById('subscription-day-of-year-day');
                    if (dayOfYearSelect) {
                        dayOfYearSelect.innerHTML = Array.from({ length: 31 }, (_, i) =>
                            `<option value="${i + 1}">${i + 1}æ—¥</option>`
                        ).join('');
                    }

                    // é»˜è®¤æ˜¾ç¤ºæŒ‰æœˆçš„è¾“å…¥æ–¹å¼
                    this.updateBillingDateInput('month');
                } catch (error) {
                    console.error('åˆå§‹åŒ–æ‰£è´¹æ—¥æœŸé€‰é¡¹å¤±è´¥:', error);
                }
            }

            // æ ¹æ®å‘¨æœŸç±»å‹æ›´æ–°æ‰£è´¹æ—¥æœŸè¾“å…¥æ–¹å¼
            updateBillingDateInput(cycleType) {
                const label = document.getElementById('billing-date-label');
                const hint = document.getElementById('billing-date-hint');
                const dayOfWeek = document.getElementById('billing-day-of-week');
                const dayOfMonth = document.getElementById('billing-day-of-month');
                const dayOfQuarter = document.getElementById('billing-day-of-quarter');
                const dayOfYear = document.getElementById('billing-day-of-year');
                const dayHint = document.getElementById('billing-day-hint');
                const lifetimeOptionsGroup = document.getElementById('lifetime-options-group');

                // éšè—æ‰€æœ‰é€‰é¡¹
                if (dayOfWeek) dayOfWeek.style.display = 'none';
                if (dayOfMonth) dayOfMonth.style.display = 'none';
                if (dayOfQuarter) dayOfQuarter.style.display = 'none';
                if (dayOfYear) dayOfYear.style.display = 'none';
                if (dayHint) dayHint.style.display = 'none';
                if (lifetimeOptionsGroup) lifetimeOptionsGroup.style.display = 'none';

                switch (cycleType) {
                    case 'day':
                        if (label) label.innerHTML = 'æ‰£è´¹æ—¥æœŸ';
                        if (hint) hint.textContent = 'æ¯å¤©æ‰£è´¹ï¼Œç³»ç»Ÿå°†ä»ä»Šå¤©å¼€å§‹æ¯å¤©è®¡ç®—';
                        if (dayHint) dayHint.style.display = 'block';
                        break;
                    case 'week':
                        if (label) label.innerHTML = 'æ‰£è´¹æ—¥æœŸï¼ˆæ˜ŸæœŸå‡ ï¼‰ <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = 'é€‰æ‹©æ¯å‘¨å‡ æ‰£è´¹';
                        if (dayOfWeek) dayOfWeek.style.display = 'block';
                        break;
                    case 'month':
                        if (label) label.innerHTML = 'æ‰£è´¹æ—¥æœŸï¼ˆå‡ å·ï¼‰ <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = 'é€‰æ‹©æ¯æœˆå‡ å·æ‰£è´¹';
                        if (dayOfMonth) dayOfMonth.style.display = 'block';
                        break;
                    case 'quarter':
                        if (label) label.innerHTML = 'æ‰£è´¹æ—¥æœŸï¼ˆå­£åº¦èµ·å§‹æœˆ-æ—¥ï¼‰ <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = 'é€‰æ‹©å­£åº¦ä¸­çš„èµ·å§‹æœˆä»½å’Œæ—¥æœŸï¼Œç³»ç»Ÿä¼šåœ¨æ¯å­£åº¦ï¼ˆæ¯3ä¸ªæœˆï¼‰çš„è¯¥æ—¥æœŸæ‰£è´¹';
                        if (dayOfQuarter) dayOfQuarter.style.display = 'block';
                        break;
                    case 'year':
                        if (label) label.innerHTML = 'æ‰£è´¹æ—¥æœŸï¼ˆæœˆ-æ—¥ï¼‰ <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = 'é€‰æ‹©æ¯å¹´å‡ æœˆå‡ æ—¥æ‰£è´¹';
                        if (dayOfYear) dayOfYear.style.display = 'block';
                        break;
                    case 'lifetime':
                        if (label) label.innerHTML = 'æ‰£è´¹æ—¥æœŸ';
                        if (hint) hint.textContent = 'ç»ˆèº«æœ‰æ•ˆï¼Œæ— éœ€æ‰£è´¹';
                        if (dayHint) {
                            dayHint.style.display = 'block';
                            dayHint.querySelector('div').textContent = 'ç»ˆèº«æœ‰æ•ˆï¼Œæ— éœ€æ‰£è´¹';
                        }
                        // æ˜¾ç¤ºç»ˆèº«è®¢é˜…é€‰é¡¹
                        if (lifetimeOptionsGroup) lifetimeOptionsGroup.style.display = 'block';
                        break;
                    default:
                        // å…¶ä»–å‘¨æœŸç±»å‹ä¸æ˜¾ç¤ºç»ˆèº«è®¢é˜…é€‰é¡¹
                        break;
                }
            }

            // è·å–æ‰£è´¹æ—¥æœŸå€¼ï¼ˆæ ¹æ®å½“å‰é€‰æ‹©çš„å‘¨æœŸç±»å‹ï¼‰
            getBillingDateValue() {
                const cycleType = document.getElementById('subscription-cycle-type').value;

                switch (cycleType) {
                    case 'day':
                        return new Date().toISOString().split('T')[0]; // æŒ‰å¤©ï¼Œè¿”å›ä»Šå¤©
                    case 'week':
                        return document.getElementById('subscription-day-of-week').value;
                    case 'month':
                        return document.getElementById('subscription-day-of-month').value;
                    case 'quarter':
                        const qMonth = document.getElementById('subscription-quarter-month').value;
                        const qDay = document.getElementById('subscription-quarter-day').value;
                        return `${qMonth}-${qDay}`;
                    case 'year':
                        const month = document.getElementById('subscription-month').value;
                        const day = document.getElementById('subscription-day-of-year-day').value;
                        return `${month}-${day}`;
                    default:
                        return '';
                }
            }

            // è®¾ç½®æ‰£è´¹æ—¥æœŸå€¼ï¼ˆç”¨äºç¼–è¾‘è®¢é˜…ï¼‰
            setBillingDateValue(cycleType, firstBillingDate) {
                switch (cycleType) {
                    case 'week':
                        document.getElementById('subscription-day-of-week').value = firstBillingDate;
                        break;
                    case 'month':
                        document.getElementById('subscription-day-of-month').value = firstBillingDate;
                        break;
                    case 'quarter':
                        const [qMonth, qDay] = firstBillingDate.split('-');
                        document.getElementById('subscription-quarter-month').value = qMonth;
                        document.getElementById('subscription-quarter-day').value = qDay;
                        break;
                    case 'year':
                        const [month, day] = firstBillingDate.split('-');
                        document.getElementById('subscription-month').value = month;
                        document.getElementById('subscription-day-of-year-day').value = day;
                        break;
                }
            }

            // ============================================================
            // å›¾æ ‡é€‰æ‹©å™¨
            // ============================================================

            openIconPicker() {
                const modal = document.getElementById('icon-picker-modal');
                modal.classList.add('active');
                this.renderIconPickerIcons('common');
            }

            closeIconPicker() {
                const modal = document.getElementById('icon-picker-modal');
                modal.classList.remove('active');
            }

            renderIconPickerIcons(category) {
                const container = document.getElementById('icon-picker-icons');
                if (!container) return;

                const icons = this.storage.iconLibrary[category] || this.storage.iconLibrary.common;

                container.innerHTML = icons.map(icon => `
                    <div class="icon-picker-icon" data-icon="${icon}">${icon}</div>
                `).join('');

                // ç»‘å®šç‚¹å‡»äº‹ä»¶
                container.querySelectorAll('.icon-picker-icon').forEach(iconEl => {
                    iconEl.onclick = () => {
                        const icon = iconEl.dataset.icon;
                        document.getElementById('subscription-icon').value = icon;
                        document.getElementById('subscription-icon-preview').textContent = icon;

                        container.querySelectorAll('.icon-picker-icon').forEach(i => i.classList.remove('selected'));
                        iconEl.classList.add('selected');

                        this.closeIconPicker();
                    };
                });
            }

            // ============================================================
            // è®¢é˜…åˆ†ç±»ç®¡ç†
            // ============================================================

            openSubscriptionCategoryManageModal() {
                const modal = document.getElementById('subscription-category-manage-modal');
                modal.classList.add('active');
                this.renderSubscriptionCategoryManageList();
            }

            closeSubscriptionCategoryManageModal() {
                const modal = document.getElementById('subscription-category-manage-modal');
                modal.classList.remove('active');
            }

            renderSubscriptionCategoryManageList() {
                const container = document.getElementById('subscription-category-manage-list');
                if (!container) return;

                const categories = this.storage.getSubscriptionCategories();

                container.innerHTML = categories.map(cat => `
                    <div class="manage-item">
                        <div class="manage-item-name">${cat.icon} ${cat.name}</div>
                        <div class="manage-item-actions">
                            <button class="edit" data-id="${cat.id}">ç¼–è¾‘</button>
                            <button class="delete" data-id="${cat.id}">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            }

            addSubscriptionCategoryInModal() {
                const name = prompt('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼š');
                if (!name || !name.trim()) return;

                const icons = Object.values(this.storage.iconLibrary).flat();
                const randomIcon = icons[Math.floor(Math.random() * icons.length)];

                const result = this.storage.addSubscriptionCategory({
                    name: name.trim(),
                    icon: randomIcon
                });

                if (result) {
                    this.renderSubscriptionCategoryManageList();
                    this.renderSubscriptionCategoryTabs();
                    alert('åˆ†ç±»æ·»åŠ æˆåŠŸï¼');
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            }

            editSubscriptionCategoryInModal(id) {
                const cat = this.storage.getSubscriptionCategoryById(id);
                if (!cat) return;

                const name = prompt('è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°ï¼š', cat.name);
                if (name === null || !name.trim()) return;

                const result = this.storage.updateSubscriptionCategory(id, {
                    name: name.trim()
                });

                if (result) {
                    this.renderSubscriptionCategoryManageList();
                    this.renderSubscriptionCategoryTabs();
                    this.renderSubscriptionList();
                    alert('åˆ†ç±»æ›´æ–°æˆåŠŸï¼');
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            }

            deleteSubscriptionCategoryInModal(id) {
                const cat = this.storage.getSubscriptionCategoryById(id);
                if (!cat) return;

                if (confirm(`ç¡®å®šè¦åˆ é™¤åˆ†ç±»"${cat.name}"å—ï¼Ÿ`)) {
                    const result = this.storage.deleteSubscriptionCategory(id);
                    if (result) {
                        this.renderSubscriptionCategoryManageList();
                        this.renderSubscriptionCategoryTabs();
                        alert('åˆ†ç±»åˆ é™¤æˆåŠŸï¼');
                    } else {
                        alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                    }
                }
            }
        }

        // ============================================================
        // åº”ç”¨ç®¡ç†
        // ============================================================
        class App {
            constructor() {
                this.storage = new Storage();
                this.subscriptionStorage = new SubscriptionStorage();
                this.subscriptionManager = new SubscriptionManager(this.subscriptionStorage);
                this.subscriptionUI = new SubscriptionUI(this.subscriptionStorage, this.subscriptionManager);
                this.currentEditingItem = null;
                this.dialogCallback = null;
                this.currentDraggedItemId = null; // å½“å‰æ‹–æ‹½çš„ç‰©å“ID
                this.currentDropTarget = null; // å½“å‰æ‹–æ‹½ç›®æ ‡ID
                this.tempReorderedItems = null; // ä¸´æ—¶æ’åºçš„ç‰©å“æ•°æ®
                this.lastPreviewTarget = null; // ä¸Šä¸€æ¬¡é¢„è§ˆçš„ç›®æ ‡ID
                this.orderSaved = false; // æ ‡è®°æ˜¯å¦å·²ä¿å­˜æ’åº
                this.currentLayout = 'grid'; // å½“å‰å¸ƒå±€æ¨¡å¼
                this.currentTheme = null; // å½“å‰ä¸»é¢˜
                this.charts = {}; // å­˜å‚¨å›¾è¡¨å®ä¾‹
                
                // é¢„è®¾ä¸»é¢˜
                this.themePresets = {
                    default: {
                        name: 'é»˜è®¤è“',
                        primary: '#4361ee',
                        secondary: '#3f37c9',
                        accent: '#4cc9f0',
                        background: '#ffffff',
                        backgroundSecondary: '#f9fafb'
                    },
                    purple: {
                        name: 'ä¼˜é›…ç´«',
                        primary: '#9333ea',
                        secondary: '#7c3aed',
                        accent: '#c084fc',
                        background: '#ffffff',
                        backgroundSecondary: '#faf5ff'
                    },
                    green: {
                        name: 'æ¸…æ–°ç»¿',
                        primary: '#10b981',
                        secondary: '#059669',
                        accent: '#34d399',
                        background: '#ffffff',
                        backgroundSecondary: '#f0fdf4'
                    },
                    orange: {
                        name: 'æ´»åŠ›æ©™',
                        primary: '#f59e0b',
                        secondary: '#d97706',
                        accent: '#fbbf24',
                        background: '#ffffff',
                        backgroundSecondary: '#fffbeb'
                    },
                    pink: {
                        name: 'ç”œç¾ç²‰',
                        primary: '#ec4899',
                        secondary: '#db2777',
                        accent: '#f472b6',
                        background: '#ffffff',
                        backgroundSecondary: '#fdf2f8'
                    },
                    dark: {
                        name: 'æš—å¤œé»‘',
                        primary: '#60a5fa',
                        secondary: '#3b82f6',
                        accent: '#93c5fd',
                        background: '#1f2937',
                        backgroundSecondary: '#111827'
                    }
                };
                
                // åŠ è½½è‡ªå®šä¹‰ä¸»é¢˜
                const customThemes = JSON.parse(localStorage.getItem('wucanglu_custom_themes') || '{}');
                Object.assign(this.themePresets, customThemes);
            }
            
            // æ˜¾ç¤ºæç¤ºä¿¡æ¯
            showToast(message, type = 'info') {
                // åˆ›å»ºæç¤ºå…ƒç´ 
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                // æ·»åŠ æ ·å¼
                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.padding = '12px 20px';
                toast.style.borderRadius = '8px';
                toast.style.color = '#fff';
                toast.style.fontSize = '14px';
                toast.style.fontWeight = '500';
                toast.style.zIndex = '9999';
                toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                toast.style.transition = 'all 0.3s ease';
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                
                // æ ¹æ®ç±»å‹è®¾ç½®èƒŒæ™¯è‰²
                switch (type) {
                    case 'success':
                        toast.style.backgroundColor = '#52c41a';
                        break;
                    case 'error':
                        toast.style.backgroundColor = '#f5222d';
                        break;
                    case 'warning':
                        toast.style.backgroundColor = '#faad14';
                        break;
                    default:
                        toast.style.backgroundColor = '#1890ff';
                }
                
                // æ·»åŠ åˆ°é¡µé¢
                document.body.appendChild(toast);
                
                // æ˜¾ç¤ºæç¤º
                setTimeout(() => {
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateX(0)';
                }, 10);
                
                // 3ç§’åéšè—æç¤º
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // åˆå§‹åŒ–
            init() {
                console.log('å¼€å§‹åˆå§‹åŒ–åº”ç”¨');

                // è®¾ç½®é»˜è®¤çš„æ´»åŠ¨æ ‡ç­¾é¡µ
                document.body.setAttribute('data-active-tab', 'items');

                // åˆå§‹åŒ–æŒ‰é’®æ˜¾ç¤ºçŠ¶æ€ï¼ˆé»˜è®¤æ˜¾ç¤ºæ·»åŠ ç‰©å“æŒ‰é’®ï¼‰
                const addItemBtn = document.getElementById('add-item-btn');
                const addSubscriptionBtn = document.getElementById('add-subscription-btn');
                if (addItemBtn) addItemBtn.style.display = 'flex';
                if (addSubscriptionBtn) addSubscriptionBtn.style.display = 'none';

                // åˆå§‹åŒ–é»˜è®¤æ•°æ®
                console.log('åˆå§‹åŒ–é»˜è®¤æ•°æ®');
                this.storage.initDefaultData();

                // åˆå§‹åŒ–è®¢é˜…é»˜è®¤æ•°æ®
                console.log('åˆå§‹åŒ–è®¢é˜…é»˜è®¤æ•°æ®');
                this.subscriptionStorage.initDefaultData();

                // æ›´æ–°è®¢é˜…çš„ä¸‹æ¬¡æ‰£è´¹æ—¥æœŸ
                this.subscriptionStorage.updateAllNextBillingDates();

                // æ£€æŸ¥è®¢é˜…æé†’
                this.subscriptionManager.checkReminders();

                // æ¸²æŸ“ç•Œé¢
                console.log('æ¸²æŸ“åˆ†ç±»æ ‡ç­¾');
                this.renderCategoryTabs();
                console.log('æ¸²æŸ“ç‰©å“åˆ—è¡¨');
                this.renderItems();
                console.log('æ›´æ–°ç‰©å“ç»Ÿè®¡ä¿¡æ¯');
                this.updateItemStats();
                console.log('æ¸²æŸ“åˆ†ç±»åˆ—è¡¨');
                this.renderCategories();
                console.log('æ¸²æŸ“è´­ä¹°æ¸ é“åˆ—è¡¨');
                this.renderChannels();
                console.log('åˆå§‹åŒ–è´­ä¹°æ¸ é“é€‰æ‹©æ¡†');
                this.initChannelSelects();

                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                console.log('æ›´æ–°ç»Ÿè®¡ä¿¡æ¯');
                this.updateStats();

                // ç»‘å®šäº‹ä»¶
                console.log('ç»‘å®šäº‹ä»¶');
                this.bindEvents();

                // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
                console.log('ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶');
                this.bindDialogEvents();

                // ç»‘å®šè®¢é˜…ç›¸å…³äº‹ä»¶
                console.log('ç»‘å®šè®¢é˜…ç›¸å…³äº‹ä»¶');
                this.bindSubscriptionEvents();

                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            }
            
            // æ¸²æŸ“æ•°æ®åˆ†æ
            renderAnalytics() {
                const items = this.storage.getItems();
                const categories = this.storage.getCategories();
                
                // è®¡ç®—ç»Ÿè®¡æ•°æ®
                const totalItems = items.length;
                const totalValue = items.reduce((sum, item) => sum + (item.price || 0), 0);
                const avgPrice = totalItems > 0 ? totalValue / totalItems : 0;
                
                // è®¡ç®—å¹³å‡æŒæœ‰å¤©æ•°å’Œæ€»æ—¥å‡æˆæœ¬
                let totalDays = 0;
                let totalDailyCost = 0;
                items.forEach(item => {
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    if (purchaseDate) {
                        const now = new Date();
                        const purchased = new Date(purchaseDate);
                        const days = Math.ceil((now - purchased) / (1000 * 60 * 60 * 24));
                        totalDays += days;

                        // è®¡ç®—æ—¥å‡æˆæœ¬
                        const price = item.price || 0;
                        if (price > 0 && days > 0) {
                            totalDailyCost += price / days;
                        }
                    }
                });
                const avgDays = totalItems > 0 ? Math.round(totalDays / totalItems) : 0;
                
                // æ‰¾å‡ºæœ€è´µçš„ç‰©å“
                const mostExpensive = items.reduce((max, item) => {
                    return (item.price || 0) > (max.price || 0) ? item : max;
                }, { name: '-', price: 0 });
                
                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                const statsElements = {
                    'analytics-total-items': totalItems,
                    'analytics-total-value': `Â¥${totalValue.toFixed(0)}`,
                    'analytics-avg-price': `Â¥${avgPrice.toFixed(0)}`,
                    'analytics-avg-days': `${avgDays}å¤©`,
                    'analytics-total-daily-cost': `Â¥${totalDailyCost.toFixed(2)}/å¤©`
                };
                
                Object.keys(statsElements).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = statsElements[id];
                });
                
                // é”€æ¯æ—§å›¾è¡¨
                if (this.charts) {
                    Object.values(this.charts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                }
                this.charts = {};
                
                // æ¸²æŸ“æ‰€æœ‰å›¾è¡¨
                this.renderCategoryPieChart(items, categories);
                this.renderPriceBarChart(items);
                this.renderTimelineChart(items);
                this.renderSeasonalChart(items);
                this.renderDurationChart(items);
                this.renderDailyValueChart(items);
                this.renderCategoryValueChart(items, categories);
                this.renderScatterChart(items);
                this.renderRadarChart(items, categories);
                this.renderSpendingChart(items);
                
                // æ¸²æŸ“TOPæ¦œå•
                this.renderTopLists(items);
            }
            
            // åˆ†ç±»åˆ†å¸ƒé¥¼å›¾
            renderCategoryPieChart(items, categories) {
                const ctx = document.getElementById('category-chart');
                if (!ctx) return;
                
                // ç»Ÿè®¡æ¯ä¸ªåˆ†ç±»çš„ç‰©å“æ•°é‡
                const categoryCount = {};
                categories.forEach(cat => {
                    categoryCount[cat.name] = 0;
                });
                
                items.forEach(item => {
                    if (categoryCount.hasOwnProperty(item.category)) {
                        categoryCount[item.category]++;
                    }
                });
                
                const labels = Object.keys(categoryCount);
                const data = Object.values(categoryCount);
                
                const colors = [
                    '#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#7209b7',
                    '#560bad', '#b5179e', '#f72585', '#4895ef', '#4cc9f0'
                ];
                
                this.charts.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value}ä»¶ (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // ä»·æ ¼åŒºé—´åˆ†å¸ƒæŸ±çŠ¶å›¾
            renderPriceBarChart(items) {
                const ctx = document.getElementById('price-chart');
                if (!ctx) return;
                
                // å®šä¹‰ä»·æ ¼åŒºé—´
                const ranges = [
                    { label: '0-100', min: 0, max: 100 },
                    { label: '100-500', min: 100, max: 500 },
                    { label: '500-1000', min: 500, max: 1000 },
                    { label: '1000-3000', min: 1000, max: 3000 },
                    { label: '3000-5000', min: 3000, max: 5000 },
                    { label: '5000+', min: 5000, max: Infinity }
                ];
                
                const counts = ranges.map(range => {
                    return items.filter(item => {
                        const price = item.price || 0;
                        return price >= range.min && price < range.max;
                    }).length;
                });
                
                this.charts.priceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ranges.map(r => r.label),
                        datasets: [{
                            label: 'ç‰©å“æ•°é‡',
                            data: counts,
                            backgroundColor: 'rgba(67, 97, 238, 0.8)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æ•°é‡: ${context.parsed.y}ä»¶`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
            
            // è´­ä¹°æ—¶é—´è¶‹åŠ¿å›¾
            renderTimelineChart(items) {
                const ctx = document.getElementById('timeline-chart');
                if (!ctx) return;
                
                // æŒ‰æœˆä»½ç»Ÿè®¡
                const monthlyData = {};
                items.forEach(item => {
                    const date = item.purchaseDate || item.createdAt;
                    if (date) {
                        const month = date.substring(0, 7); // YYYY-MM
                        monthlyData[month] = (monthlyData[month] || 0) + 1;
                    }
                });
                
                // æ’åºå¹¶å–æœ€è¿‘12ä¸ªæœˆ
                const sortedMonths = Object.keys(monthlyData).sort();
                const recentMonths = sortedMonths.slice(-12);
                const counts = recentMonths.map(month => monthlyData[month]);
                
                this.charts.timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: recentMonths,
                        datasets: [{
                            label: 'è´­ä¹°æ•°é‡',
                            data: counts,
                            borderColor: 'rgba(76, 201, 240, 1)',
                            backgroundColor: 'rgba(76, 201, 240, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `è´­ä¹°: ${context.parsed.y}ä»¶`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
            
            // æ—¥å‡ä»·å€¼æ’è¡Œ
            renderDailyValueChart(items) {
                const ctx = document.getElementById('daily-value-chart');
                if (!ctx) return;
                
                // è®¡ç®—æ¯ä¸ªç‰©å“çš„æ—¥å‡ä»·å€¼
                const itemsWithDailyValue = items.map(item => {
                    const price = item.price || 0;
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    let dailyValue = 0;
                    
                    if (price > 0 && purchaseDate) {
                        const now = new Date();
                        const purchased = new Date(purchaseDate);
                        const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                        dailyValue = price / days;
                    }
                    
                    return {
                        name: item.name,
                        dailyValue: dailyValue
                    };
                }).filter(item => item.dailyValue > 0)
                  .sort((a, b) => b.dailyValue - a.dailyValue)
                  .slice(0, 10);
                
                const labels = itemsWithDailyValue.map(item => item.name.length > 10 ? item.name.substring(0, 10) + '...' : item.name);
                const data = itemsWithDailyValue.map(item => item.dailyValue);
                
                this.charts.dailyValueChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ—¥å‡ä»·å€¼',
                            data: data,
                            backgroundColor: 'rgba(124, 58, 237, 0.8)',
                            borderColor: 'rgba(124, 58, 237, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æ—¥å‡: Â¥${context.parsed.x.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // åˆ†ç±»ä»·å€¼å¯¹æ¯”
            renderCategoryValueChart(items, categories) {
                const ctx = document.getElementById('category-value-chart');
                if (!ctx) return;
                
                // ç»Ÿè®¡æ¯ä¸ªåˆ†ç±»çš„æ€»ä»·å€¼
                const categoryValue = {};
                categories.forEach(cat => {
                    categoryValue[cat.name] = 0;
                });
                
                items.forEach(item => {
                    if (categoryValue.hasOwnProperty(item.category)) {
                        categoryValue[item.category] += (item.price || 0);
                    }
                });
                
                const labels = Object.keys(categoryValue);
                const data = Object.values(categoryValue);
                
                this.charts.categoryValueChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ€»ä»·å€¼',
                            data: data,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æ€»ä»·å€¼: Â¥${context.parsed.y.toFixed(0)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // å­£èŠ‚æ€§è´­ä¹°åˆ†æ
            renderSeasonalChart(items) {
                const ctx = document.getElementById('seasonal-chart');
                if (!ctx) return;
                
                const seasons = { 'æ˜¥å­£': 0, 'å¤å­£': 0, 'ç§‹å­£': 0, 'å†¬å­£': 0 };
                
                items.forEach(item => {
                    const date = item.purchaseDate || item.createdAt;
                    if (date) {
                        const month = new Date(date).getMonth() + 1;
                        if (month >= 3 && month <= 5) seasons['æ˜¥å­£']++;
                        else if (month >= 6 && month <= 8) seasons['å¤å­£']++;
                        else if (month >= 9 && month <= 11) seasons['ç§‹å­£']++;
                        else seasons['å†¬å­£']++;
                    }
                });
                
                this.charts.seasonalChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: Object.keys(seasons),
                        datasets: [{
                            data: Object.values(seasons),
                            backgroundColor: [
                                'rgba(76, 201, 240, 0.7)',
                                'rgba(245, 87, 108, 0.7)',
                                'rgba(245, 159, 0, 0.7)',
                                'rgba(96, 165, 250, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // æŒæœ‰æ—¶é•¿åˆ†å¸ƒ
            renderDurationChart(items) {
                const ctx = document.getElementById('duration-chart');
                if (!ctx) return;
                
                const ranges = [
                    { label: '< 1ä¸ªæœˆ', min: 0, max: 30 },
                    { label: '1-3ä¸ªæœˆ', min: 30, max: 90 },
                    { label: '3-6ä¸ªæœˆ', min: 90, max: 180 },
                    { label: '6-12ä¸ªæœˆ', min: 180, max: 365 },
                    { label: '1-2å¹´', min: 365, max: 730 },
                    { label: '> 2å¹´', min: 730, max: Infinity }
                ];
                
                const counts = ranges.map(range => {
                    return items.filter(item => {
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        if (!purchaseDate) return false;
                        const days = Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24));
                        return days >= range.min && days < range.max;
                    }).length;
                });
                
                this.charts.durationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ranges.map(r => r.label),
                        datasets: [{
                            label: 'ç‰©å“æ•°é‡',
                            data: counts,
                            backgroundColor: 'rgba(147, 51, 234, 0.8)',
                            borderColor: 'rgba(147, 51, 234, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
            
            // ä»·æ ¼ä¸æŒæœ‰æ—¶é•¿æ•£ç‚¹å›¾
            renderScatterChart(items) {
                const ctx = document.getElementById('scatter-chart');
                if (!ctx) return;
                
                const data = items.map(item => {
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    const days = purchaseDate ? Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24)) : 0;
                    return {
                        x: days,
                        y: item.price || 0
                    };
                }).filter(d => d.x > 0 && d.y > 0);
                
                this.charts.scatterChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: 'ç‰©å“',
                            data: data,
                            backgroundColor: 'rgba(67, 97, 238, 0.6)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æŒæœ‰${context.parsed.x}å¤©, ä»·æ ¼Â¥${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: 'æŒæœ‰å¤©æ•°' },
                                beginAtZero: true
                            },
                            y: {
                                title: { display: true, text: 'ä»·æ ¼ï¼ˆå…ƒï¼‰' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // åˆ†ç±»é›·è¾¾å›¾
            renderRadarChart(items, categories) {
                const ctx = document.getElementById('radar-chart');
                if (!ctx) return;
                
                const categoryStats = {};
                categories.forEach(cat => {
                    categoryStats[cat.name] = { count: 0, value: 0, avgDays: 0, totalDays: 0 };
                });
                
                items.forEach(item => {
                    if (categoryStats[item.category]) {
                        categoryStats[item.category].count++;
                        categoryStats[item.category].value += (item.price || 0);
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        if (purchaseDate) {
                            const days = Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24));
                            categoryStats[item.category].totalDays += days;
                        }
                    }
                });
                
                // è®¡ç®—å¹³å‡å€¼å¹¶å½’ä¸€åŒ–
                const labels = Object.keys(categoryStats).slice(0, 6); // æœ€å¤š6ä¸ªåˆ†ç±»
                const countData = labels.map(cat => categoryStats[cat].count);
                const valueData = labels.map(cat => categoryStats[cat].value / 100); // ç¼©æ”¾
                const avgDaysData = labels.map(cat => {
                    return categoryStats[cat].count > 0 ? categoryStats[cat].totalDays / categoryStats[cat].count / 10 : 0;
                });
                
                this.charts.radarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'æ•°é‡',
                                data: countData,
                                borderColor: 'rgba(67, 97, 238, 1)',
                                backgroundColor: 'rgba(67, 97, 238, 0.2)',
                                borderWidth: 2
                            },
                            {
                                label: 'ä»·å€¼(Ã·100)',
                                data: valueData,
                                borderColor: 'rgba(245, 87, 108, 1)',
                                backgroundColor: 'rgba(245, 87, 108, 0.2)',
                                borderWidth: 2
                            },
                            {
                                label: 'å¹³å‡æŒæœ‰(Ã·10å¤©)',
                                data: avgDaysData,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            r: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // æœˆåº¦æ”¯å‡ºè¶‹åŠ¿
            renderSpendingChart(items) {
                const ctx = document.getElementById('spending-chart');
                if (!ctx) return;
                
                const monthlySpending = {};
                items.forEach(item => {
                    const date = item.purchaseDate || item.createdAt;
                    if (date) {
                        const month = date.substring(0, 7);
                        monthlySpending[month] = (monthlySpending[month] || 0) + (item.price || 0);
                    }
                });
                
                const sortedMonths = Object.keys(monthlySpending).sort().slice(-12);
                const spending = sortedMonths.map(month => monthlySpending[month]);
                
                this.charts.spendingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: 'æ”¯å‡ºé‡‘é¢',
                            data: spending,
                            borderColor: 'rgba(245, 87, 108, 1)',
                            backgroundColor: 'rgba(245, 87, 108, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `æ”¯å‡º: Â¥${context.parsed.y.toFixed(0)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // æ¸²æŸ“TOPæ¦œå•
            renderTopLists(items) {
                // æœ€è´µç‰©å“TOP5
                const topExpensive = [...items]
                    .sort((a, b) => (b.price || 0) - (a.price || 0))
                    .slice(0, 5);
                
                const expensiveList = document.getElementById('top-expensive-list');
                if (expensiveList) {
                    expensiveList.innerHTML = topExpensive.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${item.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">Â¥${(item.price || 0).toFixed(0)}</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">æš‚æ— æ•°æ®</div>';
                }
                
                // æœ€å€¼ç‰©å“TOP5ï¼ˆæ—¥å‡ä»·å€¼æœ€ä½ï¼‰
                const itemsWithDailyValue = items
                    .map(item => {
                        const price = item.price || 0;
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        let dailyValue = price;

                        if (price > 0 && purchaseDate) {
                            const days = Math.max(1, Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24)));
                            dailyValue = price / days;
                        }

                        return { ...item, dailyValue };
                    })
                    .filter(item => item.price > 0);
                
                const topValue = [...itemsWithDailyValue]
                    .sort((a, b) => a.dailyValue - b.dailyValue)
                    .slice(0, 5);
                
                const valueList = document.getElementById('top-value-list');
                if (valueList) {
                    valueList.innerHTML = topValue.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">æ—¥å‡Â¥${item.dailyValue.toFixed(2)}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--success-color);">Â¥${(item.price || 0).toFixed(0)}</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">æš‚æ— æ•°æ®</div>';
                }
                
                // æ—¥å‡æˆæœ¬æœ€é«˜TOP5
                const topDailyCost = [...itemsWithDailyValue]
                    .sort((a, b) => b.dailyValue - a.dailyValue)
                    .slice(0, 5);
                
                const dailyCostList = document.getElementById('top-daily-cost-list');
                if (dailyCostList) {
                    dailyCostList.innerHTML = topDailyCost.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">æ—¥å‡Â¥${item.dailyValue.toFixed(2)}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--danger-color);">Â¥${(item.price || 0).toFixed(0)}</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">æš‚æ— æ•°æ®</div>';
                }
                
                // æŒæœ‰æœ€ä¹…TOP5
                const itemsWithDays = items.map(item => {
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    const days = purchaseDate ? Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24)) : 0;
                    return { ...item, days };
                }).filter(item => item.days > 0);
                
                const topOldest = [...itemsWithDays]
                    .sort((a, b) => b.days - a.days)
                    .slice(0, 5);
                
                const oldestList = document.getElementById('top-oldest-list');
                if (oldestList) {
                    oldestList.innerHTML = topOldest.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${item.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--accent-color);">${item.days}å¤©</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">æš‚æ— æ•°æ®</div>';
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateStats() {
                const items = this.storage.getItems();

                // è®¡ç®—ç‰©å“æ€»æ•°
                const totalItems = items.length;

                // è®¡ç®—æ€»èµ„äº§ï¼ˆä»…åŒ…å«ç‰©å“ï¼Œä¸åŒ…å«è®¢é˜…ï¼‰
                const totalAssets = items.reduce((sum, item) => sum + (item.price || 0), 0);

                // è®¡ç®—æ—¥å‡æˆæœ¬ï¼ˆåŒ…å«ç‰©å“å’Œè®¢é˜…ï¼‰
                let totalDailyCost = 0;

                // 1. è®¡ç®—ç‰©å“çš„æ—¥å‡æˆæœ¬
                items.forEach(item => {
                    const price = item.price || 0;
                    if (price > 0) {
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        if (purchaseDate) {
                            const now = new Date();
                            const purchased = new Date(purchaseDate);
                            const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                            totalDailyCost += price / days;
                        }
                    }
                });

                // 2. è®¡ç®—è®¢é˜…çš„æ—¥å‡æˆæœ¬
                const subscriptions = this.subscriptionStorage.getSubscriptions();
                subscriptions.forEach(sub => {
                    // åªè®¡ç®—æ´»è·ƒçŠ¶æ€çš„è®¢é˜…
                    if (sub.status === 'active') {
                        const price = sub.price || 0;
                        if (price > 0) {
                            const cycleType = sub.cycleType;

                            // ç»ˆèº«è®¢é˜…
                            if (cycleType === 'lifetime') {
                                // åªæœ‰å‹¾é€‰äº†"è®¡å…¥æ—¥å‡æˆæœ¬"ä¸”æœ‰è´­ä¹°æ—¥æœŸæ—¶æ‰è®¡ç®—
                                if (sub.lifetimeIncludeDaily && sub.lifetimePurchaseDate) {
                                    const now = new Date();
                                    const purchased = new Date(sub.lifetimePurchaseDate);
                                    const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                                    totalDailyCost += price / days;
                                }
                            } else {
                                // å‘¨æœŸæ€§è®¢é˜…ï¼šæ ¹æ®å‘¨æœŸè®¡ç®—æ—¥å‡æˆæœ¬
                                const daysPerCycle = this.getDaysPerCycle(cycleType);
                                if (daysPerCycle > 0) {
                                    totalDailyCost += price / daysPerCycle;
                                }
                            }
                        }
                    }
                });
                
                // æ›´æ–°DOM
                const totalItemsElement = document.getElementById('total-items-count');
                const totalAssetsElement = document.getElementById('total-assets');
                const dailyAverageElement = document.getElementById('daily-average');
                const avgPriceElement = document.getElementById('avg-price');
                
                if (totalItemsElement) {
                    totalItemsElement.textContent = totalItems;
                }
                
                if (totalAssetsElement) {
                    totalAssetsElement.textContent = `Â¥${totalAssets.toFixed(2)}`;
                }
                
                if (dailyAverageElement) {
                    dailyAverageElement.textContent = `Â¥${totalDailyCost.toFixed(2)}/å¤©`;
                }
                
                if (avgPriceElement) {
                    const avgPrice = totalItems > 0 ? totalAssets / totalItems : 0;
                    avgPriceElement.textContent = `Â¥${avgPrice.toFixed(2)}`;
                }
                
                // æ›´æ–°"æˆ‘çš„"é¡µé¢çš„ç»Ÿè®¡å¡ç‰‡
                const statsItemsElement = document.getElementById('stats-total-items');
                const statsAssetsElement = document.getElementById('stats-total-assets');
                const statsCategoriesElement = document.getElementById('stats-total-categories');
                const statsDailyElement = document.getElementById('stats-daily-average');
                
                if (statsItemsElement) {
                    statsItemsElement.textContent = totalItems;
                }
                
                if (statsAssetsElement) {
                    statsAssetsElement.textContent = `Â¥${Math.round(totalAssets)}`;
                }
                
                if (statsCategoriesElement) {
                    const categories = this.storage.getCategories();
                    statsCategoriesElement.textContent = categories.length;
                }
                
                if (statsDailyElement) {
                    statsDailyElement.textContent = `Â¥${totalDailyCost.toFixed(2)}`;
                }
            }

            // æ ¹æ®è®¢é˜…å‘¨æœŸç±»å‹è·å–å¤©æ•°ï¼ˆç”¨äºè®¡ç®—æ—¥å‡æˆæœ¬ï¼‰
            getDaysPerCycle(cycleType) {
                const cycleDaysMap = {
                    'day': 1,      // æŒ‰å¤©ï¼š1å¤©
                    'week': 7,     // æŒ‰å‘¨ï¼š7å¤©
                    'month': 30,   // æŒ‰æœˆï¼š30å¤©
                    'quarter': 90, // æŒ‰å­£ï¼š90å¤©
                    'year': 365,   // æŒ‰å¹´ï¼š365å¤©
                    'lifetime': 0  // ç»ˆèº«ï¼šç‰¹æ®Šå¤„ç†ï¼Œä¸åœ¨æ­¤è®¡ç®—
                };
                return cycleDaysMap[cycleType] || 0;
            }

            // ç»‘å®šå¯¹è¯æ¡†äº‹ä»¶
            bindDialogEvents() {
                const dialogCancel = document.getElementById('dialog-cancel');
                const dialogConfirm = document.getElementById('dialog-confirm');
                const customDialog = document.getElementById('custom-dialog');
                
                if (dialogCancel) {
                    dialogCancel.addEventListener('click', () => {
                        const callback = this.dialogCallback;
                        this.hideDialog();
                        if (callback) {
                            callback(false, '');
                        }
                    });
                }
                
                if (dialogConfirm) {
                    dialogConfirm.addEventListener('click', () => {
                        const input = document.getElementById('dialog-input');
                        const value = input && input.style.display !== 'none' ? input.value : '';
                        const callback = this.dialogCallback;
                        this.hideDialog();
                        if (callback) {
                            callback(true, value);
                        }
                    });
                }
                
                // ç‚¹å‡»å¯¹è¯æ¡†å¤–éƒ¨å…³é—­
                if (customDialog) {
                    customDialog.addEventListener('click', (e) => {
                        // åªæœ‰ç‚¹å‡»å¯¹è¯æ¡†èƒŒæ™¯ï¼ˆä¸æ˜¯å†…å®¹åŒºåŸŸï¼‰æ—¶æ‰è§¦å‘
                        if (e.target === customDialog) {
                            const callback = this.dialogCallback;
                            this.hideDialog();
                            if (callback) {
                                callback(false, '');
                            }
                        }
                    });
                }
            }
            
            // æ˜¾ç¤ºå¯¹è¯æ¡†
            showDialog(title, message, type = 'confirm', defaultValue = '') {
                console.log('å¼€å§‹æ˜¾ç¤ºå¯¹è¯æ¡†:', title, message, type, defaultValue);
                const dialog = document.getElementById('custom-dialog');
                console.log('æ‰¾åˆ°dialogå…ƒç´ :', !!dialog);
                const dialogTitle = document.getElementById('dialog-title');
                console.log('æ‰¾åˆ°dialogTitleå…ƒç´ :', !!dialogTitle);
                const dialogMessage = document.getElementById('dialog-message');
                console.log('æ‰¾åˆ°dialogMessageå…ƒç´ :', !!dialogMessage);
                const dialogInput = document.getElementById('dialog-input');
                console.log('æ‰¾åˆ°dialogInputå…ƒç´ :', !!dialogInput);
                
                if (!dialog || !dialogTitle || !dialogMessage || !dialogInput) {
                    console.error('å¯¹è¯æ¡†å…ƒç´ ä¸å­˜åœ¨');
                    return;
                }
                
                console.log('è®¾ç½®å¯¹è¯æ¡†æ ‡é¢˜å’Œæ¶ˆæ¯');
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                
                if (type === 'input') {
                    console.log('æ˜¾ç¤ºè¾“å…¥æ¡†');
                    dialogInput.style.display = 'block';
                    dialogInput.value = defaultValue;
                    dialogInput.focus();
                } else {
                    console.log('éšè—è¾“å…¥æ¡†');
                    dialogInput.style.display = 'none';
                }
                
                console.log('æ˜¾ç¤ºå¯¹è¯æ¡†');
                dialog.style.display = 'flex';
                console.log('å¯¹è¯æ¡†æ˜¾ç¤ºå®Œæˆ');
            }
            
            // éšè—å¯¹è¯æ¡†
            hideDialog() {
                const dialog = document.getElementById('custom-dialog');
                const dialogInput = document.getElementById('dialog-input');
                
                if (dialog) {
                    dialog.style.display = 'none';
                }
                
                if (dialogInput) {
                    dialogInput.value = '';
                }
                
                this.dialogCallback = null;
            }
            
            // ç¡®è®¤å¯¹è¯æ¡†
            confirm(title, message, callback) {
                this.dialogCallback = callback;
                this.showDialog(title, message, 'confirm');
            }
            
            // è¾“å…¥å¯¹è¯æ¡†
            prompt(title, message, defaultValue, callback) {
                this.dialogCallback = callback;
                this.showDialog(title, message, 'input', defaultValue);
            }

            // ç»‘å®šè®¢é˜…ç›¸å…³äº‹ä»¶
            bindSubscriptionEvents() {
                console.log('å¼€å§‹ç»‘å®šè®¢é˜…ç›¸å…³äº‹ä»¶');

                // è®¢é˜…åˆ—è¡¨äº‹ä»¶å§”æ‰˜ï¼ˆç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼‰
                const subscriptionList = document.getElementById('subscription-list');
                if (subscriptionList) {
                    subscriptionList.addEventListener('click', (e) => {
                        const editBtn = e.target.closest('.subscription-actions .edit');
                        const deleteBtn = e.target.closest('.subscription-actions .delete');

                        if (editBtn) {
                            const id = editBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.openEditSubscriptionDialog(id);
                            }
                        }

                        if (deleteBtn) {
                            const id = deleteBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.deleteSubscription(id);
                            }
                        }
                    });
                }

                // è®¢é˜…åˆ†ç±»åˆ—è¡¨äº‹ä»¶å§”æ‰˜ï¼ˆç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®ï¼‰
                const subCategoryList = document.getElementById('subscription-category-manage-list');
                if (subCategoryList) {
                    subCategoryList.addEventListener('click', (e) => {
                        const editBtn = e.target.closest('.manage-item-actions .edit');
                        const deleteBtn = e.target.closest('.manage-item-actions .delete');

                        if (editBtn) {
                            const id = editBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.editSubscriptionCategoryInModal(id);
                            }
                        }

                        if (deleteBtn) {
                            const id = deleteBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.deleteSubscriptionCategoryInModal(id);
                            }
                        }
                    });
                }

                // æ·»åŠ è®¢é˜…æŒ‰é’®
                const addSubscriptionBtn = document.getElementById('add-subscription-btn');
                console.log('æŸ¥æ‰¾æ·»åŠ è®¢é˜…æŒ‰é’®:', addSubscriptionBtn);
                if (addSubscriptionBtn) {
                    const styles = window.getComputedStyle(addSubscriptionBtn);
                    console.log('æ·»åŠ è®¢é˜…æŒ‰é’®æ ·å¼:', {
                        display: styles.display,
                        position: styles.position,
                        zIndex: styles.zIndex,
                        pointerEvents: styles.pointerEvents,
                        visibility: styles.visibility,
                        opacity: styles.opacity
                    });
                    console.log('body data-active-tab:', document.body.getAttribute('data-active-tab'));

                    addSubscriptionBtn.addEventListener('click', (e) => {
                        console.log('æ·»åŠ è®¢é˜…æŒ‰é’®è¢«ç‚¹å‡»');
                        console.log('event:', e);
                        console.log('subscriptionUI:', this.subscriptionUI);
                        console.log('openAddSubscriptionDialog:', typeof this.subscriptionUI.openAddSubscriptionDialog);
                        e.preventDefault();
                        e.stopPropagation();
                        this.subscriptionUI.openAddSubscriptionDialog();
                    });
                    console.log('æ·»åŠ è®¢é˜…æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
                } else {
                    console.error('æœªæ‰¾åˆ°æ·»åŠ è®¢é˜…æŒ‰é’®');
                }

                // è®¢é˜…æ¨¡æ€æ¡†
                const cancelSubscriptionBtn = document.getElementById('cancel-subscription');
                const saveSubscriptionBtn = document.getElementById('save-subscription');
                const subscriptionModal = document.getElementById('subscription-modal');

                if (cancelSubscriptionBtn) {
                    cancelSubscriptionBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeSubscriptionDialog();
                    });
                }

                if (saveSubscriptionBtn) {
                    saveSubscriptionBtn.addEventListener('click', () => {
                        this.subscriptionUI.saveSubscription();
                    });
                }

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                if (subscriptionModal) {
                    subscriptionModal.addEventListener('click', (e) => {
                        if (e.target === subscriptionModal) {
                            this.subscriptionUI.closeSubscriptionDialog();
                        }
                    });
                }

                // åˆå§‹åŒ–æ‰£è´¹æ—¥æœŸé€‰é¡¹
                this.subscriptionUI.initBillingDateOptions();

                // å‘¨æœŸç±»å‹å˜åŒ–æ—¶åˆ‡æ¢æ‰£è´¹æ—¥æœŸè¾“å…¥æ–¹å¼
                const cycleTypeSelect = document.getElementById('subscription-cycle-type');
                const firstBillingDateGroup = document.getElementById('first-billing-date-group');

                if (cycleTypeSelect) {
                    cycleTypeSelect.addEventListener('change', () => {
                        this.subscriptionUI.updateBillingDateInput(cycleTypeSelect.value);
                        if (cycleTypeSelect.value === 'lifetime') {
                            firstBillingDateGroup.style.display = 'none';
                        } else {
                            firstBillingDateGroup.style.display = 'block';
                        }
                    });
                }

                // ç»ˆèº«è®¢é˜…"è®¡å…¥æ—¥å‡æˆæœ¬"å¤é€‰æ¡†äº‹ä»¶
                const lifetimeIncludeDailyCheckbox = document.getElementById('lifetime-include-daily');
                const lifetimePurchaseDateGroup = document.getElementById('lifetime-purchase-date-group');
                if (lifetimeIncludeDailyCheckbox && lifetimePurchaseDateGroup) {
                    lifetimeIncludeDailyCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            lifetimePurchaseDateGroup.style.display = 'block';
                        } else {
                            lifetimePurchaseDateGroup.style.display = 'none';
                        }
                    });
                }

                // å›¾æ ‡é€‰æ‹©å™¨
                const iconPickerBtn = document.getElementById('subscription-icon-picker-btn');
                const closeIconPickerBtn = document.getElementById('close-icon-picker');
                const iconPickerModal = document.getElementById('icon-picker-modal');

                if (iconPickerBtn) {
                    iconPickerBtn.addEventListener('click', () => {
                        this.subscriptionUI.openIconPicker();
                    });
                }

                if (closeIconPickerBtn) {
                    closeIconPickerBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeIconPicker();
                    });
                }

                // å›¾æ ‡åˆ†ç±»æ ‡ç­¾åˆ‡æ¢
                const iconCategoryTabs = document.querySelectorAll('.icon-category-tab');
                iconCategoryTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        iconCategoryTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.subscriptionUI.renderIconPickerIcons(tab.dataset.category);
                    });
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                if (iconPickerModal) {
                    iconPickerModal.addEventListener('click', (e) => {
                        if (e.target === iconPickerModal) {
                            this.subscriptionUI.closeIconPicker();
                        }
                    });
                }

                // è®¢é˜…åˆ†ç±»ç®¡ç†
                const manageSubCategoriesBtn = document.getElementById('manage-subscription-categories-btn');
                const closeSubCategoryModalBtn = document.getElementById('close-subscription-category-modal');
                const addSubCategoryInModalBtn = document.getElementById('add-subscription-category-in-modal');
                const subCategoryModal = document.getElementById('subscription-category-manage-modal');

                if (manageSubCategoriesBtn) {
                    manageSubCategoriesBtn.addEventListener('click', () => {
                        this.subscriptionUI.openSubscriptionCategoryManageModal();
                    });
                }

                if (closeSubCategoryModalBtn) {
                    closeSubCategoryModalBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeSubscriptionCategoryManageModal();
                    });
                }

                if (addSubCategoryInModalBtn) {
                    addSubCategoryInModalBtn.addEventListener('click', () => {
                        this.subscriptionUI.addSubscriptionCategoryInModal();
                    });
                }

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                if (subCategoryModal) {
                    subCategoryModal.addEventListener('click', (e) => {
                        if (e.target === subCategoryModal) {
                            this.subscriptionUI.closeSubscriptionCategoryManageModal();
                        }
                    });
                }

                // æ‰£è´¹æ—¥æœŸè¯¦æƒ…å¼¹çª—
                const closeBillingDetailBtn = document.getElementById('close-billing-date-detail');
                const billingDetailModal = document.getElementById('billing-date-detail-modal');
                const billingDetailList = document.getElementById('billing-date-detail-list');

                if (closeBillingDetailBtn) {
                    closeBillingDetailBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeBillingDateDetail();
                    });
                }

                // æ‰£è´¹æ—¥æœŸè¯¦æƒ…åˆ—è¡¨äº‹ä»¶å§”æ‰˜ï¼ˆç¼–è¾‘æŒ‰é’®ï¼‰
                if (billingDetailList) {
                    billingDetailList.addEventListener('click', (e) => {
                        const editBtn = e.target.closest('.billing-detail-actions .edit');
                        if (editBtn) {
                            const id = editBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.closeBillingDateDetail();
                                this.subscriptionUI.openEditSubscriptionDialog(id);
                            }
                        }
                    });
                }

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                if (billingDetailModal) {
                    billingDetailModal.addEventListener('click', (e) => {
                        if (e.target === billingDetailModal) {
                            this.subscriptionUI.closeBillingDateDetail();
                        }
                    });
                }

                // æ—¥å†å¯¼èˆª
                const calendarNavBtns = document.querySelectorAll('.calendar-nav-btn');
                calendarNavBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const direction = btn.dataset.direction;
                        const currentDate = this.subscriptionUI.currentCalendarDate;
                        if (direction === 'prev') {
                            currentDate.setMonth(currentDate.getMonth() - 1);
                        } else {
                            currentDate.setMonth(currentDate.getMonth() + 1);
                        }
                        this.subscriptionUI.renderCalendar();
                    });
                });

                // uTools å¯åŠ¨æ—¶æ£€æŸ¥æé†’
                if (typeof utools !== 'undefined' && utools.onPluginEnter) {
                    utools.onPluginEnter(() => {
                        this.subscriptionStorage.updateAllNextBillingDates();
                        this.subscriptionManager.checkReminders();
                    });
                }
            }

            // æ¸²æŸ“åˆ†ç±»æ ‡ç­¾
            renderCategoryTabs() {
                const categoryTabsContainer = document.querySelector('.category-tabs');
                if (!categoryTabsContainer) return;
                
                // ä¿ç•™"å…¨éƒ¨"æ ‡ç­¾ï¼Œç§»é™¤å…¶ä»–æ ‡ç­¾
                const allTab = categoryTabsContainer.querySelector('[data-category="all"]');
                categoryTabsContainer.innerHTML = '';
                categoryTabsContainer.appendChild(allTab);
                
                // è·å–æ‰€æœ‰åˆ†ç±»
                const categories = this.storage.getCategories();
                categories.forEach(category => {
                    const tab = document.createElement('button');
                    tab.className = 'category-tab';
                    tab.dataset.category = category.name;
                    tab.textContent = category.name;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    tab.addEventListener('click', () => {
                        // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        
                        // æŒ‰åˆ†ç±»ç­›é€‰ç‰©å“
                        this.renderItems(category.name);
                    });
                    
                    categoryTabsContainer.appendChild(tab);
                });
                
                // ä¸º"å…¨éƒ¨"æ ‡ç­¾æ·»åŠ ç‚¹å‡»äº‹ä»¶
                allTab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    allTab.classList.add('active');
                    this.renderItems();
                });
            }

            // æ›´æ–°ç‰©å“å¿«é€Ÿç»Ÿè®¡
            updateItemStats() {
                const items = this.storage.getItems();
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0-11

                // ç‰©å“æ€»æ•°
                const totalCount = items.length;

                // æœ¬æœˆæ–°å¢
                const monthlyNew = items.filter(item => {
                    if (!item.createdAt) return false;
                    const createdDate = new Date(item.createdAt);
                    return createdDate.getFullYear() === currentYear && createdDate.getMonth() === currentMonth;
                }).length;

                // å¹´åº¦æ–°å¢
                const yearlyNew = items.filter(item => {
                    if (!item.createdAt) return false;
                    const createdDate = new Date(item.createdAt);
                    return createdDate.getFullYear() === currentYear;
                }).length;

                // æ€»ä»·å€¼
                const totalValue = items.reduce((sum, item) => sum + (item.price || 0), 0);

                // æ›´æ–°DOM
                document.getElementById('item-total-count').textContent = totalCount;
                document.getElementById('item-monthly-new').textContent = monthlyNew;
                document.getElementById('item-yearly-new').textContent = yearlyNew;
                document.getElementById('item-total-value').textContent = `Â¥${totalValue.toFixed(0)}`;
            }

            // æ¸²æŸ“ç‰©å“åˆ—è¡¨
            renderItems(category = 'all') {
                const itemList = document.getElementById('item-list');
                if (!itemList) return;
                
                // æ¸…ç©ºç‰©å“åˆ—è¡¨
                itemList.innerHTML = '';
                
                // è·å–æ‰€æœ‰ç‰©å“ - å¦‚æœæœ‰ä¸´æ—¶æ’åºæ•°æ®åˆ™ä½¿ç”¨ä¸´æ—¶æ•°æ®
                const allItems = this.tempReorderedItems || this.storage.getItems();
                
                // æŒ‰åˆ†ç±»ç­›é€‰
                let filteredItems = allItems;
                if (category !== 'all') {
                    filteredItems = allItems.filter(item => item.category === category);
                }
                
                // å¦‚æœæ²¡æœ‰ç‰©å“ï¼Œæ˜¾ç¤ºæç¤º
                if (filteredItems.length === 0) {
                    itemList.innerHTML = '<div style="text-align: center; padding: 40px 0; color: #999;">æš‚æ— ç‰©å“</div>';
                    return;
                }
                
                // ä¸ºæ¯ä¸ªç‰©å“åˆ›å»ºå¡ç‰‡
                filteredItems.forEach((item, index) => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';
                    itemCard.draggable = true;
                    itemCard.dataset.itemId = item.id;
                    itemCard.dataset.originalIndex = index;
                    
                    // è®¡ç®—ä½¿ç”¨å¤©æ•°
                    let daysUsed = 0;
                    if (item.purchaseDate) {
                        const now = new Date();
                        const purchaseDate = new Date(item.purchaseDate);
                        daysUsed = Math.max(0, Math.ceil((now - purchaseDate) / (1000 * 60 * 60 * 24)));
                    }
                    
                    // è®¾ç½®å¡ç‰‡å†…å®¹
                    itemCard.innerHTML = `
                        <div class="item-header">
                            <div class="item-name">${item.name}</div>
                            <div class="item-days">å·²ä½¿ç”¨ ${daysUsed} å¤©</div>
                        </div>
                        <div class="item-category">${item.category}</div>
                        ${item.desc ? `<div class="item-desc">${item.desc}</div>` : ''}
                        ${item.purchaseChannel ? `<div class="item-desc" style="color: #6b7280; font-size: 12px;">è´­ä¹°æ¸ é“: ${item.purchaseChannel}</div>` : ''}
                        <div class="item-footer">
                            <div class="item-price">Â¥${item.price?.toFixed(2) || '0.00'}<span class="item-price-unit">å…ƒ</span></div>
                        </div>
                    `;
                    
                    // æ·»åŠ ç‚¹å‡»åŠ¨ç”»æ•ˆæœ
                    itemCard.addEventListener('click', () => {
                        itemCard.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            itemCard.style.transform = '';
                            this.showItemDetail(item);
                        }, 100);
                    });
                    
                    // æ·»åŠ æ‹–æ‹½äº‹ä»¶ç›‘å¬å™¨
                    itemCard.addEventListener('dragstart', (e) => {
                        // å­˜å‚¨æ‹–æ‹½ç‰©å“çš„ID
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', item.id.toString());
                        // å­˜å‚¨åˆ°å…¨å±€å˜é‡
                        this.currentDraggedItemId = item.id.toString();
                        // æ·»åŠ æ‹–æ‹½çŠ¶æ€æ ·å¼
                        itemCard.classList.add('dragging');
                    });
                    
                    // å…è®¸æ”¾ç½® - å®æ—¶æ˜¾ç¤ºæŒ¤å¼€æ•ˆæœ
                    itemCard.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        
                        // è®°å½•å½“å‰æ‚¬åœçš„ç›®æ ‡
                        const draggedItemId = this.currentDraggedItemId;
                        if (draggedItemId && draggedItemId !== item.id.toString()) {
                            this.currentDropTarget = item.id.toString();
                            // å®æ—¶è§†è§‰é¢„è§ˆï¼ˆä¸æ”¹å˜DOMç»“æ„ï¼‰
                            this.visualPreview(draggedItemId, item.id.toString());
                        }
                    });
                    
                    // å¤„ç†æ”¾ç½®äº‹ä»¶ - ç¡®è®¤æ’åº
                    itemCard.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('=== Drop event triggered ===');
                        
                        // ä½¿ç”¨å…¨å±€å˜é‡è·å–æ‹–æ‹½çš„ç‰©å“ID
                        const draggedItemId = this.currentDraggedItemId;
                        const targetItemId = item.id.toString();
                        console.log('draggedItemId:', draggedItemId, 'targetItemId:', targetItemId);
                        
                        if (draggedItemId && draggedItemId !== targetItemId) {
                            // ç›´æ¥é‡æ–°æ’åºå¹¶ä¿å­˜
                            const items = [...this.storage.getItems()];
                            console.log('Current items:', items.map(i => i.name));
                            
                            const draggedIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                            const targetIndex = items.findIndex(item => item.id.toString() === targetItemId);
                            console.log('draggedIndex:', draggedIndex, 'targetIndex:', targetIndex);
                            
                            if (draggedIndex !== -1 && targetIndex !== -1) {
                                const [draggedItem] = items.splice(draggedIndex, 1);
                                items.splice(targetIndex, 0, draggedItem);
                                console.log('New order:', items.map(i => i.name));
                                
                                // ä¿å­˜æ–°é¡ºåº
                                const result = this.storage.saveItems(items);
                                console.log('Save result:', result);
                                
                                if (result) {
                                    this.orderSaved = true;
                                    console.log('Order saved successfully!');
                                    
                                    // æ¸…ç©ºä¸´æ—¶æ•°æ®
                                    this.tempReorderedItems = null;
                                    
                                    // æ¸…ç†æ‰€æœ‰transformæ ·å¼
                                    const allCards = document.querySelectorAll('.item-card');
                                    allCards.forEach(card => {
                                        card.style.transform = '';
                                        card.style.transition = '';
                                    });
                                    
                                    // é‡æ–°æ¸²æŸ“
                                    const activeTab = document.querySelector('.category-tab.active');
                                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                                    console.log('Re-rendering with category:', currentCategory);
                                    this.renderItems(currentCategory);
                                } else {
                                    console.error('Failed to save items!');
                                }
                            }
                        }
                    });
                    
                    // æ‹–æ‹½ç»“æŸ
                    itemCard.addEventListener('dragend', () => {
                        console.log('Dragend event');
                        console.log('orderSaved:', this.orderSaved);
                        console.log('currentDropTarget:', this.currentDropTarget);
                        
                        // ç§»é™¤æ‹–æ‹½çŠ¶æ€æ ·å¼
                        itemCard.classList.remove('dragging');
                        
                        // å¦‚æœæ²¡æœ‰é€šè¿‡dropä¿å­˜ï¼Œä½†æœ‰è®°å½•çš„ç›®æ ‡ä½ç½®ï¼Œåˆ™åœ¨è¿™é‡Œä¿å­˜
                        if (!this.orderSaved && this.currentDropTarget && this.currentDraggedItemId) {
                            const draggedItemId = this.currentDraggedItemId;
                            const targetItemId = this.currentDropTarget;
                            
                            console.log('Saving from dragend - draggedId:', draggedItemId, 'targetId:', targetItemId);
                            
                            if (draggedItemId !== targetItemId) {
                                // é‡æ–°æ’åºå¹¶ä¿å­˜
                                const items = [...this.storage.getItems()];
                                const draggedIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                                const targetIndex = items.findIndex(item => item.id.toString() === targetItemId);
                                
                                if (draggedIndex !== -1 && targetIndex !== -1) {
                                    const [draggedItem] = items.splice(draggedIndex, 1);
                                    items.splice(targetIndex, 0, draggedItem);
                                    
                                    // ä¿å­˜æ–°é¡ºåº
                                    const result = this.storage.saveItems(items);
                                    console.log('Save from dragend result:', result);
                                    
                                    if (result) {
                                        // æ¸…ç©ºä¸´æ—¶æ•°æ®
                                        this.tempReorderedItems = null;
                                    }
                                }
                            }
                        }
                        
                        // æ¸…ç†æ‰€æœ‰transformæ ·å¼
                        const allCards = document.querySelectorAll('.item-card');
                        allCards.forEach(card => {
                            card.style.transform = '';
                            card.style.transition = '';
                        });
                        
                        // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæœ€ç»ˆçŠ¶æ€
                        const activeTab = document.querySelector('.category-tab.active');
                        const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                        this.renderItems(currentCategory);
                        
                        // æ¸…ç†çŠ¶æ€
                        this.currentDraggedItemId = null;
                        this.currentDropTarget = null;
                        this.lastPreviewTarget = null;
                        this.orderSaved = false;
                    });
                    
                    // æ·»åŠ åˆ°ç‰©å“åˆ—è¡¨
                    itemList.appendChild(itemCard);
                });
            }
            
            // è§†è§‰é¢„è§ˆï¼ˆåªç”¨CSS transformï¼Œä¸æ”¹å˜DOMï¼‰
            visualPreview(draggedItemId, targetItemId) {
                // å¦‚æœç›®æ ‡æ²¡å˜ï¼Œä¸éœ€è¦é‡æ–°è®¡ç®—
                if (this.lastPreviewTarget === targetItemId) {
                    return;
                }
                
                // ç«‹å³æ›´æ–°ç›®æ ‡
                this.lastPreviewTarget = targetItemId;
                
                const itemList = document.getElementById('item-list');
                if (!itemList) return;
                
                const allCards = Array.from(itemList.querySelectorAll('.item-card'));
                const draggedCard = allCards.find(card => card.dataset.itemId === draggedItemId);
                const targetCard = allCards.find(card => card.dataset.itemId === targetItemId);
                
                if (!draggedCard || !targetCard) return;
                
                const draggedIndex = allCards.indexOf(draggedCard);
                const targetIndex = allCards.indexOf(targetCard);
                
                console.log('Visual preview - draggedIndex:', draggedIndex, 'targetIndex:', targetIndex);
                
                // è®¡ç®—gridå¸ƒå±€å‚æ•°
                const cardRect = allCards[0].getBoundingClientRect();
                const cardWidth = cardRect.width;
                const cardHeight = cardRect.height;
                const gap = 16;
                const containerWidth = itemList.offsetWidth;
                const cols = Math.floor(containerWidth / (cardWidth + gap));
                
                // ä¸ºæ¯ä¸ªå¡ç‰‡è®¡ç®—åç§»
                allCards.forEach((card, index) => {
                    // è¢«æ‹–åŠ¨çš„å¡ç‰‡ä¸ç§»åŠ¨ï¼Œä¿æŒåœ¨åŸä½ç½®ï¼ˆé€æ˜æ˜¾ç¤ºï¼‰
                    if (card.dataset.itemId === draggedItemId) {
                        card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        card.style.transform = 'translate(0, 0)';
                        return;
                    }
                    
                    let offset = 0;
                    
                    if (draggedIndex < targetIndex) {
                        // å‘å³æ‹–åŠ¨ï¼šdraggedIndex å’Œ targetIndex ä¹‹é—´çš„å¡ç‰‡å‘å·¦ç§»åŠ¨
                        if (index > draggedIndex && index <= targetIndex) {
                            offset = -1;
                            console.log('Card at index', index, 'moves left (offset -1)');
                        }
                    } else {
                        // å‘å·¦æ‹–åŠ¨ï¼štargetIndex å’Œ draggedIndex ä¹‹é—´çš„å¡ç‰‡å‘å³ç§»åŠ¨
                        if (index >= targetIndex && index < draggedIndex) {
                            offset = 1;
                            console.log('Card at index', index, 'moves right (offset 1)');
                        }
                    }
                    
                    if (offset !== 0) {
                        // è®¡ç®—å½“å‰å¡ç‰‡åœ¨gridä¸­çš„è¡Œåˆ—ä½ç½®
                        const currentRow = Math.floor(index / cols);
                        const currentCol = index % cols;
                        
                        // è®¡ç®—æ–°ä½ç½®çš„è¡Œåˆ—
                        const newPosition = index + offset;
                        const newRow = Math.floor(newPosition / cols);
                        const newCol = newPosition % cols;
                        
                        // è®¡ç®—å®é™…çš„åç§»é‡
                        const translateX = (newCol - currentCol) * (cardWidth + gap);
                        const translateY = (newRow - currentRow) * (cardHeight + gap);
                        
                        console.log('Card at index', index, '- translateX:', translateX, 'translateY:', translateY);
                        
                        card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        card.style.transform = `translate(${translateX}px, ${translateY}px)`;
                    } else {
                        card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        card.style.transform = 'translate(0, 0)';
                    }
                });
            }
            
            // å®æ—¶é¢„è§ˆé‡æ–°æ’åºï¼ˆæ‹–åŠ¨æ—¶ï¼‰
            previewReorder(draggedItemId, targetItemId) {
                // é˜²æ­¢é¢‘ç¹è§¦å‘
                if (this.lastPreviewTarget === targetItemId) {
                    return;
                }
                this.lastPreviewTarget = targetItemId;
                
                // æ›´æ–°ä¸´æ—¶æ’åºæ•°æ®
                const items = [...this.storage.getItems()]; // åˆ›å»ºå‰¯æœ¬
                const draggedItemIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                const targetItemIndex = items.findIndex(item => item.id.toString() === targetItemId);
                
                if (draggedItemIndex !== -1 && targetItemIndex !== -1) {
                    const [draggedItem] = items.splice(draggedItemIndex, 1);
                    items.splice(targetItemIndex, 0, draggedItem);
                    this.tempReorderedItems = items;
                    console.log('Preview reorder - temp items updated');
                    
                    // è·å–å½“å‰æ¿€æ´»çš„åˆ†ç±»æ ‡ç­¾
                    const activeTab = document.querySelector('.category-tab.active');
                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                    
                    // é‡æ–°æ¸²æŸ“ä»¥æ˜¾ç¤ºæ–°é¡ºåº
                    this.renderItems(currentCategory);
                    
                    // é‡æ–°æ·»åŠ draggingç±»åˆ°è¢«æ‹–åŠ¨çš„å…ƒç´ 
                    setTimeout(() => {
                        const draggedCard = document.querySelector(`[data-item-id="${draggedItemId}"]`);
                        if (draggedCard) {
                            draggedCard.classList.add('placeholder');
                        }
                    }, 0);
                }
            }
            
            // ç¡®è®¤é‡æ–°æ’åºï¼ˆæ”¾ä¸‹æ—¶ï¼‰
            confirmReorder(draggedItemId, targetItemId) {
                console.log('confirmReorder called', draggedItemId, targetItemId);
                console.log('tempReorderedItems:', this.tempReorderedItems);
                
                // å¦‚æœæœ‰ä¸´æ—¶æ’åºï¼Œä¿å­˜å®ƒ
                if (this.tempReorderedItems) {
                    console.log('Saving reordered items...');
                    const result = this.storage.saveItems(this.tempReorderedItems);
                    console.log('Save result:', result);
                    if (result) {
                        // æ ‡è®°ä¸ºå·²ä¿å­˜ï¼Œä½†ä¸æ¸…ç©ºä¸´æ—¶æ•°æ®ï¼ˆè®©dragendæ¥æ¸…ç†ï¼‰
                        this.orderSaved = true;
                        console.log('Order saved successfully');
                    }
                } else {
                    console.log('No temp items, using reorderItems');
                    // å¦‚æœæ²¡æœ‰ä¸´æ—¶æ’åºï¼Œæ‰§è¡ŒåŸæœ‰é€»è¾‘
                    this.reorderItems(draggedItemId, targetItemId);
                }
            }
            
            // æ¢å¤åŸå§‹é¡ºåºï¼ˆæ‹–æ‹½å–æ¶ˆæ—¶ï¼‰
            restoreOriginalOrder() {
                if (this.tempReorderedItems) {
                    // è·å–å½“å‰æ¿€æ´»çš„åˆ†ç±»æ ‡ç­¾
                    const activeTab = document.querySelector('.category-tab.active');
                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                    
                    // è·å–å½“å‰æ˜¾ç¤ºçš„ç‰©å“åˆ—è¡¨
                    const itemList = document.getElementById('item-list');
                    if (!itemList) return;
                    
                    // è·å–æ‰€æœ‰å¡ç‰‡å…ƒç´ å¹¶ä¿å­˜ä½ç½®
                    const cards = Array.from(itemList.querySelectorAll('.item-card'));
                    const positions = new Map();
                    cards.forEach(card => {
                        const rect = card.getBoundingClientRect();
                        positions.set(card.dataset.itemId, {
                            top: rect.top,
                            left: rect.left
                        });
                    });
                    
                    // æ¸…ç©ºä¸´æ—¶æ•°æ®
                    this.tempReorderedItems = null;
                    this.lastPreviewTarget = null;
                    
                    // é‡æ–°æ¸²æŸ“ä»¥æ¢å¤åŸå§‹é¡ºåº
                    this.renderItems(currentCategory);
                    
                    // ä½¿ç”¨FLIPæŠ€æœ¯å®ç°å¹³æ»‘åŠ¨ç”»
                    requestAnimationFrame(() => {
                        const newCards = Array.from(itemList.querySelectorAll('.item-card'));
                        
                        newCards.forEach(card => {
                            const itemId = card.dataset.itemId;
                            const oldPos = positions.get(itemId);
                            
                            // ç§»é™¤å ä½ç¬¦æ ·å¼
                            card.classList.remove('placeholder');
                            
                            if (oldPos) {
                                const newRect = card.getBoundingClientRect();
                                const deltaX = oldPos.left - newRect.left;
                                const deltaY = oldPos.top - newRect.top;
                                
                                // å…ˆç§»åŠ¨åˆ°æ—§ä½ç½®ï¼ˆä¸å¸¦åŠ¨ç”»ï¼‰
                                card.style.transition = 'none';
                                card.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                                
                                // å¼ºåˆ¶é‡æ’
                                card.offsetHeight;
                                
                                // ç„¶ååŠ¨ç”»åˆ°æ–°ä½ç½®
                                card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                card.style.transform = 'translate(0, 0)';
                            }
                        });
                    });
                }
            }
            
            // é‡æ–°æ’åºç‰©å“
            reorderItems(draggedItemId, targetItemId) {
                // è·å–æ‰€æœ‰ç‰©å“
                const items = this.storage.getItems();
                
                // æŸ¥æ‰¾æ‹–æ‹½ç‰©å“å’Œç›®æ ‡ç‰©å“çš„ç´¢å¼•
                const draggedIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                const targetIndex = items.findIndex(item => item.id.toString() === targetItemId);
                
                // ç¡®ä¿æ‰¾åˆ°ä¸¤ä¸ªç‰©å“
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    // ç§»é™¤æ‹–æ‹½çš„ç‰©å“
                    const [draggedItem] = items.splice(draggedIndex, 1);
                    // æ’å…¥åˆ°ç›®æ ‡ä½ç½®
                    items.splice(targetIndex, 0, draggedItem);
                    
                    // ä¿å­˜æ–°çš„é¡ºåº
                    const result = this.storage.saveItems(items);
                    
                    // ä¿å­˜æˆåŠŸåé‡æ–°æ¸²æŸ“
                    if (result) {
                        // è·å–å½“å‰æ¿€æ´»çš„åˆ†ç±»æ ‡ç­¾
                        const activeTab = document.querySelector('.category-tab.active');
                        const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                        
                        // åº”ç”¨æ’åºåŠ¨ç”»æ•ˆæœ
                        this.applySortAnimation(() => {
                            // é‡æ–°æ¸²æŸ“ç‰©å“åˆ—è¡¨
                            this.renderItems(currentCategory);
                        });
                    }
                }
            }
            
            // åº”ç”¨æ’åºåŠ¨ç”»æ•ˆæœ
            applySortAnimation(callback) {
                const itemList = document.getElementById('item-list');
                if (!itemList) {
                    callback();
                    return;
                }
                
                const itemCards = Array.from(itemList.querySelectorAll('.item-card'));
                
                // ä¸ºæ¯ä¸ªå¡ç‰‡æ·»åŠ æ·¡å‡ºåŠ¨ç”»
                itemCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                    }, index * 50);
                });
                
                // ç­‰å¾…åŠ¨ç”»å®Œæˆåæ‰§è¡Œå›è°ƒ
                setTimeout(callback, itemCards.length * 50 + 300);
            }
            
            // æ¸²æŸ“åˆ†ç±»åˆ—è¡¨ï¼ˆæ›´æ–°å¿«æ·å¡ç‰‡è®¡æ•°ï¼‰
            renderCategories() {
                console.log('æ›´æ–°åˆ†ç±»è®¡æ•°');
                const categories = this.storage.getCategories();
                const categoryCount = document.getElementById('category-count');
                if (categoryCount) {
                    categoryCount.textContent = categories.length;
                }
            }

            // åœ¨ç®¡ç†å¼¹çª—ä¸­æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
            renderCategoryManageList() {
                const manageList = document.getElementById('category-manage-list');
                if (!manageList) {
                    console.log('category-manage-listå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                console.log('å¼€å§‹æ¸²æŸ“åˆ†ç±»ç®¡ç†åˆ—è¡¨');
                manageList.innerHTML = '';

                const categories = this.storage.getCategories();
                console.log('è·å–åˆ°çš„åˆ†ç±»æ•°é‡:', categories.length);

                categories.forEach(category => {
                    console.log('æ¸²æŸ“åˆ†ç±»:', category.name);
                    const item = document.createElement('div');
                    item.className = 'manage-item';
                    item.innerHTML = `
                        <div class="manage-item-name">${category.icon} ${category.name}</div>
                        <div class="manage-item-actions">
                            <button class="edit" data-id="${category.id}">ç¼–è¾‘</button>
                            <button class="delete" data-id="${category.id}">åˆ é™¤</button>
                        </div>
                    `;
                    manageList.appendChild(item);
                });

                console.log('åˆ†ç±»ç®¡ç†åˆ—è¡¨æ¸²æŸ“å®Œæˆ');

                // é‡æ–°ç»‘å®šåˆ†ç±»é¡¹çš„ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
                this.bindCategoryManageEvents();
            }

            // ç»‘å®šåˆ†ç±»ç®¡ç†å¼¹çª—ä¸­çš„ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
            bindCategoryManageEvents() {
                const manageList = document.getElementById('category-manage-list');
                if (!manageList) {
                    console.error('category-manage-listå…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
                    return;
                }

                // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                const editBtns = manageList.querySelectorAll('.manage-item-actions button.edit');
                editBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.editCategoryInModal(id);
                    };
                });

                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtns = manageList.querySelectorAll('.manage-item-actions button.delete');
                deleteBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.deleteCategoryInModal(id);
                    };
                });
                console.log('åˆ†ç±»ç®¡ç†äº‹ä»¶ç»‘å®šå®Œæˆ');
            }

            // åˆå§‹åŒ–è´­ä¹°æ¸ é“é€‰æ‹©æ¡†
            initChannelSelects() {
                console.log('åˆå§‹åŒ–è´­ä¹°æ¸ é“é€‰æ‹©æ¡†');
                const channels = this.storage.getChannels();
                console.log('è·å–åˆ°è´­ä¹°æ¸ é“æ•°é‡:', channels.length);

                // æ›´æ–°æ·»åŠ ç‰©å“æ¨¡æ€æ¡†çš„è´­ä¹°æ¸ é“é€‰æ‹©æ¡†
                const addChannelSelect = document.getElementById('item-purchase-channel');
                if (addChannelSelect) {
                    addChannelSelect.innerHTML = '';
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = channel.name;
                        addChannelSelect.appendChild(option);
                    });
                    // è®¾ç½®é»˜è®¤å€¼ä¸ºç¬¬ä¸€ä¸ªé€‰é¡¹
                    if (channels.length > 0) {
                        addChannelSelect.value = channels[0].name;
                    }
                }

                // æ›´æ–°è¯¦æƒ…æ¨¡æ€æ¡†çš„è´­ä¹°æ¸ é“é€‰æ‹©æ¡†
                const detailChannelSelect = document.getElementById('detail-item-purchase-channel');
                if (detailChannelSelect) {
                    detailChannelSelect.innerHTML = '<option value="">è¯·é€‰æ‹©è´­ä¹°æ¸ é“</option>';
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = channel.name;
                        detailChannelSelect.appendChild(option);
                    });
                }
            }

            // æ¸²æŸ“è´­ä¹°æ¸ é“åˆ—è¡¨ï¼ˆæ›´æ–°å¿«æ·å¡ç‰‡è®¡æ•°ï¼‰
            renderChannels() {
                console.log('æ›´æ–°è´­ä¹°æ¸ é“è®¡æ•°');
                const channels = this.storage.getChannels();
                const channelCount = document.getElementById('channel-count');
                if (channelCount) {
                    channelCount.textContent = channels.length;
                }
            }

            // åœ¨ç®¡ç†å¼¹çª—ä¸­æ¸²æŸ“è´­ä¹°æ¸ é“åˆ—è¡¨
            renderChannelManageList() {
                const manageList = document.getElementById('channel-manage-list');
                if (!manageList) {
                    console.log('channel-manage-listå…ƒç´ ä¸å­˜åœ¨');
                    return;
                }

                console.log('å¼€å§‹æ¸²æŸ“è´­ä¹°æ¸ é“ç®¡ç†åˆ—è¡¨');
                manageList.innerHTML = '';

                const channels = this.storage.getChannels();
                console.log('è·å–åˆ°çš„è´­ä¹°æ¸ é“æ•°é‡:', channels.length);

                channels.forEach(channel => {
                    console.log('æ¸²æŸ“è´­ä¹°æ¸ é“:', channel.name);
                    const item = document.createElement('div');
                    item.className = 'manage-item';
                    item.innerHTML = `
                        <div class="manage-item-name">${channel.name}</div>
                        <div class="manage-item-actions">
                            <button class="edit" data-id="${channel.id}">ç¼–è¾‘</button>
                            <button class="delete" data-id="${channel.id}">åˆ é™¤</button>
                        </div>
                    `;
                    manageList.appendChild(item);
                });

                console.log('è´­ä¹°æ¸ é“ç®¡ç†åˆ—è¡¨æ¸²æŸ“å®Œæˆ');

                // é‡æ–°ç»‘å®šæ¸ é“é¡¹çš„ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
                this.bindChannelManageEvents();
            }

            // ç»‘å®šè´­ä¹°æ¸ é“ç®¡ç†å¼¹çª—ä¸­çš„ç¼–è¾‘å’Œåˆ é™¤äº‹ä»¶
            bindChannelManageEvents() {
                const manageList = document.getElementById('channel-manage-list');
                if (!manageList) {
                    console.error('channel-manage-listå…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
                    return;
                }

                // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
                const editBtns = manageList.querySelectorAll('.manage-item-actions button.edit');
                editBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.editChannelInModal(id);
                    };
                });

                // ç»‘å®šåˆ é™¤æŒ‰é’®äº‹ä»¶
                const deleteBtns = manageList.querySelectorAll('.manage-item-actions button.delete');
                deleteBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.deleteChannelInModal(id);
                    };
                });
                console.log('è´­ä¹°æ¸ é“ç®¡ç†äº‹ä»¶ç»‘å®šå®Œæˆ');
            }

            // æ‰“å¼€åˆ†ç±»ç®¡ç†å¼¹çª—
            openCategoryManageModal() {
                console.log('æ‰“å¼€åˆ†ç±»ç®¡ç†å¼¹çª—');
                const modal = document.getElementById('category-manage-modal');
                if (modal) {
                    this.renderCategoryManageList();
                    modal.style.display = 'flex';
                }
            }

            // å…³é—­åˆ†ç±»ç®¡ç†å¼¹çª—
            closeCategoryManageModal() {
                console.log('å…³é—­åˆ†ç±»ç®¡ç†å¼¹çª—');
                const modal = document.getElementById('category-manage-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // æ‰“å¼€è´­ä¹°æ¸ é“ç®¡ç†å¼¹çª—
            openChannelManageModal() {
                console.log('æ‰“å¼€è´­ä¹°æ¸ é“ç®¡ç†å¼¹çª—');
                const modal = document.getElementById('channel-manage-modal');
                if (modal) {
                    this.renderChannelManageList();
                    modal.style.display = 'flex';
                }
            }

            // å…³é—­è´­ä¹°æ¸ é“ç®¡ç†å¼¹çª—
            closeChannelManageModal() {
                console.log('å…³é—­è´­ä¹°æ¸ é“ç®¡ç†å¼¹çª—');
                const modal = document.getElementById('channel-manage-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // åœ¨å¼¹çª—ä¸­æ·»åŠ åˆ†ç±»
            addCategoryInModal() {
                console.log('addCategoryInModalè¢«è°ƒç”¨');
                this.prompt('æ·»åŠ åˆ†ç±»', 'è¯·è¾“å…¥åˆ†ç±»åç§°:', '', (confirmed, categoryName) => {
                    if (confirmed) {
                        const trimmedName = categoryName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼', 'error');
                            return;
                        }

                        // ä½¿ç”¨é»˜è®¤å›¾æ ‡
                        const result = this.storage.addCategory({ name: trimmedName, icon: 'ğŸ“¦' });
                        console.log('æ·»åŠ åˆ†ç±»ç»“æœ:', result);
                        if (result) {
                            this.renderCategoryManageList();
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.initCustomSelects();
                            this.showToast('åˆ†ç±»æ·»åŠ æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('åˆ†ç±»æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åœ¨å¼¹çª—ä¸­ç¼–è¾‘åˆ†ç±»
            editCategoryInModal(id) {
                console.log('ç¼–è¾‘åˆ†ç±»:', id);
                const category = this.storage.getCategoryById(id);
                if (!category) {
                    console.error('åˆ†ç±»ä¸å­˜åœ¨:', id);
                    this.showToast('åˆ†ç±»ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }

                this.prompt('ç¼–è¾‘åˆ†ç±»', 'è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:', category.name, (confirmed, categoryName) => {
                    if (confirmed) {
                        const trimmedName = categoryName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼', 'error');
                            return;
                        }

                        const result = this.storage.updateCategory(id, { name: trimmedName });
                        console.log('ç¼–è¾‘åˆ†ç±»ç»“æœ:', result);
                        if (result) {
                            this.renderCategoryManageList();
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.initCustomSelects();
                            this.showToast('åˆ†ç±»ç¼–è¾‘æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('åˆ†ç±»ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åœ¨å¼¹çª—ä¸­åˆ é™¤åˆ†ç±»
            deleteCategoryInModal(id) {
                console.log('åˆ é™¤åˆ†ç±»:', id);
                this.confirm('åˆ é™¤åˆ†ç±»', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteCategory(id);
                        console.log('åˆ é™¤åˆ†ç±»ç»“æœ:', result);
                        if (result) {
                            this.renderCategoryManageList();
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.renderItems();
                            this.initCustomSelects();
                            this.showToast('åˆ†ç±»åˆ é™¤æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('åˆ†ç±»åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åœ¨å¼¹çª—ä¸­æ·»åŠ è´­ä¹°æ¸ é“
            addChannelInModal() {
                console.log('addChannelInModalè¢«è°ƒç”¨');
                this.prompt('æ·»åŠ è´­ä¹°æ¸ é“', 'è¯·è¾“å…¥è´­ä¹°æ¸ é“åç§°:', '', (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥è´­ä¹°æ¸ é“åç§°ï¼', 'error');
                            return;
                        }

                        const result = this.storage.addChannel({ name: trimmedName });
                        console.log('æ·»åŠ è´­ä¹°æ¸ é“ç»“æœ:', result);
                        if (result) {
                            this.renderChannelManageList();
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('è´­ä¹°æ¸ é“æ·»åŠ æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('è´­ä¹°æ¸ é“æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åœ¨å¼¹çª—ä¸­ç¼–è¾‘è´­ä¹°æ¸ é“
            editChannelInModal(id) {
                console.log('ç¼–è¾‘è´­ä¹°æ¸ é“:', id);
                const channel = this.storage.getChannelById(id);
                if (!channel) {
                    console.error('è´­ä¹°æ¸ é“ä¸å­˜åœ¨:', id);
                    this.showToast('è´­ä¹°æ¸ é“ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }

                this.prompt('ç¼–è¾‘è´­ä¹°æ¸ é“', 'è¯·è¾“å…¥æ–°çš„è´­ä¹°æ¸ é“åç§°:', channel.name, (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥è´­ä¹°æ¸ é“åç§°ï¼', 'error');
                            return;
                        }

                        const result = this.storage.updateChannel(id, { name: trimmedName });
                        console.log('ç¼–è¾‘è´­ä¹°æ¸ é“ç»“æœ:', result);
                        if (result) {
                            this.renderChannelManageList();
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('è´­ä¹°æ¸ é“ç¼–è¾‘æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('è´­ä¹°æ¸ é“ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åœ¨å¼¹çª—ä¸­åˆ é™¤è´­ä¹°æ¸ é“
            deleteChannelInModal(id) {
                console.log('åˆ é™¤è´­ä¹°æ¸ é“:', id);
                this.confirm('åˆ é™¤è´­ä¹°æ¸ é“', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´­ä¹°æ¸ é“å—ï¼Ÿ', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteChannel(id);
                        console.log('åˆ é™¤è´­ä¹°æ¸ é“ç»“æœ:', result);
                        if (result) {
                            this.renderChannelManageList();
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('è´­ä¹°æ¸ é“åˆ é™¤æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('è´­ä¹°æ¸ é“åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // æ·»åŠ è´­ä¹°æ¸ é“
            addChannel() {
                console.log('addChannelè¢«è°ƒç”¨');
                this.prompt('æ·»åŠ è´­ä¹°æ¸ é“', 'è¯·è¾“å…¥è´­ä¹°æ¸ é“åç§°:', '', (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥è´­ä¹°æ¸ é“åç§°ï¼', 'error');
                            return;
                        }

                        const result = this.storage.addChannel({ name: trimmedName });
                        console.log('æ·»åŠ è´­ä¹°æ¸ é“ç»“æœ:', result);
                        if (result) {
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('è´­ä¹°æ¸ é“æ·»åŠ æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('è´­ä¹°æ¸ é“æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // ç¼–è¾‘è´­ä¹°æ¸ é“
            editChannel(id) {
                console.log('ç¼–è¾‘è´­ä¹°æ¸ é“:', id);
                const channel = this.storage.getChannelById(id);
                if (!channel) {
                    console.error('è´­ä¹°æ¸ é“ä¸å­˜åœ¨:', id);
                    this.showToast('è´­ä¹°æ¸ é“ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }

                this.prompt('ç¼–è¾‘è´­ä¹°æ¸ é“', 'è¯·è¾“å…¥æ–°çš„è´­ä¹°æ¸ é“åç§°:', channel.name, (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥è´­ä¹°æ¸ é“åç§°ï¼', 'error');
                            return;
                        }

                        const result = this.storage.updateChannel(id, { name: trimmedName });
                        console.log('ç¼–è¾‘è´­ä¹°æ¸ é“ç»“æœ:', result);
                        if (result) {
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('è´­ä¹°æ¸ é“ç¼–è¾‘æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('è´­ä¹°æ¸ é“ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åˆ é™¤è´­ä¹°æ¸ é“
            deleteChannel(id) {
                console.log('åˆ é™¤è´­ä¹°æ¸ é“:', id);
                this.confirm('åˆ é™¤è´­ä¹°æ¸ é“', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè´­ä¹°æ¸ é“å—ï¼Ÿ', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteChannel(id);
                        console.log('åˆ é™¤è´­ä¹°æ¸ é“ç»“æœ:', result);
                        if (result) {
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('è´­ä¹°æ¸ é“åˆ é™¤æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('è´­ä¹°æ¸ é“åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }

            // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
            initCustomSelects() {
                console.log('åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†');

                // ä»storageä¸­è·å–æ‰€æœ‰åˆ†ç±»
                const categories = this.storage.getCategories();
                console.log('è·å–åˆ°åˆ†ç±»æ•°é‡:', categories.length);

                // ä¸ºæ‰€æœ‰è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                const customSelects = document.querySelectorAll('.custom-select');
                console.log('æ‰¾åˆ°è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†æ•°é‡:', customSelects.length);

                customSelects.forEach(select => {
                    const trigger = select.querySelector('.custom-select-trigger');
                    const optionsContainer = select.querySelector('.custom-select-options');
                    const hiddenInput = select.querySelector('input[type="hidden"]');

                    if (trigger && optionsContainer && hiddenInput) {
                        // æ¸…ç©ºç°æœ‰é€‰é¡¹
                        optionsContainer.innerHTML = '';

                        // åˆ†ç±»ä¸‹æ‹‰æ¡†é€‰é¡¹
                        categories.forEach(category => {
                            const option = document.createElement('div');
                            option.className = 'custom-select-option';
                            option.dataset.value = category.name;
                            option.textContent = `${category.icon} ${category.name}`;
                            optionsContainer.appendChild(option);
                        });
                        
                        // è·å–æ–°ç”Ÿæˆçš„é€‰é¡¹
                        const optionItems = select.querySelectorAll('.custom-select-option');
                        
                        // ç§»é™¤ä¹‹å‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
                        trigger.onclick = null;
                        optionItems.forEach(option => {
                            option.onclick = null;
                        });
                        
                        // ç‚¹å‡»è§¦å‘æ¡†åˆ‡æ¢é€‰é¡¹åˆ—è¡¨æ˜¾ç¤ºçŠ¶æ€
                        trigger.onclick = (e) => {
                            e.stopPropagation();
                            // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
                            document.querySelectorAll('.custom-select').forEach(s => {
                                if (s !== select) {
                                    s.classList.remove('open');
                                }
                            });
                            // åˆ‡æ¢å½“å‰ä¸‹æ‹‰æ¡†çŠ¶æ€
                            select.classList.toggle('open');
                        };
                        
                        // é€‰æ‹©é€‰é¡¹
                        optionItems.forEach(option => {
                            option.onclick = (e) => {
                                e.stopPropagation();
                                const value = option.dataset.value;
                                const text = option.textContent;

                                // æ›´æ–°è§¦å‘æ¡†æ–‡æœ¬
                                trigger.textContent = text;
                                // æ›´æ–°éšè—è¾“å…¥æ¡†å€¼
                                hiddenInput.value = value;
                                // æ ‡è®°é€‰ä¸­çŠ¶æ€
                                optionItems.forEach(opt => opt.classList.remove('selected'));
                                option.classList.add('selected');
                                // å…³é—­é€‰é¡¹åˆ—è¡¨
                                select.classList.remove('open');
                            };
                        });
                    }
                });
                
                // åªæ·»åŠ ä¸€æ¬¡å…¨å±€ç‚¹å‡»äº‹ä»¶
                if (!document.querySelector('.custom-select-click-handler')) {
                    const clickHandler = document.createElement('div');
                    clickHandler.className = 'custom-select-click-handler';
                    document.body.appendChild(clickHandler);
                    
                    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­ä¸‹æ‹‰æ¡†
                    document.addEventListener('click', () => {
                        document.querySelectorAll('.custom-select').forEach(select => {
                            select.classList.remove('open');
                        });
                    });
                    
                    // ç‚¹å‡»é€‰é¡¹åˆ—è¡¨å†…éƒ¨ä¸å…³é—­
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('.custom-select-options')) {
                            e.stopPropagation();
                        }
                    });
                }
            }
            
            // ç»‘å®šäº‹ä»¶
            bindEvents() {
                console.log('å¼€å§‹ç»‘å®šäº‹ä»¶');
                
                // åˆå§‹åŒ–ä¸»é¢˜å’Œå¸ƒå±€
                this.initThemeAndLayout();
                this.renderThemePresets();
                
                // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸‹æ‹‰æ¡†
                this.initCustomSelects();
                
                // æ ‡ç­¾åˆ‡æ¢
                const tabs = document.querySelectorAll('.tab');
                console.log('æ‰¾åˆ°æ ‡ç­¾æ•°é‡:', tabs.length);
                tabs.forEach(tab => {
                    console.log('ç»‘å®šæ ‡ç­¾ç‚¹å‡»äº‹ä»¶:', tab.dataset.tab);
                    tab.addEventListener('click', () => {
                        console.log('æ ‡ç­¾è¢«ç‚¹å‡»:', tab.dataset.tab);
                        const tabId = tab.dataset.tab;
                        if (!tabId) return;

                        // æ›´æ–°æ ‡ç­¾çŠ¶æ€
                        tabs.forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                        tab.classList.add('active');

                        // æ›´æ–° body çš„ data-active-tab å±æ€§ï¼Œç”¨äºæ§åˆ¶æ·»åŠ æŒ‰é’®çš„æ˜¾ç¤º
                        document.body.setAttribute('data-active-tab', tabId);

                        // ç›´æ¥æ§åˆ¶æ·»åŠ æŒ‰é’®çš„æ˜¾ç¤º
                        const addItemBtn = document.getElementById('add-item-btn');
                        const addSubscriptionBtn = document.getElementById('add-subscription-btn');

                        if (tabId === 'subscription') {
                            // è®¢é˜…æ ‡ç­¾ï¼šéšè—æ·»åŠ ç‰©å“æŒ‰é’®ï¼Œæ˜¾ç¤ºæ·»åŠ è®¢é˜…æŒ‰é’®
                            if (addItemBtn) addItemBtn.style.display = 'none';
                            if (addSubscriptionBtn) {
                                addSubscriptionBtn.style.display = 'flex';
                                console.log('æ˜¾ç¤ºæ·»åŠ è®¢é˜…æŒ‰é’®');
                            }
                        } else {
                            // å…¶ä»–æ ‡ç­¾ï¼šæ˜¾ç¤ºæ·»åŠ ç‰©å“æŒ‰é’®ï¼Œéšè—æ·»åŠ è®¢é˜…æŒ‰é’®
                            if (addItemBtn) addItemBtn.style.display = 'flex';
                            if (addSubscriptionBtn) addSubscriptionBtn.style.display = 'none';
                        }

                        // æ˜¾ç¤ºå¯¹åº”é¢æ¿
                        const panel = document.getElementById(`${tabId}-panel`);
                        if (panel) {
                            panel.classList.add('active');
                            console.log('æ˜¾ç¤ºé¢æ¿:', tabId);

                            // å¦‚æœåˆ‡æ¢åˆ°æˆ‘çš„æ ‡ç­¾ï¼Œé‡æ–°æ¸²æŸ“åˆ†ç±»åˆ—è¡¨ã€è´­ä¹°æ¸ é“åˆ—è¡¨å¹¶æ›´æ–°ç»Ÿè®¡
                            if (tabId === 'settings') {
                                this.renderCategories();
                                this.renderChannels();
                                this.updateStats();
                            }

                            // å¦‚æœåˆ‡æ¢åˆ°è®¢é˜…æ ‡ç­¾ï¼Œæ¸²æŸ“è®¢é˜…é¢æ¿
                            if (tabId === 'subscription') {
                                this.subscriptionUI.renderSubscriptionPanel();
                            }

                            // å¦‚æœåˆ‡æ¢åˆ°åˆ†ææ ‡ç­¾ï¼Œæ¸²æŸ“æ•°æ®åˆ†æ
                            if (tabId === 'analytics') {
                                this.renderAnalytics();
                            }
                        }
                    });
                });

                // æ·»åŠ ç‰©å“æŒ‰é’®
                const addItemBtn = document.getElementById('add-item-btn');
                console.log('æ‰¾åˆ°æ·»åŠ ç‰©å“æŒ‰é’®:', !!addItemBtn);
                if (addItemBtn) {
                    console.log('ç»‘å®šæ·»åŠ ç‰©å“æŒ‰é’®ç‚¹å‡»äº‹ä»¶');
                    addItemBtn.addEventListener('click', function() {
                        console.log('æ·»åŠ ç‰©å“æŒ‰é’®è¢«ç‚¹å‡»');
                        const addModal = document.getElementById('add-item-modal');
                        if (addModal) {
                            addModal.style.display = 'flex';
                            console.log('æ˜¾ç¤ºæ·»åŠ ç‰©å“æ¨¡æ€æ¡†');
                            
                            // è®¾ç½®è´­ä¹°æ—¥æœŸé»˜è®¤å€¼ä¸ºä»Šå¤©
                            const purchaseDateInput = document.getElementById('item-purchase-date');
                            if (purchaseDateInput) {
                                purchaseDateInput.value = new Date().toISOString().split('T')[0];
                            }

                            // åˆå§‹åŒ–è´­ä¹°æ¸ é“é€‰æ‹©æ¡†
                            this.initChannelSelects();

                            // ä¿å­˜thisçš„å¼•ç”¨
                            const self = this;
                            // æ˜¾ç¤ºæ¨¡æ€æ¡†ååˆå§‹åŒ–ä¸‹æ‹‰æ¡†
                            setTimeout(function() {
                                self.initCustomSelects();
                            }, 100);
                        }
                    }.bind(this));
                }
                
                // å–æ¶ˆæ·»åŠ 
                const cancelAddBtn = document.getElementById('cancel-add');
                if (cancelAddBtn) {
                    cancelAddBtn.addEventListener('click', () => {
                        const addModal = document.getElementById('add-item-modal');
                        if (addModal) {
                            addModal.style.display = 'none';
                        }
                    });
                }
                
                // ä¿å­˜ç‰©å“
                const saveItemBtn = document.getElementById('save-item');
                if (saveItemBtn) {
                    saveItemBtn.addEventListener('click', () => {
                        const nameInput = document.getElementById('item-name');
                        const categoryInput = document.getElementById('item-category');
                        const descInput = document.getElementById('item-desc');
                        const locationInput = document.getElementById('item-location');
                        const priceInput = document.getElementById('item-price');
                        const purchaseDateInput = document.getElementById('item-purchase-date');
                        const purchaseChannelInput = document.getElementById('item-purchase-channel');

                        const name = nameInput?.value?.trim();
                        const category = categoryInput?.value;
                        const desc = descInput?.value?.trim();
                        const location = locationInput?.value?.trim();
                        const priceValue = priceInput?.value?.trim();
                        const price = parseFloat(priceValue) || 0;
                        const purchaseDate = purchaseDateInput?.value || new Date().toISOString().split('T')[0];
                        const purchaseChannel = purchaseChannelInput?.value || '';

                        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
                        this.clearInputError(nameInput);
                        this.clearInputError(categoryInput);
                        this.clearInputError(priceInput);
                        this.clearInputError(purchaseChannelInput);

                        // éªŒè¯å¿…å¡«é¡¹
                        if (!name) {
                            this.showInputError(nameInput, 'è¯·è¾“å…¥ç‰©å“åç§°');
                            return;
                        }

                        if (!category) {
                            this.showInputError(categoryInput, 'è¯·é€‰æ‹©åˆ†ç±»');
                            return;
                        }

                        // éªŒè¯è´­ä¹°æ¸ é“
                        if (!purchaseChannel) {
                            this.showInputError(purchaseChannelInput, 'è¯·é€‰æ‹©è´­ä¹°æ¸ é“');
                            return;
                        }

                        // éªŒè¯ä»·æ ¼
                        if (priceValue && (isNaN(price) || price < 0)) {
                            this.showInputError(priceInput, 'è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆä¸èƒ½ä¸ºè´Ÿæ•°ï¼‰');
                            return;
                        }

                        const newItem = {
                            name,
                            category,
                            desc,
                            location,
                            price,
                            purchaseDate,
                            purchaseChannel
                        };
                        
                        const result = this.storage.addItem(newItem);
                        
                        if (result) {
                            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                            this.updateStats();
                            this.updateItemStats();

                            // é‡æ–°æ¸²æŸ“ç‰©å“åˆ—è¡¨ï¼Œæ˜¾ç¤ºæ–°æ·»åŠ çš„ç‰©å“
                            // ä¿æŒå½“å‰çš„åˆ†ç±»ç­›é€‰çŠ¶æ€
                            const activeTab = document.querySelector('.category-tab.active');
                            const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                            this.renderItems(currentCategory);
                            
                            const addModal = document.getElementById('add-item-modal');
                            if (addModal) {
                                addModal.style.display = 'none';
                            }
                            
                            // æ¸…ç©ºè¡¨å•
                            if (nameInput) nameInput.value = '';
                            if (descInput) descInput.value = '';
                            if (locationInput) locationInput.value = '';
                            if (priceInput) priceInput.value = '';
                            if (purchaseDateInput) purchaseDateInput.value = new Date().toISOString().split('T')[0];
                            if (purchaseChannelInput) purchaseChannelInput.value = '';

                            this.showToast('ç‰©å“æ·»åŠ æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('ç‰©å“æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    });
                }
                
                // å…³é—­è¯¦æƒ…
                const closeDetailBtn = document.getElementById('close-detail');
                if (closeDetailBtn) {
                    closeDetailBtn.addEventListener('click', () => {
                        const detailModal = document.getElementById('item-detail-modal');
                        if (detailModal) {
                            detailModal.style.display = 'none';
                        }
                    });
                }
                
                // ä¿å­˜ç‰©å“è¯¦æƒ…æŒ‰é’®
                const saveItemDetailBtn = document.getElementById('save-item-detail');
                if (saveItemDetailBtn) {
                    saveItemDetailBtn.addEventListener('click', () => {
                        this.saveItemEdit();
                    });
                }
                
                // åˆ é™¤ç‰©å“æŒ‰é’®
                const deleteItemDetailBtn = document.getElementById('delete-item-detail');
                if (deleteItemDetailBtn) {
                    deleteItemDetailBtn.addEventListener('click', () => {
                        this.deleteItem();
                    });
                }

                // å¿«æ·ç®¡ç†å¡ç‰‡ç‚¹å‡»äº‹ä»¶
                console.log('å¼€å§‹ç»‘å®šå¿«æ·ç®¡ç†å¡ç‰‡ç‚¹å‡»äº‹ä»¶');
                const categoryManageCard = document.getElementById('category-manage-card');
                const channelManageCard = document.getElementById('channel-manage-card');

                if (categoryManageCard) {
                    categoryManageCard.addEventListener('click', () => {
                        this.openCategoryManageModal();
                    });
                }

                if (channelManageCard) {
                    channelManageCard.addEventListener('click', () => {
                        this.openChannelManageModal();
                    });
                }

                // åˆ†ç±»ç®¡ç†å¼¹çª—äº‹ä»¶
                const closeCategoryModalBtn = document.getElementById('close-category-modal');
                const addCategoryInModalBtn = document.getElementById('add-category-in-modal');

                if (closeCategoryModalBtn) {
                    closeCategoryModalBtn.addEventListener('click', () => {
                        this.closeCategoryManageModal();
                    });
                }

                if (addCategoryInModalBtn) {
                    addCategoryInModalBtn.addEventListener('click', () => {
                        this.addCategoryInModal();
                    });
                }

                // è´­ä¹°æ¸ é“ç®¡ç†å¼¹çª—äº‹ä»¶
                const closeChannelModalBtn = document.getElementById('close-channel-modal');
                const addChannelInModalBtn = document.getElementById('add-channel-in-modal');

                if (closeChannelModalBtn) {
                    closeChannelModalBtn.addEventListener('click', () => {
                        this.closeChannelManageModal();
                    });
                }

                if (addChannelInModalBtn) {
                    addChannelInModalBtn.addEventListener('click', () => {
                        this.addChannelInModal();
                    });
                }

                // å¯¼å‡ºæ•°æ®
                const exportBtn = document.getElementById('export-data-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportData();
                    });
                }
                
                // å¯¼å…¥æ•°æ®
                const importBtn = document.getElementById('import-data-btn');
                if (importBtn) {
                    importBtn.addEventListener('click', () => {
                        this.importData();
                    });
                }
                
                // å¸ƒå±€åˆ‡æ¢æŒ‰é’®
                const layoutOptions = document.querySelectorAll('.layout-option');
                layoutOptions.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const layout = btn.dataset.layout;
                        if (layout) {
                            this.switchLayout(layout);
                        }
                    });
                });
                
                // è‡ªå®šä¹‰ä¸»é¢˜æŒ‰é’®
                const customThemeBtn = document.getElementById('custom-theme-btn');
                if (customThemeBtn) {
                    customThemeBtn.addEventListener('click', () => {
                        this.createCustomTheme();
                    });
                }
                
                // æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
                this.setupModalClickOutside();
            }
            
            // æ˜¾ç¤ºç‰©å“è¯¦æƒ…
            showItemDetail(item) {
                const detailModal = document.getElementById('item-detail-modal');
                if (!detailModal) return;
                
                const detailItemName = document.getElementById('detail-item-name');
                if (detailItemName) detailItemName.value = item.name;
                
                // è®¾ç½®ä»·æ ¼
                const detailItemPrice = document.getElementById('detail-item-price');
                if (detailItemPrice) detailItemPrice.value = item.price || 0;
                
                // è®¾ç½®è´­ä¹°æ—¥æœŸ
                const detailItemPurchaseDate = document.getElementById('detail-item-purchase-date');
                if (detailItemPurchaseDate) detailItemPurchaseDate.value = item.purchaseDate || item.createdAt?.split('T')[0];
                
                // è®¡ç®—å¹¶è®¾ç½®æ—¥å‡ä»·å€¼
                const calculateDailyValue = (price, purchaseDate) => {
                    if (!price || !purchaseDate) return 0;
                    const now = new Date();
                    const purchased = new Date(purchaseDate);
                    const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                    return price / days;
                };
                
                const dailyValue = calculateDailyValue(item.price, item.purchaseDate || item.createdAt);
                const detailItemDailyValue = document.getElementById('detail-item-daily-value');
                if (detailItemDailyValue) detailItemDailyValue.value = dailyValue.toFixed(2);
                
                // å­˜å‚¨å½“å‰ç¼–è¾‘çš„ç‰©å“ID
                this.currentEditingItem = item;
                
                detailModal.style.display = 'flex';
                
                // ä¿å­˜thisçš„å¼•ç”¨
                const self = this;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†ååˆå§‹åŒ–ä¸‹æ‹‰æ¡†å¹¶è®¾ç½®å½“å‰åˆ†ç±»
                setTimeout(function() {
                    self.initCustomSelects();
                    
                    // è®¾ç½®å½“å‰åˆ†ç±»
                    const customSelect = document.getElementById('custom-detail-category-select');
                    if (customSelect) {
                        const trigger = customSelect.querySelector('.custom-select-trigger');
                        const hiddenInput = customSelect.querySelector('input[type="hidden"]');
                        const options = customSelect.querySelectorAll('.custom-select-option');
                        
                        if (trigger && hiddenInput && options) {
                            // è·å–åˆ†ç±»ä¿¡æ¯ï¼ŒåŒ…æ‹¬å›¾æ ‡
                            const categories = self.storage.getCategories();
                            const itemCategory = categories.find(cat => cat.name === item.category);
                            
                            if (itemCategory) {
                                trigger.textContent = `${itemCategory.icon} ${item.category}`;
                            } else {
                                trigger.textContent = item.category || 'è¯·é€‰æ‹©åˆ†ç±»';
                            }
                            
                            hiddenInput.value = item.category || '';
                            
                            // æ ‡è®°é€‰ä¸­çŠ¶æ€
                            options.forEach(option => {
                                if (option.dataset.value === item.category) {
                                    option.classList.add('selected');
                                } else {
                                    option.classList.remove('selected');
                                }
                            });
                        }
                    }
                    
                    // è®¾ç½®å…¶ä»–å­—æ®µ
                    const detailItemDesc = document.getElementById('detail-item-desc');
                    if (detailItemDesc) detailItemDesc.value = item.desc;
                    const detailItemLocation = document.getElementById('detail-item-location');
                    if (detailItemLocation) detailItemLocation.value = item.location;

                    // è®¾ç½®è´­ä¹°æ¸ é“
                    const detailPurchaseChannel = document.getElementById('detail-item-purchase-channel');
                    if (detailPurchaseChannel) {
                        detailPurchaseChannel.value = item.purchaseChannel || '';
                    }
                }, 100);
            }
            
            // ä¿å­˜ç‰©å“ç¼–è¾‘
            saveItemEdit() {
                console.log('saveItemEditè¢«è°ƒç”¨');
                console.log('currentEditingItem:', this.currentEditingItem);
                if (!this.currentEditingItem) {
                    console.error('currentEditingItemä¸ºç©ºï¼');
                    return;
                }
                
                // è·å–ç¼–è¾‘åçš„å€¼
                const detailItemName = document.getElementById('detail-item-name');
                const detailItemCategory = document.getElementById('detail-item-category');
                const detailItemDesc = document.getElementById('detail-item-desc');
                const detailItemLocation = document.getElementById('detail-item-location');
                const detailItemPrice = document.getElementById('detail-item-price');
                const detailItemPurchaseDate = document.getElementById('detail-item-purchase-date');
                const detailPurchaseChannel = document.getElementById('detail-item-purchase-channel');

                const name = detailItemName ? detailItemName.value?.trim() : '';
                const category = detailItemCategory ? detailItemCategory.value : '';
                const priceValue = detailItemPrice ? detailItemPrice.value?.trim() : '';
                const price = parseFloat(priceValue) || 0;
                const purchaseChannel = detailPurchaseChannel ? detailPurchaseChannel.value : '';

                console.log('ç¼–è¾‘åçš„å€¼:', { name, category, price, purchaseChannel });

                // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
                this.clearInputError(detailItemName);
                this.clearInputError(detailItemCategory);
                this.clearInputError(detailItemPrice);

                // éªŒè¯å¿…å¡«é¡¹
                if (!name) {
                    this.showInputError(detailItemName, 'è¯·è¾“å…¥ç‰©å“åç§°');
                    return;
                }

                if (!category) {
                    this.showInputError(detailItemCategory, 'è¯·é€‰æ‹©åˆ†ç±»');
                    return;
                }

                // éªŒè¯ä»·æ ¼
                if (priceValue && (isNaN(price) || price < 0)) {
                    this.showInputError(detailItemPrice, 'è¯·è¾“å…¥æœ‰æ•ˆçš„ä»·æ ¼ï¼ˆä¸èƒ½ä¸ºè´Ÿæ•°ï¼‰');
                    return;
                }

                const updates = {
                    name: name,
                    category: category,
                    desc: detailItemDesc ? detailItemDesc.value?.trim() : this.currentEditingItem.desc,
                    location: detailItemLocation ? detailItemLocation.value?.trim() : this.currentEditingItem.location,
                    price: price,
                    purchaseDate: detailItemPurchaseDate ? detailItemPurchaseDate.value : this.currentEditingItem.purchaseDate,
                    purchaseChannel: purchaseChannel
                };
                
                console.log('å‡†å¤‡æ›´æ–°ç‰©å“ï¼ŒID:', this.currentEditingItem.id, 'æ›´æ–°å†…å®¹:', updates);
                
                // æ›´æ–°ç‰©å“æ•°æ®
                const result = this.storage.updateItem(this.currentEditingItem.id, updates);
                
                console.log('æ›´æ–°ç»“æœ:', result);
                
                if (result) {
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    this.updateStats();
                    this.updateItemStats();

                    // é‡æ–°æ¸²æŸ“ç‰©å“åˆ—è¡¨ï¼Œä¿æŒå½“å‰åˆ†ç±»ç­›é€‰çŠ¶æ€
                    const activeTab = document.querySelector('.category-tab.active');
                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                    this.renderItems(currentCategory);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    const detailModal = document.getElementById('item-detail-modal');
                    if (detailModal) {
                        detailModal.style.display = 'none';
                    }
                    
                    // é‡ç½®å½“å‰ç¼–è¾‘çš„ç‰©å“
                    this.currentEditingItem = null;
                    
                    this.showToast('ç‰©å“æ›´æ–°æˆåŠŸï¼', 'success');
                } else {
                    this.showToast('ç‰©å“æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            }
            
            // åˆ é™¤ç‰©å“
            deleteItem() {
                console.log('deleteItemè¢«è°ƒç”¨');
                if (!this.currentEditingItem) {
                    console.error('currentEditingItemä¸ºç©ºï¼');
                    return;
                }
                
                console.log('å‡†å¤‡åˆ é™¤ç‰©å“:', this.currentEditingItem);
                
                this.confirm('åˆ é™¤ç‰©å“', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç‰©å“å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚', (confirmed) => {
                    console.log('ç¡®è®¤å¯¹è¯æ¡†å›è°ƒè¢«è°ƒç”¨, confirmed:', confirmed);
                    if (confirmed) {
                        // åˆ é™¤ç‰©å“
                        console.log('å¼€å§‹åˆ é™¤ç‰©å“ï¼ŒID:', this.currentEditingItem.id);
                        const result = this.storage.deleteItem(this.currentEditingItem.id);
                        console.log('åˆ é™¤ç»“æœ:', result);
                        
                        if (result) {
                            console.log('åˆ é™¤æˆåŠŸï¼Œå‡†å¤‡æ˜¾ç¤ºæç¤º');

                            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                            this.updateStats();
                            this.updateItemStats();

                            // é‡æ–°æ¸²æŸ“ç‰©å“åˆ—è¡¨ï¼Œä¿æŒå½“å‰åˆ†ç±»ç­›é€‰çŠ¶æ€
                            const activeTab = document.querySelector('.category-tab.active');
                            const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                            this.renderItems(currentCategory);
                            
                            // å…³é—­æ¨¡æ€æ¡†
                            const detailModal = document.getElementById('item-detail-modal');
                            if (detailModal) {
                                detailModal.style.display = 'none';
                            }
                            
                            // é‡ç½®å½“å‰ç¼–è¾‘çš„ç‰©å“
                            this.currentEditingItem = null;
                            
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            console.log('è°ƒç”¨showToastæ˜¾ç¤ºæˆåŠŸæç¤º');
                            this.showToast('ç‰©å“åˆ é™¤æˆåŠŸï¼', 'success');
                            console.log('showToastè°ƒç”¨å®Œæˆ');
                        } else {
                            console.log('åˆ é™¤å¤±è´¥');
                            // æ˜¾ç¤ºå¤±è´¥æç¤º
                            this.showToast('ç‰©å“åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    } else {
                        console.log('ç”¨æˆ·å–æ¶ˆäº†åˆ é™¤');
                    }
                });
            }
            
            // ç¼–è¾‘åˆ†ç±»
            editCategory(id) {
                console.log('ç¼–è¾‘åˆ†ç±»:', id);
                const category = this.storage.getCategoryById(id);
                if (!category) {
                    console.error('åˆ†ç±»ä¸å­˜åœ¨:', id);
                    this.showToast('åˆ†ç±»ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }
                
                this.prompt('ç¼–è¾‘åˆ†ç±»', 'è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°:', category.name, (confirmed, categoryName) => {
                    if (confirmed) {
                        const trimmedName = categoryName?.trim();
                        if (!trimmedName) {
                            this.showToast('è¯·è¾“å…¥åˆ†ç±»åç§°ï¼', 'error');
                            return;
                        }
                        
                        const result = this.storage.updateCategory(id, { name: trimmedName });
                        console.log('ç¼–è¾‘åˆ†ç±»ç»“æœ:', result);
                        if (result) {
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.initCustomSelects();
                            this.showToast('åˆ†ç±»ç¼–è¾‘æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('åˆ†ç±»ç¼–è¾‘å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }
            
            // åˆ é™¤åˆ†ç±»
            deleteCategory(id) {
                console.log('åˆ é™¤åˆ†ç±»:', id);
                this.confirm('åˆ é™¤åˆ†ç±»', 'ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»å—ï¼Ÿ', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteCategory(id);
                        console.log('åˆ é™¤åˆ†ç±»ç»“æœ:', result);
                        if (result) {
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.renderItems(); // é‡æ–°æ¸²æŸ“ç‰©å“åˆ—è¡¨ï¼Œç¡®ä¿åˆ†ç±»ç­›é€‰æ­£ç¡®
                            this.initCustomSelects();
                            this.showToast('åˆ†ç±»åˆ é™¤æˆåŠŸï¼', 'success');
                        } else {
                            this.showToast('åˆ†ç±»åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    }
                });
            }
            
            // æ˜¾ç¤ºè¾“å…¥é”™è¯¯
            showInputError(inputElement, message) {
                if (!inputElement) return;
                
                // æ·»åŠ é”™è¯¯æ ·å¼
                inputElement.classList.add('input-error');
                
                // æŸ¥æ‰¾æˆ–åˆ›å»ºé”™è¯¯æ¶ˆæ¯å…ƒç´ 
                let errorMsg = inputElement.parentElement.querySelector('.error-message');
                if (!errorMsg) {
                    errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    inputElement.parentElement.appendChild(errorMsg);
                }
                
                errorMsg.textContent = message;
                errorMsg.classList.add('show');
                
                // 3ç§’åç§»é™¤é”™è¯¯æ ·å¼
                setTimeout(() => {
                    inputElement.classList.remove('input-error');
                    errorMsg.classList.remove('show');
                }, 3000);
                
                // èšç„¦åˆ°é”™è¯¯è¾“å…¥æ¡†
                inputElement.focus();
            }
            
            // æ¸…é™¤è¾“å…¥é”™è¯¯
            clearInputError(inputElement) {
                if (!inputElement) return;
                
                inputElement.classList.remove('input-error');
                const errorMsg = inputElement.parentElement.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.classList.remove('show');
                }
            }
            
            // è®¾ç½®æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­
            setupModalClickOutside() {
                console.log('è®¾ç½®æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­');
                const modals = [
                    { id: 'add-item-modal', formSelector: '#add-item-modal form', inputs: ['#item-name', '#item-desc', '#item-location', '#item-price'] },
                    { id: 'item-detail-modal', formSelector: '#item-detail-modal form', inputs: ['#detail-item-name', '#detail-item-desc', '#detail-item-location', '#detail-item-price'] },
                    { id: 'category-manage-modal', formSelector: null, inputs: [] },
                    { id: 'channel-manage-modal', formSelector: null, inputs: [] }
                ];
                
                modals.forEach(modalConfig => {
                    const modal = document.getElementById(modalConfig.id);
                    console.log(`æ‰¾åˆ°æ¨¡æ€æ¡† ${modalConfig.id}:`, !!modal);
                    if (!modal) return;
                    
                    modal.addEventListener('click', (e) => {
                        // åªæœ‰ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯ï¼ˆä¸æ˜¯å†…å®¹åŒºåŸŸï¼‰æ—¶æ‰è§¦å‘
                        if (e.target === modal) {
                            console.log(`ç‚¹å‡»äº†æ¨¡æ€æ¡† ${modalConfig.id} çš„å¤–éƒ¨`);
                            this.handleModalClose(modal, modalConfig);
                        }
                    });
                });
                console.log('æ¨¡æ€æ¡†ç‚¹å‡»å¤–éƒ¨å…³é—­è®¾ç½®å®Œæˆ');
            }
            
            // å¤„ç†æ¨¡æ€æ¡†å…³é—­
            handleModalClose(modal, modalConfig) {
                // æ£€æŸ¥æ˜¯å¦æœ‰è¾“å…¥å†…å®¹
                const hasInput = modalConfig.inputs.some(selector => {
                    const input = document.querySelector(selector);
                    return input && input.value && input.value.trim() !== '';
                });
                
                if (hasInput) {
                    // æœ‰è¾“å…¥å†…å®¹ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦ä¿å­˜
                    this.dialogCallback = (confirmed) => {
                        if (confirmed) {
                            // ç¡®è®¤å…³é—­ï¼Œæ¸…ç©ºè¡¨å•
                            this.clearModalForm(modalConfig);
                            modal.style.display = 'none';
                        }
                        // å–æ¶ˆæ—¶ä¸åšä»»ä½•æ“ä½œ
                    };
                    this.showDialog('ç¡®è®¤å…³é—­', 'æ‚¨æœ‰æœªä¿å­˜çš„å†…å®¹ï¼Œç¡®å®šè¦å…³é—­å—ï¼Ÿ', 'confirm');
                } else {
                    // æ²¡æœ‰è¾“å…¥å†…å®¹ï¼Œç›´æ¥å…³é—­
                    modal.style.display = 'none';
                }
            }
            
            // æ¸…ç©ºæ¨¡æ€æ¡†è¡¨å•
            clearModalForm(modalConfig) {
                modalConfig.inputs.forEach(selector => {
                    const input = document.querySelector(selector);
                    if (input) {
                        input.value = '';
                        this.clearInputError(input);
                    }
                });
            }
            
            // åº”ç”¨ä¸»é¢˜
            applyTheme(themeKey) {
                const theme = this.themePresets[themeKey];
                if (!theme) return;
                
                const root = document.documentElement;
                root.style.setProperty('--primary-color', theme.primary);
                root.style.setProperty('--secondary-color', theme.secondary);
                root.style.setProperty('--accent-color', theme.accent);
                root.style.setProperty('--background-primary', theme.background);
                root.style.setProperty('--background-secondary', theme.backgroundSecondary);
                
                // æš—è‰²ä¸»é¢˜ç‰¹æ®Šå¤„ç†
                if (themeKey === 'dark') {
                    root.style.setProperty('--text-primary', '#f9fafb');
                    root.style.setProperty('--text-secondary', '#d1d5db');
                    root.style.setProperty('--text-light', '#9ca3af');
                    root.style.setProperty('--border-color', '#374151');
                    root.style.setProperty('--background-tertiary', '#1f2937');
                    document.body.style.backgroundColor = theme.backgroundSecondary;
                } else {
                    root.style.setProperty('--text-primary', '#1f2937');
                    root.style.setProperty('--text-secondary', '#6b7280');
                    root.style.setProperty('--text-light', '#9ca3af');
                    root.style.setProperty('--border-color', '#e5e7eb');
                    root.style.setProperty('--background-tertiary', '#f3f4f6');
                    document.body.style.backgroundColor = theme.backgroundSecondary;
                }
                
                this.currentTheme = themeKey;
                localStorage.setItem('wucanglu_theme', themeKey);
            }
            
            // æ¸²æŸ“ä¸»é¢˜é¢„è®¾
            renderThemePresets() {
                const container = document.getElementById('theme-presets');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.keys(this.themePresets).forEach(key => {
                    const theme = this.themePresets[key];
                    const card = document.createElement('div');
                    card.className = 'theme-preset-card';
                    card.dataset.theme = key;
                    card.style.cssText = `
                        padding: 12px;
                        border: 2px solid ${this.currentTheme === key ? theme.primary : '#e5e7eb'};
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: ${this.currentTheme === key ? theme.primary + '10' : 'white'};
                    `;
                    
                    card.innerHTML = `
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            <div style="width: 20px; height: 20px; border-radius: 4px; background: ${theme.primary};"></div>
                            <div style="width: 20px; height: 20px; border-radius: 4px; background: ${theme.secondary};"></div>
                            <div style="width: 20px; height: 20px; border-radius: 4px; background: ${theme.accent};"></div>
                        </div>
                        <div style="font-size: 12px; font-weight: 500; color: #374151;">${theme.name}</div>
                        ${this.currentTheme === key ? '<div style="font-size: 10px; color: ' + theme.primary + '; margin-top: 4px;">âœ“ ä½¿ç”¨ä¸­</div>' : ''}
                    `;
                    
                    card.addEventListener('click', () => {
                        this.applyTheme(key);
                        this.renderThemePresets();
                        this.showToast('ä¸»é¢˜å·²åˆ‡æ¢ï¼', 'success');
                    });
                    
                    container.appendChild(card);
                });
            }
            
            // åˆ‡æ¢å¸ƒå±€
            switchLayout(layout) {
                this.currentLayout = layout;
                localStorage.setItem('wucanglu_layout', layout);
                
                const itemList = document.getElementById('item-list');
                if (!itemList) return;
                
                // ç§»é™¤æ‰€æœ‰å¸ƒå±€ç±»
                itemList.classList.remove('layout-grid', 'layout-list', 'layout-masonry');
                
                // æ·»åŠ æ–°å¸ƒå±€ç±»
                itemList.classList.add(`layout-${layout}`);
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.layout-option').forEach(btn => {
                    if (btn.dataset.layout === layout) {
                        btn.classList.add('active');
                        btn.style.borderColor = '#4361ee';
                        btn.style.background = '#f0f4ff';
                    } else {
                        btn.classList.remove('active');
                        btn.style.borderColor = '#e5e7eb';
                        btn.style.background = 'white';
                    }
                });
                
                // é‡æ–°æ¸²æŸ“ç‰©å“åˆ—è¡¨ä»¥åº”ç”¨æ–°å¸ƒå±€
                const activeTab = document.querySelector('.category-tab.active');
                const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                this.renderItems(currentCategory);
                
                // æ˜¾ç¤ºæç¤º
                const layoutNames = { grid: 'ç½‘æ ¼', list: 'åˆ—è¡¨', masonry: 'ç€‘å¸ƒæµ' };
                this.showToast(`å·²åˆ‡æ¢åˆ°${layoutNames[layout]}å¸ƒå±€`, 'success');
            }
            
            // åˆå§‹åŒ–ä¸»é¢˜å’Œå¸ƒå±€
            initThemeAndLayout() {
                // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
                const savedTheme = localStorage.getItem('wucanglu_theme') || 'default';
                this.currentTheme = savedTheme;
                this.applyTheme(savedTheme);
                
                // åŠ è½½ä¿å­˜çš„å¸ƒå±€
                const savedLayout = localStorage.getItem('wucanglu_layout') || 'grid';
                this.currentLayout = savedLayout;
                
                const itemList = document.getElementById('item-list');
                if (itemList) {
                    itemList.classList.add(`layout-${savedLayout}`);
                }
                
                // æ›´æ–°å¸ƒå±€æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.layout-option').forEach(btn => {
                    if (btn.dataset.layout === savedLayout) {
                        btn.classList.add('active');
                        btn.style.borderColor = '#4361ee';
                        btn.style.background = '#f0f4ff';
                    } else {
                        btn.classList.remove('active');
                        btn.style.borderColor = '#e5e7eb';
                        btn.style.background = 'white';
                    }
                });
            }
            
            // åˆ›å»ºè‡ªå®šä¹‰ä¸»é¢˜
            createCustomTheme() {
                // åˆ›å»ºè‡ªå®šä¹‰ä¸»é¢˜å¯¹è¯æ¡†
                const dialog = document.createElement('div');
                dialog.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px);';
                
                dialog.innerHTML = `
                    <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                        <h4 style="margin-top: 0; margin-bottom: 8px; font-size: 18px; font-weight: 600;">è‡ªå®šä¹‰ä¸»é¢˜</h4>
                        <p style="margin-bottom: 20px; font-size: 13px; color: #6b7280;">é€‰æ‹©é¢œè‰²æ¥åˆ›å»ºä½ çš„ä¸“å±ä¸»é¢˜é…è‰²æ–¹æ¡ˆ</p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">ä¸»é¢˜åç§°</label>
                            <input type="text" id="custom-theme-name" placeholder="æˆ‘çš„ä¸»é¢˜" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">ä¸»è‰²è°ƒ</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">ç”¨äºæŒ‰é’®ã€æ ‡ç­¾ã€æ¿€æ´»çŠ¶æ€ç­‰ä¸»è¦å…ƒç´ </p>
                            <input type="color" id="custom-primary-color" value="#4361ee" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">æ¬¡è¦è‰²</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">ç”¨äºæ¸å˜æ•ˆæœã€å¤´éƒ¨èƒŒæ™¯ç­‰è¾…åŠ©å…ƒç´ </p>
                            <input type="color" id="custom-secondary-color" value="#3f37c9" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">å¼ºè°ƒè‰²</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">ç”¨äºé«˜äº®ã€æ‚¬åœæ•ˆæœç­‰éœ€è¦çªå‡ºçš„å…ƒç´ </p>
                            <input type="color" id="custom-accent-color" value="#4cc9f0" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">èƒŒæ™¯è‰²</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">ç”¨äºé¡µé¢æ•´ä½“èƒŒæ™¯è‰²</p>
                            <input type="color" id="custom-background-color" value="#f9fafb" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <!-- é¢„è§ˆåŒºåŸŸ -->
                        <div style="margin-bottom: 20px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                            <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 12px;">é¢„è§ˆæ•ˆæœ</div>
                            <div id="theme-preview" style="display: flex; gap: 8px; align-items: center;">
                                <div id="preview-primary" style="width: 60px; height: 40px; border-radius: 6px; background: #4361ee; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 500;">ä¸»è‰²</div>
                                <div id="preview-secondary" style="width: 60px; height: 40px; border-radius: 6px; background: #3f37c9; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 500;">æ¬¡è¦</div>
                                <div id="preview-accent" style="width: 60px; height: 40px; border-radius: 6px; background: #4cc9f0; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 500;">å¼ºè°ƒ</div>
                                <div id="preview-background" style="width: 60px; height: 40px; border-radius: 6px; background: #f9fafb; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #374151; font-size: 10px; font-weight: 500;">èƒŒæ™¯</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 12px;">
                            <button id="cancel-custom-theme" class="btn btn-secondary">å–æ¶ˆ</button>
                            <button id="save-custom-theme" class="btn btn-primary">ä¿å­˜ä¸»é¢˜</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // å®æ—¶é¢„è§ˆåŠŸèƒ½
                const primaryInput = dialog.querySelector('#custom-primary-color');
                const secondaryInput = dialog.querySelector('#custom-secondary-color');
                const accentInput = dialog.querySelector('#custom-accent-color');
                const backgroundInput = dialog.querySelector('#custom-background-color');
                
                const previewPrimary = dialog.querySelector('#preview-primary');
                const previewSecondary = dialog.querySelector('#preview-secondary');
                const previewAccent = dialog.querySelector('#preview-accent');
                const previewBackground = dialog.querySelector('#preview-background');
                
                // æ›´æ–°é¢„è§ˆ
                const updatePreview = () => {
                    previewPrimary.style.background = primaryInput.value;
                    previewSecondary.style.background = secondaryInput.value;
                    previewAccent.style.background = accentInput.value;
                    previewBackground.style.background = backgroundInput.value;
                };
                
                primaryInput.addEventListener('input', updatePreview);
                secondaryInput.addEventListener('input', updatePreview);
                accentInput.addEventListener('input', updatePreview);
                backgroundInput.addEventListener('input', updatePreview);
                
                // å–æ¶ˆæŒ‰é’®
                dialog.querySelector('#cancel-custom-theme').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });
                
                // ä¿å­˜æŒ‰é’®
                dialog.querySelector('#save-custom-theme').addEventListener('click', () => {
                    const name = dialog.querySelector('#custom-theme-name').value.trim() || 'è‡ªå®šä¹‰ä¸»é¢˜';
                    const primaryColor = dialog.querySelector('#custom-primary-color').value;
                    const secondaryColor = dialog.querySelector('#custom-secondary-color').value;
                    const accentColor = dialog.querySelector('#custom-accent-color').value;
                    const backgroundColor = dialog.querySelector('#custom-background-color').value;
                    
                    // åˆ›å»ºè‡ªå®šä¹‰ä¸»é¢˜å¯¹è±¡ï¼ˆåŒ¹é…é¢„è®¾ä¸»é¢˜çš„ç»“æ„ï¼‰
                    const customTheme = {
                        name: name,
                        primary: primaryColor,
                        secondary: secondaryColor,
                        accent: accentColor,
                        background: '#ffffff',
                        backgroundSecondary: backgroundColor
                    };
                    
                    // ä¿å­˜åˆ°ä¸»é¢˜é¢„è®¾ä¸­
                    const customKey = 'custom_' + Date.now();
                    this.themePresets[customKey] = customTheme;
                    
                    // åº”ç”¨ä¸»é¢˜
                    this.applyTheme(customKey);
                    
                    // é‡æ–°æ¸²æŸ“ä¸»é¢˜é¢„è®¾
                    this.renderThemePresets();
                    
                    // ä¿å­˜è‡ªå®šä¹‰ä¸»é¢˜åˆ°localStorage
                    const customThemes = JSON.parse(localStorage.getItem('wucanglu_custom_themes') || '{}');
                    customThemes[customKey] = customTheme;
                    localStorage.setItem('wucanglu_custom_themes', JSON.stringify(customThemes));
                    
                    // å…³é—­å¯¹è¯æ¡†
                    document.body.removeChild(dialog);
                    
                    this.showToast('è‡ªå®šä¹‰ä¸»é¢˜å·²ä¿å­˜ï¼', 'success');
                });
                
                // è‡ªåŠ¨èšç„¦åˆ°åç§°è¾“å…¥æ¡†
                setTimeout(() => {
                    dialog.querySelector('#custom-theme-name').focus();
                }, 100);
            }
            
            // è·å–å›¾æ ‡çš„ä¸­æ–‡åç§°
            getIconName(icon) {
                const iconNames = {
                    'ğŸ“¦': 'ç›’å­', 'ğŸ“': 'æ–‡ä»¶å¤¹', 'ğŸ—‚ï¸': 'å¡ç‰‡ç›’', 'ğŸ“‹': 'å‰ªè´´æ¿', 'ğŸ“Œ': 'å›¾é’‰', 'ğŸ”–': 'ä¹¦ç­¾', 'ğŸ·ï¸': 'æ ‡ç­¾', 
                    'âœ¨': 'æ˜Ÿå…‰', 'â­': 'æ˜Ÿæ˜Ÿ', 'ğŸŒŸ': 'é—ªæ˜Ÿ', 'ğŸ’«': 'æµæ˜Ÿ', 'ğŸ¯': 'é¶å¿ƒ', 'ğŸª': 'é©¬æˆå›¢', 'ğŸ¨': 'è°ƒè‰²æ¿', 
                    'ğŸ­': 'é¢å…·', 'ğŸ¬': 'åœºè®°æ¿', 'ğŸ®': 'æ¸¸æˆæœº', 'ğŸ²': 'éª°å­', 'ğŸ°': 'è€è™æœº', 'ğŸ³': 'ä¿é¾„çƒ',
                    'ğŸ’»': 'ç¬”è®°æœ¬', 'âŒ¨ï¸': 'é”®ç›˜', 'ğŸ–¥ï¸': 'å°å¼æœº', 'ğŸ–¨ï¸': 'æ‰“å°æœº', 'ğŸ–±ï¸': 'é¼ æ ‡', 'ğŸ’¾': 'è½¯ç›˜', 'ğŸ’¿': 'å…‰ç›˜', 
                    'ğŸ“±': 'æ‰‹æœº', 'â˜ï¸': 'ç”µè¯', 'ğŸ“': 'è¯ç­’', 'ğŸ“Ÿ': 'ä¼ å‘¼æœº', 'ğŸ“ ': 'ä¼ çœŸæœº', 'ğŸ“º': 'ç”µè§†', 'ğŸ“»': 'æ”¶éŸ³æœº', 
                    'ğŸ™ï¸': 'éº¦å…‹é£', 'ğŸšï¸': 'æ¨å­', 'ğŸ›ï¸': 'æ—‹é’®', 'â±ï¸': 'ç§’è¡¨', 'â°': 'é—¹é’Ÿ', 'â²ï¸': 'è®¡æ—¶å™¨', 'ğŸ”‹': 'ç”µæ± ', 
                    'ğŸ”Œ': 'æ’å¤´', 'ğŸ’¡': 'ç¯æ³¡', 'ğŸ”¦': 'æ‰‹ç”µç­’', 'ğŸ•¯ï¸': 'èœ¡çƒ›', 'ğŸ“·': 'ç›¸æœº', 'ğŸ“¸': 'å¿«ç…§', 'ğŸ“¹': 'æ‘„åƒæœº', 
                    'ğŸ“¼': 'å½•åƒå¸¦', 'ğŸ”': 'æ”¾å¤§é•œ', 'ğŸ”': 'æœç´¢', 'ğŸ”¬': 'æ˜¾å¾®é•œ', 'ğŸ”­': 'æœ›è¿œé•œ', 'ğŸ“¡': 'å«æ˜Ÿå¤©çº¿', 'ğŸ•¹ï¸': 'æ‘‡æ†',
                    'ğŸ‘•': 'Tæ¤', 'ğŸ‘”': 'é¢†å¸¦', 'ğŸ‘—': 'è¿è¡£è£™', 'ğŸ‘™': 'æ¯”åŸºå°¼', 'ğŸ‘š': 'å¥³è£…', 'ğŸ‘›': 'é’±åŒ…', 
                    'ğŸ‘œ': 'æ‰‹æåŒ…', 'ğŸ‘': 'æ‰‹æ‹¿åŒ…', 'ğŸ’': 'ä¹¦åŒ…', 'ğŸ‘': 'çš®é‹', 'ğŸ‘Ÿ': 'è¿åŠ¨é‹', 'ğŸ‘ ': 'é«˜è·Ÿé‹', 'ğŸ‘¡': 'å‡‰é‹', 
                    'ğŸ‘¢': 'é´å­', 'ğŸ‘‘': 'çš‡å† ', 'ğŸ‘’': 'å¥³å¸½', 'ğŸ©': 'ç¤¼å¸½', 'ğŸ“': 'å­¦å£«å¸½', 'ğŸ§¢': 'é¸­èˆŒå¸½', 'â›‘ï¸': 'æ•‘æ´å¸½', 
                    'ğŸ§£': 'å›´å·¾', 'ğŸ§¤': 'æ‰‹å¥—', 'ğŸ§¥': 'å¤–å¥—', 'ğŸ§¦': 'è¢œå­', 'ğŸ‘“': 'çœ¼é•œ', 'ğŸ•¶ï¸': 'å¢¨é•œ', 'ğŸ¥½': 'æŠ¤ç›®é•œ', 'ğŸ¥¼': 'å®éªŒæœ',
                    'ğŸ ': 'æˆ¿å­', 'ğŸ¡': 'å°å±‹', 'ğŸ˜ï¸': 'ä½å®…', 'ğŸšï¸': 'åºŸå±‹', 'ğŸ—ï¸': 'å»ºç­‘', 'ğŸ­': 'å·¥å‚', 'ğŸ¢': 'åŠå…¬æ¥¼', 
                    'ğŸ¬': 'å•†åœº', 'ğŸ£': 'é‚®å±€', 'ğŸ¤': 'é‚®æ”¿', 'ğŸ¥': 'åŒ»é™¢', 'ğŸ¦': 'é“¶è¡Œ', 'ğŸ¨': 'é…’åº—', 'ğŸª': 'ä¾¿åˆ©åº—', 
                    'ğŸ«': 'å­¦æ ¡', 'ğŸ©': 'æƒ…äººæ—…é¦†', 'ğŸ’’': 'å©šç¤¼', 'ğŸ›ï¸': 'åºŠ', 'ğŸ›‹ï¸': 'æ²™å‘', 'ğŸšª': 'é—¨', 'ğŸª‘': 'æ¤…å­', 
                    'ğŸš¿': 'æ·‹æµ´', 'ğŸ›': 'æµ´ç¼¸', 'ğŸš½': 'é©¬æ¡¶', 'ğŸ§»': 'å«ç”Ÿçº¸', 'ğŸ§¼': 'è‚¥çš‚', 'ğŸ§½': 'æµ·ç»µ', 'ğŸ§¹': 'æ‰«å¸š', 
                    'ğŸ§º': 'ç¯®å­', 'ğŸ”‘': 'é’¥åŒ™', 'ğŸ—ï¸': 'è€é’¥åŒ™', 'ğŸ”¨': 'é”¤å­', 'ğŸª“': 'æ–§å¤´', 'â›ï¸': 'é•', 'ğŸ”§': 'æ‰³æ‰‹', 
                    'ğŸ”©': 'èºæ¯', 'âš™ï¸': 'é½¿è½®', 'ğŸ—œï¸': 'å¤¹å…·', 'âš–ï¸': 'å¤©å¹³', 'ğŸ”—': 'é“¾æ¥', 'â›“ï¸': 'é“¾æ¡', 'ğŸ§°': 'å·¥å…·ç®±', 'ğŸ§²': 'ç£é“',
                    'ğŸ’„': 'å£çº¢', 'ğŸ’…': 'æŒ‡ç”²æ²¹', 'ğŸ’': 'æˆ’æŒ‡', 'ğŸ’': 'å®çŸ³', 'ğŸ””': 'é“ƒé“›', 'ğŸ”•': 'é™éŸ³', 'ğŸ“¿': 'å¿µç ', 
                    'ğŸ§´': 'ä¹³æ¶²', 'ğŸ§µ': 'çº¿', 'ğŸ§¶': 'æ¯›çº¿', 'ğŸª¡': 'é’ˆ', 'ğŸª¢': 'ç»³ç»“', 'ğŸ§¿': 'æŠ¤èº«ç¬¦', 'ğŸª¬': 'æ³•è’‚ç›ä¹‹æ‰‹', 
                    'ğŸ’ˆ': 'ç†å‘åº—', 'ğŸª®': 'æ¢³å­', 'ğŸª¥': 'ç‰™åˆ·', 'ğŸª’': 'å‰ƒé¡»åˆ€', 'ğŸ§–': 'æ¡‘æ‹¿', 'ğŸ§—': 'æ”€å²©', 'ğŸ§˜': 'ç‘œä¼½',
                    'ğŸª”': 'æ²¹ç¯', 'ğŸ§¯': 'ç­ç«å™¨', 'ğŸ›¢ï¸': 'æ²¹æ¡¶', 'ğŸ’¸': 'é£é’±', 'ğŸ’µ': 'ç¾å…ƒ', 'ğŸ’´': 'æ—¥å…ƒ', 'ğŸ’¶': 'æ¬§å…ƒ', 
                    'ğŸ’·': 'è‹±é•‘', 'ğŸª™': 'ç¡¬å¸', 'ğŸ’°': 'é’±è¢‹', 'ğŸ’³': 'é“¶è¡Œå¡', 'ğŸ§¾': 'æ”¶æ®',
                    'ğŸ¸': 'å‰ä»–', 'ğŸ¹': 'é’¢ç´', 'ğŸº': 'å°å·', 'ğŸ»': 'å°æç´', 'ğŸª•': 'ç­å“ç´', 'ğŸ¥': 'é¼“', 'ğŸª˜': 'é•¿é¼“', 
                    'ğŸ·': 'è¨å…‹æ–¯', 'ğŸ¤': 'è¯ç­’', 'ğŸ§': 'è€³æœº', 'ğŸ¼': 'ä¹è°±', 'ğŸµ': 'éŸ³ç¬¦', 'ğŸ¶': 'éŸ³ä¹', 'ğŸ“¯': 'å·è§’',
                    'âŒš': 'æ‰‹è¡¨', 'ğŸ–²ï¸': 'è½¨è¿¹çƒ', 'â³': 'æ²™æ¼', 'âŒ›': 'è®¡æ—¶', 'ğŸ§­': 'æŒ‡å—é’ˆ', 'ğŸ¥': 'æ‘„å½±', 'ğŸ“½ï¸': 'æ”¾æ˜ æœº', 
                    'ğŸï¸': 'èƒ¶ç‰‡', 'ğŸ“€': 'DVD',
                    'ğŸŒ±': 'å¹¼è‹—', 'ğŸŒ¿': 'è‰æœ¬', 'â˜˜ï¸': 'ä¸‰å¶è‰', 'ğŸ€': 'å››å¶è‰', 'ğŸ': 'æ¾ç«¹', 'ğŸ‹': 'è®¸æ„¿æ ‘', 'ğŸƒ': 'å¶å­', 
                    'ğŸ‚': 'è½å¶', 'ğŸ': 'æ«å¶', 'ğŸŒ¾': 'ç¨»ç©—', 'ğŸŒº': 'æœ¨æ§¿', 'ğŸŒ»': 'å‘æ—¥è‘µ', 'ğŸŒ¼': 'é›èŠ', 'ğŸŒ·': 'éƒé‡‘é¦™', 
                    'ğŸŒ¹': 'ç«ç‘°', 'ğŸ¥€': 'æ¯è', 'ğŸµï¸': 'èŠ±ç¯', 'ğŸ’': 'èŠ±æŸ', 'ğŸŒ¸': 'æ¨±èŠ±', 'ğŸ’®': 'ç™½èŠ±', 'ğŸ”ï¸': 'é›ªå±±', 
                    'â›°ï¸': 'å±±', 'ğŸŒ‹': 'ç«å±±', 'ğŸ—»': 'å¯Œå£«å±±', 'ğŸ•ï¸': 'éœ²è¥', 'ğŸ–ï¸': 'æµ·æ»©', 'ğŸœï¸': 'æ²™æ¼ ', 'ğŸï¸': 'è’å²›', 
                    'ğŸï¸': 'å›½å®¶å…¬å›­', 'ğŸª¨': 'çŸ³å¤´', 'ğŸªµ': 'æœ¨å¤´', 'ğŸ›–': 'å°å±‹',
                    'ğŸ‘¶': 'å©´å„¿', 'ğŸ‘§': 'å¥³å­©', 'ğŸ§’': 'å„¿ç«¥', 'ğŸ‘¦': 'ç”·å­©', 'ğŸ¼': 'å¥¶ç“¶', 'ğŸ§·': 'å®‰å…¨åˆ«é’ˆ', 'ğŸ§¸': 'æ³°è¿ªç†Š', 
                    'ğŸª€': 'æ‚ æ‚ çƒ', 'ğŸª': 'é£ç­', 'ğŸˆ': 'æ°”çƒ', 'ğŸ€': 'è´è¶ç»“', 'ğŸ': 'ç¤¼ç‰©', 'ğŸŠ': 'å½©çƒ', 'ğŸ‰': 'å½©å¸¦', 
                    'ğŸª…': 'çš®çº³å¡”', 'ğŸª†': 'å¥—å¨ƒ', 'ğŸ§ƒ': 'æœæ±ç›’', 'ğŸ­': 'æ£’æ£’ç³–', 'ğŸ¬': 'ç³–æœ', 'ğŸ«': 'å·§å…‹åŠ›', 'ğŸ‚': 'è›‹ç³•', 'ğŸ§': 'çº¸æ¯è›‹ç³•',
                    'ğŸ¶': 'ç‹—', 'ğŸ•': 'çŠ¬', 'ğŸ¦®': 'å¯¼ç›²çŠ¬', 'ğŸ•â€ğŸ¦º': 'æœåŠ¡çŠ¬', 'ğŸ©': 'è´µå®¾çŠ¬', 'ğŸº': 'ç‹¼', 'ğŸ¦Š': 'ç‹ç‹¸', 
                    'ğŸ¦': 'æµ£ç†Š', 'ğŸ±': 'çŒ«', 'ğŸˆ': 'å®¶çŒ«', 'ğŸˆâ€â¬›': 'é»‘çŒ«', 'ğŸ¦': 'ç‹®å­', 'ğŸ¯': 'è™è„¸', 'ğŸ…': 'è€è™', 
                    'ğŸ†': 'è±¹å­', 'ğŸ´': 'é©¬è„¸', 'ğŸ': 'é©¬', 'ğŸ¦„': 'ç‹¬è§’å…½', 'ğŸ¦“': 'æ–‘é©¬', 'ğŸ¦Œ': 'é¹¿', 'ğŸ¦¬': 'é‡ç‰›', 
                    'ğŸ®': 'ç‰›è„¸', 'ğŸ‚': 'å…¬ç‰›', 'ğŸƒ': 'æ°´ç‰›', 'ğŸ„': 'å¥¶ç‰›', 'ğŸ·': 'çŒªè„¸', 'ğŸ–': 'çŒª', 'ğŸ—': 'é‡çŒª', 
                    'ğŸ½': 'çŒªé¼»', 'ğŸ': 'å…¬ç¾Š', 'ğŸ‘': 'ç»µç¾Š', 'ğŸ': 'å±±ç¾Š', 'ğŸª': 'å•å³°é©¼', 'ğŸ«': 'åŒå³°é©¼', 'ğŸ¦™': 'ç¾Šé©¼', 
                    'ğŸ¦’': 'é•¿é¢ˆé¹¿', 'ğŸ˜': 'å¤§è±¡', 'ğŸ¦£': 'çŒ›çŠ¸è±¡', 'ğŸ¦': 'çŠ€ç‰›', 'ğŸ¦›': 'æ²³é©¬', 'ğŸ­': 'é¼ è„¸', 'ğŸ': 'è€é¼ ', 
                    'ğŸ€': 'å¤§é¼ ', 'ğŸ¹': 'ä»“é¼ ', 'ğŸ°': 'å…”è„¸', 'ğŸ‡': 'å…”å­', 'ğŸ¿ï¸': 'æ¾é¼ ', 'ğŸ¦«': 'æµ·ç‹¸', 'ğŸ¦”': 'åˆºçŒ¬', 
                    'ğŸ¦‡': 'è™è ', 'ğŸ»': 'ç†Š', 'ğŸ¨': 'è€ƒæ‹‰', 'ğŸ¼': 'ç†ŠçŒ«', 'ğŸ¦¥': 'æ ‘æ‡’', 'ğŸ¦¦': 'æ°´ç­', 'ğŸ¦¨': 'è‡­é¼¬', 
                    'ğŸ¦˜': 'è¢‹é¼ ', 'ğŸ¦¡': 'ç¾', 'ğŸ¾': 'çˆªå°',
                    'ğŸ§©': 'æ‹¼å›¾', 'ğŸ“š': 'ä¹¦ç±', 'ğŸ“–': 'ä¹¦æœ¬', 'ğŸ“•': 'çº¢ä¹¦', 'ğŸ“—': 'ç»¿ä¹¦', 'ğŸ“˜': 'è“ä¹¦', 'ğŸ“™': 'æ©™ä¹¦', 
                    'ğŸ““': 'ç¬”è®°æœ¬', 'ğŸ“”': 'æ—¥è®°æœ¬', 'ğŸ“’': 'è´¦æœ¬', 'ğŸ“ƒ': 'æ–‡æ¡£', 'ğŸ“œ': 'å·è½´', 'ğŸ“„': 'é¡µé¢', 'ğŸ“°': 'æŠ¥çº¸', 
                    'ğŸ—ï¸': 'æ–°é—»', 'ğŸ“‘': 'ä¹¦ç­¾æ ‡ç­¾', 'âœ‰ï¸': 'ä¿¡å°', 'ğŸ“§': 'ç”µå­é‚®ä»¶', 'ğŸ“¨': 'æ”¶ä»¶', 'ğŸ“©': 'å‘ä»¶', 
                    'ğŸ“¤': 'å‘ä»¶ç®±', 'ğŸ“¥': 'æ”¶ä»¶ç®±', 'ğŸ“«': 'é‚®ç®±', 'ğŸ“ª': 'é‚®ç®±å…³', 'ğŸ“¬': 'é‚®ç®±å¼€', 'ğŸ“­': 'é‚®ç®±ç©º', 
                    'ğŸ“®': 'é‚®ç­’', 'ğŸ—³ï¸': 'æŠ•ç¥¨ç®±'
                };
                return iconNames[icon] || icon;
            }
            
            // æ·»åŠ åˆ†ç±»
            addCategory() {
                try {
                    console.log('å¼€å§‹æ·»åŠ åˆ†ç±»');
                    
                    // é¢„åˆ¶å›¾æ ‡åº“ï¼ˆå¸¦åç§°ï¼‰
                    const iconLibrary = {
                        'å…¨éƒ¨': ['ğŸ“¦', 'ğŸ“', 'ğŸ—‚ï¸', 'ğŸ“‹', 'ğŸ“Œ', 'ğŸ”–', 'ğŸ·ï¸', 'âœ¨', 'â­', 'ğŸŒŸ', 'ğŸ’«', 'ğŸ¯', 'ğŸª', 'ğŸ¨', 'ğŸ­', 'ğŸ¬', 'ğŸ®', 'ğŸ²', 'ğŸ°', 'ğŸ³'],
                        'æ•°ç ': ['ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“±', 'â˜ï¸', 'ğŸ“', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'â±ï¸', 'â°', 'â²ï¸', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ“¼', 'ğŸ”', 'ğŸ”', 'ğŸ”¬', 'ğŸ”­', 'ğŸ“¡', 'ğŸ®', 'ğŸ•¹ï¸', 'ğŸ°'],
                        'æœé¥°': ['ğŸ‘•', 'ğŸ‘”', 'ğŸ‘—', 'ğŸ‘™', 'ğŸ‘š', 'ğŸ‘›', 'ğŸ‘œ', 'ğŸ‘', 'ğŸ’', 'ğŸ‘', 'ğŸ‘Ÿ', 'ğŸ‘ ', 'ğŸ‘¡', 'ğŸ‘¢', 'ğŸ‘‘', 'ğŸ‘’', 'ğŸ©', 'ğŸ“', 'ğŸ§¢', 'â›‘ï¸', 'ğŸ§£', 'ğŸ§¤', 'ğŸ§¥', 'ğŸ§¦', 'ğŸ‘“', 'ğŸ•¶ï¸', 'ğŸ¥½', 'ğŸ¥¼'],
                        'ç”Ÿæ´»': ['ğŸ ', 'ğŸ¡', 'ğŸ˜ï¸', 'ğŸšï¸', 'ğŸ—ï¸', 'ğŸ­', 'ğŸ¢', 'ğŸ¬', 'ğŸ£', 'ğŸ¤', 'ğŸ¥', 'ğŸ¦', 'ğŸ¨', 'ğŸª', 'ğŸ«', 'ğŸ©', 'ğŸ’’', 'ğŸ›ï¸', 'ğŸ›‹ï¸', 'ğŸšª', 'ğŸª‘', 'ğŸš¿', 'ğŸ›', 'ğŸš½', 'ğŸ§»', 'ğŸ§¼', 'ğŸ§½', 'ğŸ§¹', 'ğŸ§º', 'ğŸ”‘', 'ğŸ—ï¸', 'ğŸ”¨', 'ğŸª“', 'â›ï¸', 'ğŸ”§', 'ğŸ”©', 'âš™ï¸', 'ğŸ—œï¸', 'âš–ï¸', 'ğŸ”—', 'â›“ï¸', 'ğŸ§°', 'ğŸ§²'],
                        'ç¾å¦†': ['ğŸ’„', 'ğŸ’…', 'ğŸ’', 'ğŸ’', 'ğŸ””', 'ğŸ”•', 'ğŸ“¿', 'ğŸ§´', 'ğŸ§µ', 'ğŸ§¶', 'ğŸª¡', 'ğŸª¢', 'ğŸ§¿', 'ğŸª¬', 'ğŸ’ˆ', 'ğŸª®', 'ğŸª¥', 'ğŸª’', 'ğŸ§–', 'ğŸ§—', 'ğŸ§˜'],
                        'å®¶ç”µ': ['ğŸ“º', 'ğŸ“»', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ’¸', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸª™', 'ğŸ’°', 'ğŸ’³', 'ğŸ§¾'],
                        'ä¹å™¨': ['ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸª•', 'ğŸ¥', 'ğŸª˜', 'ğŸ·', 'ğŸ¤', 'ğŸ§', 'ğŸ¼', 'ğŸµ', 'ğŸ¶', 'ğŸ™ï¸', 'ğŸ“»', 'ğŸ“¯', 'ğŸ””', 'ğŸ”•', 'ğŸšï¸', 'ğŸ›ï¸'],
                        'é…é¥°': ['âŒš', 'ğŸ“±', 'ğŸ’»', 'âŒ¨ï¸', 'ğŸ–¥ï¸', 'ğŸ–¨ï¸', 'ğŸ–±ï¸', 'ğŸ–²ï¸', 'ğŸ•¹ï¸', 'ğŸ—œï¸', 'ğŸ’¾', 'ğŸ’¿', 'ğŸ“€', 'ğŸ“¼', 'ğŸ“·', 'ğŸ“¸', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“½ï¸', 'ğŸï¸', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ“º', 'ğŸ“»', 'ğŸ™ï¸', 'ğŸšï¸', 'ğŸ›ï¸', 'ğŸ§­', 'â±ï¸', 'â°', 'â²ï¸', 'â³', 'âŒ›', 'ğŸ“¡', 'ğŸ”‹', 'ğŸ”Œ', 'ğŸ’¡', 'ğŸ”¦', 'ğŸ•¯ï¸', 'ğŸª”', 'ğŸ§¯', 'ğŸ›¢ï¸', 'ğŸ’¸'],
                        'å›­è‰º': ['ğŸŒ±', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€', 'ğŸ', 'ğŸ‹', 'ğŸƒ', 'ğŸ‚', 'ğŸ', 'ğŸŒ¾', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸµï¸', 'ğŸ’', 'ğŸŒ¸', 'ğŸ’®', 'ğŸ”ï¸', 'â›°ï¸', 'ğŸŒ‹', 'ğŸ—»', 'ğŸ•ï¸', 'ğŸ–ï¸', 'ğŸœï¸', 'ğŸï¸', 'ğŸï¸', 'ğŸª¨', 'ğŸªµ', 'ğŸ›–'],
                        'æ¯å©´': ['ğŸ‘¶', 'ğŸ‘§', 'ğŸ§’', 'ğŸ‘¦', 'ğŸ¼', 'ğŸ§·', 'ğŸ§¸', 'ğŸª€', 'ğŸª', 'ğŸˆ', 'ğŸ€', 'ğŸ', 'ğŸŠ', 'ğŸ‰', 'ğŸª…', 'ğŸª†', 'ğŸ§ƒ', 'ğŸ­', 'ğŸ¬', 'ğŸ«', 'ğŸ‚', 'ğŸ§'],
                        'å® ç‰©': ['ğŸ¶', 'ğŸ•', 'ğŸ¦®', 'ğŸ•â€ğŸ¦º', 'ğŸ©', 'ğŸº', 'ğŸ¦Š', 'ğŸ¦', 'ğŸ±', 'ğŸˆ', 'ğŸˆâ€â¬›', 'ğŸ¦', 'ğŸ¯', 'ğŸ…', 'ğŸ†', 'ğŸ´', 'ğŸ', 'ğŸ¦„', 'ğŸ¦“', 'ğŸ¦Œ', 'ğŸ¦¬', 'ğŸ®', 'ğŸ‚', 'ğŸƒ', 'ğŸ„', 'ğŸ·', 'ğŸ–', 'ğŸ—', 'ğŸ½', 'ğŸ', 'ğŸ‘', 'ğŸ', 'ğŸª', 'ğŸ«', 'ğŸ¦™', 'ğŸ¦’', 'ğŸ˜', 'ğŸ¦£', 'ğŸ¦', 'ğŸ¦›', 'ğŸ­', 'ğŸ', 'ğŸ€', 'ğŸ¹', 'ğŸ°', 'ğŸ‡', 'ğŸ¿ï¸', 'ğŸ¦«', 'ğŸ¦”', 'ğŸ¦‡', 'ğŸ»', 'ğŸ¨', 'ğŸ¼', 'ğŸ¦¥', 'ğŸ¦¦', 'ğŸ¦¨', 'ğŸ¦˜', 'ğŸ¦¡', 'ğŸ¾'],
                        'å…¶ä»–': ['ğŸ¯', 'ğŸª', 'ğŸ¨', 'ğŸ­', 'ğŸ¬', 'ğŸ®', 'ğŸ²', 'ğŸ°', 'ğŸ³', 'ğŸ§©', 'ğŸ§¸', 'ğŸª€', 'ğŸª', 'ğŸˆ', 'ğŸ€', 'ğŸ', 'ğŸŠ', 'ğŸ‰', 'ğŸª…', 'ğŸª†', 'ğŸ“š', 'ğŸ“–', 'ğŸ“•', 'ğŸ“—', 'ğŸ“˜', 'ğŸ“™', 'ğŸ““', 'ğŸ“”', 'ğŸ“’', 'ğŸ“ƒ', 'ğŸ“œ', 'ğŸ“„', 'ğŸ“°', 'ğŸ—ï¸', 'ğŸ“‘', 'ğŸ”–', 'ğŸ·ï¸', 'ğŸ’°', 'ğŸ’´', 'ğŸ’µ', 'ğŸ’¶', 'ğŸ’·', 'ğŸ’¸', 'ğŸ’³', 'ğŸ§¾', 'âœ‰ï¸', 'ğŸ“§', 'ğŸ“¨', 'ğŸ“©', 'ğŸ“¤', 'ğŸ“¥', 'ğŸ“¦', 'ğŸ“«', 'ğŸ“ª', 'ğŸ“¬', 'ğŸ“­', 'ğŸ“®', 'ğŸ—³ï¸']
                    };
                    
                    // åˆ›å»ºè‡ªå®šä¹‰å¯¹è¯æ¡†
                    const dialog = document.createElement('div');
                    dialog.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px);';
                    
                    dialog.innerHTML = `
                        <div style="background-color: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                            <h4 style="margin-top: 0; margin-bottom: 16px; font-size: 18px; font-weight: 600;">æ·»åŠ åˆ†ç±»</h4>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">åˆ†ç±»åç§°</label>
                                <input type="text" id="category-name-input" placeholder="è¯·è¾“å…¥åˆ†ç±»åç§°" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">åˆ†ç±»å›¾æ ‡</label>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div id="selected-icon-display" style="width: 48px; height: 48px; border: 2px solid #4361ee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: #f0f4ff;">ğŸ“¦</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #374151; font-size: 14px;" id="selected-icon-name">ç›’å­</div>
                                        <div style="color: #9ca3af; font-size: 12px;">ç‚¹å‡»ä¸‹æ–¹å›¾æ ‡é€‰æ‹©</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <div id="icon-category-tabs" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                                        ${Object.keys(iconLibrary).map(cat => 
                                            `<button class="icon-category-tab ${cat === 'å…¨éƒ¨' ? 'active' : ''}" data-category="${cat}" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 16px; background: ${cat === 'å…¨éƒ¨' ? '#4361ee' : 'white'}; color: ${cat === 'å…¨éƒ¨' ? 'white' : '#374151'}; font-size: 12px; cursor: pointer; transition: all 0.2s;">${cat}</button>`
                                        ).join('')}
                                    </div>
                                </div>
                                <div id="icon-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; max-height: 240px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    ${iconLibrary['å…¨éƒ¨'].map(icon => 
                                        `<div class="icon-option" data-icon="${icon}" style="display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; border: 2px solid transparent;">
                                            <div style="font-size: 28px; margin-bottom: 2px;">${icon}</div>
                                            <div style="font-size: 11px; color: #6b7280; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.getIconName(icon)}</div>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                                <button id="category-cancel-btn" class="btn btn-secondary">å–æ¶ˆ</button>
                                <button id="category-confirm-btn" class="btn btn-primary">ç¡®å®š</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(dialog);
                    
                    const nameInput = dialog.querySelector('#category-name-input');
                    const iconDisplay = dialog.querySelector('#selected-icon-display');
                    const iconNameDisplay = dialog.querySelector('#selected-icon-name');
                    const iconGrid = dialog.querySelector('#icon-grid');
                    const categoryTabs = dialog.querySelectorAll('.icon-category-tab');
                    const cancelBtn = dialog.querySelector('#category-cancel-btn');
                    const confirmBtn = dialog.querySelector('#category-confirm-btn');
                    
                    let selectedIcon = 'ğŸ“¦';
                    
                    // è‡ªåŠ¨èšç„¦åˆ°åç§°è¾“å…¥æ¡†
                    setTimeout(() => nameInput.focus(), 100);
                    
                    // å›¾æ ‡åˆ†ç±»åˆ‡æ¢
                    categoryTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            // æ›´æ–°æ¿€æ´»çŠ¶æ€
                            categoryTabs.forEach(t => {
                                t.classList.remove('active');
                                t.style.background = 'white';
                                t.style.color = '#374151';
                            });
                            tab.classList.add('active');
                            tab.style.background = '#4361ee';
                            tab.style.color = 'white';
                            
                            // æ›´æ–°å›¾æ ‡ç½‘æ ¼
                            const category = tab.dataset.category;
                            iconGrid.innerHTML = iconLibrary[category].map(icon => 
                                `<div class="icon-option" data-icon="${icon}" style="display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; border: 2px solid transparent;">
                                    <div style="font-size: 28px; margin-bottom: 2px;">${icon}</div>
                                    <div style="font-size: 11px; color: #6b7280; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.getIconName(icon)}</div>
                                </div>`
                            ).join('');
                            
                            // é‡æ–°ç»‘å®šå›¾æ ‡ç‚¹å‡»äº‹ä»¶
                            bindIconClickEvents();
                        });
                    });
                    
                    // ç»‘å®šå›¾æ ‡ç‚¹å‡»äº‹ä»¶
                    function bindIconClickEvents() {
                        const iconOptions = dialog.querySelectorAll('.icon-option');
                        iconOptions.forEach(option => {
                            option.addEventListener('click', () => {
                                selectedIcon = option.dataset.icon;
                                iconDisplay.textContent = selectedIcon;
                                iconNameDisplay.textContent = this.getIconName(selectedIcon);
                                
                                // æ›´æ–°é€‰ä¸­çŠ¶æ€
                                iconOptions.forEach(opt => {
                                    opt.style.border = '2px solid transparent';
                                    opt.style.background = 'transparent';
                                });
                                option.style.border = '2px solid #4361ee';
                                option.style.background = '#f0f4ff';
                            });
                            
                            // æ‚¬åœæ•ˆæœ
                            option.addEventListener('mouseenter', () => {
                                if (option.dataset.icon !== selectedIcon) {
                                    option.style.background = '#e5e7eb';
                                }
                            });
                            option.addEventListener('mouseleave', () => {
                                if (option.dataset.icon !== selectedIcon) {
                                    option.style.background = 'transparent';
                                }
                            });
                        });
                    }
                    
                    bindIconClickEvents();
                    
                    // å–æ¶ˆæŒ‰é’®
                    cancelBtn.addEventListener('click', () => {
                        document.body.removeChild(dialog);
                    });
                    
                    // ç¡®å®šæŒ‰é’®
                    confirmBtn.addEventListener('click', () => {
                        const categoryName = nameInput.value.trim();
                        
                        // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯
                        this.clearInputError(nameInput);
                        
                        if (!categoryName) {
                            this.showInputError(nameInput, 'è¯·è¾“å…¥åˆ†ç±»åç§°');
                            return;
                        }
                        
                        console.log('å¼€å§‹æ·»åŠ åˆ†ç±»:', categoryName, selectedIcon);
                        const result = this.storage.addCategory({ name: categoryName, icon: selectedIcon });
                        console.log('æ·»åŠ åˆ†ç±»ç»“æœ:', result);
                        
                        if (result) {
                            // é‡æ–°æ¸²æŸ“åˆ†ç±»åˆ—è¡¨
                            this.renderCategories();
                            
                            // é‡æ–°æ¸²æŸ“åˆ†ç±»æ ‡ç­¾
                            this.renderCategoryTabs();
                            
                            // é‡æ–°åˆå§‹åŒ–ä¸‹æ‹‰æ¡†ï¼Œæ˜¾ç¤ºæ–°æ·»åŠ çš„åˆ†ç±»
                            this.initCustomSelects();
                            
                            console.log('åˆ†ç±»æ·»åŠ å®Œæˆ');
                            this.showToast('åˆ†ç±»æ·»åŠ æˆåŠŸï¼', 'success');
                            
                            document.body.removeChild(dialog);
                        } else {
                            console.error('åˆ†ç±»æ·»åŠ å¤±è´¥');
                            this.showToast('åˆ†ç±»æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•ï¼', 'error');
                        }
                    });
                    
                    // æ”¯æŒå›è½¦é”®ç¡®è®¤
                    nameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            confirmBtn.click();
                        }
                    });
                    
                } catch (error) {
                    console.error('addCategoryæ–¹æ³•æ‰§è¡Œå¤±è´¥:', error);
                    this.showToast('æ·»åŠ åˆ†ç±»æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·é‡è¯•ï¼', 'error');
                }
            }
            
            // å¯¼å‡ºæ•°æ®
            exportData() {
                const data = this.storage.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ç‰©è—å½•æ•°æ®_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            // å¯¼å…¥æ•°æ®
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const result = this.storage.importData(event.target.result);
                            if (result) {
                                alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                                this.renderItems();
                                this.renderCategories();
                                this.renderChannels();
                                this.initChannelSelects();
                                this.renderCategoryTabs();
                                this.updateStats();
                            } else {
                                alert('æ•°æ®å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
                input.click();
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨');
                const app = new App();
                app.init();

                // æš´éœ²è®¢é˜… UI ä¸ºå…¨å±€å˜é‡ï¼Œä¾› HTML ä¸­çš„ onclick äº‹ä»¶ä½¿ç”¨
                window.subscriptionUI = app.subscriptionUI;

                console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
            } catch (error) {
                console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
            }
        });
    </script>
</body>
</html>