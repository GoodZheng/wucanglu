<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>物藏录</title>
    <script src="chart.min.js"></script>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* 自定义属性 */
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --accent-color: #4cc9f0;
            --success-color: #4ade80;
            --danger-color: #f87171;
            --warning-color: #fbbf24;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-light: #9ca3af;
            --background-primary: #ffffff;
            --background-secondary: #f9fafb;
            --background-tertiary: #f3f4f6;
            --border-color: #e5e7eb;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --transition: all 0.3s ease;
        }
        
        /* 基础样式 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--background-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* 应用容器 */
        .app-container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 头部 */
        .app-header {
            box-shadow: var(--box-shadow);
        }
        
        .app-header h1 {
            font-size: 24px;
            font-weight: 700;
            margin: 0;
            letter-spacing: -0.5px;
        }
        
        /* 头部按钮悬停效果 */
        .header-action-btn:hover {
            background: rgba(255,255,255,0.25) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .header-action-btn:active {
            transform: translateY(0);
        }
        
        /* 内容区域 */
        .app-content {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* 导航标签 */
        .tab-container {
            display: flex;
            background-color: var(--background-primary);
            border-bottom: 2px solid var(--border-color);
            padding: 0 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .tab {
            padding: 18px 32px;
            cursor: pointer;
            font-weight: 500;
            font-size: 15px;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            background: transparent;
        }
        
        .tab:hover {
            color: var(--primary-color);
            background-color: rgba(67, 97, 238, 0.05);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            border-radius: 3px 3px 0 0;
        }
        
        /* 面板内容 */
        .panel {
            display: none;
            padding: 16px 24px;
            flex: 1;
            overflow-y: auto;
            width: 100%;
        }
        
        .panel.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        /* 标题样式 */
        h3 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }
        
        /* 分类标签 */
        .category-tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        
        .category-tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .category-tabs::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .category-tabs::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 2px;
        }
        
        .category-tab {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            background: var(--background-primary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            white-space: nowrap;
            transition: var(--transition);
        }
        
        .category-tab:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        
        .category-tab.active {
            background: var(--primary-color);
            color: white !important;
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        /* 添加物品按钮 */
        .add-item-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-size: 28px;
            border: none;
            cursor: pointer;
            box-shadow: var(--box-shadow-hover);
            transition: var(--transition);
            z-index: 100;
            display: none; /* 默认隐藏，由 data-active-tab 属性控制显示 */
            align-items: center;
            justify-content: center;
        }
        
        .add-item-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px -5px rgba(67, 97, 238, 0.3);
        }

        /* 添加订阅按钮 */
        .add-subscription-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white;
            font-size: 28px;
            border: none;
            cursor: pointer;
            box-shadow: var(--box-shadow-hover);
            transition: var(--transition);
            z-index: 100;
            display: none; /* 默认隐藏 */
            align-items: center;
            justify-content: center;
            pointer-events: auto;
        }

        .add-subscription-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 20px -5px rgba(67, 97, 238, 0.3);
        }

        /* 根据标签页控制添加按钮显示 */
        /* 只在物品页面显示添加物品按钮 */
        body[data-active-tab="items"] .add-item-btn {
            display: flex !important;
        }

        /* 只在订阅页面显示添加订阅按钮 */
        body[data-active-tab="subscription"] .add-subscription-btn {
            display: flex !important;
        }

        /* 在分析和设置页面隐藏所有添加按钮 */
        body[data-active-tab="analytics"] .add-item-btn,
        body[data-active-tab="analytics"] .add-subscription-btn,
        body[data-active-tab="settings"] .add-item-btn,
        body[data-active-tab="settings"] .add-subscription-btn {
            display: none !important;
        }

        /* 分析类型分段控制器 */
        .analytics-toggle {
            display: inline-flex;
            background: var(--background-tertiary);
            padding: 4px;
            border-radius: 14px;
            gap: 4px;
        }

        .analytics-toggle-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.25s ease;
            user-select: none;
        }

        .analytics-toggle-option:hover {
            color: var(--text-primary);
        }

        .analytics-toggle-option.active {
            background: var(--background-primary);
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .analytics-toggle-option .toggle-icon {
            font-size: 16px;
        }

        /* 物品列表 */
        .item-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
            align-items: start;
            contain: layout;
        }
        
        /* 网格布局（默认） */
        .item-list.layout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
        }
        
        /* 列表布局 */
        .item-list.layout-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .item-list.layout-list .item-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 16px;
        }
        
        .item-list.layout-list .item-header {
            flex: 1;
            margin-bottom: 0;
        }
        
        .item-list.layout-list .item-footer {
            margin-top: 0;
            margin-left: 16px;
        }
        
        /* 瀑布流布局 */
        .item-list.layout-masonry {
            column-count: 3;
            column-gap: 16px;
        }
        
        .item-list.layout-masonry .item-card {
            break-inside: avoid;
            margin-bottom: 16px;
        }
        
        @media (max-width: 1024px) {
            .item-list.layout-masonry {
                column-count: 2;
            }
        }
        
        @media (max-width: 768px) {
            .item-list.layout-masonry {
                column-count: 1;
            }
        }
        
        /* 物品卡片 */
        .item-card {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--primary-color), transparent);
            transition: left 0.5s ease;
        }
        
        .item-card:hover::before {
            left: 100%;
        }
        
        .item-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--box-shadow-hover);
            border-color: var(--primary-color);
        }
        
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1 1 auto;
            min-width: 0;
            margin-right: 8px;
            overflow: hidden;
        }

        .item-name span:not(.item-icon) {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .item-days {
            font-size: 11px;
            color: var(--text-secondary);
            background: rgba(76, 201, 240, 0.1);
            padding: 3px 8px;
            border-radius: 10px;
            white-space: nowrap;
        }
        
        .item-category {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 500;
            margin-bottom: 6px;
            background: rgba(67, 97, 238, 0.1);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
        }
        
        .item-desc {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
        }
        
        .item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .item-price-unit {
            font-size: 11px;
            color: var(--text-secondary);
            margin-left: 2px;
        }
        
        .item-price-info .price {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--background-primary);
        }
        
        /* 自定义下拉框组件 */
        .custom-select {
            position: relative;
            margin-bottom: 20px;
        }
        
        .custom-select select {
            display: none;
        }
        
        .custom-select-trigger {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--background-primary);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .custom-select-trigger::after {
            content: '';
            width: 12px;
            height: 6px;
            background-image: url('data:image/svg+xml;charset=UTF-8,%3csvg xmlns="http://www.w3.org/2000/svg" width="12" height="6" viewBox="0 0 12 6" fill="none"%3e%3cpath d="M1 1l5 4 5-4" stroke="%236b7280" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/%3e%3c/svg%3e');
            background-repeat: no-repeat;
            background-position: center;
            background-size: 100% 100%;
            transition: transform 0.3s ease;
        }
        
        .custom-select.open .custom-select-trigger::after {
            transform: rotate(180deg);
        }
        
        .custom-select-trigger:hover {
            border-color: var(--primary-color);
        }
        
        .custom-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 8px;
            background: var(--background-primary);
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .custom-select.open .custom-select-options {
            display: block;
            animation: fadeIn 0.2s ease;
        }
        
        .custom-select-option {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .custom-select-option:hover {
            background-color: rgba(67, 97, 238, 0.1);
        }
        
        .custom-select-option.selected {
            background-color: rgba(67, 97, 238, 0.1);
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .custom-select-options::-webkit-scrollbar {
            width: 4px;
        }
        
        .custom-select-options::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .custom-select-options::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        /* 按钮样式 */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .btn-secondary {
            background: var(--background-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #ef4444);
            color: white;
            border: none;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(248, 113, 113, 0.3);
        }
        
        /* 分类列表 */
        .category-list {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* 购买渠道列表 */
        .channel-list {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        /* 快捷管理卡片 */
        .quick-manage-card {
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--box-shadow);
        }

        .quick-manage-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .quick-manage-card button {
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }

        .quick-manage-card:hover button {
            opacity: 1;
        }

        /* 管理弹窗样式 */
        #category-manage-modal,
        #channel-manage-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #category-manage-modal.active,
        #channel-manage-modal.active {
            display: flex;
        }

        #category-manage-modal > div,
        #channel-manage-modal > div {
            background: var(--background-primary);
            border-radius: 16px;
            padding: 28px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* 管理列表项样式 */
        .manage-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .manage-item:last-child {
            border-bottom: none;
        }

        .manage-item:hover {
            background: var(--background-secondary);
            border-radius: 8px;
            margin: 0 -4px;
            padding-left: 20px;
            padding-right: 20px;
        }

        .manage-item-name {
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .manage-item-actions {
            display: flex;
            gap: 8px;
        }

        .manage-item-actions button {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .manage-item-actions button.edit {
            background: var(--primary-color);
            color: white;
        }

        .manage-item-actions button.edit:hover {
            background: var(--primary-color);
            opacity: 0.8;
        }

        .manage-item-actions button.delete {
            background: #ef4444;
            color: white;
        }

        .manage-item-actions button.delete:hover {
            background: #dc3545;
        }

        /* 订阅管理弹窗样式 */
        #subscription-modal,
        #icon-picker-modal,
        #subscription-category-manage-modal,
        #billing-date-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        #subscription-modal.active,
        #icon-picker-modal.active,
        #subscription-category-manage-modal.active,
        #billing-date-detail-modal.active {
            display: flex;
        }

        /* 订阅卡片样式 */
        .subscription-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 16px;
            align-items: start;
            contain: layout;
        }

        .subscription-card {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .subscription-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
            border-color: var(--primary-color);
        }

        .subscription-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-color);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .subscription-card:hover::before {
            opacity: 1;
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .subscription-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 0;
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .subscription-name span:not(.subscription-icon) {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subscription-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .subscription-category {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 500;
            background: rgba(67, 97, 238, 0.1);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .subscription-footer {
            margin-top: auto;
            padding-top: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .subscription-price {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .subscription-price-unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 2px;
        }

        .subscription-billing {
            font-size: 11px;
            color: var(--text-secondary);
            margin: 0;
            text-align: right;
        }

        .subscription-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: var(--box-shadow-hover);
            border-color: var(--primary-color);
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .subscription-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            flex: 1 1 auto;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .subscription-name span:not(.subscription-icon) {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subscription-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .subscription-category {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: 500;
            background: rgba(67, 97, 238, 0.1);
            display: inline-block;
            padding: 2px 8px;
            border-radius: 8px;
            flex-shrink: 0;
            white-space: nowrap;
        }

        .subscription-price {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 8px 0;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subscription-price-unit {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 2px;
        }

        .subscription-billing {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            width: 100%;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subscription-billing.soon {
            color: #f59e0b;
            font-weight: 500;
        }

        .subscription-billing.urgent {
            color: #ef4444;
            font-weight: 600;
        }

        .subscription-billing.soon {
            color: #f59e0b;
            font-weight: 500;
        }

        /* 日历样式 */
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2px;
            border-radius: 4px;
            background: var(--background-primary);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .calendar-day:hover {
            border-color: var(--primary-color);
            background: var(--background-secondary);
        }

        .calendar-day.empty {
            background: transparent;
            border: none;
            cursor: default;
        }

        .calendar-day.today {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }

        .calendar-day.has-billing {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
        }

        .day-number {
            font-weight: 600;
            font-size: 11px;
            margin-bottom: 1px;
            line-height: 1.2;
        }

        .billing-dots {
            display: flex;
            flex-wrap: wrap;
            gap: 1px;
            justify-content: center;
        }

        .billing-dot {
            font-size: 9px;
            cursor: pointer;
            transition: transform 0.2s ease;
            line-height: 1;
        }

        .billing-dot:hover {
            transform: scale(1.2);
        }

        /* 图标选择器样式 */
        .icon-category-tab {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: var(--background-primary);
            border-radius: 16px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .icon-category-tab:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .icon-category-tab.active {
            background: var(--primary-color);
            color: white !important;
            border-color: var(--primary-color);
        }

        .icon-picker-icon {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: var(--background-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-picker-icon:hover {
            border-color: var(--primary-color);
            background: var(--background-tertiary);
        }

        .icon-picker-icon.selected {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.1);
        }

        /* 扣费详情列表 */
        .billing-detail-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .billing-detail-item:last-child {
            border-bottom: none;
        }

        .billing-detail-info {
            flex: 1;
        }

        .billing-detail-name {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .billing-detail-price {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .billing-detail-actions {
            display: flex;
            gap: 8px;
        }

        .billing-detail-actions button {
            padding: 6px 12px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .billing-detail-actions button.edit {
            background: var(--primary-color);
            color: white;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 14px;
            color: var(--text-light);
        }

        .category-item {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }
        
        .category-item:hover {
            background: var(--background-secondary);
            border-radius: 8px;
            margin: 0 -8px;
            padding-left: 24px;
            padding-right: 24px;
        }
        
        .category-item:last-child {
            border-bottom: none;
        }
        
        .category-name {
            font-weight: 500;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .category-icon {
            font-size: 24px;
        }
        
        .category-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            padding: 8px 16px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        
        .action-btn.edit {
            background: rgba(33, 150, 243, 0.1);
            color: #2196F3;
        }
        
        .action-btn.edit:hover {
            background: rgba(33, 150, 243, 0.2);
        }
        
        .action-btn.delete {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
        }
        
        .action-btn.delete:hover {
            background: rgba(244, 67, 54, 0.2);
        }
        
        /* 模态框样式 */
        #add-item-modal,
        #item-detail-modal,
        #subscription-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        #add-item-modal.active,
        #item-detail-modal.active,
        #subscription-detail-modal.active {
            display: flex;
        }

        #add-item-modal > div,
        #item-detail-modal > div,
        #subscription-detail-modal > div {
            background: var(--background-primary);
            border-radius: 16px;
            padding: 28px;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        #add-item-modal > div::-webkit-scrollbar,
        #item-detail-modal > div::-webkit-scrollbar,
        #subscription-detail-modal > div::-webkit-scrollbar {
            width: 4px;
        }

        #add-item-modal > div::-webkit-scrollbar-track,
        #item-detail-modal > div::-webkit-scrollbar-track,
        #subscription-detail-modal > div::-webkit-scrollbar-track {
            background: transparent;
        }

        #add-item-modal > div::-webkit-scrollbar-thumb,
        #item-detail-modal > div::-webkit-scrollbar-thumb,
        #subscription-detail-modal > div::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 2px;
        }

        #add-item-modal > div::-webkit-scrollbar-thumb:hover,
        #item-detail-modal > div::-webkit-scrollbar-thumb:hover,
        #subscription-detail-modal > div::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #add-item-modal h3,
        #item-detail-modal h3,
        #subscription-detail-modal h3 {
            margin-bottom: 24px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* 自定义对话框 */
        #custom-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }
        
        #custom-dialog > div {
            background: var(--background-primary);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        #dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        #dialog-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }
        
        #dialog-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 24px;
            transition: var(--transition);
        }
        
        #dialog-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }
        
        /* 底部操作区 */
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 24px;
        }
        
        /* 拖拽样式 */
        .item-card {
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        opacity 0.3s ease,
                        box-shadow 0.3s ease;
        }
        
        .item-card.dragging {
            opacity: 0.15;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .item-card.placeholder {
            opacity: 0.3;
            transform: scale(0.95);
        }
        
        .item-card.drag-over {
            transform: translateX(10px);
        }
        
        .item-card:hover {
            cursor: grab;
        }
        
        .item-card:active {
            cursor: grabbing;
        }
        
        /* 设置页面 */
        .settings-section {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        
        .settings-section h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        .settings-section p {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .panel {
                padding: 16px;
            }
            
            .tab-container {
                padding: 0 16px;
            }
            
            .tab {
                padding: 14px 20px;
                font-size: 14px;
            }
            
            h3 {
                font-size: 20px;
            }
            
            .item-list {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .add-item-btn {
                width: 56px;
                height: 56px;
                font-size: 24px;
                bottom: 24px;
                right: 24px;
            }
            
            #add-item-modal > div,
            #item-detail-modal > div,
            #subscription-detail-modal > div,
            #custom-dialog > div {
                padding: 24px;
                width: 95%;
            }
            
            /* 头部响应式 */
            .app-header h1 {
                font-size: 18px !important;
            }
            
            .app-header > div {
                padding: 12px 16px !important;
            }
            
            .app-header > div > div:first-child {
                margin-bottom: 10px !important;
            }
        }
        
        @media (max-width: 480px) {
            .app-header h1 {
                font-size: 20px;
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-actions .btn {
                width: 100%;
            }
        }
        
        /* 玻璃拟态效果（可选） */
        .glass-effect {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        /* 加载动画 */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        /* 输入验证错误样式 */
        .input-error {
            border-color: #ef4444 !important;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .error-message {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .error-message.show {
            display: block;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-state h4 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }
        
        .empty-state p {
            font-size: 14px;
        }
        
        /* 布局选项按钮 */
        .layout-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .layout-option:hover {
            border-color: #4361ee;
            background: #f0f4ff;
            transform: translateY(-2px);
        }
        
        .layout-option.active {
            border-color: #4361ee;
            background: #f0f4ff;
        }
        
        /* 统计卡片 */
        .stats-card {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: var(--transition);
        }
        
        /* 统计卡片容器 */
        .item-stats-cards,
        .subscription-stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            min-height: 96px;
        }
        
        .stats-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-hover);
        }
        
        .stats-icon {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            flex-shrink: 0;
        }
        
        .stats-content {
            flex: 1;
            min-width: 0;
        }
        
        .stats-label {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .stats-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
            min-width: 60px;
        }
        
        /* 图表容器 */
        .chart-container {
            background: var(--background-primary);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }
        
        .chart-container canvas {
            max-height: 300px;
        }

        /* 日均成本提示样式 */
        .daily-cost-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
            cursor: help;
        }

        .daily-cost-tooltip .tooltip-icon {
            width: 16px;
            height: 16px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            margin-left: 4px;
            transition: all 0.2s;
        }

        .daily-cost-tooltip:hover .tooltip-icon {
            background: rgba(255,255,255,0.5);
        }

        .daily-cost-tooltip .tooltip-content {
            visibility: hidden;
            opacity: 0;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 100;
            transition: all 0.2s;
            pointer-events: none;
            line-height: 1.4;
        }

        .daily-cost-tooltip:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }

        .daily-cost-tooltip .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0,0,0,0.85);
        }
    </style>
    
    <!-- 自定义弹出框 -->
    <div id="custom-dialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 400px;">
            <h4 id="dialog-title" style="margin-top: 0; margin-bottom: 16px;"></h4>
            <p id="dialog-message" style="margin-bottom: 20px;"></p>
            <input type="text" id="dialog-input" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; display: none;">
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button id="dialog-cancel" class="btn btn-secondary">取消</button>
                <button id="dialog-confirm" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); padding: 14px 24px; color: white;">
                <!-- 第一行：标题和物品总数 -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <h1 style="margin: 0; font-size: 22px; font-weight: 700; letter-spacing: 0.5px;">物藏录</h1>
                        <div style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 16px; font-size: 12px; font-weight: 500; backdrop-filter: blur(10px);">
                            共 <span id="total-items-count" style="font-weight: 700;">0</span> 件物品、<span id="total-subscriptions-count" style="font-weight: 700;">0</span> 个订阅
                        </div>
                    </div>
                    
                    <!-- 右侧按钮 -->
                    <div style="display: flex; gap: 8px;">
                        <button class="header-action-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 12px; padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; backdrop-filter: blur(10px);">
                            <span style="margin-right: 3px;">🔍</span>筛选
                        </button>
                        <button class="header-action-btn" style="background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; font-size: 12px; padding: 6px 14px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-weight: 500; backdrop-filter: blur(10px);">
                            <span style="margin-right: 3px;">📊</span>排序
                        </button>
                    </div>
                </div>
                
                <!-- 第二行：统计卡片 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px;">
                    <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">💰</div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; opacity: 0.85; margin-bottom: 2px; font-weight: 500;">总资产</div>
                                <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.3px;" id="total-assets">¥0.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">📅</div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; opacity: 0.85; margin-bottom: 2px; font-weight: 500; display: flex; align-items: center; gap: 4px;">
                                    <span class="daily-cost-tooltip">
                                        日均成本
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">包含物品和订阅项目的成本</span>
                                    </span>
                                </div>
                                <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.3px;" id="daily-average">¥0.00/天</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.15); padding: 10px 14px; border-radius: 10px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 36px; height: 36px; background: rgba(255,255,255,0.25); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px;">📊</div>
                            <div style="flex: 1;">
                                <div style="font-size: 11px; opacity: 0.85; margin-bottom: 2px; font-weight: 500;">平均价格</div>
                                <div style="font-size: 16px; font-weight: 700; letter-spacing: 0.3px;" id="avg-price">¥0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="app-content">
            <div class="tab-container">
                <div class="tab active" data-tab="items">物品</div>
                <div class="tab" data-tab="subscription">订阅</div>
                <div class="tab" data-tab="analytics">分析</div>
                <div class="tab" data-tab="settings">我的</div>
            </div>
            
            <div class="panel active" id="items-panel">
                <!-- 快速统计卡片 -->
                <div class="item-stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">📦</div>
                        <div class="stats-content">
                            <div class="stats-label">物品总数</div>
                            <div class="stats-value" id="item-total-count">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">📅</div>
                        <div class="stats-content">
                            <div class="stats-label">本月新增</div>
                            <div class="stats-value" id="item-monthly-new">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">📆</div>
                        <div class="stats-content">
                            <div class="stats-label">年度新增</div>
                            <div class="stats-value" id="item-yearly-new">0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">💰</div>
                        <div class="stats-content">
                            <div class="stats-label">总价值</div>
                            <div class="stats-value" id="item-total-value">¥0</div>
                        </div>
                    </div>
                </div>

                <!-- 物品分类标签和操作 -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="category-tabs" style="margin-bottom: 0;">
                        <button class="category-tab active" data-category="all">全部</button>
                        <!-- 分类标签将通过JavaScript动态生成 -->
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button id="manage-categories-btn" class="btn btn-secondary" style="padding: 8px 16px;">📁 管理分类</button>
                        <button id="manage-channels-btn" class="btn btn-secondary" style="padding: 8px 16px;">🛒 管理购买方式</button>
                    </div>
                </div>

                <div class="item-list" id="item-list">
                    <!-- 物品卡片将通过JavaScript动态生成 -->
                </div>
            </div>

            <!-- 订阅管理面板 -->
            <div class="panel" id="subscription-panel">
                <!-- 快速统计卡片 -->
                <div class="subscription-stats-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">💰</div>
                        <div class="stats-content">
                            <div class="stats-label">本月支出</div>
                            <div class="stats-value" id="subscription-monthly-expense">¥0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">📊</div>
                        <div class="stats-content">
                            <div class="stats-label">年度支出</div>
                            <div class="stats-value" id="subscription-yearly-expense">¥0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">⏰</div>
                        <div class="stats-content">
                            <div class="stats-label">即将到期</div>
                            <div class="stats-value" id="subscription-upcoming-count">0个</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">📦</div>
                        <div class="stats-content">
                            <div class="stats-label">订阅总数</div>
                            <div class="stats-value" id="subscription-total-count">0</div>
                        </div>
                    </div>
                </div>

                <!-- 订阅分类标签和操作 -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div class="subscription-category-tabs" style="display: flex; gap: 12px; overflow-x: auto; padding-bottom: 8px;">
                        <button class="category-tab active" data-category="all">全部</button>
                        <!-- 分类标签将通过JavaScript动态生成 -->
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button id="manage-subscription-categories-btn" class="btn btn-secondary" style="padding: 8px 16px;">📁 管理分类</button>
                    </div>
                </div>

                <!-- 订阅列表 -->
                <div class="subscription-list" id="subscription-list">
                    <!-- 订阅卡片将通过JavaScript动态生成 -->
                </div>

                <!-- 日历视图 -->
                <div style="margin-top: 32px; max-width: 50%;">
                    <h3 style="font-size: 20px; font-weight: 600; margin-bottom: 16px;">📅 扣费日历</h3>
                    <div class="subscription-calendar-container">
                        <div class="calendar-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <button class="calendar-nav-btn" data-direction="prev" style="padding: 8px 16px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 8px; cursor: pointer;">◀</button>
                            <div class="calendar-title" style="font-size: 18px; font-weight: 600;">2025年2月</div>
                            <button class="calendar-nav-btn" data-direction="next" style="padding: 8px 16px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 8px; cursor: pointer;">▶</button>
                        </div>
                        <div class="calendar-weekdays" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin-bottom: 6px;">
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">日</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">一</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">二</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">三</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">四</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">五</div>
                            <div style="text-align: center; font-weight: 600; color: var(--text-secondary); padding: 4px 2px; font-size: 11px;">六</div>
                        </div>
                        <div class="calendar-days" id="subscription-calendar-days" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px;">
                            <!-- 日历日期将通过JavaScript动态生成 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 添加订阅按钮 -->
            <button id="add-subscription-btn" class="add-subscription-btn">+</button>

            <div class="panel" id="analytics-panel">
                <!-- 分析类型分段控制器 -->
                <div style="margin-bottom: 24px; display: flex; justify-content: center;">
                    <div class="analytics-toggle">
                        <div class="analytics-toggle-option active" data-type="items">
                            <span class="toggle-icon">📦</span>
                            <span>物品分析</span>
                        </div>
                        <div class="analytics-toggle-option" data-type="subscription">
                            <span class="toggle-icon">💳</span>
                            <span>订阅分析</span>
                        </div>
                    </div>
                </div>

                <!-- 物品分析内容 -->
                <div id="analytics-items-content">
                    <!-- 概览卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="stats-card">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">📦</div>
                            <div class="stats-content">
                                <div class="stats-label">物品总数</div>
                                <div class="stats-value" id="analytics-total-items">0</div>
                            </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">💰</div>
                        <div class="stats-content">
                            <div class="stats-label">总价值</div>
                            <div class="stats-value" id="analytics-total-value">¥0</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">📊</div>
                        <div class="stats-content">
                            <div class="stats-label">平均价格</div>
                            <div class="stats-value" id="analytics-avg-price">¥0</div>
                        </div>
                    </div>

                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">⏱️</div>
                        <div class="stats-content">
                            <div class="stats-label">平均持有</div>
                            <div class="stats-value" id="analytics-avg-days">0天</div>
                        </div>
                    </div>
                    <div class="stats-card">
                        <div class="stats-icon" style="background: linear-gradient(135deg, #ff6b6b 0%, #feca57 100%);">�</div>
                        <div class="stats-content">
                            <div class="stats-label" style="display: flex; align-items: center; gap: 4px;">
                                总日均成本
                            </div>
                            <div class="stats-value" id="analytics-total-daily-cost">¥0/天</div>
                        </div>
                    </div>

                </div>
                
                <!-- 图表区域 -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                    <!-- 分类分布饼图 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">📊 分类分布</h4>
                        <canvas id="category-chart"></canvas>
                    </div>
                    
                    <!-- 价格分布柱状图 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">💵 价格区间分布</h4>
                        <canvas id="price-chart"></canvas>
                    </div>
                    
                    <!-- 购买时间趋势图 -->
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">📈 购买时间趋势（最近12个月）</h4>
                        <canvas id="timeline-chart"></canvas>
                    </div>
                    
                    <!-- 季节性购买分析 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">🌸 季节性购买分析</h4>
                        <canvas id="seasonal-chart"></canvas>
                    </div>
                    
                    <!-- 持有时长分布 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">⏳ 持有时长分布</h4>
                        <canvas id="duration-chart"></canvas>
                    </div>
                    
                    <!-- 日均价值排行 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">🏆 日均价值排行（Top 10）</h4>
                        <canvas id="daily-value-chart"></canvas>
                    </div>
                    
                    <!-- 分类价值对比 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">💎 分类总价值对比</h4>
                        <canvas id="category-value-chart"></canvas>
                    </div>
                    
                    <!-- 价格vs持有时长散点图 -->
                    <div class="chart-container" style="grid-column: 1 / -1;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">🎯 价格与持有时长关系</h4>
                        <canvas id="scatter-chart"></canvas>
                    </div>
                    
                    <!-- 分类雷达图 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">🕸️ 分类多维度分析</h4>
                        <canvas id="radar-chart"></canvas>
                    </div>
                    
                    <!-- 月度支出趋势 -->
                    <div class="chart-container">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">💸 月度支出趋势</h4>
                        <canvas id="spending-chart"></canvas>
                    </div>
                </div>
                
                <!-- TOP榜单 -->
                <div style="margin-top: 24px;">
                    <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">🏅 TOP榜单</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        <!-- 最贵物品TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">💰 最贵物品 TOP5</h5>
                            <div id="top-expensive-list"></div>
                        </div>
                        
                        <!-- 最值物品TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">⭐ 最值物品 TOP5</h5>
                            <div id="top-value-list"></div>
                        </div>
                        
                        <!-- 日均成本最高TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color); display: flex; align-items: center; gap: 6px;">
                                💸 日均成本最高 TOP5
                            </h5>
                            <div id="top-daily-cost-list"></div>
                        </div>
                        
                        <!-- 持有最久TOP5 -->
                        <div class="chart-container">
                            <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">🕰️ 持有最久 TOP5</h5>
                            <div id="top-oldest-list"></div>
                        </div>
                    </div>
                </div>
                </div>

                <!-- 订阅分析内容 -->
                <div id="analytics-subscription-content" style="display: none;">
                    <!-- 概览卡片 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div class="stats-card">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">💳</div>
                            <div class="stats-content">
                                <div class="stats-label">订阅总数</div>
                                <div class="stats-value" id="sub-analytics-total">0</div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">💰</div>
                            <div class="stats-content">
                                <div class="stats-label">
                                    <span class="daily-cost-tooltip">
                                        月度支出
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">按天：单价×30 | 按周：单价×4.33 | 按月：单价 | 按季：单价÷3 | 按年：单价÷12</span>
                                    </span>
                                </div>
                                <div class="stats-value" id="sub-analytics-monthly">¥0</div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">📊</div>
                            <div class="stats-content">
                                <div class="stats-label">
                                    <span class="daily-cost-tooltip">
                                        年度支出
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-content">按天：单价×365 | 按周：单价×52 | 按月：单价×12 | 按季：单价×4 | 按年：单价</span>
                                    </span>
                                </div>
                                <div class="stats-value" id="sub-analytics-yearly">¥0</div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="stats-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">📅</div>
                            <div class="stats-content">
                                <div class="stats-label">即将到期</div>
                                <div class="stats-value" id="sub-analytics-expiring">0</div>
                            </div>
                        </div>
                    </div>

                    <!-- 图表区域 -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
                        <!-- 分类分布饼图 -->
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">📊 分类分布</h4>
                            <canvas id="sub-category-chart"></canvas>
                        </div>

                        <!-- 计费周期分布 -->
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">🔄 计费周期分布</h4>
                            <canvas id="sub-cycle-chart"></canvas>
                        </div>

                        <!-- 费用区间分布 -->
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">💵 费用区间分布</h4>
                            <canvas id="sub-price-chart"></canvas>
                        </div>

                        <!-- 月度支出趋势 -->
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">📈 订阅时间趋势</h4>
                            <canvas id="sub-timeline-chart"></canvas>
                        </div>

                        <!-- 分类支出对比 -->
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">💎 分类月度支出对比</h4>
                            <canvas id="sub-category-value-chart"></canvas>
                        </div>

                        <!-- 状态分布 -->
                        <div class="chart-container">
                            <h4 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">📋 状态分布</h4>
                            <canvas id="sub-status-chart"></canvas>
                        </div>
                    </div>

                    <!-- TOP榜单 -->
                    <div style="margin-top: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">🏅 TOP榜单</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                            <!-- 最贵订阅TOP5 -->
                            <div class="chart-container">
                                <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">💰 最贵订阅 TOP5</h5>
                                <div id="sub-top-expensive-list"></div>
                            </div>

                            <!-- 即将到期TOP5 -->
                            <div class="chart-container">
                                <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">📅 即将到期 TOP5</h5>
                                <div id="sub-top-expiring-list"></div>
                            </div>

                            <!-- 持有最久TOP5 -->
                            <div class="chart-container">
                                <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">🕰️ 持有最久 TOP5</h5>
                                <div id="sub-top-oldest-list"></div>
                            </div>

                            <!-- 年度支出最高TOP5 -->
                            <div class="chart-container">
                                <h5 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: var(--primary-color);">💸 年度支出最高 TOP5</h5>
                                <div id="sub-top-yearly-list"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="panel" id="settings-panel">
                <!-- 统计概览 -->
                <div class="settings-section" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; border: none;">
                    <h4 style="color: white; margin-bottom: 16px;">统计概览</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px;">
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">物品总数</div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-items">0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">件</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">总资产</div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-assets">¥0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">元</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px;">订阅数量</div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-total-subscriptions">0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">个</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; backdrop-filter: blur(10px);">
                            <div style="font-size: 11px; opacity: 0.9; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; gap: 4px;">
                                <span class="daily-cost-tooltip">
                                    日均成本
                                    <span class="tooltip-icon">?</span>
                                    <span class="tooltip-content">包含物品和订阅项目的成本</span>
                                </span>
                            </div>
                            <div style="font-size: 24px; font-weight: 700;" id="stats-daily-average">¥0</div>
                            <div style="font-size: 10px; opacity: 0.8; margin-top: 2px;">元/天</div>
                        </div>
                    </div>
                </div>

                <!-- 主题选择 -->
                <div class="settings-section">
                    <h4>主题配色</h4>
                    <p>选择预设主题或自定义配色方案</p>
                    <div id="theme-presets" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <!-- 主题卡片将通过JavaScript生成 -->
                    </div>
                    <button id="custom-theme-btn" class="btn btn-secondary" style="width: 100%;">自定义主题</button>
                </div>
                
                <!-- 布局选择 -->
                <div class="settings-section">
                    <h4>卡片布局</h4>
                    <p>选择物品卡片的显示方式</p>
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                        <button class="layout-option active" data-layout="grid" style="flex: 1; padding: 12px; border: 2px solid #4361ee; border-radius: 8px; background: #f0f4ff; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 24px; margin-bottom: 4px;">▦</div>
                            <div style="font-size: 12px; font-weight: 500;">网格</div>
                        </button>
                        <button class="layout-option" data-layout="list" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 24px; margin-bottom: 4px;">☰</div>
                            <div style="font-size: 12px; font-weight: 500;">列表</div>
                        </button>
                        <button class="layout-option" data-layout="masonry" style="flex: 1; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; transition: all 0.2s;">
                            <div style="font-size: 24px; margin-bottom: 4px;">▦▥</div>
                            <div style="font-size: 12px; font-weight: 500;">瀑布流</div>
                        </button>
                    </div>
                </div>
                
                <!-- 数据管理 -->
                <div class="settings-section">
                    <h4>数据管理</h4>
                    <p>导出或导入您的数据</p>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" id="export-data-btn" style="flex: 1;">导出数据</button>
                        <button class="btn btn-primary" id="import-data-btn" style="flex: 1;">导入数据</button>
                    </div>
                </div>
                
                <!-- 关于 -->
                <div class="settings-section">
                    <h4>关于</h4>
                    <p style="margin-bottom: 4px;">物藏录 v1.0.0</p>
                    <p style="margin-bottom: 0;">个人物品管理工具</p>
                </div>
            </div>
        </div>
        
        <button class="add-item-btn" id="add-item-btn">+</button>
    </div>
    
    <!-- 添加物品模态框 -->
    <div id="add-item-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3>添加新物品</h3>
            <div class="form-group">
                <label>物品名称 <span style="color: #f5222d;">*</span></label>
                <input type="text" id="item-name" placeholder="请输入物品名称">
            </div>
            <div class="form-group">
                <label>分类 <span style="color: #f5222d;">*</span></label>
                <div class="custom-select" id="custom-category-select">
                    <div class="custom-select-trigger">请选择分类</div>
                    <div class="custom-select-options"></div>
                    <input type="hidden" id="item-category" value="">
                </div>
            </div>
            <div class="form-group">
                <label>描述</label>
                <textarea id="item-desc" rows="3" placeholder="请输入物品描述"></textarea>
            </div>
            <div class="form-group">
                <label>存放位置</label>
                <input type="text" id="item-location" placeholder="请输入存放位置">
            </div>
            <div class="form-group">
                <label>价格 (¥)</label>
                <input type="number" id="item-price" placeholder="请输入物品价格" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>购买日期</label>
                <input type="date" id="item-purchase-date">
            </div>
            <div class="form-group">
                <label>购买渠道 <span style="color: #f5222d;">*</span></label>
                <select id="item-purchase-channel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <!-- 购买渠道选项将通过JavaScript动态生成 -->
                </select>
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-add">取消</button>
                <button class="btn btn-primary" id="save-item">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 物品详情模态框 -->
    <div id="item-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3>物品详情</h3>
            <div class="form-group">
                <label>物品名称 <span style="color: #f5222d;">*</span></label>
                <input type="text" id="detail-item-name">
            </div>
            <div class="form-group">
                <label>分类 <span style="color: #f5222d;">*</span></label>
                <div class="custom-select" id="custom-detail-category-select">
                    <div class="custom-select-trigger">请选择分类</div>
                    <div class="custom-select-options"></div>
                    <input type="hidden" id="detail-item-category" value="">
                </div>
            </div>
            <div class="form-group">
                <label>描述</label>
                <textarea id="detail-item-desc" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label>存放位置</label>
                <input type="text" id="detail-item-location">
            </div>
            <div class="form-group">
                <label>价格 (¥)</label>
                <input type="number" id="detail-item-price" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>购买日期</label>
                <input type="date" id="detail-item-purchase-date">
            </div>
            <div class="form-group">
                <label>日均价值 (¥)</label>
                <input type="number" id="detail-item-daily-value" readonly step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>购买渠道</label>
                <select id="detail-item-purchase-channel" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <!-- 购买渠道选项将通过JavaScript动态生成 -->
                </select>
            </div>

            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="close-detail">取消</button>
                <button class="btn btn-primary" id="save-item-detail">保存</button>
                <button class="btn btn-danger" id="delete-item-detail">删除</button>
            </div>
        </div>
    </div>

    <!-- 分类管理弹窗 -->
    <div id="category-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">📁 分类管理</h3>
            <div id="category-manage-list" style="margin-bottom: 20px;">
                <!-- 分类列表项将通过JavaScript动态生成 -->
            </div>
            <button id="add-category-in-modal" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px;">+ 添加新分类</button>
            <button id="close-category-modal" class="btn btn-secondary" style="width: 100%; margin-top: 12px; padding: 12px; font-size: 14px;">关闭</button>
        </div>
    </div>

    <!-- 购买渠道管理弹窗 -->
    <div id="channel-manage-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">🛒 购买渠道管理</h3>
            <div id="channel-manage-list" style="margin-bottom: 20px;">
                <!-- 渠道列表项将通过JavaScript动态生成 -->
            </div>
            <button id="add-channel-in-modal" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px;">+ 添加新渠道</button>
            <button id="close-channel-modal" class="btn btn-secondary" style="width: 100%; margin-top: 12px; padding: 12px; font-size: 14px;">关闭</button>
        </div>
    </div>

    <!-- 添加/编辑订阅弹窗 -->
    <div id="subscription-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 id="subscription-modal-title" style="margin-bottom: 20px; text-align: center; font-size: 18px;">添加订阅</h3>
            <div class="form-group">
                <label>订阅名称 <span style="color: #f5222d;">*</span></label>
                <input type="text" id="subscription-name" placeholder="如：Netflix、Spotify" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label>分类 <span style="color: #f5222d;">*</span></label>
                <select id="subscription-category" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <!-- 分类选项将通过JavaScript动态生成 -->
                </select>
            </div>
            <div class="form-group">
                <label>图标</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div id="subscription-icon-preview" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--border-color);">🎬</div>
                    <button id="subscription-icon-picker-btn" type="button" class="btn btn-secondary" style="padding: 8px 16px;">选择图标</button>
                </div>
                <input type="hidden" id="subscription-icon" value="🎬">
            </div>
            <div class="form-group">
                <label>价格 (¥) <span style="color: #f5222d;">*</span></label>
                <input type="number" id="subscription-price" placeholder="请输入价格" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            <div class="form-group">
                <label>周期类型 <span style="color: #f5222d;">*</span></label>
                <select id="subscription-cycle-type" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <option value="day">按天</option>
                    <option value="week">按周</option>
                    <option value="month" selected>按月</option>
                    <option value="quarter">按季</option>
                    <option value="year">按年</option>
                    <option value="lifetime">终身有效</option>
                </select>
            </div>
            <div class="form-group" id="first-billing-date-group">
                <label id="billing-date-label">扣费日期 <span style="color: #f5222d;">*</span></label>

                <!-- 按周：选择星期几 -->
                <div id="billing-day-of-week" style="display: none;">
                    <select id="subscription-day-of-week" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="1">周一</option>
                        <option value="2">周二</option>
                        <option value="3">周三</option>
                        <option value="4">周四</option>
                        <option value="5">周五</option>
                        <option value="6">周六</option>
                        <option value="0">周日</option>
                    </select>
                </div>

                <!-- 按月：选择几号 -->
                <div id="billing-day-of-month" style="display: none;">
                    <select id="subscription-day-of-month" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </select>
                </div>

                <!-- 按季：选择月份和日期 -->
                <div id="billing-day-of-quarter" style="display: none;">
                    <select id="subscription-quarter-month" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                        <option value="1">1月</option>
                        <option value="4">4月</option>
                        <option value="7">7月</option>
                        <option value="10">10月</option>
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">月</span>
                    <select id="subscription-quarter-day" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">日</span>
                </div>

                <!-- 按年：选择月-日 -->
                <div id="billing-day-of-year" style="display: none;">
                    <select id="subscription-month" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">月</span>
                    <select id="subscription-day-of-year-day" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">日</span>
                </div>

                <!-- 按天：提示每天扣费 -->
                <div id="billing-day-hint" style="display: none;">
                    <div style="padding: 10px; background: var(--background-secondary); border-radius: 6px; color: var(--text-secondary);">
                        每天扣费，无需选择日期
                    </div>
                </div>

                <small id="billing-date-hint" style="color: var(--text-secondary);">选择下次扣费的日期，系统会自动计算后续扣费时间</small>
            </div>

            <!-- 终身订阅的特殊选项 -->
            <div class="form-group" id="lifetime-options-group" style="display: none;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <input type="checkbox" id="lifetime-include-daily" style="width: 18px; height: 18px;">
                    <label for="lifetime-include-daily" style="margin: 0;">计入日均成本</label>
                </div>
                <div id="lifetime-purchase-date-group" style="display: none;">
                    <label style="font-size: 14px; color: var(--text-primary); margin-bottom: 6px; display: block;">购买日期</label>
                    <input type="date" id="lifetime-purchase-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <small style="color: var(--text-secondary);">将按购买日期到现在的天数计算日均成本</small>
                </div>
            </div>

            <div class="form-group">
                <label>提醒设置</label>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <input type="checkbox" id="subscription-reminder-enabled" checked style="width: 18px; height: 18px;">
                    <label for="subscription-reminder-enabled" style="margin: 0;">启用到期提醒</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="subscription-reminder-days" style="margin: 0;">提前</label>
                    <input type="number" id="subscription-reminder-days" value="1" min="0" max="30" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <label for="subscription-reminder-days" style="margin: 0;">天提醒</label>
                </div>
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea id="subscription-notes" rows="2" placeholder="可选的备注信息" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></textarea>
            </div>
            <div class="form-group">
                <label>官网</label>
                <input type="url" id="subscription-website" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-subscription">取消</button>
                <button class="btn btn-primary" id="save-subscription">保存</button>
            </div>
        </div>
    </div>

    <!-- 订阅详情弹窗 -->
    <div id="subscription-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 24px; border-radius: 8px; width: 90%; max-width: 500px;">
            <h3>订阅详情</h3>
            <div class="form-group">
                <label>订阅名称 <span style="color: #f5222d;">*</span></label>
                <input type="text" id="detail-subscription-name">
            </div>
            <div class="form-group">
                <label>分类 <span style="color: #f5222d;">*</span></label>
                <select id="detail-subscription-category">
                    <!-- 分类选项将通过JavaScript动态生成 -->
                </select>
            </div>
            <div class="form-group">
                <label>图标</label>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <div id="detail-subscription-icon-preview" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: var(--background-secondary); border-radius: 8px; border: 1px solid var(--border-color);">🎬</div>
                    <button id="detail-subscription-icon-picker-btn" type="button" class="btn btn-secondary" style="padding: 8px 16px;">选择图标</button>
                </div>
                <input type="hidden" id="detail-subscription-icon">
            </div>
            <div class="form-group">
                <label>价格 (¥) <span style="color: #f5222d;">*</span></label>
                <input type="number" id="detail-subscription-price" step="0.01" min="0">
            </div>
            <div class="form-group">
                <label>周期类型 <span style="color: #f5222d;">*</span></label>
                <select id="detail-subscription-cycle-type">
                    <option value="day">按天</option>
                    <option value="week">按周</option>
                    <option value="month">按月</option>
                    <option value="quarter">按季</option>
                    <option value="year">按年</option>
                    <option value="lifetime">终身有效</option>
                </select>
            </div>
            <div class="form-group" id="detail-first-billing-date-group">
                <label id="detail-billing-date-label">扣费日期 <span style="color: #f5222d;">*</span></label>
                <!-- 按周：选择星期几 -->
                <div id="detail-billing-day-of-week" style="display: none;">
                    <select id="detail-subscription-day-of-week" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                        <option value="1">周一</option>
                        <option value="2">周二</option>
                        <option value="3">周三</option>
                        <option value="4">周四</option>
                        <option value="5">周五</option>
                        <option value="6">周六</option>
                        <option value="0">周日</option>
                    </select>
                </div>
                <!-- 按月：选择几号 -->
                <div id="detail-billing-day-of-month" style="display: none;">
                    <select id="detail-subscription-day-of-month" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"></select>
                </div>
                <!-- 按季：选择月份和日期 -->
                <div id="detail-billing-day-of-quarter" style="display: none;">
                    <select id="detail-subscription-quarter-month" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;">
                        <option value="1">1月</option>
                        <option value="4">4月</option>
                        <option value="7">7月</option>
                        <option value="10">10月</option>
                    </select>
                    <span style="display: inline-block; width: 4%; text-align: center;">月</span>
                    <select id="detail-subscription-quarter-day" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;"></select>
                    <span style="display: inline-block; width: 4%; text-align: center;">日</span>
                </div>
                <!-- 按年：选择月-日 -->
                <div id="detail-billing-day-of-year" style="display: none;">
                    <select id="detail-subscription-month" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;"></select>
                    <span style="display: inline-block; width: 4%; text-align: center;">月</span>
                    <select id="detail-subscription-day-of-year-day" style="width: 48%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; display: inline-block;"></select>
                    <span style="display: inline-block; width: 4%; text-align: center;">日</span>
                </div>
                <!-- 按天：提示每天扣费 -->
                <div id="detail-billing-day-hint" style="display: none;">
                    <div style="padding: 10px; background: var(--background-secondary); border-radius: 6px; color: var(--text-secondary);">每天扣费，无需选择日期</div>
                </div>
                <small id="detail-billing-date-hint" style="color: var(--text-secondary);">选择下次扣费的日期，系统会自动计算后续扣费时间</small>
            </div>
            <!-- 终身订阅的特殊选项 -->
            <div class="form-group" id="detail-lifetime-options-group" style="display: none;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <input type="checkbox" id="detail-lifetime-include-daily" style="width: 18px; height: 18px;">
                    <label for="detail-lifetime-include-daily" style="margin: 0;">计入日均成本</label>
                </div>
                <div id="detail-lifetime-purchase-date-group" style="display: none;">
                    <label style="font-size: 14px; color: var(--text-primary); margin-bottom: 6px; display: block;">购买日期</label>
                    <input type="date" id="detail-lifetime-purchase-date" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <small style="color: var(--text-secondary);">将按购买日期到现在的天数计算日均成本</small>
                </div>
            </div>
            <div class="form-group">
                <label>提醒设置</label>
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                    <input type="checkbox" id="detail-subscription-reminder-enabled" style="width: 18px; height: 18px;">
                    <label for="detail-subscription-reminder-enabled" style="margin: 0;">启用到期提醒</label>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="detail-subscription-reminder-days" style="margin: 0;">提前</label>
                    <input type="number" id="detail-subscription-reminder-days" value="1" min="0" max="30" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    <label for="detail-subscription-reminder-days" style="margin: 0;">天提醒</label>
                </div>
            </div>
            <div class="form-group">
                <label>备注</label>
                <textarea id="detail-subscription-notes" rows="2"></textarea>
            </div>
            <div class="form-group">
                <label>官网</label>
                <input type="url" id="detail-subscription-website">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button class="btn btn-secondary" id="close-subscription-detail">取消</button>
                <button class="btn btn-primary" id="save-subscription-detail">保存</button>
                <button class="btn btn-danger" id="delete-subscription-detail">删除</button>
            </div>
        </div>
    </div>

    <!-- 图标选择器弹窗 -->
    <div id="icon-picker-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1100; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">选择图标</h3>
            <div id="icon-picker-categories" style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px;">
                <button class="icon-category-tab active" data-category="common" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">常用</button>
                <button class="icon-category-tab" data-category="entertainment" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">娱乐</button>
                <button class="icon-category-tab" data-category="office" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">办公</button>
                <button class="icon-category-tab" data-category="education" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">教育</button>
                <button class="icon-category-tab" data-category="tools" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">工具</button>
                <button class="icon-category-tab" data-category="finance" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">金融</button>
                <button class="icon-category-tab" data-category="other" style="padding: 6px 12px; border: 1px solid var(--border-color); background: var(--background-primary); border-radius: 16px; cursor: pointer; white-space: nowrap;">其他</button>
            </div>
            <div id="icon-picker-icons" style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 8px; margin-bottom: 20px;">
                <!-- 图标将通过JavaScript动态生成 -->
            </div>
            <button id="close-icon-picker" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 14px;">关闭</button>
        </div>
    </div>

    <!-- 订阅分类管理弹窗 -->
    <div id="subscription-category-manage-modal">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 style="margin-bottom: 20px; text-align: center; font-size: 18px;">📁 订阅分类管理</h3>
            <div id="subscription-category-manage-list" style="margin-bottom: 20px;">
                <!-- 分类列表项将通过JavaScript动态生成 -->
            </div>
            <button id="add-subscription-category-in-modal" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 14px;">+ 添加新分类</button>
            <button id="close-subscription-category-modal" class="btn btn-secondary" style="width: 100%; margin-top: 12px; padding: 12px; font-size: 14px;">关闭</button>
        </div>
    </div>

    <!-- 扣费日期详情弹窗 -->
    <div id="billing-date-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <h3 id="billing-date-detail-title" style="margin-bottom: 20px; text-align: center; font-size: 18px;">扣费详情</h3>
            <div id="billing-date-detail-list">
                <!-- 扣费列表将通过JavaScript动态生成 -->
            </div>
            <button id="close-billing-date-detail" class="btn btn-secondary" style="width: 100%; margin-top: 20px; padding: 12px; font-size: 14px;">关闭</button>
        </div>
    </div>

    <script>
        // 存储管理模块
        class Storage {
            constructor() {
                this.itemsKey = 'wucanglu_items';
                this.categoriesKey = 'wucanglu_categories';
                this.channelsKey = 'wucanglu_channels';
                this.settingsKey = 'wucanglu_settings';
                this.useUToolsDB = typeof utools !== 'undefined' && utools.db;
                console.log('存储方式:', this.useUToolsDB ? 'uTools 本地数据库' : 'localStorage');

                // 检测localStorage是否可用
                this.localStorageAvailable = this.isLocalStorageAvailable();
                console.log('localStorage是否可用:', this.localStorageAvailable);

                // 内存存储作为后备方案
                this.memoryStorage = {
                    items: [],
                    categories: [],
                    channels: [],
                    settings: {
                        theme: 'light',
                        autoBackup: false
                    }
                };
            }
            
            // 检测localStorage是否可用
            isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }
            
            // 初始化默认数据
            initDefaultData() {
                console.log('开始初始化默认数据');
                
                // 先检查并修复旧的硬编码ID
                this.migrateOldData();
                
                const categories = this.getCategories();
                console.log('当前分类数量:', categories.length);
                if (!categories.length) {
                    console.log('初始化默认分类');
                    const defaultCategories = [
                        { id: Date.now().toString(), name: '数码产品', icon: '💻' },
                        { id: (Date.now() + 1).toString(), name: '生活用品', icon: '🏠' },
                        { id: (Date.now() + 2).toString(), name: '书籍', icon: '📚' },
                        { id: (Date.now() + 3).toString(), name: '其他', icon: '📦' }
                    ];
                    const result = this.saveCategories(defaultCategories);
                    console.log('初始化默认分类结果:', result);
                }
                
                // 初始化默认购买渠道
                const channels = this.getChannels();
                console.log('当前购买渠道数量:', channels.length);
                if (!channels.length) {
                    console.log('初始化默认购买渠道');
                    const defaultChannels = [
                        { id: Date.now().toString(), name: '淘宝' },
                        { id: (Date.now() + 1).toString(), name: '京东' },
                        { id: (Date.now() + 2).toString(), name: '抖音' },
                        { id: (Date.now() + 3).toString(), name: '拼多多' },
                        { id: (Date.now() + 4).toString(), name: '其他' }
                    ];
                    const result = this.saveChannels(defaultChannels);
                    console.log('初始化默认购买渠道结果:', result);
                }

                // 不再初始化默认物品，让用户从空白状态开始
                console.log('初始化默认数据完成');
            }
            
            // 迁移旧数据（修复硬编码ID）
            migrateOldData() {
                console.log('检查是否需要迁移旧数据');
                
                // 修复物品ID
                const items = this.getItems();
                let itemsNeedMigration = false;
                const migratedItems = items.map(item => {
                    // 检查是否是旧的硬编码ID（单个数字字符）
                    if (item.id && item.id.length <= 2 && /^\d+$/.test(item.id)) {
                        console.log(`迁移物品ID: ${item.id} -> ${Date.now() + parseInt(item.id)}`);
                        itemsNeedMigration = true;
                        return { ...item, id: (Date.now() + parseInt(item.id)).toString() };
                    }
                    return item;
                });
                
                if (itemsNeedMigration) {
                    console.log('保存迁移后的物品数据');
                    this.saveItems(migratedItems);
                }

                // 修复分类ID
                const categories = this.getCategories();
                let categoriesNeedMigration = false;
                const migratedCategories = categories.map(category => {
                    // 检查是否是旧的硬编码ID（单个数字字符）
                    if (category.id && category.id.length <= 2 && /^\d+$/.test(category.id)) {
                        console.log(`迁移分类ID: ${category.id} -> ${Date.now() + parseInt(category.id)}`);
                        categoriesNeedMigration = true;
                        return { ...category, id: (Date.now() + parseInt(category.id) + 1000).toString() };
                    }
                    return category;
                });
                
                if (categoriesNeedMigration) {
                    console.log('保存迁移后的分类数据');
                    this.saveCategories(migratedCategories);
                }
                
                console.log('数据迁移检查完成');
            }
            
            // 获取所有物品
            getItems() {
                try {
                    console.log('开始获取物品数据');
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.itemsKey);
                        console.log('从uTools数据库获取到的物品数据:', doc);
                        return doc ? doc.items : [];
                    } else if (this.localStorageAvailable) {
                        const items = localStorage.getItem(this.itemsKey);
                        console.log('从localStorage获取到的物品数据:', items);
                        return items ? JSON.parse(items) : [];
                    } else {
                        console.log('从内存存储获取物品数据');
                        return this.memoryStorage.items;
                    }
                } catch (error) {
                    console.error('获取物品数据失败:', error);
                    return this.memoryStorage.items;
                }
            }
            
            // 保存物品列表
            saveItems(items) {
                try {
                    console.log('开始保存物品数据:', items);
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.itemsKey);
                        const putDoc = {
                            _id: this.itemsKey,
                            items: items
                        };
                        // 只有在文档已存在时才添加 _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('保存物品数据结果:', result);
                        if (result.error) {
                            console.error('uTools数据库保存失败:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.itemsKey, JSON.stringify(items));
                        console.log('保存物品数据成功');
                        return true;
                    } else {
                        console.log('保存物品数据到内存存储');
                        this.memoryStorage.items = items;
                        return true;
                    }
                } catch (error) {
                    console.error('保存物品数据失败:', error);
                    console.log('保存物品数据到内存存储作为后备');
                    this.memoryStorage.items = items;
                    return true;
                }
            }
            
            // 添加物品
            addItem(item) {
                const items = this.getItems();
                const newItem = {
                    id: Date.now().toString(),
                    createdAt: new Date().toISOString(),
                    ...item
                };
                items.push(newItem);
                return this.saveItems(items) ? newItem : null;
            }
            
            // 更新物品
            updateItem(id, updates) {
                const items = this.getItems();
                // 确保ID比较时类型一致，同时支持数字和字符串
                const index = items.findIndex(item => item.id == id || item.id.toString() === id.toString());
                if (index !== -1) {
                    items[index] = { ...items[index], ...updates };
                    return this.saveItems(items);
                }
                return false;
            }
            
            // 删除物品
            deleteItem(id) {
                const items = this.getItems();
                // 确保ID比较时类型一致，同时支持数字和字符串
                const filteredItems = items.filter(item => item.id != id && item.id.toString() !== id.toString());
                return this.saveItems(filteredItems);
            }
            
            // 获取物品详情
            getItemById(id) {
                const items = this.getItems();
                // 确保ID比较时类型一致，同时支持数字和字符串
                return items.find(item => item.id == id || item.id.toString() === id.toString()) || null;
            }
            
            // 获取所有分类
            getCategories() {
                try {
                    console.log('开始获取分类数据');
                    if (this.useUToolsDB) {
                        console.log('使用uTools本地数据库获取分类数据');
                        const doc = utools.db.get(this.categoriesKey);
                        console.log('从uTools数据库获取到的分类数据:', doc);
                        const categories = doc ? doc.categories : [];
                        console.log('解析后的分类数据:', categories);
                        return categories;
                    } else if (this.localStorageAvailable) {
                        console.log('使用localStorage获取分类数据');
                        const categories = localStorage.getItem(this.categoriesKey);
                        console.log('从localStorage获取到的分类数据:', categories);
                        const parsedCategories = categories ? JSON.parse(categories) : [];
                        console.log('解析后的分类数据:', parsedCategories);
                        return parsedCategories;
                    } else {
                        console.log('从内存存储获取分类数据');
                        return this.memoryStorage.categories;
                    }
                } catch (error) {
                    console.error('获取分类数据失败:', error);
                    return this.memoryStorage.categories;
                }
            }
            
            // 保存分类列表
            saveCategories(categories) {
                try {
                    console.log('开始保存分类数据:', categories);
                    if (this.useUToolsDB) {
                        console.log('使用uTools本地数据库保存分类数据');
                        const doc = utools.db.get(this.categoriesKey);
                        console.log('获取到的分类文档:', doc);
                        const putDoc = {
                            _id: this.categoriesKey,
                            categories: categories
                        };
                        // 只有在文档已存在时才添加 _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('保存分类数据结果:', result);
                        if (result.error) {
                            console.error('uTools数据库保存失败:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        console.log('使用localStorage保存分类数据');
                        localStorage.setItem(this.categoriesKey, JSON.stringify(categories));
                        console.log('保存分类数据成功');
                        return true;
                    } else {
                        console.log('保存分类数据到内存存储');
                        this.memoryStorage.categories = categories;
                        return true;
                    }
                } catch (error) {
                    console.error('保存分类数据失败:', error);
                    console.log('保存分类数据到内存存储作为后备');
                    this.memoryStorage.categories = categories;
                    return true;
                }
            }
            
            // 添加分类
            addCategory(category) {
                console.log('storage.addCategory被调用:', category);
                const categories = this.getCategories();
                console.log('添加前的分类数量:', categories.length);
                const newCategory = {
                    id: Date.now().toString(),
                    ...category
                };
                console.log('新分类:', newCategory);
                categories.push(newCategory);
                console.log('添加后的分类数量:', categories.length);
                const result = this.saveCategories(categories);
                console.log('保存结果:', result);
                return result;
            }
            
            // 更新分类
            updateCategory(id, updates) {
                console.log('更新分类:', id, updates);
                const categories = this.getCategories();
                console.log('更新前的分类:', categories);
                // 确保ID比较时类型一致，同时支持数字和字符串
                const index = categories.findIndex(category => category.id == id || category.id.toString() === id.toString());
                console.log('找到分类索引:', index);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...updates };
                    console.log('更新后的分类:', categories);
                    const result = this.saveCategories(categories);
                    console.log('更新分类结果:', result);
                    return result;
                }
                console.error('分类不存在:', id);
                return false;
            }
            
            // 删除分类（将该分类下的物品转移到"其他"分类）
            deleteCategory(id) {
                console.log('删除分类:', id);
                const categories = this.getCategories();

                // 找到"其他"分类
                const otherCategory = categories.find(c => c.name === '其他');
                if (!otherCategory) {
                    console.error('未找到"其他"分类');
                    return false;
                }

                // 防止删除"其他"分类本身
                const categoryToDelete = categories.find(c => c.id == id || c.id.toString() === id.toString());
                if (!categoryToDelete) {
                    console.error('分类不存在:', id);
                    return false;
                }

                if (categoryToDelete.name === '其他') {
                    console.error('不能删除"其他"分类');
                    return false;
                }

                // 将属于该分类的物品转移到"其他"分类
                const items = this.getItems();
                const updatedItems = items.map(item => {
                    if (item.category == id || item.category.toString() === id.toString()) {
                        return { ...item, category: otherCategory.id };
                    }
                    return item;
                });

                // 保存更新后的物品
                this.saveItems(updatedItems);

                // 删除分类
                const filteredCategories = categories.filter(category => category.id != id && category.id.toString() !== id.toString());
                const result = this.saveCategories(filteredCategories);
                console.log('删除分类结果:', result);
                return result;
            }
            
            // 获取分类详情
            getCategoryById(id) {
                console.log('获取分类详情:', id);
                const categories = this.getCategories();
                console.log('当前分类列表:', categories);
                // 确保ID比较时类型一致，同时支持数字和字符串
                const category = categories.find(category => category.id == id || category.id.toString() === id.toString());
                console.log('找到的分类:', category);
                return category || null;
            }

            getCategoryByName(name) {
                const categories = this.getCategories();
                return categories.find(category => category.name === name) || null;
            }

            // 获取所有购买渠道
            getChannels() {
                try {
                    console.log('开始获取购买渠道数据');
                    if (this.useUToolsDB) {
                        console.log('使用uTools本地数据库获取购买渠道数据');
                        const doc = utools.db.get(this.channelsKey);
                        console.log('从uTools数据库获取到的购买渠道数据:', doc);
                        const channels = doc ? doc.channels : [];
                        console.log('解析后的购买渠道数据:', channels);
                        return channels;
                    } else if (this.localStorageAvailable) {
                        console.log('使用localStorage获取购买渠道数据');
                        const channels = localStorage.getItem(this.channelsKey);
                        console.log('从localStorage获取到的购买渠道数据:', channels);
                        const parsedChannels = channels ? JSON.parse(channels) : [];
                        console.log('解析后的购买渠道数据:', parsedChannels);
                        return parsedChannels;
                    } else {
                        console.log('从内存存储获取购买渠道数据');
                        return this.memoryStorage.channels;
                    }
                } catch (error) {
                    console.error('获取购买渠道数据失败:', error);
                    return this.memoryStorage.channels;
                }
            }

            // 保存购买渠道列表
            saveChannels(channels) {
                try {
                    console.log('开始保存购买渠道数据:', channels);
                    if (this.useUToolsDB) {
                        console.log('使用uTools本地数据库保存购买渠道数据');
                        const doc = utools.db.get(this.channelsKey);
                        console.log('获取到的购买渠道文档:', doc);
                        const putDoc = {
                            _id: this.channelsKey,
                            channels: channels
                        };
                        // 只有在文档已存在时才添加 _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('保存购买渠道数据结果:', result);
                        if (result.error) {
                            console.error('uTools数据库保存失败:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        console.log('使用localStorage保存购买渠道数据');
                        localStorage.setItem(this.channelsKey, JSON.stringify(channels));
                        console.log('保存购买渠道数据成功');
                        return true;
                    } else {
                        console.log('保存购买渠道数据到内存存储');
                        this.memoryStorage.channels = channels;
                        return true;
                    }
                } catch (error) {
                    console.error('保存购买渠道数据失败:', error);
                    console.log('保存购买渠道数据到内存存储作为后备');
                    this.memoryStorage.channels = channels;
                    return true;
                }
            }

            // 添加购买渠道
            addChannel(channel) {
                console.log('storage.addChannel被调用:', channel);
                const channels = this.getChannels();
                console.log('添加前的购买渠道数量:', channels.length);
                const newChannel = {
                    id: Date.now().toString(),
                    ...channel
                };
                console.log('新购买渠道:', newChannel);
                channels.push(newChannel);
                console.log('添加后的购买渠道数量:', channels.length);
                const result = this.saveChannels(channels);
                console.log('保存结果:', result);
                return result;
            }

            // 更新购买渠道
            updateChannel(id, updates) {
                console.log('更新购买渠道:', id, updates);
                const channels = this.getChannels();
                console.log('更新前的购买渠道:', channels);
                // 确保ID比较时类型一致，同时支持数字和字符串
                const index = channels.findIndex(channel => channel.id == id || channel.id.toString() === id.toString());
                console.log('找到购买渠道索引:', index);
                if (index !== -1) {
                    channels[index] = { ...channels[index], ...updates };
                    console.log('更新后的购买渠道:', channels);
                    const result = this.saveChannels(channels);
                    console.log('更新购买渠道结果:', result);
                    return result;
                }
                console.error('购买渠道不存在:', id);
                return false;
            }

            // 删除购买渠道（将该渠道下的物品转移到"其他"渠道）
            deleteChannel(id) {
                console.log('删除购买渠道:', id);
                const channels = this.getChannels();

                // 找到"其他"渠道
                const otherChannel = channels.find(c => c.name === '其他');
                if (!otherChannel) {
                    console.error('未找到"其他"购买渠道');
                    return false;
                }

                // 防止删除"其他"渠道本身
                const channelToDelete = channels.find(c => c.id == id || c.id.toString() === id.toString());
                if (!channelToDelete) {
                    console.error('购买渠道不存在:', id);
                    return false;
                }

                if (channelToDelete.name === '其他') {
                    console.error('不能删除"其他"购买渠道');
                    return false;
                }

                // 将属于该渠道的物品转移到"其他"渠道
                const items = this.getItems();
                const updatedItems = items.map(item => {
                    if (item.purchaseChannel == id || item.purchaseChannel.toString() === id.toString()) {
                        return { ...item, purchaseChannel: otherChannel.id };
                    }
                    return item;
                });

                // 保存更新后的物品
                this.saveItems(updatedItems);

                // 删除购买渠道
                const filteredChannels = channels.filter(channel => channel.id != id && channel.id.toString() !== id.toString());
                const result = this.saveChannels(filteredChannels);
                console.log('删除购买渠道结果:', result);
                return result;
            }

            // 获取购买渠道详情
            getChannelById(id) {
                console.log('获取购买渠道详情:', id);
                const channels = this.getChannels();
                console.log('当前购买渠道列表:', channels);
                // 确保ID比较时类型一致，同时支持数字和字符串
                const channel = channels.find(channel => channel.id == id || channel.id.toString() === id.toString());
                console.log('找到的购买渠道:', channel);
                return channel || null;
            }

            // 获取设置
            getSettings() {
                try {
                    console.log('开始获取设置数据');
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.settingsKey);
                        console.log('从uTools数据库获取到的设置数据:', doc);
                        return doc ? doc.settings : this.memoryStorage.settings;
                    } else if (this.localStorageAvailable) {
                        const settings = localStorage.getItem(this.settingsKey);
                        console.log('从localStorage获取到的设置数据:', settings);
                        return settings ? JSON.parse(settings) : this.memoryStorage.settings;
                    } else {
                        console.log('从内存存储获取设置数据');
                        return this.memoryStorage.settings;
                    }
                } catch (error) {
                    console.error('获取设置数据失败:', error);
                    return this.memoryStorage.settings;
                }
            }
            
            // 保存设置
            saveSettings(settings) {
                try {
                    console.log('开始保存设置数据:', settings);
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.settingsKey);
                        const putDoc = {
                            _id: this.settingsKey,
                            settings: settings
                        };
                        // 只有在文档已存在时才添加 _rev
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        console.log('保存设置数据结果:', result);
                        if (result.error) {
                            console.error('uTools数据库保存失败:', result.message);
                        }
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.settingsKey, JSON.stringify(settings));
                        console.log('保存设置数据成功');
                        return true;
                    } else {
                        console.log('保存设置数据到内存存储');
                        this.memoryStorage.settings = settings;
                        return true;
                    }
                } catch (error) {
                    console.error('保存设置数据失败:', error);
                    console.log('保存设置数据到内存存储作为后备');
                    this.memoryStorage.settings = settings;
                    return true;
                }
            }
            
            // 导出所有数据
            exportData() {
                const data = {
                    items: this.getItems(),
                    categories: this.getCategories(),
                    channels: this.getChannels(),
                    settings: this.getSettings(),
                    exportTime: new Date().toISOString()
                };
                return JSON.stringify(data, null, 2);
            }

            // 导入数据
            importData(jsonData) {
                try {
                    const data = JSON.parse(jsonData);
                    if (data.items) this.saveItems(data.items);
                    if (data.categories) this.saveCategories(data.categories);
                    if (data.channels) this.saveChannels(data.channels);
                    if (data.settings) this.saveSettings(data.settings);
                    return true;
                } catch (error) {
                    console.error('导入数据失败:', error);
                    return false;
                }
            }
            
            // 清空所有数据
            clearAllData() {
                try {
                    console.log('开始清空所有数据');
                    if (this.useUToolsDB) {
                        utools.db.remove(this.itemsKey);
                        utools.db.remove(this.categoriesKey);
                        utools.db.remove(this.settingsKey);
                        console.log('从uTools数据库清空数据成功');
                    } else if (this.localStorageAvailable) {
                        localStorage.removeItem(this.itemsKey);
                        localStorage.removeItem(this.categoriesKey);
                        localStorage.removeItem(this.settingsKey);
                        console.log('从localStorage清空数据成功');
                    }
                    
                    // 清空内存存储
                    this.memoryStorage = {
                        items: [],
                        categories: [],
                        settings: {
                            theme: 'light',
                            autoBackup: false
                        }
                    };
                    console.log('从内存存储清空数据成功');
                    
                    return true;
                } catch (error) {
                    console.error('清空数据失败:', error);
                    
                    // 即使出错，也要清空内存存储
                    this.memoryStorage = {
                        items: [],
                        categories: [],
                        settings: {
                            theme: 'light',
                            autoBackup: false
                        }
                    };
                    console.log('从内存存储清空数据成功');
                    
                    return true;
                }
            }
        }

        // ============================================================
        // 订阅管理存储类
        // ============================================================
        class SubscriptionStorage {
            constructor() {
                this.subscriptionsKey = 'wucanglu_subscriptions';
                this.subscriptionCategoriesKey = 'wucanglu_subscription_categories';
                this.reminderLogKey = 'wucanglu_reminder_log';
                this.useUToolsDB = typeof utools !== 'undefined' && utools.db;
                this.localStorageAvailable = this.isLocalStorageAvailable();
                this.memoryStorage = {
                    subscriptions: [],
                    subscriptionCategories: [],
                    reminderLog: []
                };

                // 图标库
                this.iconLibrary = {
                    common: ['🎬', '🎵', '📺', '🎮', '📱', '💻', '🔧', '📦', '🛒', '⭐', '💡', '🔔'],
                    entertainment: ['🎬', '🎵', '🎤', '🎨', '📺', '🎮', '🎯', '🎪', '🎭', '🎪', '🎸', '🎹', '🎧', '📻', '📀', '🎞️', '🎟️', '🎫'],
                    office: ['💼', '📊', '📈', '📉', '📁', '📂', '🗂️', '📝', '✏️', '🖊️', '📋', '📌', '📍', '🔗', '🔒', '🔐', '📧', '✉️', '📨'],
                    education: ['📚', '📖', '📕', '📗', '📘', '📙', '📓', '📔', '📒', '🎓', '🏫', '✏️', '🖊️', '📝', '🔬', '🔭', '🌍', '🌎', '🌏'],
                    tools: ['🔧', '🔨', '⚙️', '🛠️', '🔩', '🔮', '💡', '🔦', '🔋', '🔌', '💻', '🖥️', '📱', '⌚', '📷', '📸', '📹', '🎥', '📼'],
                    finance: ['💰', '💵', '💴', '💶', '💷', '💸', '💳', '🏧', '🏦', '🏛️', '🏨', '💎', '📈', '📉', '🔔', '⏰', '📊', '💹'],
                    other: ['🏠', '🏥', '🏪', '🏫', '🏢', '⛽', '🅿️', '🚗', '🚕', '🚌', '🚇', '✈️', '🚀', '⚓', '🎁', '🎈', '🎉', '🎊', '🏆']
                };

                // 默认订阅分类
                this.defaultCategories = [
                    { id: 'sub_cat_1', name: '娱乐', icon: '🎬' },
                    { id: 'sub_cat_2', name: '办公', icon: '💼' },
                    { id: 'sub_cat_3', name: '教育', icon: '📚' },
                    { id: 'sub_cat_4', name: '工具', icon: '🔧' },
                    { id: 'sub_cat_5', name: '健康', icon: '🏥' },
                    { id: 'sub_cat_6', name: '金融', icon: '💰' },
                    { id: 'sub_cat_7', name: '其他', icon: '📦' }
                ];
            }

            // 检测localStorage是否可用
            isLocalStorageAvailable() {
                try {
                    const test = 'test';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            }

            // 初始化默认数据
            initDefaultData() {
                console.log('开始初始化订阅默认数据');

                const categories = this.getSubscriptionCategories();
                console.log('当前订阅分类数量:', categories.length);
                if (!categories.length) {
                    console.log('初始化默认订阅分类');
                    this.saveSubscriptionCategories(this.defaultCategories);
                }

                console.log('初始化订阅默认数据完成');
            }

            // ============================================================
            // 订阅管理
            // ============================================================

            getSubscriptions() {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionsKey);
                        return doc && doc.subscriptions ? doc.subscriptions : [];
                    } else if (this.localStorageAvailable) {
                        const data = localStorage.getItem(this.subscriptionsKey);
                        return data ? JSON.parse(data) : [];
                    } else {
                        return this.memoryStorage.subscriptions;
                    }
                } catch (error) {
                    console.error('获取订阅数据失败:', error);
                    return this.memoryStorage.subscriptions;
                }
            }

            saveSubscriptions(subscriptions) {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionsKey);
                        const putDoc = {
                            _id: this.subscriptionsKey,
                            subscriptions: subscriptions
                        };
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.subscriptionsKey, JSON.stringify(subscriptions));
                        return true;
                    } else {
                        this.memoryStorage.subscriptions = subscriptions;
                        return true;
                    }
                } catch (error) {
                    console.error('保存订阅数据失败:', error);
                    this.memoryStorage.subscriptions = subscriptions;
                    return true;
                }
            }

            addSubscription(subscription) {
                const subscriptions = this.getSubscriptions();
                const newSubscription = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    reminderEnabled: true,
                    reminderDays: 1,
                    currency: 'CNY',
                    ...subscription
                };

                // 计算下次扣费日期
                newSubscription.nextBillingDate = this.calculateNextBillingDate(newSubscription);

                subscriptions.push(newSubscription);
                return this.saveSubscriptions(subscriptions) ? newSubscription : null;
            }

            updateSubscription(id, updates) {
                const subscriptions = this.getSubscriptions();
                // 确保ID比较时类型一致，同时支持数字和字符串
                const index = subscriptions.findIndex(s => s.id == id || s.id.toString() === id.toString());
                if (index !== -1) {
                    subscriptions[index] = {
                        ...subscriptions[index],
                        ...updates,
                        updatedAt: new Date().toISOString()
                    };

                    // 如果周期或扣费日期发生变化，重新计算下次扣费日期
                    if (updates.cycleType !== undefined || updates.cycleValue !== undefined || updates.firstBillingDate !== undefined) {
                        subscriptions[index].nextBillingDate = this.calculateNextBillingDate(subscriptions[index]);
                    }

                    return this.saveSubscriptions(subscriptions);
                }
                return false;
            }

            deleteSubscription(id) {
                const subscriptions = this.getSubscriptions();
                // 确保ID比较时类型一致，同时支持数字和字符串
                const filtered = subscriptions.filter(s => s.id != id && s.id.toString() !== id.toString());
                return this.saveSubscriptions(filtered);
            }

            getSubscriptionById(id) {
                const subscriptions = this.getSubscriptions();
                // 确保ID比较时类型一致，同时支持数字和字符串
                return subscriptions.find(s => s.id == id || s.id.toString() === id.toString()) || null;
            }

            // 计算下次扣费日期
            calculateNextBillingDate(subscription) {
                if (subscription.cycleType === 'lifetime') {
                    return null;
                }

                const { firstBillingDate, cycleType, cycleValue = 1 } = subscription;
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                let nextDate;

                switch (cycleType) {
                    case 'day':
                        // 按天扣费，下次扣费日期就是明天
                        nextDate = new Date(today);
                        nextDate.setDate(nextDate.getDate() + 1);
                        break;

                    case 'week':
                        // firstBillingDate 是星期几 (0-6, 0=周日)
                        const dayOfWeek = parseInt(firstBillingDate);
                        nextDate = new Date(today);
                        const currentDayOfWeek = nextDate.getDay();
                        const daysUntilBilling = (dayOfWeek - currentDayOfWeek + 7) % 7;
                        // 如果今天就是扣费日，下次是7天后
                        if (daysUntilBilling === 0) {
                            nextDate.setDate(nextDate.getDate() + 7);
                        } else {
                            nextDate.setDate(nextDate.getDate() + daysUntilBilling);
                        }
                        break;

                    case 'month':
                        // firstBillingDate 是几号 (1-31)
                        const dayOfMonth = parseInt(firstBillingDate);
                        nextDate = new Date(today);
                        nextDate.setDate(1); // 设为本月第一天
                        nextDate.setDate(dayOfMonth);
                        // 如果这个日期已经过了，设为下个月
                        if (nextDate <= today) {
                            nextDate.setMonth(nextDate.getMonth() + 1);
                            // 重新设置日期，因为可能跨月
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            nextDate.setDate(Math.min(dayOfMonth, lastDayOfMonth));
                        } else {
                            // 处理月份没有31天的情况
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            if (dayOfMonth > lastDayOfMonth) {
                                nextDate.setDate(lastDayOfMonth);
                            }
                        }
                        break;

                    case 'quarter':
                        // firstBillingDate 是季度起始月-日格式 (如 "1-15")
                        const [qMonth, qDay] = firstBillingDate.split('-').map(Number);
                        nextDate = new Date(today);

                        // 找出用户选择的季度月份属于哪个季度（1月=Q1, 4月=Q2, 7月=Q3, 10月=Q4）
                        const quarterMonths = [1, 4, 7, 10];
                        const baseQuarterIndex = quarterMonths.indexOf(qMonth);

                        // 找出当前日期对应的季度
                        const currentMonth = nextDate.getMonth() + 1; // 1-12
                        const currentQuarterIndex = Math.floor((currentMonth - 1) / 3);

                        // 计算从基准季度到当前季度的偏移
                        let quartersSinceBase = currentQuarterIndex - baseQuarterIndex;
                        if (quartersSinceBase < 0) {
                            quartersSinceBase += 4;
                        }

                        // 设置下一个扣费日期
                        nextDate.setMonth(qMonth - 1, 1);
                        nextDate.setDate(qDay);

                        // 如果当前基准季度的日期已经过了，加一个季度（3个月）
                        if (nextDate <= today) {
                            nextDate.setMonth(nextDate.getMonth() + 3);
                            // 重新设置日期，因为可能跨月
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            nextDate.setDate(Math.min(qDay, lastDayOfMonth));
                        } else {
                            // 处理月份没有该日期的情况（如2月30日）
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            if (qDay > lastDayOfMonth) {
                                nextDate.setDate(lastDayOfMonth);
                            }
                        }
                        break;

                    case 'year':
                        // firstBillingDate 是月-日格式 (如 "3-15")
                        const [month, day] = firstBillingDate.split('-').map(Number);
                        nextDate = new Date(today);
                        nextDate.setMonth(month - 1, 1);
                        nextDate.setDate(day);
                        if (nextDate <= today) {
                            nextDate.setFullYear(nextDate.getFullYear() + 1);
                            // 重新设置日期，处理闰年等情况
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            nextDate.setDate(Math.min(day, lastDayOfMonth));
                        } else {
                            const lastDayOfMonth = new Date(nextDate.getFullYear(), nextDate.getMonth() + 1, 0).getDate();
                            if (day > lastDayOfMonth) {
                                nextDate.setDate(lastDayOfMonth);
                            }
                        }
                        break;

                    default:
                        return null;
                }

                return nextDate.toISOString().split('T')[0];
            }

            // 更新所有订阅的下次扣费日期
            updateAllNextBillingDates() {
                const subscriptions = this.getSubscriptions();
                let updated = false;
                subscriptions.forEach(sub => {
                    if (sub.cycleType !== 'lifetime') {
                        const oldNextBillingDate = sub.nextBillingDate;
                        sub.nextBillingDate = this.calculateNextBillingDate(sub);
                        if (oldNextBillingDate !== sub.nextBillingDate) {
                            updated = true;
                        }
                    }
                });
                if (updated) {
                    this.saveSubscriptions(subscriptions);
                }
            }

            // ============================================================
            // 订阅分类管理
            // ============================================================

            getSubscriptionCategories() {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionCategoriesKey);
                        return doc && doc.categories ? doc.categories : [];
                    } else if (this.localStorageAvailable) {
                        const data = localStorage.getItem(this.subscriptionCategoriesKey);
                        return data ? JSON.parse(data) : [];
                    } else {
                        return this.memoryStorage.subscriptionCategories;
                    }
                } catch (error) {
                    console.error('获取订阅分类数据失败:', error);
                    return this.memoryStorage.subscriptionCategories;
                }
            }

            saveSubscriptionCategories(categories) {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.subscriptionCategoriesKey);
                        const putDoc = {
                            _id: this.subscriptionCategoriesKey,
                            categories: categories
                        };
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.subscriptionCategoriesKey, JSON.stringify(categories));
                        return true;
                    } else {
                        this.memoryStorage.subscriptionCategories = categories;
                        return true;
                    }
                } catch (error) {
                    console.error('保存订阅分类数据失败:', error);
                    this.memoryStorage.subscriptionCategories = categories;
                    return true;
                }
            }

            addSubscriptionCategory(category) {
                const categories = this.getSubscriptionCategories();
                const newCategory = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    createdAt: new Date().toISOString(),
                    ...category
                };
                categories.push(newCategory);
                return this.saveSubscriptionCategories(categories) ? newCategory : null;
            }

            updateSubscriptionCategory(id, updates) {
                const categories = this.getSubscriptionCategories();
                const index = categories.findIndex(c => c.id === id);
                if (index !== -1) {
                    categories[index] = { ...categories[index], ...updates };
                    return this.saveSubscriptionCategories(categories);
                }
                return false;
            }

            // 删除订阅分类（将该分类下的订阅转移到"其他"分类）
            deleteSubscriptionCategory(id) {
                const categories = this.getSubscriptionCategories();

                // 找到"其他"分类
                const otherCategory = categories.find(c => c.name === '其他');
                if (!otherCategory) {
                    console.error('未找到"其他"分类');
                    return false;
                }

                // 防止删除"其他"分类本身
                const categoryToDelete = categories.find(c => c.id === id);
                if (!categoryToDelete) {
                    console.error('分类不存在:', id);
                    return false;
                }

                if (categoryToDelete.name === '其他') {
                    console.error('不能删除"其他"分类');
                    return false;
                }

                // 将属于该分类的订阅转移到"其他"分类
                const subscriptions = this.getSubscriptions();
                const updatedSubscriptions = subscriptions.map(sub => {
                    if (sub.category === id) {
                        return { ...sub, category: otherCategory.id };
                    }
                    return sub;
                });

                // 保存更新后的订阅
                this.saveSubscriptions(updatedSubscriptions);

                // 删除分类
                const filtered = categories.filter(c => c.id !== id);
                return this.saveSubscriptionCategories(filtered);
            }

            getSubscriptionCategoryById(id) {
                const categories = this.getSubscriptionCategories();
                return categories.find(c => c.id === id) || null;
            }

            // ============================================================
            // 提醒日志管理
            // ============================================================

            getReminderLog() {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.reminderLogKey);
                        return doc && doc.logs ? doc.logs : [];
                    } else if (this.localStorageAvailable) {
                        const data = localStorage.getItem(this.reminderLogKey);
                        return data ? JSON.parse(data) : [];
                    } else {
                        return this.memoryStorage.reminderLog;
                    }
                } catch (error) {
                    console.error('获取提醒日志失败:', error);
                    return this.memoryStorage.reminderLog;
                }
            }

            saveReminderLog(logs) {
                try {
                    if (this.useUToolsDB) {
                        const doc = utools.db.get(this.reminderLogKey);
                        const putDoc = {
                            _id: this.reminderLogKey,
                            logs: logs
                        };
                        if (doc && doc._rev) {
                            putDoc._rev = doc._rev;
                        }
                        const result = utools.db.put(putDoc);
                        return result.ok;
                    } else if (this.localStorageAvailable) {
                        localStorage.setItem(this.reminderLogKey, JSON.stringify(logs));
                        return true;
                    } else {
                        this.memoryStorage.reminderLog = logs;
                        return true;
                    }
                } catch (error) {
                    console.error('保存提醒日志失败:', error);
                    this.memoryStorage.reminderLog = logs;
                    return true;
                }
            }

            addReminderLog(log) {
                const logs = this.getReminderLog();
                const newLog = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    ...log
                };
                logs.push(newLog);

                // 清理3个月前的旧日志
                const threeMonthsAgo = new Date();
                threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);
                const filteredLogs = logs.filter(log => {
                    return new Date(log.reminderDate) >= threeMonthsAgo;
                });

                return this.saveReminderLog(filteredLogs) ? newLog : null;
            }

            hasReminder(subscriptionId, billingDate) {
                const logs = this.getReminderLog();
                return logs.some(log =>
                    log.subscriptionId === subscriptionId &&
                    log.billingDate === billingDate &&
                    log.notified
                );
            }
        }

        // ============================================================
        // 订阅管理类
        // ============================================================
        class SubscriptionManager {
            constructor(storage) {
                this.storage = storage;
            }

            // 检查提醒
            checkReminders() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const subscriptions = this.storage.getSubscriptions();

                subscriptions.forEach(sub => {
                    if (sub.status !== 'active' || !sub.reminderEnabled || !sub.nextBillingDate) return;

                    const nextBillingDate = new Date(sub.nextBillingDate);
                    nextBillingDate.setHours(0, 0, 0, 0);
                    const daysUntilBilling = Math.ceil((nextBillingDate - today) / (1000 * 60 * 60 * 24));

                    // 检查是否在提醒范围内
                    if (daysUntilBilling <= sub.reminderDays && daysUntilBilling >= 0) {
                        // 检查是否已发送过提醒
                        const alreadyNotified = this.storage.hasReminder(sub.id, sub.nextBillingDate);

                        if (!alreadyNotified) {
                            // 发送通知
                            const cycleText = this.getCycleText(sub.cycleType, sub.cycleValue);
                            let message = `🔔 ${sub.icon || '📦'} ${sub.name}\n`;
                            message += `将在 ${daysUntilBilling === 0 ? '今天' : daysUntilBilling + ' 天后'}扣费 ¥${sub.price}\n`;
                            message += `周期：${cycleText}`;

                            if (typeof utools !== 'undefined' && utools.showNotification) {
                                utools.showNotification(message);
                            }

                            // 记录提醒日志
                            this.storage.addReminderLog({
                                subscriptionId: sub.id,
                                reminderDate: today.toISOString().split('T')[0],
                                billingDate: sub.nextBillingDate,
                                notified: true,
                                notifiedAt: new Date().toISOString()
                            });
                        }
                    }
                });
            }

            // 获取周期文本
            getCycleText(cycleType, cycleValue = 1) {
                const cycleTexts = {
                    day: cycleValue === 1 ? '每天' : `每${cycleValue}天`,
                    week: cycleValue === 1 ? '每周' : `每${cycleValue}周`,
                    month: cycleValue === 1 ? '每月' : `每${cycleValue}个月`,
                    quarter: cycleValue === 1 ? '每季度' : `每${cycleValue}季度`,
                    year: cycleValue === 1 ? '每年' : `每${cycleValue}年`,
                    lifetime: '终身有效'
                };
                return cycleTexts[cycleType] || cycleType;
            }

            // 获取月度支出
            getMonthlyExpense(year, month) {
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');
                let total = 0;

                subscriptions.forEach(sub => {
                    if (!sub.nextBillingDate) return;
                    const nextDate = new Date(sub.nextBillingDate);
                    if (nextDate.getFullYear() === year && nextDate.getMonth() + 1 === month) {
                        total += sub.price;
                    }
                });

                return total;
            }

            // 获取年度支出
            getYearlyExpense(year) {
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');
                let total = 0;

                subscriptions.forEach(sub => {
                    if (sub.cycleType === 'lifetime') return;

                    // 估算年度支出
                    const yearlyMultiplier = this.getYearlyMultiplier(sub.cycleType, sub.cycleValue);
                    total += sub.price * yearlyMultiplier;
                });

                return total;
            }

            // 获取年度倍数
            getYearlyMultiplier(cycleType, cycleValue = 1) {
                const multipliers = {
                    day: 365 / cycleValue,
                    week: 52 / cycleValue,
                    month: 12 / cycleValue,
                    quarter: 4 / cycleValue,
                    year: 1 / cycleValue,
                    lifetime: 0
                };
                return Math.round(multipliers[cycleType] * 100) / 100;
            }

            // 获取即将到期的订阅
            getUpcomingSubscriptions(days = 7) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const futureDate = new Date(today);
                futureDate.setDate(futureDate.getDate() + days);

                const subscriptions = this.storage.getSubscriptions().filter(sub => {
                    if (sub.status !== 'active' || !sub.nextBillingDate) return false;
                    const nextDate = new Date(sub.nextBillingDate);
                    return nextDate >= today && nextDate <= futureDate;
                });

                return subscriptions.sort((a, b) => new Date(a.nextBillingDate) - new Date(b.nextBillingDate));
            }

            // 获取分类支出
            getCategoryExpenses(year, month) {
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');
                const expenses = {};

                subscriptions.forEach(sub => {
                    if (!sub.nextBillingDate) return;
                    const nextDate = new Date(sub.nextBillingDate);
                    if (nextDate.getFullYear() === year && nextDate.getMonth() + 1 === month) {
                        const category = sub.category || '未分类';
                        expenses[category] = (expenses[category] || 0) + sub.price;
                    }
                });

                return Object.entries(expenses).map(([category, amount]) => ({ category, amount }));
            }

            // 获取月度趋势数据（最近12个月）
            getMonthlyTrend() {
                const trend = [];
                const today = new Date();
                const year = today.getFullYear();
                const month = today.getMonth() + 1;

                for (let i = 11; i >= 0; i--) {
                    const date = new Date(year, month - 1 - i, 1);
                    const trendYear = date.getFullYear();
                    const trendMonth = date.getMonth() + 1;
                    trend.push({
                        year: trendYear,
                        month: trendMonth,
                        label: `${trendYear}年${trendMonth}月`,
                        amount: this.getMonthlyExpense(trendYear, trendMonth)
                    });
                }

                return trend;
            }
        }

        // ============================================================
        // 订阅UI管理类
        // ============================================================
        class SubscriptionUI {
            constructor(storage, manager, app) {
                this.storage = storage;
                this.manager = manager;
                this.app = app;
                this.currentEditingSubscription = null;
                this.currentCalendarDate = new Date();
            }

            // 渲染订阅面板
            renderSubscriptionPanel() {
                this.updateQuickStats();
                this.renderSubscriptionCategoryTabs();
                this.renderCalendar();
                this.renderSubscriptionList();
            }

            // 更新快速统计
            updateQuickStats() {
                const today = new Date();
                const monthlyExpense = this.manager.getMonthlyExpense(today.getFullYear(), today.getMonth() + 1);
                const yearlyExpense = this.manager.getYearlyExpense(today.getFullYear());
                const upcoming = this.manager.getUpcomingSubscriptions(7);
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');

                document.getElementById('subscription-monthly-expense').textContent = `¥${monthlyExpense.toFixed(2)}`;
                document.getElementById('subscription-yearly-expense').textContent = `¥${yearlyExpense.toFixed(2)}`;
                document.getElementById('subscription-upcoming-count').textContent = `${upcoming.length}个`;
                document.getElementById('subscription-total-count').textContent = subscriptions.length;
            }

            // 渲染订阅分类标签
            renderSubscriptionCategoryTabs() {
                const container = document.querySelector('.subscription-category-tabs');
                if (!container) return;

                const categories = this.storage.getSubscriptionCategories();

                // 保留"全部"按钮
                const allBtn = container.querySelector('button[data-category="all"]');
                container.innerHTML = '';
                if (allBtn) container.appendChild(allBtn);
                else {
                    const btn = document.createElement('button');
                    btn.className = 'category-tab active';
                    btn.dataset.category = 'all';
                    btn.textContent = '全部';
                    container.appendChild(btn);
                }

                // 排序：把"其他"分类放在最后
                const sortedCategories = [...categories].sort((a, b) => {
                    if (a.name === '其他') return 1;
                    if (b.name === '其他') return -1;
                    return 0;
                });

                sortedCategories.forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = 'category-tab';
                    btn.dataset.category = category.name;
                    btn.textContent = `${category.icon} ${category.name}`;
                    container.appendChild(btn);
                });

                // 绑定点击事件
                container.querySelectorAll('.category-tab').forEach(tab => {
                    tab.onclick = () => {
                        container.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.renderSubscriptionList(tab.dataset.category);
                    };
                });
            }

            // 渲染订阅列表
            renderSubscriptionList(category = 'all') {
                const container = document.getElementById('subscription-list');
                if (!container) return;

                let subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active');

                if (category !== 'all') {
                    subscriptions = subscriptions.filter(sub => sub.category === category);
                }

                if (subscriptions.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <div class="empty-state-text">暂无订阅</div>
                            <div class="empty-state-hint">点击右下角的 + 按钮添加您的第一个订阅</div>
                        </div>
                    `;
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                container.innerHTML = subscriptions.map(sub => {
                    const nextDate = new Date(sub.nextBillingDate);
                    nextDate.setHours(0, 0, 0, 0);
                    const daysUntil = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));
                    const cycleText = this.manager.getCycleText(sub.cycleType, sub.cycleValue);

                    let billingClass = '';
                    if (daysUntil <= 1) billingClass = 'urgent';
                    else if (daysUntil <= 7) billingClass = 'soon';

                    const billingText = sub.cycleType === 'lifetime'
                        ? '终身有效'
                        : daysUntil === 0
                        ? '今天扣费'
                        : daysUntil === 1
                        ? '明天扣费'
                        : `${daysUntil}天后扣费`;

                    // 获取分类名称
                    const cat = this.storage.getSubscriptionCategoryById(sub.category);
                    const categoryName = cat ? cat.name : '未分类';

                    return `
                        <div class="subscription-card" data-id="${sub.id}">
                            <div class="subscription-header">
                                <div class="subscription-name">
                                    <span class="subscription-icon">${sub.icon || '📦'}</span>
                                    <span>${sub.name}</span>
                                </div>
                                <div class="subscription-category">${categoryName}</div>
                            </div>
                            <div class="subscription-footer">
                                <div class="subscription-price">¥${sub.price}<span class="subscription-price-unit">/${cycleText}</span></div>
                                <div class="subscription-billing ${billingClass}">${sub.nextBillingDate || '无'} (${billingText})</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 渲染日历
            renderCalendar() {
                const year = this.currentCalendarDate.getFullYear();
                const month = this.currentCalendarDate.getMonth();

                // 更新标题
                const titleEl = document.querySelector('.calendar-title');
                if (titleEl) {
                    titleEl.textContent = `${year}年${month + 1}月`;
                }

                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startWeekday = firstDay.getDay();
                const daysInMonth = lastDay.getDate();

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // 获取当月扣费订阅
                const subscriptions = this.storage.getSubscriptions().filter(sub => sub.status === 'active' && sub.nextBillingDate);
                const billingDates = {};
                subscriptions.forEach(sub => {
                    const date = new Date(sub.nextBillingDate);
                    if (date.getFullYear() === year && date.getMonth() === month) {
                        const day = date.getDate();
                        if (!billingDates[day]) billingDates[day] = [];
                        billingDates[day].push(sub);
                    }
                });

                // 生成日历
                const container = document.getElementById('subscription-calendar-days');
                if (!container) return;

                container.innerHTML = '';

                // 填充空白
                for (let i = 0; i < startWeekday; i++) {
                    container.innerHTML += '<div class="calendar-day empty"></div>';
                }

                // 填充日期
                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(year, month, day);
                    const isToday = currentDate.getTime() === today.getTime();
                    const hasBilling = billingDates[day] && billingDates[day].length > 0;

                    let dotsHtml = '';
                    if (hasBilling) {
                        dotsHtml = '<div class="billing-dots">';
                        billingDates[day].forEach(sub => {
                            dotsHtml += `<span class="billing-dot" title="${sub.name} - ¥${sub.price}">${sub.icon || '📦'}</span>`;
                        });
                        dotsHtml += '</div>';
                    }

                    container.innerHTML += `
                        <div class="calendar-day ${isToday ? 'today' : ''} ${hasBilling ? 'has-billing' : ''}" data-day="${day}">
                            <span class="day-number">${day}</span>
                            ${dotsHtml}
                        </div>
                    `;
                }

                // 绑定点击事件
                container.querySelectorAll('.calendar-day:not(.empty)').forEach(dayEl => {
                    dayEl.onclick = () => {
                        const day = parseInt(dayEl.dataset.day);
                        if (billingDates[day] && billingDates[day].length > 0) {
                            this.showBillingDateDetail(year, month, day, billingDates[day]);
                        }
                    };
                });
            }

            // 显示扣费日期详情
            showBillingDateDetail(year, month, day, subscriptions) {
                const modal = document.getElementById('billing-date-detail-modal');
                const titleEl = document.getElementById('billing-date-detail-title');
                const listEl = document.getElementById('billing-date-detail-list');

                titleEl.textContent = `${year}年${month + 1}月${day}日 扣费详情`;

                listEl.innerHTML = subscriptions.map(sub => `
                    <div class="billing-detail-item">
                        <div class="billing-detail-info">
                            <div class="billing-detail-name">
                                <span>${sub.icon || '📦'}</span>
                                <span>${sub.name}</span>
                            </div>
                            <div class="billing-detail-price">¥${sub.price} · ${this.manager.getCycleText(sub.cycleType, sub.cycleValue)}</div>
                        </div>
                        <div class="billing-detail-actions">
                            <button class="edit" data-id="${sub.id}">编辑</button>
                        </div>
                    </div>
                `).join('');

                modal.classList.add('active');
            }

            closeBillingDateDetail() {
                const modal = document.getElementById('billing-date-detail-modal');
                modal.classList.remove('active');
            }

            // 打开添加订阅对话框
            openAddSubscriptionDialog() {
                console.log('openAddSubscriptionDialog 被调用');
                this.currentEditingSubscription = null;
                const modal = document.getElementById('subscription-modal');
                console.log('找到订阅模态框:', !!modal);
                document.getElementById('subscription-modal-title').textContent = '添加订阅';

                // 重置表单
                document.getElementById('subscription-name').value = '';
                document.getElementById('subscription-price').value = '';
                document.getElementById('subscription-cycle-type').value = 'month';
                document.getElementById('subscription-reminder-enabled').checked = true;
                document.getElementById('subscription-reminder-days').value = '1';
                document.getElementById('subscription-notes').value = '';
                document.getElementById('subscription-website').value = '';
                document.getElementById('subscription-icon').value = '🎬';
                document.getElementById('subscription-icon-preview').textContent = '🎬';

                // 重置终身订阅选项
                const lifetimeIncludeDailyCheckbox = document.getElementById('lifetime-include-daily');
                const lifetimePurchaseDateInput = document.getElementById('lifetime-purchase-date');
                const lifetimePurchaseDateGroup = document.getElementById('lifetime-purchase-date-group');
                if (lifetimeIncludeDailyCheckbox) lifetimeIncludeDailyCheckbox.checked = false;
                if (lifetimePurchaseDateInput) lifetimePurchaseDateInput.value = '';
                if (lifetimePurchaseDateGroup) lifetimePurchaseDateGroup.style.display = 'none';

                // 填充分类选项
                this.fillSubscriptionCategories();

                // 更新扣费日期输入方式为默认的"按月"
                this.updateBillingDateInput('month');

                modal.classList.add('active');
            }

            // 打开编辑订阅对话框
            openEditSubscriptionDialog(id) {
                const sub = this.storage.getSubscriptionById(id);
                if (!sub) return;

                this.currentEditingSubscription = sub;
                const modal = document.getElementById('subscription-modal');
                document.getElementById('subscription-modal-title').textContent = '编辑订阅';

                // 填充表单
                document.getElementById('subscription-name').value = sub.name || '';
                document.getElementById('subscription-price').value = sub.price || '';
                const cycleType = sub.cycleType || 'month';
                document.getElementById('subscription-cycle-type').value = cycleType;
                document.getElementById('subscription-reminder-enabled').checked = sub.reminderEnabled !== false;
                document.getElementById('subscription-reminder-days').value = sub.reminderDays || 1;
                document.getElementById('subscription-notes').value = sub.notes || '';
                document.getElementById('subscription-website').value = sub.website || '';
                document.getElementById('subscription-icon').value = sub.icon || '🎬';
                document.getElementById('subscription-icon-preview').textContent = sub.icon || '🎬';

                // 填充分类选项
                this.fillSubscriptionCategories();
                document.getElementById('subscription-category').value = sub.category || '';

                // 更新扣费日期输入方式并设置值
                this.updateBillingDateInput(cycleType);
                if (sub.firstBillingDate) {
                    this.setBillingDateValue(cycleType, sub.firstBillingDate);
                }

                // 终身订阅的特殊选项
                if (cycleType === 'lifetime') {
                    const lifetimeIncludeDailyCheckbox = document.getElementById('lifetime-include-daily');
                    const lifetimePurchaseDateInput = document.getElementById('lifetime-purchase-date');
                    const lifetimePurchaseDateGroup = document.getElementById('lifetime-purchase-date-group');

                    lifetimeIncludeDailyCheckbox.checked = sub.lifetimeIncludeDaily || false;
                    lifetimePurchaseDateInput.value = sub.lifetimePurchaseDate || '';
                    if (sub.lifetimeIncludeDaily && sub.lifetimePurchaseDate) {
                        lifetimePurchaseDateGroup.style.display = 'block';
                    }
                }

                modal.classList.add('active');
            }

            // 填充订阅分类选项
            fillSubscriptionCategories() {
                const select = document.getElementById('subscription-category');
                if (!select) return;

                const categories = this.storage.getSubscriptionCategories();
                select.innerHTML = categories.map(cat =>
                    `<option value="${cat.name}">${cat.icon} ${cat.name}</option>`
                ).join('');
            }

            // 关闭订阅对话框
            closeSubscriptionDialog() {
                const modal = document.getElementById('subscription-modal');
                modal.classList.remove('active');
            }

            // 保存订阅
            saveSubscription() {
                const name = document.getElementById('subscription-name').value.trim();
                const category = document.getElementById('subscription-category').value;
                const price = parseFloat(document.getElementById('subscription-price').value);
                const cycleType = document.getElementById('subscription-cycle-type').value;
                const cycleValue = 1; // 固定为1，表示按选择的周期扣费一次
                const firstBillingDate = this.getBillingDateValue();
                const reminderEnabled = document.getElementById('subscription-reminder-enabled').checked;
                const reminderDays = parseInt(document.getElementById('subscription-reminder-days').value) || 1;
                const notes = document.getElementById('subscription-notes').value.trim();
                const website = document.getElementById('subscription-website').value.trim();
                const icon = document.getElementById('subscription-icon').value || '🎬';

                // 终身订阅的特殊选项
                let lifetimeIncludeDaily = false;
                let lifetimePurchaseDate = null;
                if (cycleType === 'lifetime') {
                    lifetimeIncludeDaily = document.getElementById('lifetime-include-daily').checked;
                    if (lifetimeIncludeDaily) {
                        lifetimePurchaseDate = document.getElementById('lifetime-purchase-date').value;
                        if (!lifetimePurchaseDate) {
                            alert('请选择购买日期');
                            return;
                        }
                    }
                }

                // 验证必填字段
                if (!name) {
                    alert('请输入订阅名称');
                    return;
                }
                if (!category) {
                    alert('请选择分类');
                    return;
                }
                if (isNaN(price) || price <= 0) {
                    alert('请输入有效的价格');
                    return;
                }
                if (cycleType !== 'lifetime' && !firstBillingDate) {
                    alert('请选择扣费日期');
                    return;
                }
                if (cycleType === 'lifetime' && lifetimeIncludeDaily && !lifetimePurchaseDate) {
                    alert('请选择购买日期');
                    return;
                }

                const data = {
                    name,
                    category,
                    price,
                    cycleType,
                    cycleValue,
                    firstBillingDate: cycleType === 'lifetime' ? null : firstBillingDate,
                    reminderEnabled,
                    reminderDays,
                    notes,
                    website,
                    icon,
                    // 终身订阅的额外字段
                    lifetimeIncludeDaily: cycleType === 'lifetime' ? lifetimeIncludeDaily : undefined,
                    lifetimePurchaseDate: cycleType === 'lifetime' ? lifetimePurchaseDate : undefined
                };

                let result;
                if (this.currentEditingSubscription) {
                    result = this.storage.updateSubscription(this.currentEditingSubscription.id, data);
                } else {
                    result = this.storage.addSubscription(data);
                }

                if (result) {
                    this.closeSubscriptionDialog();
                    this.renderSubscriptionPanel();
                    this.app.updateStats(); // 更新全局统计
                    this.app.showToast(this.currentEditingSubscription ? '订阅更新成功！' : '订阅添加成功！', 'success');
                } else {
                    this.app.showToast('操作失败，请重试！', 'error');
                }
            }

            // 删除订阅
            deleteSubscription(id) {
                this.app.confirm('删除订阅', '确定要删除这个订阅吗？此操作不可恢复。', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteSubscription(id);
                        if (result) {
                            this.renderSubscriptionPanel();
                            this.app.updateStats(); // 更新全局统计
                            this.app.showToast('订阅删除成功！', 'success');
                        } else {
                            this.app.showToast('删除失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 显示订阅详情
            showSubscriptionDetail(id) {
                const subscription = this.storage.getSubscriptionById(id);
                if (!subscription) return;

                const detailModal = document.getElementById('subscription-detail-modal');
                if (!detailModal) return;

                // 设置订阅名称
                const detailName = document.getElementById('detail-subscription-name');
                if (detailName) detailName.value = subscription.name || '';

                // 设置价格
                const detailPrice = document.getElementById('detail-subscription-price');
                if (detailPrice) detailPrice.value = subscription.price || 0;

                // 设置周期类型
                const detailCycleType = document.getElementById('detail-subscription-cycle-type');
                if (detailCycleType) detailCycleType.value = subscription.cycleType || 'month';

                // 设置图标
                const detailIcon = document.getElementById('detail-subscription-icon');
                const detailIconPreview = document.getElementById('detail-subscription-icon-preview');
                if (detailIcon) detailIcon.value = subscription.icon || '🎬';
                if (detailIconPreview) detailIconPreview.textContent = subscription.icon || '🎬';

                // 设置分类
                const detailCategory = document.getElementById('detail-subscription-category');
                if (detailCategory) {
                    // 填充分类选项
                    const categories = this.storage.getSubscriptionCategories();
                    detailCategory.innerHTML = categories.map(cat =>
                        `<option value="${cat.id}">${cat.icon} ${cat.name}</option>`
                    ).join('');
                    detailCategory.value = subscription.category || '';
                }

                // 设置备注
                const detailNotes = document.getElementById('detail-subscription-notes');
                if (detailNotes) detailNotes.value = subscription.notes || '';

                // 设置官网
                const detailWebsite = document.getElementById('detail-subscription-website');
                if (detailWebsite) detailWebsite.value = subscription.website || '';

                // 设置提醒
                const detailReminderEnabled = document.getElementById('detail-subscription-reminder-enabled');
                const detailReminderDays = document.getElementById('detail-subscription-reminder-days');
                if (detailReminderEnabled) detailReminderEnabled.checked = subscription.reminderEnabled !== false;
                if (detailReminderDays) detailReminderDays.value = subscription.reminderDays || 1;

                // 存储当前编辑的订阅
                this.currentEditingSubscription = subscription;

                // 保存原始值用于比较是否有修改
                const originalValues = {
                    '#detail-subscription-name': subscription.name || '',
                    '#detail-subscription-price': (subscription.price || 0).toString(),
                    '#detail-subscription-notes': subscription.notes || '',
                    '#detail-subscription-website': subscription.website || ''
                };
                detailModal.dataset.originalValues = JSON.stringify(originalValues);
                console.log('订阅详情弹窗 - 已保存原始值:', originalValues);

                detailModal.style.display = 'flex';
            }

            // 保存订阅详情
            saveSubscriptionDetail() {
                if (!this.currentEditingSubscription) return;

                const name = document.getElementById('detail-subscription-name').value.trim();
                const price = parseFloat(document.getElementById('detail-subscription-price').value) || 0;
                const category = document.getElementById('detail-subscription-category').value;
                const icon = document.getElementById('detail-subscription-icon').value;
                const cycleType = document.getElementById('detail-subscription-cycle-type').value;
                const notes = document.getElementById('detail-subscription-notes').value.trim();
                const website = document.getElementById('detail-subscription-website').value.trim();
                const reminderEnabled = document.getElementById('detail-subscription-reminder-enabled').checked;
                const reminderDays = parseInt(document.getElementById('detail-subscription-reminder-days').value) || 1;

                if (!name) {
                    this.app.showToast('请输入订阅名称', 'error');
                    return;
                }

                const updatedSubscription = {
                    ...this.currentEditingSubscription,
                    name,
                    price,
                    category,
                    icon,
                    cycleType,
                    notes,
                    website,
                    reminderEnabled,
                    reminderDays
                };

                const result = this.storage.updateSubscription(this.currentEditingSubscription.id, updatedSubscription);
                if (result) {
                    this.renderSubscriptionPanel();
                    this.app.updateStats(); // 更新全局统计
                    this.closeSubscriptionDetail();
                    this.app.showToast('订阅更新成功！', 'success');
                } else {
                    this.app.showToast('更新失败，请重试！', 'error');
                }
            }

            // 关闭订阅详情弹窗
            closeSubscriptionDetail() {
                const detailModal = document.getElementById('subscription-detail-modal');
                if (detailModal) {
                    detailModal.style.display = 'none';
                }
                this.currentEditingSubscription = null;
            }

            // 从详情弹窗删除订阅
            deleteSubscriptionDetail() {
                if (!this.currentEditingSubscription) return;

                this.app.confirm('删除订阅', '确定要删除这个订阅吗？此操作不可恢复。', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteSubscription(this.currentEditingSubscription.id);
                        if (result) {
                            this.renderSubscriptionPanel();
                            this.app.updateStats(); // 更新全局统计
                            this.closeSubscriptionDetail();
                            this.app.showToast('订阅删除成功！', 'success');
                        } else {
                            this.app.showToast('删除失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 获取订阅图标的中文名称
            getSubscriptionIconName(icon) {
                const iconNames = {
                    '🎬': '场记板', '🎞️': '胶片', '📺': '电视', '🎵': '音符', '🎤': '话筒', '🎧': '耳机', '🎸': '吉他', '🎹': '钢琴', '🎺': '小号',
                    '🎻': '小提琴', '🪕': '班卓琴', '🥁': '鼓', '🪘': '长鼓', '🎷': '萨克斯', '🎮': '游戏机', '🕹️': '摇杆',
                    '🎰': '老虎机', '🎲': '骰子', '🎳': '保龄球', '🃏': '国际象棋', '🀄': '围棋', '🎱': '台球', '🎯': '靶心',
                    '📚': '书籍', '📖': '书本', '💻': '电脑', '⌨️': '键盘', '🖥️': '显示器', '🖨️': '打印机', '💾': '软盘',
                    '🏠': '房子', '✈️': '飞机', '🍔': '汉堡', '☕': '咖啡', '💊': '药丸', '👕': 'T恤', '⚽': '足球',
                    '🏋️': '举重', '🎨': '调色板', '🔧': '扳手', '🎁': '礼物', '🎈': '气球', '🎉': '拉炮', '🎊': '糖果',
                    '🔔': '铃铛', '🔕': '静音', '📿': '念珠', '⭐': '星星', '🌟': '闪星', '💫': '流星', '✨': '星光',
                    '💰': '钱袋', '💵': '美元', '💴': '日元', '💶': '欧元', '💷': '英镑', '💳': '银行卡', '🧾': '收据',
                    '⏱️': '秒表', '⏰': '闹钟', '🏦': '银行', '🏥': '医院', '🚗': '汽车', '🚕': '出租车', '🚌': '公交车',
                    '🛒': '购物车', '🛍️': '购物袋', '👑': '皇冠', '💍': '戒指', '💎': '宝石', '💄': '口红',
                    '🔮': '水晶球', '🎪': '马戏团', '🎭': '面具', '🏆': '奖杯', '🏅': '奖牌'
                };
                return iconNames[icon] || icon;
            }

            // ============================================================
            // 扣费日期处理
            // ============================================================

            // 初始化扣费日期选项
            initBillingDateOptions() {
                try {
                    // 初始化月份选项
                    const monthSelect = document.getElementById('subscription-month');
                    if (monthSelect) {
                        const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
                        monthSelect.innerHTML = months.map((m, i) => `<option value="${i + 1}">${m}</option>`).join('');
                    }

                    // 初始化日期选项（1-31日）
                    const dayOfMonthSelect = document.getElementById('subscription-day-of-month');
                    if (dayOfMonthSelect) {
                        dayOfMonthSelect.innerHTML = Array.from({ length: 31 }, (_, i) =>
                            `<option value="${i + 1}">${i + 1}号</option>`
                        ).join('');
                    }

                    // 初始化季度日期选项（1-31日）
                    const quarterDaySelect = document.getElementById('subscription-quarter-day');
                    if (quarterDaySelect) {
                        quarterDaySelect.innerHTML = Array.from({ length: 31 }, (_, i) =>
                            `<option value="${i + 1}">${i + 1}日</option>`
                        ).join('');
                    }

                    // 初始化年度日期选项（1-31日）
                    const dayOfYearSelect = document.getElementById('subscription-day-of-year-day');
                    if (dayOfYearSelect) {
                        dayOfYearSelect.innerHTML = Array.from({ length: 31 }, (_, i) =>
                            `<option value="${i + 1}">${i + 1}日</option>`
                        ).join('');
                    }

                    // 默认显示按月的输入方式
                    this.updateBillingDateInput('month');
                } catch (error) {
                    console.error('初始化扣费日期选项失败:', error);
                }
            }

            // 根据周期类型更新扣费日期输入方式
            updateBillingDateInput(cycleType) {
                const label = document.getElementById('billing-date-label');
                const hint = document.getElementById('billing-date-hint');
                const dayOfWeek = document.getElementById('billing-day-of-week');
                const dayOfMonth = document.getElementById('billing-day-of-month');
                const dayOfQuarter = document.getElementById('billing-day-of-quarter');
                const dayOfYear = document.getElementById('billing-day-of-year');
                const dayHint = document.getElementById('billing-day-hint');
                const lifetimeOptionsGroup = document.getElementById('lifetime-options-group');

                // 隐藏所有选项
                if (dayOfWeek) dayOfWeek.style.display = 'none';
                if (dayOfMonth) dayOfMonth.style.display = 'none';
                if (dayOfQuarter) dayOfQuarter.style.display = 'none';
                if (dayOfYear) dayOfYear.style.display = 'none';
                if (dayHint) dayHint.style.display = 'none';
                if (lifetimeOptionsGroup) lifetimeOptionsGroup.style.display = 'none';

                switch (cycleType) {
                    case 'day':
                        if (label) label.innerHTML = '扣费日期';
                        if (hint) hint.textContent = '每天扣费，系统将从今天开始每天计算';
                        if (dayHint) dayHint.style.display = 'block';
                        break;
                    case 'week':
                        if (label) label.innerHTML = '扣费日期（星期几） <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = '选择每周几扣费';
                        if (dayOfWeek) dayOfWeek.style.display = 'block';
                        break;
                    case 'month':
                        if (label) label.innerHTML = '扣费日期（几号） <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = '选择每月几号扣费';
                        if (dayOfMonth) dayOfMonth.style.display = 'block';
                        break;
                    case 'quarter':
                        if (label) label.innerHTML = '扣费日期（季度起始月-日） <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = '选择季度中的起始月份和日期，系统会在每季度（每3个月）的该日期扣费';
                        if (dayOfQuarter) dayOfQuarter.style.display = 'block';
                        break;
                    case 'year':
                        if (label) label.innerHTML = '扣费日期（月-日） <span style="color: #f5222d;">*</span>';
                        if (hint) hint.textContent = '选择每年几月几日扣费';
                        if (dayOfYear) dayOfYear.style.display = 'block';
                        break;
                    case 'lifetime':
                        if (label) label.innerHTML = '扣费日期';
                        if (hint) hint.textContent = '终身有效，无需扣费';
                        if (dayHint) {
                            dayHint.style.display = 'block';
                            dayHint.querySelector('div').textContent = '终身有效，无需扣费';
                        }
                        // 显示终身订阅选项
                        if (lifetimeOptionsGroup) lifetimeOptionsGroup.style.display = 'block';
                        break;
                    default:
                        // 其他周期类型不显示终身订阅选项
                        break;
                }
            }

            // 获取扣费日期值（根据当前选择的周期类型）
            getBillingDateValue() {
                const cycleType = document.getElementById('subscription-cycle-type').value;

                switch (cycleType) {
                    case 'day':
                        return new Date().toISOString().split('T')[0]; // 按天，返回今天
                    case 'week':
                        return document.getElementById('subscription-day-of-week').value;
                    case 'month':
                        return document.getElementById('subscription-day-of-month').value;
                    case 'quarter':
                        const qMonth = document.getElementById('subscription-quarter-month').value;
                        const qDay = document.getElementById('subscription-quarter-day').value;
                        return `${qMonth}-${qDay}`;
                    case 'year':
                        const month = document.getElementById('subscription-month').value;
                        const day = document.getElementById('subscription-day-of-year-day').value;
                        return `${month}-${day}`;
                    default:
                        return '';
                }
            }

            // 设置扣费日期值（用于编辑订阅）
            setBillingDateValue(cycleType, firstBillingDate) {
                switch (cycleType) {
                    case 'week':
                        document.getElementById('subscription-day-of-week').value = firstBillingDate;
                        break;
                    case 'month':
                        document.getElementById('subscription-day-of-month').value = firstBillingDate;
                        break;
                    case 'quarter':
                        const [qMonth, qDay] = firstBillingDate.split('-');
                        document.getElementById('subscription-quarter-month').value = qMonth;
                        document.getElementById('subscription-quarter-day').value = qDay;
                        break;
                    case 'year':
                        const [month, day] = firstBillingDate.split('-');
                        document.getElementById('subscription-month').value = month;
                        document.getElementById('subscription-day-of-year-day').value = day;
                        break;
                }
            }

            // ============================================================
            // 图标选择器
            // ============================================================

            openIconPicker() {
                const modal = document.getElementById('icon-picker-modal');
                modal.classList.add('active');
                this.renderIconPickerIcons('common');
            }

            closeIconPicker() {
                const modal = document.getElementById('icon-picker-modal');
                modal.classList.remove('active');
            }

            renderIconPickerIcons(category) {
                const container = document.getElementById('icon-picker-icons');
                if (!container) return;

                const icons = this.storage.iconLibrary[category] || this.storage.iconLibrary.common;

                container.innerHTML = icons.map(icon => `
                    <div class="icon-picker-icon" data-icon="${icon}">${icon}</div>
                `).join('');

                // 绑定点击事件
                container.querySelectorAll('.icon-picker-icon').forEach(iconEl => {
                    iconEl.onclick = () => {
                        const icon = iconEl.dataset.icon;
                        document.getElementById('subscription-icon').value = icon;
                        document.getElementById('subscription-icon-preview').textContent = icon;

                        container.querySelectorAll('.icon-picker-icon').forEach(i => i.classList.remove('selected'));
                        iconEl.classList.add('selected');

                        this.closeIconPicker();
                    };
                });
            }

            // ============================================================
            // 订阅分类管理
            // ============================================================

            openSubscriptionCategoryManageModal() {
                const modal = document.getElementById('subscription-category-manage-modal');
                modal.classList.add('active');
                this.renderSubscriptionCategoryManageList();
            }

            closeSubscriptionCategoryManageModal() {
                const modal = document.getElementById('subscription-category-manage-modal');
                modal.classList.remove('active');
            }

            renderSubscriptionCategoryManageList() {
                const container = document.getElementById('subscription-category-manage-list');
                if (!container) return;

                const categories = this.storage.getSubscriptionCategories();

                // 排序：把"其他"分类放在最后
                const sortedCategories = [...categories].sort((a, b) => {
                    if (a.name === '其他') return 1;
                    if (b.name === '其他') return -1;
                    return 0;
                });

                container.innerHTML = sortedCategories.map(cat => {
                    // "其他"分类不显示编辑和删除按钮
                    const isOther = cat.name === '其他';
                    const actions = isOther
                        ? '<span style="color: var(--text-light); font-size: 12px;">默认分类</span>'
                        : `<button class="edit" data-id="${cat.id}">编辑</button>
                           <button class="delete" data-id="${cat.id}">删除</button>`;

                    return `
                        <div class="manage-item">
                            <div class="manage-item-name">${cat.icon} ${cat.name}</div>
                            <div class="manage-item-actions">
                                ${actions}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            addSubscriptionCategoryInModal() {
                try {
                    console.log('开始添加订阅分类');

                    // 预制图标库（带名称）
                    const iconLibrary = {
                        '全部': ['📦', '🎬', '🎵', '📚', '💻', '🎮', '🏠', '✈️', '🍔', '☕', '💊', '👕', '⚽', '🏋️', '🎨', '🔧'],
                        '娱乐': ['🎬', '🎞️', '📺', '🎵', '🎤', '🎧', '🎸', '🎹', '🎻', '🎺', '🥁', '🪘', '🎷', '🎮', '🕹️', '🎰', '🎲', '🃏', '🎯', '🀄', '🎱', '🪅', '🎪'],
                        '学习': ['📚', '📖', '📕', '📗', '📘', '📙', '📓', '📔', '📒', '📃', '📄', '📰', '🗞️', '🔖', '🏷️', '✏️', '✒️', '📐', '📏', '🔢', '➗', '✖️'],
                        '办公': ['💻', '⌨️', '🖥️', '🖨️', '🖱️', '💾', '💿', '📱', '☎️', '📞', '📟', '📠', '🖨️', '🖍️', '🔎', '📊', '📈', '📉', '📋', '📌', '📎', '🔖', '✏️', '📝'],
                        '工具': ['🔧', '🔨', '⚒️', '🛠️', '⛏️', '🪓', '🔩', '⚙️', '🗜️', '🔗', '⛓️', '🧰', '🧲', '🪑', '🪛', '🪚', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️'],
                        '金融': ['💰', '💵', '💴', '💶', '💷', '💸', '💳', '🧾', '💹', '📉', '📈', '🏧', '💱', '💲', '⏱️', '⏰', '🏅', '🏦'],
                        '生活': ['🏠', '🏡', '🏘️', '🏚️', '🏗️', '🏢', '🏬', '🏪', '🏫', '⛽️', '🚗', '🚕', '🚙', '🚌', '🚎', '🚓', '🚑', '🛒', '🛍️'],
                        '健康': ['💊', '💉', '🩺', '🏥', '🏥', '🦷', '🦴', '🦵', '🏃', '🏋️', '🧘', '🧘', '🧍', '🚑'],
                        '饮食': ['🍔', '🍟', '🍕', '🌭', '🍿', '🧂', '🍿', '🥩', '🍗', '🍖', '🌮', '🌯', '🥙', '🥘', '🥗', '🥫', '🍝', '🍜', '🍲', '🍛', '🍣', '🍤', '🍱', '🥢', '🧁', '🥧', '🍨', '🍩', '🍪', '🍫', '🍬', '🍭', '🍮', '🍯', '☕', '🍵', '🥤', '🧋'],
                        '其他': ['🔮', '🎁', '🎈', '🎉', '🎊', '🎀', '🎏�', '🔔', '🔕', '📿', '⭐', '🌟', '💫', '✨', '💎', '💍', '👑', '👜', '🎗', '🏆', '🏅']
                    };

                    // 创建自定义对话框
                    const dialog = document.createElement('div');
                    dialog.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px);';

                    dialog.innerHTML = `
                        <div style="background-color: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                            <h4 style="margin-top: 0; margin-bottom: 16px; font-size: 18px; font-weight: 600;">添加分类</h4>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">分类名称</label>
                                <input type="text" id="subscription-category-name-input" placeholder="请输入分类名称" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">分类图标</label>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div id="subscription-selected-icon-display" style="width: 48px; height: 48px; border: 2px solid #4361ee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: #f0f4ff;">🎬</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #374151; font-size: 14px;" id="subscription-selected-icon-name">电影</div>
                                        <div style="color: #9ca3af; font-size: 12px;">点击下方图标选择</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <div id="subscription-icon-category-tabs" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                                        ${Object.keys(iconLibrary).map(cat =>
                                            `<button class="subscription-icon-category-tab ${cat === '全部' ? 'active' : ''}" data-category="${cat}" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 16px; background: ${cat === '全部' ? '#4361ee' : 'white'}; color: ${cat === '全部' ? 'white' : '#374151'}; font-size: 12px; cursor: pointer; transition: all 0.2s;">${cat}</button>`
                                        ).join('')}
                                    </div>
                                </div>
                                <div id="subscription-icon-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; max-height: 240px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    ${iconLibrary['全部'].map(icon =>
                                        `<div class="subscription-icon-option" data-icon="${icon}" style="display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; border: 2px solid transparent;">
                                            <div style="font-size: 28px; margin-bottom: 2px;">${icon}</div>
                                            <div style="font-size: 11px; color: #6b7280; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.getSubscriptionIconName(icon)}</div>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                                <button id="subscription-category-cancel-btn" class="btn btn-secondary">取消</button>
                                <button id="subscription-category-confirm-btn" class="btn btn-primary">确定</button>
                            </div>
                        </div>
                    `;

                    document.body.appendChild(dialog);

                    const nameInput = dialog.querySelector('#subscription-category-name-input');
                    const iconDisplay = dialog.querySelector('#subscription-selected-icon-display');
                    const iconNameDisplay = dialog.querySelector('#subscription-selected-icon-name');
                    const iconGrid = dialog.querySelector('#subscription-icon-grid');
                    const categoryTabs = dialog.querySelectorAll('.subscription-icon-category-tab');
                    const cancelBtn = dialog.querySelector('#subscription-category-cancel-btn');
                    const confirmBtn = dialog.querySelector('#subscription-category-confirm-btn');

                    let selectedIcon = '🎬';

                    // 自动聚焦到名称输入框
                    setTimeout(() => nameInput.focus(), 100);

                    // 图标分类切换
                    categoryTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            // 更新激活状态
                            categoryTabs.forEach(t => {
                                t.classList.remove('active');
                                t.style.background = 'white';
                                t.style.color = '#374151';
                            });
                            tab.classList.add('active');
                            tab.style.background = '#4361ee';
                            tab.style.color = 'white';

                            // 更新图标网格
                            const category = tab.dataset.category;
                            iconGrid.innerHTML = iconLibrary[category].map(icon =>
                                `<div class="subscription-icon-option" data-icon="${icon}" style="display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; border: 2px solid transparent;">
                                    <div style="font-size: 28px; margin-bottom: 2px;">${icon}</div>
                                    <div style="font-size: 11px; color: #6b7280; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.getSubscriptionIconName(icon)}</div>
                                </div>`
                            ).join('');

                            // 重新绑定图标点击事件
                            bindIconClickEvents();
                        });
                    });

                    // 绑定图标点击事件
                    const self = this;
                    function bindIconClickEvents() {
                        const iconOptions = dialog.querySelectorAll('.subscription-icon-option');
                        iconOptions.forEach(option => {
                            option.addEventListener('click', () => {
                                selectedIcon = option.dataset.icon;
                                iconDisplay.textContent = selectedIcon;
                                iconNameDisplay.textContent = self.getSubscriptionIconName(selectedIcon);

                                // 更新选中状态
                                iconOptions.forEach(opt => {
                                    opt.style.border = '2px solid transparent';
                                    opt.style.background = 'transparent';
                                });
                                option.style.border = '2px solid #4361ee';
                                option.style.background = '#f0f4ff';
                            });

                            // 悬停效果
                            option.addEventListener('mouseenter', () => {
                                if (option.dataset.icon !== selectedIcon) {
                                    option.style.background = '#e5e7eb';
                                }
                            });
                            option.addEventListener('mouseleave', () => {
                                if (option.dataset.icon !== selectedIcon) {
                                    option.style.background = 'transparent';
                                }
                            });
                        });
                    }

                    bindIconClickEvents();

                    // 取消按钮
                    cancelBtn.addEventListener('click', () => {
                        document.body.removeChild(dialog);
                    });

                    // 确定按钮
                    confirmBtn.addEventListener('click', () => {
                        const categoryName = nameInput.value.trim();

                        if (!categoryName) {
                            alert('请输入分类名称');
                            return;
                        }

                        const result = this.storage.addSubscriptionCategory({
                            name: categoryName,
                            icon: selectedIcon
                        });

                        if (result) {
                            this.renderSubscriptionCategoryManageList();
                            this.renderSubscriptionCategoryTabs();
                            this.app.showToast('分类添加成功！', 'success');
                        } else {
                            this.app.showToast('添加失败，请重试！', 'error');
                        }

                        document.body.removeChild(dialog);
                    });

                    // 支持回车键确认
                    nameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            confirmBtn.click();
                        }
                    });

                } catch (error) {
                    console.error('addSubscriptionCategoryInModal方法执行失败:', error);
                    console.error('错误详情:', error.message);
                    console.error('错误堆栈:', error.stack);
                    if (this.app) {
                        this.app.showToast('添加分类时发生错误，请重试！', 'error');
                    } else {
                        alert('添加分类时发生错误：' + error.message);
                    }
                }
            }

            editSubscriptionCategoryInModal(id) {
                const cat = this.storage.getSubscriptionCategoryById(id);
                if (!cat) return;

                const name = prompt('请输入新的分类名称：', cat.name);
                if (name === null || !name.trim()) return;

                const result = this.storage.updateSubscriptionCategory(id, {
                    name: name.trim()
                });

                if (result) {
                    this.renderSubscriptionCategoryManageList();
                    this.renderSubscriptionCategoryTabs();
                    this.renderSubscriptionList();
                    alert('分类更新成功！');
                } else {
                    alert('更新失败，请重试！');
                }
            }

            deleteSubscriptionCategoryInModal(id) {
                const cat = this.storage.getSubscriptionCategoryById(id);
                if (!cat) return;

                // 获取该分类下的订阅数量
                const subscriptions = this.storage.getSubscriptions();
                const subsCount = subscriptions.filter(sub => sub.category === id).length;

                let message = `确定要删除分类"${cat.name}"吗？\n\n该分类下的订阅将自动归类到"其他"分类中。`;
                if (subsCount > 0) {
                    message = `确定要删除分类"${cat.name}"吗？\n\n该分类下有 ${subsCount} 个订阅，将被自动归类到"其他"分类中。`;
                }

                this.app.confirm('删除分类', message, (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteSubscriptionCategory(id);
                        if (result) {
                            this.renderSubscriptionCategoryManageList();
                            this.renderSubscriptionCategoryTabs();
                            this.renderSubscriptionList();
                            this.app.showToast('分类删除成功！', 'success');
                        } else {
                            this.app.showToast('删除失败，请重试！', 'error');
                        }
                    }
                });
            }
        }

        // ============================================================
        // 应用管理
        // ============================================================
        class App {
            constructor() {
                this.storage = new Storage();
                this.subscriptionStorage = new SubscriptionStorage();
                this.subscriptionManager = new SubscriptionManager(this.subscriptionStorage);
                this.subscriptionUI = new SubscriptionUI(this.subscriptionStorage, this.subscriptionManager, this);
                this.currentEditingItem = null;
                this.dialogCallback = null;
                this.currentDraggedItemId = null; // 当前拖拽的物品ID
                this.currentDropTarget = null; // 当前拖拽目标ID
                this.tempReorderedItems = null; // 临时排序的物品数据
                this.lastPreviewTarget = null; // 上一次预览的目标ID
                this.orderSaved = false; // 标记是否已保存排序
                this.currentLayout = 'grid'; // 当前布局模式
                this.currentTheme = null; // 当前主题
                this.charts = {}; // 存储图表实例
                this.currentAnalyticsType = 'items'; // 当前分析类型: items 或 subscription

                // 预设主题
                this.themePresets = {
                    default: {
                        name: '默认蓝',
                        primary: '#4361ee',
                        secondary: '#3f37c9',
                        accent: '#4cc9f0',
                        background: '#ffffff',
                        backgroundSecondary: '#f9fafb'
                    },
                    purple: {
                        name: '优雅紫',
                        primary: '#9333ea',
                        secondary: '#7c3aed',
                        accent: '#c084fc',
                        background: '#ffffff',
                        backgroundSecondary: '#faf5ff'
                    },
                    green: {
                        name: '清新绿',
                        primary: '#10b981',
                        secondary: '#059669',
                        accent: '#34d399',
                        background: '#ffffff',
                        backgroundSecondary: '#f0fdf4'
                    },
                    orange: {
                        name: '活力橙',
                        primary: '#f59e0b',
                        secondary: '#d97706',
                        accent: '#fbbf24',
                        background: '#ffffff',
                        backgroundSecondary: '#fffbeb'
                    },
                    pink: {
                        name: '甜美粉',
                        primary: '#ec4899',
                        secondary: '#db2777',
                        accent: '#f472b6',
                        background: '#ffffff',
                        backgroundSecondary: '#fdf2f8'
                    },
                    dark: {
                        name: '暗夜黑',
                        primary: '#60a5fa',
                        secondary: '#3b82f6',
                        accent: '#93c5fd',
                        background: '#1f2937',
                        backgroundSecondary: '#111827'
                    }
                };
                
                // 加载自定义主题
                const customThemes = JSON.parse(localStorage.getItem('wucanglu_custom_themes') || '{}');
                Object.assign(this.themePresets, customThemes);
            }
            
            // 显示提示信息
            showToast(message, type = 'info') {
                // 创建提示元素
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                
                // 添加样式
                toast.style.position = 'fixed';
                toast.style.top = '20px';
                toast.style.right = '20px';
                toast.style.padding = '12px 20px';
                toast.style.borderRadius = '8px';
                toast.style.color = '#fff';
                toast.style.fontSize = '14px';
                toast.style.fontWeight = '500';
                toast.style.zIndex = '9999';
                toast.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
                toast.style.transition = 'all 0.3s ease';
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                
                // 根据类型设置背景色
                switch (type) {
                    case 'success':
                        toast.style.backgroundColor = '#52c41a';
                        break;
                    case 'error':
                        toast.style.backgroundColor = '#f5222d';
                        break;
                    case 'warning':
                        toast.style.backgroundColor = '#faad14';
                        break;
                    default:
                        toast.style.backgroundColor = '#1890ff';
                }
                
                // 添加到页面
                document.body.appendChild(toast);
                
                // 显示提示
                setTimeout(() => {
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateX(0)';
                }, 10);
                
                // 3秒后隐藏提示
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // 初始化
            init() {
                console.log('开始初始化应用');

                // 设置默认的活动标签页
                document.body.setAttribute('data-active-tab', 'items');

                // 初始化按钮显示状态（默认显示添加物品按钮）
                const addItemBtn = document.getElementById('add-item-btn');
                const addSubscriptionBtn = document.getElementById('add-subscription-btn');
                if (addItemBtn) addItemBtn.style.display = 'flex';
                if (addSubscriptionBtn) addSubscriptionBtn.style.display = 'none';

                // 初始化默认数据
                console.log('初始化默认数据');
                this.storage.initDefaultData();

                // 初始化订阅默认数据
                console.log('初始化订阅默认数据');
                this.subscriptionStorage.initDefaultData();

                // 更新订阅的下次扣费日期
                this.subscriptionStorage.updateAllNextBillingDates();

                // 检查订阅提醒
                this.subscriptionManager.checkReminders();

                // 渲染界面
                console.log('渲染分类标签');
                this.renderCategoryTabs();
                console.log('更新物品统计信息');
                this.updateItemStats();
                console.log('渲染物品列表');
                this.renderItems();
                console.log('渲染分类列表');
                this.renderCategories();
                console.log('渲染购买渠道列表');
                this.renderChannels();
                console.log('初始化购买渠道选择框');
                this.initChannelSelects();

                // 更新统计信息
                console.log('更新统计信息');
                this.updateStats();

                // 绑定事件
                console.log('绑定事件');
                this.bindEvents();

                // 绑定对话框事件
                console.log('绑定对话框事件');
                this.bindDialogEvents();

                // 绑定订阅相关事件
                console.log('绑定订阅相关事件');
                this.bindSubscriptionEvents();

                console.log('应用初始化完成');
            }
            
            // 渲染数据分析
            renderAnalytics() {
                // 根据当前分析类型渲染对应内容
                if (this.currentAnalyticsType === 'subscription') {
                    this.renderSubscriptionAnalytics();
                } else {
                    this.renderItemsAnalytics();
                }
            }

            // 切换分析类型
            switchAnalyticsType(type) {
                this.currentAnalyticsType = type;

                // 更新切换按钮状态
                document.querySelectorAll('.analytics-toggle-option').forEach(option => {
                    option.classList.toggle('active', option.dataset.type === type);
                });

                // 显示/隐藏对应内容
                const itemsContent = document.getElementById('analytics-items-content');
                const subContent = document.getElementById('analytics-subscription-content');
                if (itemsContent && subContent) {
                    if (type === 'subscription') {
                        itemsContent.style.display = 'none';
                        subContent.style.display = 'block';
                    } else {
                        itemsContent.style.display = 'block';
                        subContent.style.display = 'none';
                    }
                }

                // 重新渲染分析数据
                this.renderAnalytics();
            }

            // 渲染物品分析
            renderItemsAnalytics() {
                const items = this.storage.getItems();
                const categories = this.storage.getCategories();

                // 计算统计数据
                const totalItems = items.length;
                const totalValue = items.reduce((sum, item) => sum + (item.price || 0), 0);
                const avgPrice = totalItems > 0 ? totalValue / totalItems : 0;
                
                // 计算平均持有天数和总日均成本
                let totalDays = 0;
                let totalDailyCost = 0;
                items.forEach(item => {
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    if (purchaseDate) {
                        const now = new Date();
                        const purchased = new Date(purchaseDate);
                        const days = Math.ceil((now - purchased) / (1000 * 60 * 60 * 24));
                        totalDays += days;

                        // 计算日均成本
                        const price = item.price || 0;
                        if (price > 0 && days > 0) {
                            totalDailyCost += price / days;
                        }
                    }
                });
                const avgDays = totalItems > 0 ? Math.round(totalDays / totalItems) : 0;
                
                // 找出最贵的物品
                const mostExpensive = items.reduce((max, item) => {
                    return (item.price || 0) > (max.price || 0) ? item : max;
                }, { name: '-', price: 0 });
                
                // 更新统计卡片
                const statsElements = {
                    'analytics-total-items': totalItems,
                    'analytics-total-value': `¥${totalValue.toFixed(0)}`,
                    'analytics-avg-price': `¥${avgPrice.toFixed(0)}`,
                    'analytics-avg-days': `${avgDays}天`,
                    'analytics-total-daily-cost': `¥${totalDailyCost.toFixed(2)}/天`
                };
                
                Object.keys(statsElements).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = statsElements[id];
                });
                
                // 销毁旧图表
                if (this.charts) {
                    Object.values(this.charts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                }
                this.charts = {};
                
                // 渲染所有图表
                this.renderCategoryPieChart(items, categories);
                this.renderPriceBarChart(items);
                this.renderTimelineChart(items);
                this.renderSeasonalChart(items);
                this.renderDurationChart(items);
                this.renderDailyValueChart(items);
                this.renderCategoryValueChart(items, categories);
                this.renderScatterChart(items);
                this.renderRadarChart(items, categories);
                this.renderSpendingChart(items);
                
                // 渲染TOP榜单
                this.renderTopLists(items);
            }
            
            // 分类分布饼图
            renderCategoryPieChart(items, categories) {
                const ctx = document.getElementById('category-chart');
                if (!ctx) return;
                
                // 统计每个分类的物品数量
                const categoryCount = {};
                categories.forEach(cat => {
                    categoryCount[cat.name] = 0;
                });
                
                items.forEach(item => {
                    if (categoryCount.hasOwnProperty(item.category)) {
                        categoryCount[item.category]++;
                    }
                });
                
                const labels = Object.keys(categoryCount);
                const data = Object.values(categoryCount);
                
                const colors = [
                    '#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#7209b7',
                    '#560bad', '#b5179e', '#f72585', '#4895ef', '#4cc9f0'
                ];
                
                this.charts.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value}件 (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // 价格区间分布柱状图
            renderPriceBarChart(items) {
                const ctx = document.getElementById('price-chart');
                if (!ctx) return;
                
                // 定义价格区间
                const ranges = [
                    { label: '0-100', min: 0, max: 100 },
                    { label: '100-500', min: 100, max: 500 },
                    { label: '500-1000', min: 500, max: 1000 },
                    { label: '1000-3000', min: 1000, max: 3000 },
                    { label: '3000-5000', min: 3000, max: 5000 },
                    { label: '5000+', min: 5000, max: Infinity }
                ];
                
                const counts = ranges.map(range => {
                    return items.filter(item => {
                        const price = item.price || 0;
                        return price >= range.min && price < range.max;
                    }).length;
                });
                
                this.charts.priceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ranges.map(r => r.label),
                        datasets: [{
                            label: '物品数量',
                            data: counts,
                            backgroundColor: 'rgba(67, 97, 238, 0.8)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `数量: ${context.parsed.y}件`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
            
            // 购买时间趋势图
            renderTimelineChart(items) {
                const ctx = document.getElementById('timeline-chart');
                if (!ctx) return;
                
                // 按月份统计
                const monthlyData = {};
                items.forEach(item => {
                    const date = item.purchaseDate || item.createdAt;
                    if (date) {
                        const month = date.substring(0, 7); // YYYY-MM
                        monthlyData[month] = (monthlyData[month] || 0) + 1;
                    }
                });
                
                // 排序并取最近12个月
                const sortedMonths = Object.keys(monthlyData).sort();
                const recentMonths = sortedMonths.slice(-12);
                const counts = recentMonths.map(month => monthlyData[month]);
                
                this.charts.timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: recentMonths,
                        datasets: [{
                            label: '购买数量',
                            data: counts,
                            borderColor: 'rgba(76, 201, 240, 1)',
                            backgroundColor: 'rgba(76, 201, 240, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `购买: ${context.parsed.y}件`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 1 }
                            }
                        }
                    }
                });
            }
            
            // 日均价值排行
            renderDailyValueChart(items) {
                const ctx = document.getElementById('daily-value-chart');
                if (!ctx) return;
                
                // 计算每个物品的日均价值
                const itemsWithDailyValue = items.map(item => {
                    const price = item.price || 0;
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    let dailyValue = 0;
                    
                    if (price > 0 && purchaseDate) {
                        const now = new Date();
                        const purchased = new Date(purchaseDate);
                        const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                        dailyValue = price / days;
                    }
                    
                    return {
                        name: item.name,
                        dailyValue: dailyValue
                    };
                }).filter(item => item.dailyValue > 0)
                  .sort((a, b) => b.dailyValue - a.dailyValue)
                  .slice(0, 10);
                
                const labels = itemsWithDailyValue.map(item => item.name.length > 10 ? item.name.substring(0, 10) + '...' : item.name);
                const data = itemsWithDailyValue.map(item => item.dailyValue);
                
                this.charts.dailyValueChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '日均价值',
                            data: data,
                            backgroundColor: 'rgba(124, 58, 237, 0.8)',
                            borderColor: 'rgba(124, 58, 237, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `日均: ¥${context.parsed.x.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // 分类价值对比
            renderCategoryValueChart(items, categories) {
                const ctx = document.getElementById('category-value-chart');
                if (!ctx) return;
                
                // 统计每个分类的总价值
                const categoryValue = {};
                categories.forEach(cat => {
                    categoryValue[cat.name] = 0;
                });
                
                items.forEach(item => {
                    if (categoryValue.hasOwnProperty(item.category)) {
                        categoryValue[item.category] += (item.price || 0);
                    }
                });
                
                const labels = Object.keys(categoryValue);
                const data = Object.values(categoryValue);
                
                this.charts.categoryValueChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '总价值',
                            data: data,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `总价值: ¥${context.parsed.y.toFixed(0)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // 季节性购买分析
            renderSeasonalChart(items) {
                const ctx = document.getElementById('seasonal-chart');
                if (!ctx) return;
                
                const seasons = { '春季': 0, '夏季': 0, '秋季': 0, '冬季': 0 };
                
                items.forEach(item => {
                    const date = item.purchaseDate || item.createdAt;
                    if (date) {
                        const month = new Date(date).getMonth() + 1;
                        if (month >= 3 && month <= 5) seasons['春季']++;
                        else if (month >= 6 && month <= 8) seasons['夏季']++;
                        else if (month >= 9 && month <= 11) seasons['秋季']++;
                        else seasons['冬季']++;
                    }
                });
                
                this.charts.seasonalChart = new Chart(ctx, {
                    type: 'polarArea',
                    data: {
                        labels: Object.keys(seasons),
                        datasets: [{
                            data: Object.values(seasons),
                            backgroundColor: [
                                'rgba(76, 201, 240, 0.7)',
                                'rgba(245, 87, 108, 0.7)',
                                'rgba(245, 159, 0, 0.7)',
                                'rgba(96, 165, 250, 0.7)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
            
            // 持有时长分布
            renderDurationChart(items) {
                const ctx = document.getElementById('duration-chart');
                if (!ctx) return;
                
                const ranges = [
                    { label: '< 1个月', min: 0, max: 30 },
                    { label: '1-3个月', min: 30, max: 90 },
                    { label: '3-6个月', min: 90, max: 180 },
                    { label: '6-12个月', min: 180, max: 365 },
                    { label: '1-2年', min: 365, max: 730 },
                    { label: '> 2年', min: 730, max: Infinity }
                ];
                
                const counts = ranges.map(range => {
                    return items.filter(item => {
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        if (!purchaseDate) return false;
                        const days = Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24));
                        return days >= range.min && days < range.max;
                    }).length;
                });
                
                this.charts.durationChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ranges.map(r => r.label),
                        datasets: [{
                            label: '物品数量',
                            data: counts,
                            backgroundColor: 'rgba(147, 51, 234, 0.8)',
                            borderColor: 'rgba(147, 51, 234, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }
            
            // 价格与持有时长散点图
            renderScatterChart(items) {
                const ctx = document.getElementById('scatter-chart');
                if (!ctx) return;
                
                const data = items.map(item => {
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    const days = purchaseDate ? Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24)) : 0;
                    return {
                        x: days,
                        y: item.price || 0
                    };
                }).filter(d => d.x > 0 && d.y > 0);
                
                this.charts.scatterChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: [{
                            label: '物品',
                            data: data,
                            backgroundColor: 'rgba(67, 97, 238, 0.6)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `持有${context.parsed.x}天, 价格¥${context.parsed.y}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                title: { display: true, text: '持有天数' },
                                beginAtZero: true
                            },
                            y: {
                                title: { display: true, text: '价格（元）' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // 分类雷达图
            renderRadarChart(items, categories) {
                const ctx = document.getElementById('radar-chart');
                if (!ctx) return;
                
                const categoryStats = {};
                categories.forEach(cat => {
                    categoryStats[cat.name] = { count: 0, value: 0, avgDays: 0, totalDays: 0 };
                });
                
                items.forEach(item => {
                    if (categoryStats[item.category]) {
                        categoryStats[item.category].count++;
                        categoryStats[item.category].value += (item.price || 0);
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        if (purchaseDate) {
                            const days = Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24));
                            categoryStats[item.category].totalDays += days;
                        }
                    }
                });
                
                // 计算平均值并归一化
                const labels = Object.keys(categoryStats).slice(0, 6); // 最多6个分类
                const countData = labels.map(cat => categoryStats[cat].count);
                const valueData = labels.map(cat => categoryStats[cat].value / 100); // 缩放
                const avgDaysData = labels.map(cat => {
                    return categoryStats[cat].count > 0 ? categoryStats[cat].totalDays / categoryStats[cat].count / 10 : 0;
                });
                
                this.charts.radarChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '数量',
                                data: countData,
                                borderColor: 'rgba(67, 97, 238, 1)',
                                backgroundColor: 'rgba(67, 97, 238, 0.2)',
                                borderWidth: 2
                            },
                            {
                                label: '价值(÷100)',
                                data: valueData,
                                borderColor: 'rgba(245, 87, 108, 1)',
                                backgroundColor: 'rgba(245, 87, 108, 0.2)',
                                borderWidth: 2
                            },
                            {
                                label: '平均持有(÷10天)',
                                data: avgDaysData,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        },
                        scales: {
                            r: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            // 月度支出趋势
            renderSpendingChart(items) {
                const ctx = document.getElementById('spending-chart');
                if (!ctx) return;
                
                const monthlySpending = {};
                items.forEach(item => {
                    const date = item.purchaseDate || item.createdAt;
                    if (date) {
                        const month = date.substring(0, 7);
                        monthlySpending[month] = (monthlySpending[month] || 0) + (item.price || 0);
                    }
                });
                
                const sortedMonths = Object.keys(monthlySpending).sort().slice(-12);
                const spending = sortedMonths.map(month => monthlySpending[month]);
                
                this.charts.spendingChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedMonths,
                        datasets: [{
                            label: '支出金额',
                            data: spending,
                            borderColor: 'rgba(245, 87, 108, 1)',
                            backgroundColor: 'rgba(245, 87, 108, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `支出: ¥${context.parsed.y.toFixed(0)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
            
            // 渲染TOP榜单
            renderTopLists(items) {
                // 最贵物品TOP5
                const topExpensive = [...items]
                    .sort((a, b) => (b.price || 0) - (a.price || 0))
                    .slice(0, 5);
                
                const expensiveList = document.getElementById('top-expensive-list');
                if (expensiveList) {
                    expensiveList.innerHTML = topExpensive.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${item.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">¥${(item.price || 0).toFixed(0)}</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }
                
                // 最值物品TOP5（日均价值最低）
                const itemsWithDailyValue = items
                    .map(item => {
                        const price = item.price || 0;
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        let dailyValue = price;

                        if (price > 0 && purchaseDate) {
                            const days = Math.max(1, Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24)));
                            dailyValue = price / days;
                        }

                        return { ...item, dailyValue };
                    })
                    .filter(item => item.price > 0);
                
                const topValue = [...itemsWithDailyValue]
                    .sort((a, b) => a.dailyValue - b.dailyValue)
                    .slice(0, 5);
                
                const valueList = document.getElementById('top-value-list');
                if (valueList) {
                    valueList.innerHTML = topValue.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">日均¥${item.dailyValue.toFixed(2)}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--success-color);">¥${(item.price || 0).toFixed(0)}</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }
                
                // 日均成本最高TOP5
                const topDailyCost = [...itemsWithDailyValue]
                    .sort((a, b) => b.dailyValue - a.dailyValue)
                    .slice(0, 5);
                
                const dailyCostList = document.getElementById('top-daily-cost-list');
                if (dailyCostList) {
                    dailyCostList.innerHTML = topDailyCost.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">日均¥${item.dailyValue.toFixed(2)}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--danger-color);">¥${(item.price || 0).toFixed(0)}</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }
                
                // 持有最久TOP5
                const itemsWithDays = items.map(item => {
                    const purchaseDate = item.purchaseDate || item.createdAt;
                    const days = purchaseDate ? Math.ceil((new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24)) : 0;
                    return { ...item, days };
                }).filter(item => item.days > 0);
                
                const topOldest = [...itemsWithDays]
                    .sort((a, b) => b.days - a.days)
                    .slice(0, 5);
                
                const oldestList = document.getElementById('top-oldest-list');
                if (oldestList) {
                    oldestList.innerHTML = topOldest.map((item, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${item.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--accent-color);">${item.days}天</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }
            }

            // ============================================================
            // 订阅分析渲染方法
            // ============================================================

            // 渲染订阅分析
            renderSubscriptionAnalytics() {
                const subscriptions = this.subscriptionStorage.getSubscriptions();
                const categories = this.subscriptionStorage.getSubscriptionCategories();

                // 只统计活跃状态的订阅
                const activeSubscriptions = subscriptions.filter(sub => sub.status === 'active');
                const totalSubscriptions = activeSubscriptions.length;

                // 计算月度和年度支出
                let totalMonthly = 0;
                let totalYearly = 0;
                activeSubscriptions.forEach(sub => {
                    const price = sub.price || 0;
                    const cycleType = sub.cycleType;

                    switch (cycleType) {
                        case 'day':
                            // 按天：按30天计算一个月
                            totalMonthly += price * 30;
                            totalYearly += price * 365;
                            break;
                        case 'week':
                            // 按周：按4.33周计算一个月
                            totalMonthly += price * 4.33;
                            totalYearly += price * 52;
                            break;
                        case 'month':
                            // 按月
                            totalMonthly += price;
                            totalYearly += price * 12;
                            break;
                        case 'quarter':
                            // 按季
                            totalMonthly += price / 3;
                            totalYearly += price * 4;
                            break;
                        case 'year':
                            // 按年
                            totalMonthly += price / 12;
                            totalYearly += price;
                            break;
                        case 'lifetime':
                            // 终身订阅不计入周期支出
                            break;
                    }
                });

                // 计算即将到期的订阅（7天内）
                const now = new Date();
                const sevenDaysLater = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
                const expiringCount = activeSubscriptions.filter(sub => {
                    if (sub.nextBillingDate) {
                        const nextDate = new Date(sub.nextBillingDate);
                        return nextDate <= sevenDaysLater;
                    }
                    return false;
                }).length;

                // 更新统计卡片
                const statsElements = {
                    'sub-analytics-total': totalSubscriptions,
                    'sub-analytics-monthly': `¥${totalMonthly.toFixed(0)}`,
                    'sub-analytics-yearly': `¥${totalYearly.toFixed(0)}`,
                    'sub-analytics-expiring': expiringCount
                };

                Object.keys(statsElements).forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = statsElements[id];
                });

                // 销毁旧图表
                if (this.charts) {
                    Object.values(this.charts).forEach(chart => {
                        if (chart && typeof chart.destroy === 'function') {
                            chart.destroy();
                        }
                    });
                }
                this.charts = {};

                // 渲染所有订阅图表
                this.renderSubCategoryPieChart(activeSubscriptions, categories);
                this.renderSubCycleChart(activeSubscriptions);
                this.renderSubPriceChart(activeSubscriptions);
                this.renderSubTimelineChart(activeSubscriptions);
                this.renderSubCategoryValueChart(activeSubscriptions, categories);
                this.renderSubStatusChart(subscriptions);

                // 渲染TOP榜单
                this.renderSubTopLists(activeSubscriptions);
            }

            // 订阅分类分布饼图
            renderSubCategoryPieChart(subscriptions, categories) {
                const ctx = document.getElementById('sub-category-chart');
                if (!ctx) return;

                const categoryCount = {};
                categories.forEach(cat => {
                    categoryCount[cat.name] = 0;
                });

                subscriptions.forEach(sub => {
                    if (categoryCount.hasOwnProperty(sub.category)) {
                        categoryCount[sub.category]++;
                    }
                });

                const labels = Object.keys(categoryCount);
                const data = Object.values(categoryCount);

                const colors = [
                    '#4361ee', '#3f37c9', '#4cc9f0', '#f72585', '#7209b7',
                    '#560bad', '#b5179e', '#f72585', '#4895ef', '#4cc9f0'
                ];

                this.charts.subCategoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${label}: ${value}个 (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            // 订阅计费周期分布图
            renderSubCycleChart(subscriptions) {
                const ctx = document.getElementById('sub-cycle-chart');
                if (!ctx) return;

                const cycleCount = { 'monthly': 0, 'quarterly': 0, 'yearly': 0, 'lifetime': 0 };
                subscriptions.forEach(sub => {
                    const cycle = sub.cycleType || 'monthly';
                    if (cycleCount.hasOwnProperty(cycle)) {
                        cycleCount[cycle]++;
                    }
                });

                const labels = { 'monthly': '月付', 'quarterly': '季付', 'yearly': '年付', 'lifetime': '终身' };

                this.charts.subCycleChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(cycleCount).map(k => labels[k]),
                        datasets: [{
                            data: Object.values(cycleCount),
                            backgroundColor: ['#4361ee', '#4cc9f0', '#f72585', '#7209b7'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }

            // 订阅费用区间分布
            renderSubPriceChart(subscriptions) {
                const ctx = document.getElementById('sub-price-chart');
                if (!ctx) return;

                const ranges = [
                    { label: '0-10', min: 0, max: 10 },
                    { label: '10-50', min: 10, max: 50 },
                    { label: '50-100', min: 50, max: 100 },
                    { label: '100-200', min: 100, max: 200 },
                    { label: '200+', min: 200, max: Infinity }
                ];

                const counts = ranges.map(range => {
                    return subscriptions.filter(sub => {
                        const price = sub.price || 0;
                        return price >= range.min && price < range.max;
                    }).length;
                });

                this.charts.subPriceChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ranges.map(r => r.label),
                        datasets: [{
                            label: '订阅数量',
                            data: counts,
                            backgroundColor: 'rgba(67, 97, 238, 0.8)',
                            borderColor: 'rgba(67, 97, 238, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }

            // 订阅时间趋势图
            renderSubTimelineChart(subscriptions) {
                const ctx = document.getElementById('sub-timeline-chart');
                if (!ctx) return;

                const monthData = {};
                const now = new Date();

                // 初始化最近12个月的数据
                for (let i = 11; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    monthData[key] = 0;
                }

                subscriptions.forEach(sub => {
                    const startDate = sub.startDate || sub.createdAt;
                    if (startDate) {
                        const date = new Date(startDate);
                        const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        if (monthData.hasOwnProperty(key)) {
                            monthData[key]++;
                        }
                    }
                });

                this.charts.subTimelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(monthData).map(k => {
                            const [y, m] = k.split('-');
                            return `${m}月`;
                        }),
                        datasets: [{
                            label: '新增订阅',
                            data: Object.values(monthData),
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            }

            // 订阅分类月度支出对比
            renderSubCategoryValueChart(subscriptions, categories) {
                const ctx = document.getElementById('sub-category-value-chart');
                if (!ctx) return;

                const categoryMonthly = {};
                categories.forEach(cat => {
                    categoryMonthly[cat.name] = 0;
                });

                subscriptions.forEach(sub => {
                    if (categoryMonthly.hasOwnProperty(sub.category)) {
                        const price = sub.price || 0;
                        const cycleType = sub.cycleType;

                        let monthlyCost = 0;
                        switch (cycleType) {
                            case 'day':
                                monthlyCost = price * 30;
                                break;
                            case 'week':
                                monthlyCost = price * 4.33;
                                break;
                            case 'month':
                                monthlyCost = price;
                                break;
                            case 'quarter':
                                monthlyCost = price / 3;
                                break;
                            case 'year':
                                monthlyCost = price / 12;
                                break;
                            case 'lifetime':
                                monthlyCost = 0;
                                break;
                        }
                        categoryMonthly[sub.category] += monthlyCost;
                    }
                });

                const labels = Object.keys(categoryMonthly);
                const data = Object.values(categoryMonthly);

                this.charts.subCategoryValueChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '月度支出',
                            data: data,
                            backgroundColor: 'rgba(244, 114, 182, 0.8)',
                            borderColor: 'rgba(244, 114, 182, 1)',
                            borderWidth: 1,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `月支出: ¥${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // 订阅状态分布图
            renderSubStatusChart(subscriptions) {
                const ctx = document.getElementById('sub-status-chart');
                if (!ctx) return;

                const statusCount = { 'active': 0, 'paused': 0, 'cancelled': 0 };
                subscriptions.forEach(sub => {
                    const status = sub.status || 'active';
                    if (statusCount.hasOwnProperty(status)) {
                        statusCount[status]++;
                    }
                });

                const labels = { 'active': '活跃', 'paused': '暂停', 'cancelled': '已取消' };

                this.charts.subStatusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCount).map(k => labels[k]),
                        datasets: [{
                            data: Object.values(statusCount),
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }

            // 订阅TOP榜单
            renderSubTopLists(subscriptions) {
                // 最贵订阅TOP5（按月费计算）
                const subsWithMonthly = subscriptions.map(sub => {
                    const price = sub.price || 0;
                    const cycleType = sub.cycleType;

                    let monthlyCost = 0;
                    let yearlyCost = 0;
                    switch (cycleType) {
                        case 'day':
                            monthlyCost = price * 30;
                            yearlyCost = price * 365;
                            break;
                        case 'week':
                            monthlyCost = price * 4.33;
                            yearlyCost = price * 52;
                            break;
                        case 'month':
                            monthlyCost = price;
                            yearlyCost = price * 12;
                            break;
                        case 'quarter':
                            monthlyCost = price / 3;
                            yearlyCost = price * 4;
                            break;
                        case 'year':
                            monthlyCost = price / 12;
                            yearlyCost = price;
                            break;
                        case 'lifetime':
                            monthlyCost = 0;
                            yearlyCost = 0;
                            break;
                    }

                    return { ...sub, monthlyCost, yearlyCost };
                });

                const topExpensive = [...subsWithMonthly]
                    .sort((a, b) => b.monthlyCost - a.monthlyCost)
                    .slice(0, 5);

                const expensiveList = document.getElementById('sub-top-expensive-list');
                if (expensiveList) {
                    expensiveList.innerHTML = topExpensive.map((sub, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${sub.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${sub.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">¥${sub.monthlyCost.toFixed(0)}/月</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }

                // 即将到期TOP5
                const now = new Date();
                const subsWithDays = subscriptions.map(sub => {
                    if (sub.nextBillingDate) {
                        const nextDate = new Date(sub.nextBillingDate);
                        const days = Math.ceil((nextDate - now) / (1000 * 60 * 60 * 24));
                        return { ...sub, daysToExpiry: days };
                    }
                    return { ...sub, daysToExpiry: Infinity };
                }).filter(sub => sub.daysToExpiry !== Infinity && sub.daysToExpiry > 0);

                const topExpiring = [...subsWithDays]
                    .sort((a, b) => a.daysToExpiry - b.daysToExpiry)
                    .slice(0, 5);

                const expiringList = document.getElementById('sub-top-expiring-list');
                if (expiringList) {
                    expiringList.innerHTML = topExpiring.map((sub, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${sub.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${sub.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: ${sub.daysToExpiry <= 3 ? 'var(--danger-color)' : 'var(--warning-color)'};">${sub.daysToExpiry}天</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }

                // 持有最久TOP5
                const subsWithAge = subscriptions.map(sub => {
                    const startDate = sub.startDate || sub.createdAt;
                    if (startDate) {
                        const days = Math.ceil((now - new Date(startDate)) / (1000 * 60 * 60 * 24));
                        return { ...sub, days };
                    }
                    return { ...sub, days: 0 };
                }).filter(sub => sub.days > 0);

                const topOldest = [...subsWithAge]
                    .sort((a, b) => b.days - a.days)
                    .slice(0, 5);

                const oldestList = document.getElementById('sub-top-oldest-list');
                if (oldestList) {
                    oldestList.innerHTML = topOldest.map((sub, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${sub.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${sub.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--accent-color);">${sub.days}天</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }

                // 年度支出最高TOP5
                const topYearly = [...subsWithMonthly]
                    .sort((a, b) => b.yearlyCost - a.yearlyCost)
                    .slice(0, 5);

                const yearlyList = document.getElementById('sub-top-yearly-list');
                if (yearlyList) {
                    yearlyList.innerHTML = topYearly.map((sub, index) => `
                        <div style="display: flex; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 24px; height: 24px; border-radius: 50%; background: ${['#FFD700', '#C0C0C0', '#CD7F32', '#E8E8E8', '#F5F5F5'][index]}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 12px;">${index + 1}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-size: 14px; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${sub.name}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${sub.category}</div>
                            </div>
                            <div style="font-size: 14px; font-weight: 600; color: var(--primary-color);">¥${sub.yearlyCost.toFixed(0)}/年</div>
                        </div>
                    `).join('') || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无数据</div>';
                }
            }

            // 更新统计信息
            updateStats() {
                const items = this.storage.getItems();

                // 计算物品总数
                const totalItems = items.length;

                // 计算总资产（仅包含物品，不包含订阅）
                const totalAssets = items.reduce((sum, item) => sum + (item.price || 0), 0);

                // 计算日均成本（包含物品和订阅）
                let totalDailyCost = 0;

                // 1. 计算物品的日均成本
                items.forEach(item => {
                    const price = item.price || 0;
                    if (price > 0) {
                        const purchaseDate = item.purchaseDate || item.createdAt;
                        if (purchaseDate) {
                            const now = new Date();
                            const purchased = new Date(purchaseDate);
                            const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                            totalDailyCost += price / days;
                        }
                    }
                });

                // 2. 计算订阅的日均成本
                const subscriptions = this.subscriptionStorage.getSubscriptions();
                subscriptions.forEach(sub => {
                    // 只计算活跃状态的订阅
                    if (sub.status === 'active') {
                        const price = sub.price || 0;
                        if (price > 0) {
                            const cycleType = sub.cycleType;

                            // 终身订阅
                            if (cycleType === 'lifetime') {
                                // 只有勾选了"计入日均成本"且有购买日期时才计算
                                if (sub.lifetimeIncludeDaily && sub.lifetimePurchaseDate) {
                                    const now = new Date();
                                    const purchased = new Date(sub.lifetimePurchaseDate);
                                    const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                                    totalDailyCost += price / days;
                                }
                            } else {
                                // 周期性订阅：根据周期计算日均成本
                                const daysPerCycle = this.getDaysPerCycle(cycleType);
                                if (daysPerCycle > 0) {
                                    totalDailyCost += price / daysPerCycle;
                                }
                            }
                        }
                    }
                });
                
                // 更新DOM
                const totalItemsElement = document.getElementById('total-items-count');
                const totalSubscriptionsElement = document.getElementById('total-subscriptions-count');
                const totalAssetsElement = document.getElementById('total-assets');
                const dailyAverageElement = document.getElementById('daily-average');
                const avgPriceElement = document.getElementById('avg-price');

                if (totalItemsElement) {
                    totalItemsElement.textContent = totalItems;
                }

                if (totalSubscriptionsElement) {
                    totalSubscriptionsElement.textContent = subscriptions.length;
                }

                if (totalAssetsElement) {
                    totalAssetsElement.textContent = `¥${totalAssets.toFixed(2)}`;
                }
                
                if (dailyAverageElement) {
                    dailyAverageElement.textContent = `¥${totalDailyCost.toFixed(2)}/天`;
                }
                
                if (avgPriceElement) {
                    const avgPrice = totalItems > 0 ? totalAssets / totalItems : 0;
                    avgPriceElement.textContent = `¥${avgPrice.toFixed(2)}`;
                }
                
                // 更新"我的"页面的统计卡片
                const statsItemsElement = document.getElementById('stats-total-items');
                const statsAssetsElement = document.getElementById('stats-total-assets');
                const statsSubscriptionsElement = document.getElementById('stats-total-subscriptions');
                const statsDailyElement = document.getElementById('stats-daily-average');

                if (statsItemsElement) {
                    statsItemsElement.textContent = totalItems;
                }

                if (statsAssetsElement) {
                    statsAssetsElement.textContent = `¥${Math.round(totalAssets)}`;
                }

                if (statsSubscriptionsElement) {
                    const subscriptions = this.subscriptionStorage.getSubscriptions();
                    const activeSubscriptions = subscriptions.filter(sub => sub.status === 'active');
                    statsSubscriptionsElement.textContent = activeSubscriptions.length;
                }

                if (statsDailyElement) {
                    statsDailyElement.textContent = `¥${totalDailyCost.toFixed(2)}`;
                }
            }

            // 根据订阅周期类型获取天数（用于计算日均成本）
            getDaysPerCycle(cycleType) {
                const cycleDaysMap = {
                    'day': 1,      // 按天：1天
                    'week': 7,     // 按周：7天
                    'month': 30,   // 按月：30天
                    'quarter': 90, // 按季：90天
                    'year': 365,   // 按年：365天
                    'lifetime': 0  // 终身：特殊处理，不在此计算
                };
                return cycleDaysMap[cycleType] || 0;
            }

            // 绑定对话框事件
            bindDialogEvents() {
                const dialogCancel = document.getElementById('dialog-cancel');
                const dialogConfirm = document.getElementById('dialog-confirm');
                const customDialog = document.getElementById('custom-dialog');
                
                if (dialogCancel) {
                    dialogCancel.addEventListener('click', () => {
                        const callback = this.dialogCallback;
                        this.hideDialog();
                        if (callback) {
                            callback(false, '');
                        }
                    });
                }
                
                if (dialogConfirm) {
                    dialogConfirm.addEventListener('click', () => {
                        const input = document.getElementById('dialog-input');
                        const value = input && input.style.display !== 'none' ? input.value : '';
                        const callback = this.dialogCallback;
                        this.hideDialog();
                        if (callback) {
                            callback(true, value);
                        }
                    });
                }
                
                // 点击对话框外部关闭
                if (customDialog) {
                    customDialog.addEventListener('click', (e) => {
                        // 只有点击对话框背景（不是内容区域）时才触发
                        if (e.target === customDialog) {
                            const callback = this.dialogCallback;
                            this.hideDialog();
                            if (callback) {
                                callback(false, '');
                            }
                        }
                    });
                }
            }
            
            // 显示对话框
            showDialog(title, message, type = 'confirm', defaultValue = '') {
                console.log('开始显示对话框:', title, message, type, defaultValue);
                const dialog = document.getElementById('custom-dialog');
                console.log('找到dialog元素:', !!dialog);
                const dialogTitle = document.getElementById('dialog-title');
                console.log('找到dialogTitle元素:', !!dialogTitle);
                const dialogMessage = document.getElementById('dialog-message');
                console.log('找到dialogMessage元素:', !!dialogMessage);
                const dialogInput = document.getElementById('dialog-input');
                console.log('找到dialogInput元素:', !!dialogInput);
                
                if (!dialog || !dialogTitle || !dialogMessage || !dialogInput) {
                    console.error('对话框元素不存在');
                    return;
                }
                
                console.log('设置对话框标题和消息');
                dialogTitle.textContent = title;
                dialogMessage.textContent = message;
                
                if (type === 'input') {
                    console.log('显示输入框');
                    dialogInput.style.display = 'block';
                    dialogInput.value = defaultValue;
                    dialogInput.focus();
                } else {
                    console.log('隐藏输入框');
                    dialogInput.style.display = 'none';
                }
                
                console.log('显示对话框');
                dialog.style.display = 'flex';
                console.log('对话框显示完成');
            }
            
            // 隐藏对话框
            hideDialog() {
                const dialog = document.getElementById('custom-dialog');
                const dialogInput = document.getElementById('dialog-input');
                
                if (dialog) {
                    dialog.style.display = 'none';
                }
                
                if (dialogInput) {
                    dialogInput.value = '';
                }
                
                this.dialogCallback = null;
            }
            
            // 确认对话框
            confirm(title, message, callback) {
                this.dialogCallback = callback;
                this.showDialog(title, message, 'confirm');
            }
            
            // 输入对话框
            prompt(title, message, defaultValue, callback) {
                this.dialogCallback = callback;
                this.showDialog(title, message, 'input', defaultValue);
            }

            // 绑定订阅相关事件
            bindSubscriptionEvents() {
                console.log('开始绑定订阅相关事件');

                // 订阅列表点击事件（点击卡片弹出详情）
                const subscriptionList = document.getElementById('subscription-list');
                if (subscriptionList) {
                    subscriptionList.addEventListener('click', (e) => {
                        const card = e.target.closest('.subscription-card');
                        if (card) {
                            const id = card.dataset.id;
                            if (id) {
                                this.subscriptionUI.showSubscriptionDetail(id);
                            }
                        }
                    });
                }

                // 订阅分类列表事件委托（编辑和删除按钮）
                const subCategoryList = document.getElementById('subscription-category-manage-list');
                if (subCategoryList) {
                    subCategoryList.addEventListener('click', (e) => {
                        const editBtn = e.target.closest('.manage-item-actions .edit');
                        const deleteBtn = e.target.closest('.manage-item-actions .delete');

                        if (editBtn) {
                            const id = editBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.editSubscriptionCategoryInModal(id);
                            }
                        }

                        if (deleteBtn) {
                            const id = deleteBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.deleteSubscriptionCategoryInModal(id);
                            }
                        }
                    });
                }

                // 添加订阅按钮
                const addSubscriptionBtn = document.getElementById('add-subscription-btn');
                console.log('查找添加订阅按钮:', addSubscriptionBtn);
                if (addSubscriptionBtn) {
                    const styles = window.getComputedStyle(addSubscriptionBtn);
                    console.log('添加订阅按钮样式:', {
                        display: styles.display,
                        position: styles.position,
                        zIndex: styles.zIndex,
                        pointerEvents: styles.pointerEvents,
                        visibility: styles.visibility,
                        opacity: styles.opacity
                    });
                    console.log('body data-active-tab:', document.body.getAttribute('data-active-tab'));

                    addSubscriptionBtn.addEventListener('click', (e) => {
                        console.log('添加订阅按钮被点击');
                        console.log('event:', e);
                        console.log('subscriptionUI:', this.subscriptionUI);
                        console.log('openAddSubscriptionDialog:', typeof this.subscriptionUI.openAddSubscriptionDialog);
                        e.preventDefault();
                        e.stopPropagation();
                        this.subscriptionUI.openAddSubscriptionDialog();
                    });
                    console.log('添加订阅按钮事件已绑定');
                } else {
                    console.error('未找到添加订阅按钮');
                }

                // 订阅模态框
                const cancelSubscriptionBtn = document.getElementById('cancel-subscription');
                const saveSubscriptionBtn = document.getElementById('save-subscription');
                const subscriptionModal = document.getElementById('subscription-modal');

                if (cancelSubscriptionBtn) {
                    cancelSubscriptionBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeSubscriptionDialog();
                    });
                }

                if (saveSubscriptionBtn) {
                    saveSubscriptionBtn.addEventListener('click', () => {
                        this.subscriptionUI.saveSubscription();
                    });
                }

                // 点击模态框外部关闭
                if (subscriptionModal) {
                    subscriptionModal.addEventListener('click', (e) => {
                        if (e.target === subscriptionModal) {
                            this.subscriptionUI.closeSubscriptionDialog();
                        }
                    });
                }

                // 初始化扣费日期选项
                this.subscriptionUI.initBillingDateOptions();

                // 周期类型变化时切换扣费日期输入方式
                const cycleTypeSelect = document.getElementById('subscription-cycle-type');
                const firstBillingDateGroup = document.getElementById('first-billing-date-group');

                if (cycleTypeSelect) {
                    cycleTypeSelect.addEventListener('change', () => {
                        this.subscriptionUI.updateBillingDateInput(cycleTypeSelect.value);
                        if (cycleTypeSelect.value === 'lifetime') {
                            firstBillingDateGroup.style.display = 'none';
                        } else {
                            firstBillingDateGroup.style.display = 'block';
                        }
                    });
                }

                // 终身订阅"计入日均成本"复选框事件
                const lifetimeIncludeDailyCheckbox = document.getElementById('lifetime-include-daily');
                const lifetimePurchaseDateGroup = document.getElementById('lifetime-purchase-date-group');
                if (lifetimeIncludeDailyCheckbox && lifetimePurchaseDateGroup) {
                    lifetimeIncludeDailyCheckbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            lifetimePurchaseDateGroup.style.display = 'block';
                        } else {
                            lifetimePurchaseDateGroup.style.display = 'none';
                        }
                    });
                }

                // 图标选择器
                const iconPickerBtn = document.getElementById('subscription-icon-picker-btn');
                const closeIconPickerBtn = document.getElementById('close-icon-picker');
                const iconPickerModal = document.getElementById('icon-picker-modal');

                if (iconPickerBtn) {
                    iconPickerBtn.addEventListener('click', () => {
                        this.subscriptionUI.openIconPicker();
                    });
                }

                if (closeIconPickerBtn) {
                    closeIconPickerBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeIconPicker();
                    });
                }

                // 图标分类标签切换
                const iconCategoryTabs = document.querySelectorAll('.icon-category-tab');
                iconCategoryTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        iconCategoryTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        this.subscriptionUI.renderIconPickerIcons(tab.dataset.category);
                    });
                });

                // 点击模态框外部关闭
                if (iconPickerModal) {
                    iconPickerModal.addEventListener('click', (e) => {
                        if (e.target === iconPickerModal) {
                            this.subscriptionUI.closeIconPicker();
                        }
                    });
                }

                // 订阅分类管理
                const manageSubCategoriesBtn = document.getElementById('manage-subscription-categories-btn');
                const closeSubCategoryModalBtn = document.getElementById('close-subscription-category-modal');
                const addSubCategoryInModalBtn = document.getElementById('add-subscription-category-in-modal');
                const subCategoryModal = document.getElementById('subscription-category-manage-modal');

                if (manageSubCategoriesBtn) {
                    manageSubCategoriesBtn.addEventListener('click', () => {
                        this.subscriptionUI.openSubscriptionCategoryManageModal();
                    });
                }

                if (closeSubCategoryModalBtn) {
                    closeSubCategoryModalBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeSubscriptionCategoryManageModal();
                    });
                }

                if (addSubCategoryInModalBtn) {
                    addSubCategoryInModalBtn.addEventListener('click', () => {
                        this.subscriptionUI.addSubscriptionCategoryInModal();
                    });
                }

                // 点击模态框外部关闭
                if (subCategoryModal) {
                    subCategoryModal.addEventListener('click', (e) => {
                        if (e.target === subCategoryModal) {
                            this.subscriptionUI.closeSubscriptionCategoryManageModal();
                        }
                    });
                }

                // 扣费日期详情弹窗
                const closeBillingDetailBtn = document.getElementById('close-billing-date-detail');
                const billingDetailModal = document.getElementById('billing-date-detail-modal');
                const billingDetailList = document.getElementById('billing-date-detail-list');

                if (closeBillingDetailBtn) {
                    closeBillingDetailBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeBillingDateDetail();
                    });
                }

                // 扣费日期详情列表事件委托（编辑按钮）
                if (billingDetailList) {
                    billingDetailList.addEventListener('click', (e) => {
                        const editBtn = e.target.closest('.billing-detail-actions .edit');
                        if (editBtn) {
                            const id = editBtn.dataset.id;
                            if (id) {
                                this.subscriptionUI.closeBillingDateDetail();
                                this.subscriptionUI.openEditSubscriptionDialog(id);
                            }
                        }
                    });
                }

                // 点击模态框外部关闭
                if (billingDetailModal) {
                    billingDetailModal.addEventListener('click', (e) => {
                        if (e.target === billingDetailModal) {
                            this.subscriptionUI.closeBillingDateDetail();
                        }
                    });
                }

                // 日历导航
                const calendarNavBtns = document.querySelectorAll('.calendar-nav-btn');
                calendarNavBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const direction = btn.dataset.direction;
                        const currentDate = this.subscriptionUI.currentCalendarDate;
                        if (direction === 'prev') {
                            currentDate.setMonth(currentDate.getMonth() - 1);
                        } else {
                            currentDate.setMonth(currentDate.getMonth() + 1);
                        }
                        this.subscriptionUI.renderCalendar();
                    });
                });

                // uTools 启动时检查提醒
                if (typeof utools !== 'undefined' && utools.onPluginEnter) {
                    utools.onPluginEnter(() => {
                        this.subscriptionStorage.updateAllNextBillingDates();
                        this.subscriptionManager.checkReminders();
                    });
                }

                // 分析类型切换器事件绑定
                const analyticsOptions = document.querySelectorAll('.analytics-toggle-option');
                analyticsOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const type = option.dataset.type;
                        this.switchAnalyticsType(type);
                    });
                });

                // 订阅详情弹窗按钮事件
                const closeSubscriptionDetailBtn = document.getElementById('close-subscription-detail');
                const saveSubscriptionDetailBtn = document.getElementById('save-subscription-detail');
                const deleteSubscriptionDetailBtn = document.getElementById('delete-subscription-detail');
                const subscriptionDetailModal = document.getElementById('subscription-detail-modal');

                if (closeSubscriptionDetailBtn) {
                    closeSubscriptionDetailBtn.addEventListener('click', () => {
                        this.subscriptionUI.closeSubscriptionDetail();
                    });
                }

                if (saveSubscriptionDetailBtn) {
                    saveSubscriptionDetailBtn.addEventListener('click', () => {
                        this.subscriptionUI.saveSubscriptionDetail();
                    });
                }

                if (deleteSubscriptionDetailBtn) {
                    deleteSubscriptionDetailBtn.addEventListener('click', () => {
                        this.subscriptionUI.deleteSubscriptionDetail();
                    });
                }
                // 注意：订阅详情弹窗的点击外部关闭事件由统一的模态框处理机制处理（在 modals 配置中）
            }

            // 渲染分类标签
            renderCategoryTabs() {
                const categoryTabsContainer = document.querySelector('.category-tabs');
                if (!categoryTabsContainer) return;

                // 保留"全部"标签，移除其他标签
                const allTab = categoryTabsContainer.querySelector('[data-category="all"]');
                categoryTabsContainer.innerHTML = '';
                categoryTabsContainer.appendChild(allTab);

                // 获取所有分类并排序，把"其他"放在最后
                const categories = this.storage.getCategories();
                const sortedCategories = [...categories].sort((a, b) => {
                    if (a.name === '其他') return 1;
                    if (b.name === '其他') return -1;
                    return 0;
                });

                sortedCategories.forEach(category => {
                    const tab = document.createElement('button');
                    tab.className = 'category-tab';
                    tab.dataset.category = category.name;
                    tab.textContent = category.name;

                    // 添加点击事件
                    tab.addEventListener('click', () => {
                        // 更新标签状态
                        document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');

                        // 按分类筛选物品
                        this.renderItems(category.name);
                    });

                    categoryTabsContainer.appendChild(tab);
                });

                // 为"全部"标签添加点击事件
                allTab.addEventListener('click', () => {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    allTab.classList.add('active');
                    this.renderItems();
                });
            }

            // 更新物品快速统计
            updateItemStats() {
                const items = this.storage.getItems();
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth(); // 0-11

                // 物品总数
                const totalCount = items.length;

                // 本月新增
                const monthlyNew = items.filter(item => {
                    if (!item.createdAt) return false;
                    const createdDate = new Date(item.createdAt);
                    return createdDate.getFullYear() === currentYear && createdDate.getMonth() === currentMonth;
                }).length;

                // 年度新增
                const yearlyNew = items.filter(item => {
                    if (!item.createdAt) return false;
                    const createdDate = new Date(item.createdAt);
                    return createdDate.getFullYear() === currentYear;
                }).length;

                // 总价值
                const totalValue = items.reduce((sum, item) => sum + (item.price || 0), 0);

                // 更新DOM
                document.getElementById('item-total-count').textContent = totalCount;
                document.getElementById('item-monthly-new').textContent = monthlyNew;
                document.getElementById('item-yearly-new').textContent = yearlyNew;
                document.getElementById('item-total-value').textContent = `¥${totalValue.toFixed(0)}`;
            }

            // 渲染物品列表
            renderItems(category = 'all') {
                const itemList = document.getElementById('item-list');
                if (!itemList) return;
                
                // 清空物品列表
                itemList.innerHTML = '';
                
                // 获取所有物品 - 如果有临时排序数据则使用临时数据
                const allItems = this.tempReorderedItems || this.storage.getItems();
                
                // 按分类筛选
                let filteredItems = allItems;
                if (category !== 'all') {
                    filteredItems = allItems.filter(item => item.category === category);
                }
                
                // 如果没有物品，显示提示
                if (filteredItems.length === 0) {
                    itemList.innerHTML = '<div style="text-align: center; padding: 40px 0; color: #999;">暂无物品</div>';
                    return;
                }
                
                // 为每个物品创建卡片
                filteredItems.forEach((item, index) => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';
                    itemCard.draggable = true;
                    itemCard.dataset.itemId = item.id;
                    itemCard.dataset.originalIndex = index;
                    
                    // 计算使用天数
                    let daysUsed = 0;
                    if (item.purchaseDate) {
                        const now = new Date();
                        const purchaseDate = new Date(item.purchaseDate);
                        daysUsed = Math.max(0, Math.ceil((now - purchaseDate) / (1000 * 60 * 60 * 24)));
                    }
                    
                    // 设置卡片内容
                    // 获取分类图标
                    const category = this.storage.getCategoryByName(item.category);
                    const categoryIcon = category?.icon || '📦';

                    itemCard.innerHTML = `
                        <div class="item-header">
                            <div class="item-name">
                                <span class="item-icon">${categoryIcon}</span>
                                <span>${item.name}</span>
                            </div>
                            <div class="item-days">已使用 ${daysUsed} 天</div>
                        </div>
                        <div class="item-category">${item.category}</div>
                        ${item.desc ? `<div class="item-desc">${item.desc}</div>` : ''}
                        ${item.purchaseChannel ? `<div class="item-desc" style="color: #6b7280; font-size: 12px;">购买渠道: ${item.purchaseChannel}</div>` : ''}
                        <div class="item-footer">
                            <div class="item-price">¥${item.price?.toFixed(2) || '0.00'}<span class="item-price-unit">元</span></div>
                        </div>
                    `;
                    
                    // 添加点击动画效果
                    itemCard.addEventListener('click', () => {
                        itemCard.style.transform = 'scale(0.98)';
                        setTimeout(() => {
                            itemCard.style.transform = '';
                            this.showItemDetail(item);
                        }, 100);
                    });
                    
                    // 添加拖拽事件监听器
                    itemCard.addEventListener('dragstart', (e) => {
                        // 存储拖拽物品的ID
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', item.id.toString());
                        // 存储到全局变量
                        this.currentDraggedItemId = item.id.toString();
                        // 添加拖拽状态样式
                        itemCard.classList.add('dragging');
                    });
                    
                    // 允许放置 - 实时显示挤开效果
                    itemCard.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        
                        // 记录当前悬停的目标
                        const draggedItemId = this.currentDraggedItemId;
                        if (draggedItemId && draggedItemId !== item.id.toString()) {
                            this.currentDropTarget = item.id.toString();
                            // 实时视觉预览（不改变DOM结构）
                            this.visualPreview(draggedItemId, item.id.toString());
                        }
                    });
                    
                    // 处理放置事件 - 确认排序
                    itemCard.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('=== Drop event triggered ===');
                        
                        // 使用全局变量获取拖拽的物品ID
                        const draggedItemId = this.currentDraggedItemId;
                        const targetItemId = item.id.toString();
                        console.log('draggedItemId:', draggedItemId, 'targetItemId:', targetItemId);
                        
                        if (draggedItemId && draggedItemId !== targetItemId) {
                            // 直接重新排序并保存
                            const items = [...this.storage.getItems()];
                            console.log('Current items:', items.map(i => i.name));
                            
                            const draggedIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                            const targetIndex = items.findIndex(item => item.id.toString() === targetItemId);
                            console.log('draggedIndex:', draggedIndex, 'targetIndex:', targetIndex);
                            
                            if (draggedIndex !== -1 && targetIndex !== -1) {
                                const [draggedItem] = items.splice(draggedIndex, 1);
                                items.splice(targetIndex, 0, draggedItem);
                                console.log('New order:', items.map(i => i.name));
                                
                                // 保存新顺序
                                const result = this.storage.saveItems(items);
                                console.log('Save result:', result);
                                
                                if (result) {
                                    this.orderSaved = true;
                                    console.log('Order saved successfully!');
                                    
                                    // 清空临时数据
                                    this.tempReorderedItems = null;
                                    
                                    // 清理所有transform样式
                                    const allCards = document.querySelectorAll('.item-card');
                                    allCards.forEach(card => {
                                        card.style.transform = '';
                                        card.style.transition = '';
                                    });
                                    
                                    // 重新渲染
                                    const activeTab = document.querySelector('.category-tab.active');
                                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                                    console.log('Re-rendering with category:', currentCategory);
                                    this.renderItems(currentCategory);
                                } else {
                                    console.error('Failed to save items!');
                                }
                            }
                        }
                    });
                    
                    // 拖拽结束
                    itemCard.addEventListener('dragend', () => {
                        console.log('Dragend event');
                        console.log('orderSaved:', this.orderSaved);
                        console.log('currentDropTarget:', this.currentDropTarget);
                        
                        // 移除拖拽状态样式
                        itemCard.classList.remove('dragging');
                        
                        // 如果没有通过drop保存，但有记录的目标位置，则在这里保存
                        if (!this.orderSaved && this.currentDropTarget && this.currentDraggedItemId) {
                            const draggedItemId = this.currentDraggedItemId;
                            const targetItemId = this.currentDropTarget;
                            
                            console.log('Saving from dragend - draggedId:', draggedItemId, 'targetId:', targetItemId);
                            
                            if (draggedItemId !== targetItemId) {
                                // 重新排序并保存
                                const items = [...this.storage.getItems()];
                                const draggedIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                                const targetIndex = items.findIndex(item => item.id.toString() === targetItemId);
                                
                                if (draggedIndex !== -1 && targetIndex !== -1) {
                                    const [draggedItem] = items.splice(draggedIndex, 1);
                                    items.splice(targetIndex, 0, draggedItem);
                                    
                                    // 保存新顺序
                                    const result = this.storage.saveItems(items);
                                    console.log('Save from dragend result:', result);
                                    
                                    if (result) {
                                        // 清空临时数据
                                        this.tempReorderedItems = null;
                                    }
                                }
                            }
                        }
                        
                        // 清理所有transform样式
                        const allCards = document.querySelectorAll('.item-card');
                        allCards.forEach(card => {
                            card.style.transform = '';
                            card.style.transition = '';
                        });
                        
                        // 重新渲染以显示最终状态
                        const activeTab = document.querySelector('.category-tab.active');
                        const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                        this.renderItems(currentCategory);
                        
                        // 清理状态
                        this.currentDraggedItemId = null;
                        this.currentDropTarget = null;
                        this.lastPreviewTarget = null;
                        this.orderSaved = false;
                    });
                    
                    // 添加到物品列表
                    itemList.appendChild(itemCard);
                });
            }
            
            // 视觉预览（只用CSS transform，不改变DOM）
            visualPreview(draggedItemId, targetItemId) {
                // 如果目标没变，不需要重新计算
                if (this.lastPreviewTarget === targetItemId) {
                    return;
                }
                
                // 立即更新目标
                this.lastPreviewTarget = targetItemId;
                
                const itemList = document.getElementById('item-list');
                if (!itemList) return;
                
                const allCards = Array.from(itemList.querySelectorAll('.item-card'));
                const draggedCard = allCards.find(card => card.dataset.itemId === draggedItemId);
                const targetCard = allCards.find(card => card.dataset.itemId === targetItemId);
                
                if (!draggedCard || !targetCard) return;
                
                const draggedIndex = allCards.indexOf(draggedCard);
                const targetIndex = allCards.indexOf(targetCard);
                
                console.log('Visual preview - draggedIndex:', draggedIndex, 'targetIndex:', targetIndex);
                
                // 计算grid布局参数
                const cardRect = allCards[0].getBoundingClientRect();
                const cardWidth = cardRect.width;
                const cardHeight = cardRect.height;
                const gap = 16;
                const containerWidth = itemList.offsetWidth;
                const cols = Math.floor(containerWidth / (cardWidth + gap));
                
                // 为每个卡片计算偏移
                allCards.forEach((card, index) => {
                    // 被拖动的卡片不移动，保持在原位置（透明显示）
                    if (card.dataset.itemId === draggedItemId) {
                        card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        card.style.transform = 'translate(0, 0)';
                        return;
                    }
                    
                    let offset = 0;
                    
                    if (draggedIndex < targetIndex) {
                        // 向右拖动：draggedIndex 和 targetIndex 之间的卡片向左移动
                        if (index > draggedIndex && index <= targetIndex) {
                            offset = -1;
                            console.log('Card at index', index, 'moves left (offset -1)');
                        }
                    } else {
                        // 向左拖动：targetIndex 和 draggedIndex 之间的卡片向右移动
                        if (index >= targetIndex && index < draggedIndex) {
                            offset = 1;
                            console.log('Card at index', index, 'moves right (offset 1)');
                        }
                    }
                    
                    if (offset !== 0) {
                        // 计算当前卡片在grid中的行列位置
                        const currentRow = Math.floor(index / cols);
                        const currentCol = index % cols;
                        
                        // 计算新位置的行列
                        const newPosition = index + offset;
                        const newRow = Math.floor(newPosition / cols);
                        const newCol = newPosition % cols;
                        
                        // 计算实际的偏移量
                        const translateX = (newCol - currentCol) * (cardWidth + gap);
                        const translateY = (newRow - currentRow) * (cardHeight + gap);
                        
                        console.log('Card at index', index, '- translateX:', translateX, 'translateY:', translateY);
                        
                        card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        card.style.transform = `translate(${translateX}px, ${translateY}px)`;
                    } else {
                        card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                        card.style.transform = 'translate(0, 0)';
                    }
                });
            }
            
            // 实时预览重新排序（拖动时）
            previewReorder(draggedItemId, targetItemId) {
                // 防止频繁触发
                if (this.lastPreviewTarget === targetItemId) {
                    return;
                }
                this.lastPreviewTarget = targetItemId;
                
                // 更新临时排序数据
                const items = [...this.storage.getItems()]; // 创建副本
                const draggedItemIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                const targetItemIndex = items.findIndex(item => item.id.toString() === targetItemId);
                
                if (draggedItemIndex !== -1 && targetItemIndex !== -1) {
                    const [draggedItem] = items.splice(draggedItemIndex, 1);
                    items.splice(targetItemIndex, 0, draggedItem);
                    this.tempReorderedItems = items;
                    console.log('Preview reorder - temp items updated');
                    
                    // 获取当前激活的分类标签
                    const activeTab = document.querySelector('.category-tab.active');
                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                    
                    // 重新渲染以显示新顺序
                    this.renderItems(currentCategory);
                    
                    // 重新添加dragging类到被拖动的元素
                    setTimeout(() => {
                        const draggedCard = document.querySelector(`[data-item-id="${draggedItemId}"]`);
                        if (draggedCard) {
                            draggedCard.classList.add('placeholder');
                        }
                    }, 0);
                }
            }
            
            // 确认重新排序（放下时）
            confirmReorder(draggedItemId, targetItemId) {
                console.log('confirmReorder called', draggedItemId, targetItemId);
                console.log('tempReorderedItems:', this.tempReorderedItems);
                
                // 如果有临时排序，保存它
                if (this.tempReorderedItems) {
                    console.log('Saving reordered items...');
                    const result = this.storage.saveItems(this.tempReorderedItems);
                    console.log('Save result:', result);
                    if (result) {
                        // 标记为已保存，但不清空临时数据（让dragend来清理）
                        this.orderSaved = true;
                        console.log('Order saved successfully');
                    }
                } else {
                    console.log('No temp items, using reorderItems');
                    // 如果没有临时排序，执行原有逻辑
                    this.reorderItems(draggedItemId, targetItemId);
                }
            }
            
            // 恢复原始顺序（拖拽取消时）
            restoreOriginalOrder() {
                if (this.tempReorderedItems) {
                    // 获取当前激活的分类标签
                    const activeTab = document.querySelector('.category-tab.active');
                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                    
                    // 获取当前显示的物品列表
                    const itemList = document.getElementById('item-list');
                    if (!itemList) return;
                    
                    // 获取所有卡片元素并保存位置
                    const cards = Array.from(itemList.querySelectorAll('.item-card'));
                    const positions = new Map();
                    cards.forEach(card => {
                        const rect = card.getBoundingClientRect();
                        positions.set(card.dataset.itemId, {
                            top: rect.top,
                            left: rect.left
                        });
                    });
                    
                    // 清空临时数据
                    this.tempReorderedItems = null;
                    this.lastPreviewTarget = null;
                    
                    // 重新渲染以恢复原始顺序
                    this.renderItems(currentCategory);
                    
                    // 使用FLIP技术实现平滑动画
                    requestAnimationFrame(() => {
                        const newCards = Array.from(itemList.querySelectorAll('.item-card'));
                        
                        newCards.forEach(card => {
                            const itemId = card.dataset.itemId;
                            const oldPos = positions.get(itemId);
                            
                            // 移除占位符样式
                            card.classList.remove('placeholder');
                            
                            if (oldPos) {
                                const newRect = card.getBoundingClientRect();
                                const deltaX = oldPos.left - newRect.left;
                                const deltaY = oldPos.top - newRect.top;
                                
                                // 先移动到旧位置（不带动画）
                                card.style.transition = 'none';
                                card.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
                                
                                // 强制重排
                                card.offsetHeight;
                                
                                // 然后动画到新位置
                                card.style.transition = 'transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                                card.style.transform = 'translate(0, 0)';
                            }
                        });
                    });
                }
            }
            
            // 重新排序物品
            reorderItems(draggedItemId, targetItemId) {
                // 获取所有物品
                const items = this.storage.getItems();
                
                // 查找拖拽物品和目标物品的索引
                const draggedIndex = items.findIndex(item => item.id.toString() === draggedItemId);
                const targetIndex = items.findIndex(item => item.id.toString() === targetItemId);
                
                // 确保找到两个物品
                if (draggedIndex !== -1 && targetIndex !== -1) {
                    // 移除拖拽的物品
                    const [draggedItem] = items.splice(draggedIndex, 1);
                    // 插入到目标位置
                    items.splice(targetIndex, 0, draggedItem);
                    
                    // 保存新的顺序
                    const result = this.storage.saveItems(items);
                    
                    // 保存成功后重新渲染
                    if (result) {
                        // 获取当前激活的分类标签
                        const activeTab = document.querySelector('.category-tab.active');
                        const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                        
                        // 应用排序动画效果
                        this.applySortAnimation(() => {
                            // 重新渲染物品列表
                            this.renderItems(currentCategory);
                        });
                    }
                }
            }
            
            // 应用排序动画效果
            applySortAnimation(callback) {
                const itemList = document.getElementById('item-list');
                if (!itemList) {
                    callback();
                    return;
                }
                
                const itemCards = Array.from(itemList.querySelectorAll('.item-card'));
                
                // 为每个卡片添加淡出动画
                itemCards.forEach((card, index) => {
                    setTimeout(() => {
                        card.style.opacity = '0';
                        card.style.transform = 'translateY(20px)';
                    }, index * 50);
                });
                
                // 等待动画完成后执行回调
                setTimeout(callback, itemCards.length * 50 + 300);
            }
            
            // 渲染分类列表（更新快捷卡片计数）
            renderCategories() {
                // 快捷卡片已移除，此方法保留以兼容现有调用
            }

            // 在管理弹窗中渲染分类列表
            renderCategoryManageList() {
                const manageList = document.getElementById('category-manage-list');
                if (!manageList) {
                    console.log('category-manage-list元素不存在');
                    return;
                }

                console.log('开始渲染分类管理列表');
                manageList.innerHTML = '';

                const categories = this.storage.getCategories();
                console.log('获取到的分类数量:', categories.length);

                // 排序：把"其他"分类放在最后
                const sortedCategories = [...categories].sort((a, b) => {
                    if (a.name === '其他') return 1;
                    if (b.name === '其他') return -1;
                    return 0;
                });

                sortedCategories.forEach(category => {
                    console.log('渲染分类:', category.name);
                    const item = document.createElement('div');
                    item.className = 'manage-item';

                    // "其他"分类不显示编辑和删除按钮
                    const isOther = category.name === '其他';
                    if (isOther) {
                        item.innerHTML = `
                            <div class="manage-item-name">${category.icon} ${category.name}</div>
                            <div class="manage-item-actions">
                                <span style="color: var(--text-light); font-size: 12px;">默认分类</span>
                            </div>
                        `;
                    } else {
                        item.innerHTML = `
                            <div class="manage-item-name">${category.icon} ${category.name}</div>
                            <div class="manage-item-actions">
                                <button class="edit" data-id="${category.id}">编辑</button>
                                <button class="delete" data-id="${category.id}">删除</button>
                            </div>
                        `;
                    }
                    manageList.appendChild(item);
                });

                console.log('分类管理列表渲染完成');

                // 重新绑定分类项的编辑和删除事件
                this.bindCategoryManageEvents();
            }

            // 绑定分类管理弹窗中的编辑和删除事件
            bindCategoryManageEvents() {
                const manageList = document.getElementById('category-manage-list');
                if (!manageList) {
                    console.error('category-manage-list元素不存在，无法绑定事件');
                    return;
                }

                // 绑定编辑按钮事件
                const editBtns = manageList.querySelectorAll('.manage-item-actions button.edit');
                editBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.editCategoryInModal(id);
                    };
                });

                // 绑定删除按钮事件
                const deleteBtns = manageList.querySelectorAll('.manage-item-actions button.delete');
                deleteBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.deleteCategoryInModal(id);
                    };
                });
                console.log('分类管理事件绑定完成');
            }

            // 初始化购买渠道选择框
            initChannelSelects() {
                console.log('初始化购买渠道选择框');
                const channels = this.storage.getChannels();
                console.log('获取到购买渠道数量:', channels.length);

                // 更新添加物品模态框的购买渠道选择框
                const addChannelSelect = document.getElementById('item-purchase-channel');
                if (addChannelSelect) {
                    addChannelSelect.innerHTML = '';
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = channel.name;
                        addChannelSelect.appendChild(option);
                    });
                    // 设置默认值为第一个选项
                    if (channels.length > 0) {
                        addChannelSelect.value = channels[0].name;
                    }
                }

                // 更新详情模态框的购买渠道选择框
                const detailChannelSelect = document.getElementById('detail-item-purchase-channel');
                if (detailChannelSelect) {
                    detailChannelSelect.innerHTML = '<option value="">请选择购买渠道</option>';
                    channels.forEach(channel => {
                        const option = document.createElement('option');
                        option.value = channel.name;
                        option.textContent = channel.name;
                        detailChannelSelect.appendChild(option);
                    });
                }
            }

            // 渲染购买渠道列表（更新快捷卡片计数）
            renderChannels() {
                // 快捷卡片已移除，此方法保留以兼容现有调用
            }

            // 在管理弹窗中渲染购买渠道列表
            renderChannelManageList() {
                const manageList = document.getElementById('channel-manage-list');
                if (!manageList) {
                    console.log('channel-manage-list元素不存在');
                    return;
                }

                console.log('开始渲染购买渠道管理列表');
                manageList.innerHTML = '';

                const channels = this.storage.getChannels();
                console.log('获取到的购买渠道数量:', channels.length);

                // 排序：把"其他"渠道放在最后
                const sortedChannels = [...channels].sort((a, b) => {
                    if (a.name === '其他') return 1;
                    if (b.name === '其他') return -1;
                    return 0;
                });

                sortedChannels.forEach(channel => {
                    console.log('渲染购买渠道:', channel.name);
                    const item = document.createElement('div');
                    item.className = 'manage-item';

                    // "其他"渠道不显示编辑和删除按钮
                    const isOther = channel.name === '其他';
                    if (isOther) {
                        item.innerHTML = `
                            <div class="manage-item-name">${channel.name}</div>
                            <div class="manage-item-actions">
                                <span style="color: var(--text-light); font-size: 12px;">默认渠道</span>
                            </div>
                        `;
                    } else {
                        item.innerHTML = `
                            <div class="manage-item-name">${channel.name}</div>
                            <div class="manage-item-actions">
                                <button class="edit" data-id="${channel.id}">编辑</button>
                                <button class="delete" data-id="${channel.id}">删除</button>
                            </div>
                        `;
                    }
                    manageList.appendChild(item);
                });

                console.log('购买渠道管理列表渲染完成');

                // 重新绑定渠道项的编辑和删除事件
                this.bindChannelManageEvents();
            }

            // 绑定购买渠道管理弹窗中的编辑和删除事件
            bindChannelManageEvents() {
                const manageList = document.getElementById('channel-manage-list');
                if (!manageList) {
                    console.error('channel-manage-list元素不存在，无法绑定事件');
                    return;
                }

                // 绑定编辑按钮事件
                const editBtns = manageList.querySelectorAll('.manage-item-actions button.edit');
                editBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.editChannelInModal(id);
                    };
                });

                // 绑定删除按钮事件
                const deleteBtns = manageList.querySelectorAll('.manage-item-actions button.delete');
                deleteBtns.forEach(btn => {
                    btn.onclick = (e) => {
                        const id = btn.dataset.id;
                        this.deleteChannelInModal(id);
                    };
                });
                console.log('购买渠道管理事件绑定完成');
            }

            // 打开分类管理弹窗
            openCategoryManageModal() {
                console.log('打开分类管理弹窗');
                const modal = document.getElementById('category-manage-modal');
                if (modal) {
                    this.renderCategoryManageList();
                    modal.style.display = 'flex';
                }
            }

            // 关闭分类管理弹窗
            closeCategoryManageModal() {
                console.log('关闭分类管理弹窗');
                const modal = document.getElementById('category-manage-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 打开购买渠道管理弹窗
            openChannelManageModal() {
                console.log('打开购买渠道管理弹窗');
                const modal = document.getElementById('channel-manage-modal');
                if (modal) {
                    this.renderChannelManageList();
                    modal.style.display = 'flex';
                }
            }

            // 关闭购买渠道管理弹窗
            closeChannelManageModal() {
                console.log('关闭购买渠道管理弹窗');
                const modal = document.getElementById('channel-manage-modal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }

            // 在弹窗中添加分类
            addCategoryInModal() {
                console.log('addCategoryInModal被调用');
                this.prompt('添加分类', '请输入分类名称:', '', (confirmed, categoryName) => {
                    if (confirmed) {
                        const trimmedName = categoryName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入分类名称！', 'error');
                            return;
                        }

                        // 使用默认图标
                        const result = this.storage.addCategory({ name: trimmedName, icon: '📦' });
                        console.log('添加分类结果:', result);
                        if (result) {
                            this.renderCategoryManageList();
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.initCustomSelects();
                            this.showToast('分类添加成功！', 'success');
                        } else {
                            this.showToast('分类添加失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 在弹窗中编辑分类
            editCategoryInModal(id) {
                console.log('编辑分类:', id);
                const category = this.storage.getCategoryById(id);
                if (!category) {
                    console.error('分类不存在:', id);
                    this.showToast('分类不存在！', 'error');
                    return;
                }

                this.prompt('编辑分类', '请输入新的分类名称:', category.name, (confirmed, categoryName) => {
                    if (confirmed) {
                        const trimmedName = categoryName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入分类名称！', 'error');
                            return;
                        }

                        const result = this.storage.updateCategory(id, { name: trimmedName });
                        console.log('编辑分类结果:', result);
                        if (result) {
                            this.renderCategoryManageList();
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.initCustomSelects();
                            this.showToast('分类编辑成功！', 'success');
                        } else {
                            this.showToast('分类编辑失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 在弹窗中删除分类
            deleteCategoryInModal(id) {
                console.log('删除分类:', id);
                const cat = this.storage.getCategoryById(id);
                if (!cat) return;

                // 获取该分类下的物品数量
                const items = this.storage.getItems();
                const itemsCount = items.filter(item => item.category == id || item.category.toString() === id.toString()).length;

                let message = `确定要删除分类"${cat.name}"吗？\n\n该分类下的物品将自动归类到"其他"分类中。`;
                if (itemsCount > 0) {
                    message = `确定要删除分类"${cat.name}"吗？\n\n该分类下有 ${itemsCount} 个物品，将被自动归类到"其他"分类中。`;
                }

                this.confirm('删除分类', message, (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteCategory(id);
                        console.log('删除分类结果:', result);
                        if (result) {
                            this.renderCategoryManageList();
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.renderItems();
                            this.initCustomSelects();
                            this.showToast('分类删除成功！', 'success');
                        } else {
                            this.showToast('分类删除失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 在弹窗中添加购买渠道
            addChannelInModal() {
                console.log('addChannelInModal被调用');
                this.prompt('添加购买渠道', '请输入购买渠道名称:', '', (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入购买渠道名称！', 'error');
                            return;
                        }

                        const result = this.storage.addChannel({ name: trimmedName });
                        console.log('添加购买渠道结果:', result);
                        if (result) {
                            this.renderChannelManageList();
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('购买渠道添加成功！', 'success');
                        } else {
                            this.showToast('购买渠道添加失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 在弹窗中编辑购买渠道
            editChannelInModal(id) {
                console.log('编辑购买渠道:', id);
                const channel = this.storage.getChannelById(id);
                if (!channel) {
                    console.error('购买渠道不存在:', id);
                    this.showToast('购买渠道不存在！', 'error');
                    return;
                }

                // 防止编辑"其他"渠道
                if (channel.name === '其他') {
                    this.showToast('不能编辑默认购买渠道！', 'error');
                    return;
                }

                this.prompt('编辑购买渠道', '请输入新的购买渠道名称:', channel.name, (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入购买渠道名称！', 'error');
                            return;
                        }

                        const result = this.storage.updateChannel(id, { name: trimmedName });
                        console.log('编辑购买渠道结果:', result);
                        if (result) {
                            this.renderChannelManageList();
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('购买渠道编辑成功！', 'success');
                        } else {
                            this.showToast('购买渠道编辑失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 在弹窗中删除购买渠道
            deleteChannelInModal(id) {
                console.log('删除购买渠道:', id);
                const channel = this.storage.getChannelById(id);
                if (!channel) {
                    console.error('购买渠道不存在:', id);
                    this.showToast('购买渠道不存在！', 'error');
                    return;
                }

                // 计算使用该渠道的物品数量
                const items = this.storage.getItems();
                const itemsCount = items.filter(item => item.purchaseChannel == id || item.purchaseChannel.toString() === id.toString()).length;

                let message = `确定要删除购买渠道"${channel.name}"吗？\n\n该渠道下的物品将自动归类到"其他"渠道中。`;
                if (itemsCount > 0) {
                    message = `确定要删除购买渠道"${channel.name}"吗？\n\n该渠道下有 ${itemsCount} 个物品，将被自动归类到"其他"渠道中。`;
                }

                this.confirm('删除购买渠道', message, (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteChannel(id);
                        console.log('删除购买渠道结果:', result);
                        if (result) {
                            this.renderChannelManageList();
                            this.renderChannels();
                            this.initChannelSelects();
                            this.renderItems(); // 重新渲染物品列表以更新显示
                            this.showToast('购买渠道删除成功！', 'success');
                        } else {
                            this.showToast('购买渠道删除失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 添加购买渠道
            addChannel() {
                console.log('addChannel被调用');
                this.prompt('添加购买渠道', '请输入购买渠道名称:', '', (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入购买渠道名称！', 'error');
                            return;
                        }

                        const result = this.storage.addChannel({ name: trimmedName });
                        console.log('添加购买渠道结果:', result);
                        if (result) {
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('购买渠道添加成功！', 'success');
                        } else {
                            this.showToast('购买渠道添加失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 编辑购买渠道
            editChannel(id) {
                console.log('编辑购买渠道:', id);
                const channel = this.storage.getChannelById(id);
                if (!channel) {
                    console.error('购买渠道不存在:', id);
                    this.showToast('购买渠道不存在！', 'error');
                    return;
                }

                // 防止编辑"其他"渠道
                if (channel.name === '其他') {
                    this.showToast('不能编辑默认购买渠道！', 'error');
                    return;
                }

                this.prompt('编辑购买渠道', '请输入新的购买渠道名称:', channel.name, (confirmed, channelName) => {
                    if (confirmed) {
                        const trimmedName = channelName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入购买渠道名称！', 'error');
                            return;
                        }

                        const result = this.storage.updateChannel(id, { name: trimmedName });
                        console.log('编辑购买渠道结果:', result);
                        if (result) {
                            this.renderChannels();
                            this.initChannelSelects();
                            this.showToast('购买渠道编辑成功！', 'success');
                        } else {
                            this.showToast('购买渠道编辑失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 删除购买渠道
            deleteChannel(id) {
                console.log('删除购买渠道:', id);
                const channel = this.storage.getChannelById(id);
                if (!channel) {
                    console.error('购买渠道不存在:', id);
                    this.showToast('购买渠道不存在！', 'error');
                    return;
                }

                // 防止删除"其他"渠道
                if (channel.name === '其他') {
                    this.showToast('不能删除默认购买渠道！', 'error');
                    return;
                }

                // 计算使用该渠道的物品数量
                const items = this.storage.getItems();
                const itemsCount = items.filter(item => item.purchaseChannel == id || item.purchaseChannel.toString() === id.toString()).length;

                let message = `确定要删除购买渠道"${channel.name}"吗？\n\n该渠道下的物品将自动归类到"其他"渠道中。`;
                if (itemsCount > 0) {
                    message = `确定要删除购买渠道"${channel.name}"吗？\n\n该渠道下有 ${itemsCount} 个物品，将被自动归类到"其他"渠道中。`;
                }

                this.confirm('删除购买渠道', message, (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteChannel(id);
                        console.log('删除购买渠道结果:', result);
                        if (result) {
                            this.renderChannels();
                            this.initChannelSelects();
                            this.renderItems(); // 重新渲染物品列表以更新显示
                            this.showToast('购买渠道删除成功！', 'success');
                        } else {
                            this.showToast('购买渠道删除失败，请重试！', 'error');
                        }
                    }
                });
            }

            // 初始化自定义下拉框
            initCustomSelects() {
                console.log('初始化自定义下拉框');

                // 从storage中获取所有分类
                const categories = this.storage.getCategories();
                console.log('获取到分类数量:', categories.length);

                // 为所有自定义下拉框添加事件监听器
                const customSelects = document.querySelectorAll('.custom-select');
                console.log('找到自定义下拉框数量:', customSelects.length);

                customSelects.forEach(select => {
                    const trigger = select.querySelector('.custom-select-trigger');
                    const optionsContainer = select.querySelector('.custom-select-options');
                    const hiddenInput = select.querySelector('input[type="hidden"]');

                    if (trigger && optionsContainer && hiddenInput) {
                        // 清空现有选项
                        optionsContainer.innerHTML = '';

                        // 分类下拉框选项
                        categories.forEach(category => {
                            const option = document.createElement('div');
                            option.className = 'custom-select-option';
                            option.dataset.value = category.name;
                            option.textContent = `${category.icon} ${category.name}`;
                            optionsContainer.appendChild(option);
                        });
                        
                        // 获取新生成的选项
                        const optionItems = select.querySelectorAll('.custom-select-option');
                        
                        // 移除之前的事件监听器（如果有）
                        trigger.onclick = null;
                        optionItems.forEach(option => {
                            option.onclick = null;
                        });
                        
                        // 点击触发框切换选项列表显示状态
                        trigger.onclick = (e) => {
                            e.stopPropagation();
                            // 关闭其他下拉框
                            document.querySelectorAll('.custom-select').forEach(s => {
                                if (s !== select) {
                                    s.classList.remove('open');
                                }
                            });
                            // 切换当前下拉框状态
                            select.classList.toggle('open');
                        };
                        
                        // 选择选项
                        optionItems.forEach(option => {
                            option.onclick = (e) => {
                                e.stopPropagation();
                                const value = option.dataset.value;
                                const text = option.textContent;

                                // 更新触发框文本
                                trigger.textContent = text;
                                // 更新隐藏输入框值
                                hiddenInput.value = value;
                                // 标记选中状态
                                optionItems.forEach(opt => opt.classList.remove('selected'));
                                option.classList.add('selected');
                                // 关闭选项列表
                                select.classList.remove('open');
                            };
                        });
                    }
                });
                
                // 只添加一次全局点击事件
                if (!document.querySelector('.custom-select-click-handler')) {
                    const clickHandler = document.createElement('div');
                    clickHandler.className = 'custom-select-click-handler';
                    document.body.appendChild(clickHandler);
                    
                    // 点击页面其他地方关闭下拉框
                    document.addEventListener('click', () => {
                        document.querySelectorAll('.custom-select').forEach(select => {
                            select.classList.remove('open');
                        });
                    });
                    
                    // 点击选项列表内部不关闭
                    document.addEventListener('click', (e) => {
                        if (e.target.closest('.custom-select-options')) {
                            e.stopPropagation();
                        }
                    });
                }
            }
            
            // 绑定事件
            bindEvents() {
                console.log('开始绑定事件');
                
                // 初始化主题和布局
                this.initThemeAndLayout();
                this.renderThemePresets();
                
                // 初始化自定义下拉框
                this.initCustomSelects();
                
                // 标签切换
                const tabs = document.querySelectorAll('.tab');
                console.log('找到标签数量:', tabs.length);
                tabs.forEach(tab => {
                    console.log('绑定标签点击事件:', tab.dataset.tab);
                    tab.addEventListener('click', () => {
                        console.log('标签被点击:', tab.dataset.tab);
                        const tabId = tab.dataset.tab;
                        if (!tabId) return;

                        // 更新标签状态
                        tabs.forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
                        tab.classList.add('active');

                        // 更新 body 的 data-active-tab 属性，用于控制添加按钮的显示
                        document.body.setAttribute('data-active-tab', tabId);

                        // 直接控制添加按钮的显示
                        const addItemBtn = document.getElementById('add-item-btn');
                        const addSubscriptionBtn = document.getElementById('add-subscription-btn');

                        if (tabId === 'subscription') {
                            // 订阅标签：隐藏添加物品按钮，显示添加订阅按钮
                            if (addItemBtn) addItemBtn.style.display = 'none';
                            if (addSubscriptionBtn) {
                                addSubscriptionBtn.style.display = 'flex';
                                console.log('显示添加订阅按钮');
                            }
                        } else {
                            // 其他标签：显示添加物品按钮，隐藏添加订阅按钮
                            if (addItemBtn) addItemBtn.style.display = 'flex';
                            if (addSubscriptionBtn) addSubscriptionBtn.style.display = 'none';
                        }

                        // 显示对应面板
                        const panel = document.getElementById(`${tabId}-panel`);
                        if (panel) {
                            panel.classList.add('active');
                            console.log('显示面板:', tabId);

                            // 如果切换到物品标签，重新渲染物品面板
                            if (tabId === 'items') {
                                // 使用 requestAnimationFrame 确保DOM更新完成后再渲染
                                requestAnimationFrame(() => {
                                    this.updateItemStats();
                                    this.renderItems();
                                });
                            }

                            // 如果切换到我的标签，重新渲染分类列表、购买渠道列表并更新统计
                            if (tabId === 'settings') {
                                this.renderCategories();
                                this.renderChannels();
                                this.updateStats();
                            }

                            // 如果切换到订阅标签，渲染订阅面板
                            if (tabId === 'subscription') {
                                // 使用 requestAnimationFrame 确保DOM更新完成后再渲染
                                requestAnimationFrame(() => {
                                    this.subscriptionUI.renderSubscriptionPanel();
                                });
                            }

                            // 如果切换到分析标签，渲染数据分析
                            if (tabId === 'analytics') {
                                this.renderAnalytics();
                            }
                        }
                    });
                });

                // 添加物品按钮
                const addItemBtn = document.getElementById('add-item-btn');
                console.log('找到添加物品按钮:', !!addItemBtn);
                if (addItemBtn) {
                    console.log('绑定添加物品按钮点击事件');
                    addItemBtn.addEventListener('click', function() {
                        console.log('添加物品按钮被点击');
                        const addModal = document.getElementById('add-item-modal');
                        if (addModal) {
                            addModal.style.display = 'flex';
                            console.log('显示添加物品模态框');
                            
                            // 设置购买日期默认值为今天
                            const purchaseDateInput = document.getElementById('item-purchase-date');
                            if (purchaseDateInput) {
                                purchaseDateInput.value = new Date().toISOString().split('T')[0];
                            }

                            // 初始化购买渠道选择框
                            this.initChannelSelects();

                            // 保存this的引用
                            const self = this;
                            // 显示模态框后初始化下拉框
                            setTimeout(function() {
                                self.initCustomSelects();
                            }, 100);
                        }
                    }.bind(this));
                }
                
                // 取消添加
                const cancelAddBtn = document.getElementById('cancel-add');
                if (cancelAddBtn) {
                    cancelAddBtn.addEventListener('click', () => {
                        const addModal = document.getElementById('add-item-modal');
                        if (addModal) {
                            addModal.style.display = 'none';
                        }
                    });
                }
                
                // 保存物品
                const saveItemBtn = document.getElementById('save-item');
                if (saveItemBtn) {
                    saveItemBtn.addEventListener('click', () => {
                        const nameInput = document.getElementById('item-name');
                        const categoryInput = document.getElementById('item-category');
                        const descInput = document.getElementById('item-desc');
                        const locationInput = document.getElementById('item-location');
                        const priceInput = document.getElementById('item-price');
                        const purchaseDateInput = document.getElementById('item-purchase-date');
                        const purchaseChannelInput = document.getElementById('item-purchase-channel');

                        const name = nameInput?.value?.trim();
                        const category = categoryInput?.value;
                        const desc = descInput?.value?.trim();
                        const location = locationInput?.value?.trim();
                        const priceValue = priceInput?.value?.trim();
                        const price = parseFloat(priceValue) || 0;
                        const purchaseDate = purchaseDateInput?.value || new Date().toISOString().split('T')[0];
                        const purchaseChannel = purchaseChannelInput?.value || '';

                        // 清除之前的错误
                        this.clearInputError(nameInput);
                        this.clearInputError(categoryInput);
                        this.clearInputError(priceInput);
                        this.clearInputError(purchaseChannelInput);

                        // 验证必填项
                        if (!name) {
                            this.showInputError(nameInput, '请输入物品名称');
                            return;
                        }

                        if (!category) {
                            this.showInputError(categoryInput, '请选择分类');
                            return;
                        }

                        // 验证购买渠道
                        if (!purchaseChannel) {
                            this.showInputError(purchaseChannelInput, '请选择购买渠道');
                            return;
                        }

                        // 验证价格
                        if (priceValue && (isNaN(price) || price < 0)) {
                            this.showInputError(priceInput, '请输入有效的价格（不能为负数）');
                            return;
                        }

                        const newItem = {
                            name,
                            category,
                            desc,
                            location,
                            price,
                            purchaseDate,
                            purchaseChannel
                        };
                        
                        const result = this.storage.addItem(newItem);
                        
                        if (result) {
                            // 更新统计信息
                            this.updateStats();
                            this.updateItemStats();

                            // 重新渲染物品列表，显示新添加的物品
                            // 保持当前的分类筛选状态
                            const activeTab = document.querySelector('.category-tab.active');
                            const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                            this.renderItems(currentCategory);
                            
                            const addModal = document.getElementById('add-item-modal');
                            if (addModal) {
                                addModal.style.display = 'none';
                            }
                            
                            // 清空表单
                            if (nameInput) nameInput.value = '';
                            if (descInput) descInput.value = '';
                            if (locationInput) locationInput.value = '';
                            if (priceInput) priceInput.value = '';
                            if (purchaseDateInput) purchaseDateInput.value = new Date().toISOString().split('T')[0];
                            if (purchaseChannelInput) purchaseChannelInput.value = '';

                            this.showToast('物品添加成功！', 'success');
                        } else {
                            this.showToast('物品添加失败，请重试！', 'error');
                        }
                    });
                }
                
                // 关闭详情
                const closeDetailBtn = document.getElementById('close-detail');
                if (closeDetailBtn) {
                    closeDetailBtn.addEventListener('click', () => {
                        const detailModal = document.getElementById('item-detail-modal');
                        if (detailModal) {
                            detailModal.style.display = 'none';
                        }
                    });
                }
                
                // 保存物品详情按钮
                const saveItemDetailBtn = document.getElementById('save-item-detail');
                if (saveItemDetailBtn) {
                    saveItemDetailBtn.addEventListener('click', () => {
                        this.saveItemEdit();
                    });
                }
                
                // 删除物品按钮
                const deleteItemDetailBtn = document.getElementById('delete-item-detail');
                if (deleteItemDetailBtn) {
                    deleteItemDetailBtn.addEventListener('click', () => {
                        this.deleteItem();
                    });
                }

                // 物品界面管理按钮
                const manageCategoriesBtn = document.getElementById('manage-categories-btn');
                const manageChannelsBtn = document.getElementById('manage-channels-btn');

                if (manageCategoriesBtn) {
                    manageCategoriesBtn.addEventListener('click', () => {
                        this.openCategoryManageModal();
                    });
                }

                if (manageChannelsBtn) {
                    manageChannelsBtn.addEventListener('click', () => {
                        this.openChannelManageModal();
                    });
                }

                // 分类管理弹窗事件
                const closeCategoryModalBtn = document.getElementById('close-category-modal');
                const addCategoryInModalBtn = document.getElementById('add-category-in-modal');

                if (closeCategoryModalBtn) {
                    closeCategoryModalBtn.addEventListener('click', () => {
                        this.closeCategoryManageModal();
                    });
                }

                if (addCategoryInModalBtn) {
                    addCategoryInModalBtn.addEventListener('click', () => {
                        this.addCategoryInModal();
                    });
                }

                // 购买渠道管理弹窗事件
                const closeChannelModalBtn = document.getElementById('close-channel-modal');
                const addChannelInModalBtn = document.getElementById('add-channel-in-modal');

                if (closeChannelModalBtn) {
                    closeChannelModalBtn.addEventListener('click', () => {
                        this.closeChannelManageModal();
                    });
                }

                if (addChannelInModalBtn) {
                    addChannelInModalBtn.addEventListener('click', () => {
                        this.addChannelInModal();
                    });
                }

                // 导出数据
                const exportBtn = document.getElementById('export-data-btn');
                if (exportBtn) {
                    exportBtn.addEventListener('click', () => {
                        this.exportData();
                    });
                }
                
                // 导入数据
                const importBtn = document.getElementById('import-data-btn');
                if (importBtn) {
                    importBtn.addEventListener('click', () => {
                        this.importData();
                    });
                }
                
                // 布局切换按钮
                const layoutOptions = document.querySelectorAll('.layout-option');
                layoutOptions.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const layout = btn.dataset.layout;
                        if (layout) {
                            this.switchLayout(layout);
                        }
                    });
                });
                
                // 自定义主题按钮
                const customThemeBtn = document.getElementById('custom-theme-btn');
                if (customThemeBtn) {
                    customThemeBtn.addEventListener('click', () => {
                        this.createCustomTheme();
                    });
                }
                
                // 模态框点击外部关闭
                this.setupModalClickOutside();
            }
            
            // 显示物品详情
            showItemDetail(item) {
                const detailModal = document.getElementById('item-detail-modal');
                if (!detailModal) return;

                // 首先设置所有需要跟踪修改的字段
                const detailItemName = document.getElementById('detail-item-name');
                if (detailItemName) detailItemName.value = item.name;

                const detailItemPrice = document.getElementById('detail-item-price');
                if (detailItemPrice) detailItemPrice.value = item.price || 0;

                const detailItemDesc = document.getElementById('detail-item-desc');
                if (detailItemDesc) detailItemDesc.value = item.desc || '';

                const detailItemLocation = document.getElementById('detail-item-location');
                if (detailItemLocation) detailItemLocation.value = item.location || '';

                // 在显示弹窗之前保存原始值
                const originalValues = {
                    '#detail-item-name': item.name || '',
                    '#detail-item-desc': item.desc || '',
                    '#detail-item-location': item.location || '',
                    '#detail-item-price': (item.price || 0).toString()
                };
                detailModal.dataset.originalValues = JSON.stringify(originalValues);
                console.log('物品详情弹窗 - 已保存原始值:', originalValues);

                // 设置购买日期（不需要跟踪修改）
                const detailItemPurchaseDate = document.getElementById('detail-item-purchase-date');
                if (detailItemPurchaseDate) detailItemPurchaseDate.value = item.purchaseDate || item.createdAt?.split('T')[0];

                // 计算并设置日均价值（不需要跟踪修改）
                const calculateDailyValue = (price, purchaseDate) => {
                    if (!price || !purchaseDate) return 0;
                    const now = new Date();
                    const purchased = new Date(purchaseDate);
                    const days = Math.max(1, Math.ceil((now - purchased) / (1000 * 60 * 60 * 24)));
                    return price / days;
                };

                const dailyValue = calculateDailyValue(item.price, item.purchaseDate || item.createdAt);
                const detailItemDailyValue = document.getElementById('detail-item-daily-value');
                if (detailItemDailyValue) detailItemDailyValue.value = dailyValue.toFixed(2);

                // 存储当前编辑的物品ID
                this.currentEditingItem = item;

                // 显示弹窗
                detailModal.style.display = 'flex';

                // 保存this的引用
                const self = this;

                // 显示模态框后初始化下拉框并设置当前分类
                setTimeout(function() {
                    self.initCustomSelects();

                    // 设置当前分类
                    const customSelect = document.getElementById('custom-detail-category-select');
                    if (customSelect) {
                        const trigger = customSelect.querySelector('.custom-select-trigger');
                        const hiddenInput = customSelect.querySelector('input[type="hidden"]');
                        const options = customSelect.querySelectorAll('.custom-select-option');

                        if (trigger && hiddenInput && options) {
                            // 获取分类信息，包括图标
                            const categories = self.storage.getCategories();
                            const itemCategory = categories.find(cat => cat.name === item.category);

                            if (itemCategory) {
                                trigger.textContent = `${itemCategory.icon} ${item.category}`;
                            } else {
                                trigger.textContent = item.category || '请选择分类';
                            }

                            hiddenInput.value = item.category || '';

                            // 标记选中状态
                            options.forEach(option => {
                                if (option.dataset.value === item.category) {
                                    option.classList.add('selected');
                                } else {
                                    option.classList.remove('selected');
                                }
                            });
                        }
                    }

                    // 设置购买渠道（不需要跟踪修改）
                    const detailPurchaseChannel = document.getElementById('detail-item-purchase-channel');
                    if (detailPurchaseChannel) {
                        detailPurchaseChannel.value = item.purchaseChannel || '';
                    }
                }, 100);
            }
            
            // 保存物品编辑
            saveItemEdit() {
                console.log('saveItemEdit被调用');
                console.log('currentEditingItem:', this.currentEditingItem);
                if (!this.currentEditingItem) {
                    console.error('currentEditingItem为空！');
                    return;
                }
                
                // 获取编辑后的值
                const detailItemName = document.getElementById('detail-item-name');
                const detailItemCategory = document.getElementById('detail-item-category');
                const detailItemDesc = document.getElementById('detail-item-desc');
                const detailItemLocation = document.getElementById('detail-item-location');
                const detailItemPrice = document.getElementById('detail-item-price');
                const detailItemPurchaseDate = document.getElementById('detail-item-purchase-date');
                const detailPurchaseChannel = document.getElementById('detail-item-purchase-channel');

                const name = detailItemName ? detailItemName.value?.trim() : '';
                const category = detailItemCategory ? detailItemCategory.value : '';
                const priceValue = detailItemPrice ? detailItemPrice.value?.trim() : '';
                const price = parseFloat(priceValue) || 0;
                const purchaseChannel = detailPurchaseChannel ? detailPurchaseChannel.value : '';

                console.log('编辑后的值:', { name, category, price, purchaseChannel });

                // 清除之前的错误
                this.clearInputError(detailItemName);
                this.clearInputError(detailItemCategory);
                this.clearInputError(detailItemPrice);

                // 验证必填项
                if (!name) {
                    this.showInputError(detailItemName, '请输入物品名称');
                    return;
                }

                if (!category) {
                    this.showInputError(detailItemCategory, '请选择分类');
                    return;
                }

                // 验证价格
                if (priceValue && (isNaN(price) || price < 0)) {
                    this.showInputError(detailItemPrice, '请输入有效的价格（不能为负数）');
                    return;
                }

                const updates = {
                    name: name,
                    category: category,
                    desc: detailItemDesc ? detailItemDesc.value?.trim() : this.currentEditingItem.desc,
                    location: detailItemLocation ? detailItemLocation.value?.trim() : this.currentEditingItem.location,
                    price: price,
                    purchaseDate: detailItemPurchaseDate ? detailItemPurchaseDate.value : this.currentEditingItem.purchaseDate,
                    purchaseChannel: purchaseChannel
                };
                
                console.log('准备更新物品，ID:', this.currentEditingItem.id, '更新内容:', updates);
                
                // 更新物品数据
                const result = this.storage.updateItem(this.currentEditingItem.id, updates);
                
                console.log('更新结果:', result);
                
                if (result) {
                    // 更新统计信息
                    this.updateStats();
                    this.updateItemStats();

                    // 重新渲染物品列表，保持当前分类筛选状态
                    const activeTab = document.querySelector('.category-tab.active');
                    const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                    this.renderItems(currentCategory);
                    
                    // 关闭模态框
                    const detailModal = document.getElementById('item-detail-modal');
                    if (detailModal) {
                        detailModal.style.display = 'none';
                    }
                    
                    // 重置当前编辑的物品
                    this.currentEditingItem = null;
                    
                    this.showToast('物品更新成功！', 'success');
                } else {
                    this.showToast('物品更新失败，请重试！', 'error');
                }
            }
            
            // 删除物品
            deleteItem() {
                console.log('deleteItem被调用');
                if (!this.currentEditingItem) {
                    console.error('currentEditingItem为空！');
                    return;
                }
                
                console.log('准备删除物品:', this.currentEditingItem);
                
                this.confirm('删除物品', '确定要删除这个物品吗？此操作不可恢复。', (confirmed) => {
                    console.log('确认对话框回调被调用, confirmed:', confirmed);
                    if (confirmed) {
                        // 删除物品
                        console.log('开始删除物品，ID:', this.currentEditingItem.id);
                        const result = this.storage.deleteItem(this.currentEditingItem.id);
                        console.log('删除结果:', result);
                        
                        if (result) {
                            console.log('删除成功，准备显示提示');

                            // 更新统计信息
                            this.updateStats();
                            this.updateItemStats();

                            // 重新渲染物品列表，保持当前分类筛选状态
                            const activeTab = document.querySelector('.category-tab.active');
                            const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                            this.renderItems(currentCategory);
                            
                            // 关闭模态框
                            const detailModal = document.getElementById('item-detail-modal');
                            if (detailModal) {
                                detailModal.style.display = 'none';
                            }
                            
                            // 重置当前编辑的物品
                            this.currentEditingItem = null;
                            
                            // 显示成功提示
                            console.log('调用showToast显示成功提示');
                            this.showToast('物品删除成功！', 'success');
                            console.log('showToast调用完成');
                        } else {
                            console.log('删除失败');
                            // 显示失败提示
                            this.showToast('物品删除失败，请重试！', 'error');
                        }
                    } else {
                        console.log('用户取消了删除');
                    }
                });
            }
            
            // 编辑分类
            editCategory(id) {
                console.log('编辑分类:', id);
                const category = this.storage.getCategoryById(id);
                if (!category) {
                    console.error('分类不存在:', id);
                    this.showToast('分类不存在！', 'error');
                    return;
                }
                
                this.prompt('编辑分类', '请输入新的分类名称:', category.name, (confirmed, categoryName) => {
                    if (confirmed) {
                        const trimmedName = categoryName?.trim();
                        if (!trimmedName) {
                            this.showToast('请输入分类名称！', 'error');
                            return;
                        }
                        
                        const result = this.storage.updateCategory(id, { name: trimmedName });
                        console.log('编辑分类结果:', result);
                        if (result) {
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.initCustomSelects();
                            this.showToast('分类编辑成功！', 'success');
                        } else {
                            this.showToast('分类编辑失败，请重试！', 'error');
                        }
                    }
                });
            }
            
            // 删除分类
            deleteCategory(id) {
                console.log('删除分类:', id);
                this.confirm('删除分类', '确定要删除这个分类吗？', (confirmed) => {
                    if (confirmed) {
                        const result = this.storage.deleteCategory(id);
                        console.log('删除分类结果:', result);
                        if (result) {
                            this.renderCategories();
                            this.renderCategoryTabs();
                            this.renderItems(); // 重新渲染物品列表，确保分类筛选正确
                            this.initCustomSelects();
                            this.showToast('分类删除成功！', 'success');
                        } else {
                            this.showToast('分类删除失败，请重试！', 'error');
                        }
                    }
                });
            }
            
            // 显示输入错误
            showInputError(inputElement, message) {
                if (!inputElement) return;
                
                // 添加错误样式
                inputElement.classList.add('input-error');
                
                // 查找或创建错误消息元素
                let errorMsg = inputElement.parentElement.querySelector('.error-message');
                if (!errorMsg) {
                    errorMsg = document.createElement('div');
                    errorMsg.className = 'error-message';
                    inputElement.parentElement.appendChild(errorMsg);
                }
                
                errorMsg.textContent = message;
                errorMsg.classList.add('show');
                
                // 3秒后移除错误样式
                setTimeout(() => {
                    inputElement.classList.remove('input-error');
                    errorMsg.classList.remove('show');
                }, 3000);
                
                // 聚焦到错误输入框
                inputElement.focus();
            }
            
            // 清除输入错误
            clearInputError(inputElement) {
                if (!inputElement) return;
                
                inputElement.classList.remove('input-error');
                const errorMsg = inputElement.parentElement.querySelector('.error-message');
                if (errorMsg) {
                    errorMsg.classList.remove('show');
                }
            }
            
            // 设置模态框点击外部关闭
            setupModalClickOutside() {
                console.log('设置模态框点击外部关闭');
                const modals = [
                    { id: 'add-item-modal', formSelector: '#add-item-modal form', inputs: ['#item-name', '#item-desc', '#item-location', '#item-price'] },
                    { id: 'item-detail-modal', formSelector: '#item-detail-modal form', inputs: ['#detail-item-name', '#detail-item-desc', '#detail-item-location', '#detail-item-price'] },
                    { id: 'subscription-detail-modal', formSelector: '#subscription-detail-modal form', inputs: ['#detail-subscription-name', '#detail-subscription-price', '#detail-subscription-notes', '#detail-subscription-website'] },
                    { id: 'category-manage-modal', formSelector: null, inputs: [] },
                    { id: 'channel-manage-modal', formSelector: null, inputs: [] }
                ];
                
                modals.forEach(modalConfig => {
                    const modal = document.getElementById(modalConfig.id);
                    console.log(`找到模态框 ${modalConfig.id}:`, !!modal);
                    if (!modal) return;

                    modal.addEventListener('click', (e) => {
                        // 只有点击模态框背景（不是内容区域）时才触发
                        if (e.target === modal) {
                            console.log(`点击了模态框 ${modalConfig.id} 的外部`);
                            this.handleModalClose(modal, modalConfig);
                        }
                    });
                });
                console.log('模态框点击外部关闭设置完成');
            }
            
            // 处理模态框关闭
            handleModalClose(modal, modalConfig) {
                // 对于详情弹窗，检查是否有修改（而非是否有内容）
                if (modalConfig.id === 'item-detail-modal' || modalConfig.id === 'subscription-detail-modal') {
                    const originalValues = modal.dataset.originalValues ? JSON.parse(modal.dataset.originalValues) : {};
                    console.log('检查详情弹窗修改:', modalConfig.id, '原始值:', originalValues);

                    const hasChanges = modalConfig.inputs.some(selector => {
                        const input = document.querySelector(selector);
                        if (!input) return false;
                        const currentValue = input.value || '';
                        const originalValue = originalValues[selector] || '';
                        const changed = currentValue !== originalValue;
                        if (changed) {
                            console.log('字段有修改:', selector, '原值:', originalValue, '当前值:', currentValue);
                        }
                        return changed;
                    });

                    console.log('是否有修改:', hasChanges);

                    if (hasChanges) {
                        // 有修改，询问用户是否保存
                        this.dialogCallback = (confirmed) => {
                            if (confirmed) {
                                modal.style.display = 'none';
                            }
                        };
                        this.showDialog('确认关闭', '您有未保存的修改，确定要关闭吗？', 'confirm');
                    } else {
                        // 没有修改，直接关闭
                        modal.style.display = 'none';
                    }
                } else {
                    // 对于其他弹窗，检查是否有输入内容
                    const hasInput = modalConfig.inputs.some(selector => {
                        const input = document.querySelector(selector);
                        return input && input.value && input.value.trim() !== '';
                    });

                    if (hasInput) {
                        // 有输入内容，询问用户是否保存
                        this.dialogCallback = (confirmed) => {
                            if (confirmed) {
                                this.clearModalForm(modalConfig);
                                modal.style.display = 'none';
                            }
                        };
                        this.showDialog('确认关闭', '您有未保存的内容，确定要关闭吗？', 'confirm');
                    } else {
                        // 没有输入内容，直接关闭
                        modal.style.display = 'none';
                    }
                }
            }
            
            // 清空模态框表单
            clearModalForm(modalConfig) {
                modalConfig.inputs.forEach(selector => {
                    const input = document.querySelector(selector);
                    if (input) {
                        input.value = '';
                        this.clearInputError(input);
                    }
                });
            }
            
            // 应用主题
            applyTheme(themeKey) {
                const theme = this.themePresets[themeKey];
                if (!theme) return;
                
                const root = document.documentElement;
                root.style.setProperty('--primary-color', theme.primary);
                root.style.setProperty('--secondary-color', theme.secondary);
                root.style.setProperty('--accent-color', theme.accent);
                root.style.setProperty('--background-primary', theme.background);
                root.style.setProperty('--background-secondary', theme.backgroundSecondary);
                
                // 暗色主题特殊处理
                if (themeKey === 'dark') {
                    root.style.setProperty('--text-primary', '#f9fafb');
                    root.style.setProperty('--text-secondary', '#d1d5db');
                    root.style.setProperty('--text-light', '#9ca3af');
                    root.style.setProperty('--border-color', '#374151');
                    root.style.setProperty('--background-tertiary', '#1f2937');
                    document.body.style.backgroundColor = theme.backgroundSecondary;
                } else {
                    root.style.setProperty('--text-primary', '#1f2937');
                    root.style.setProperty('--text-secondary', '#6b7280');
                    root.style.setProperty('--text-light', '#9ca3af');
                    root.style.setProperty('--border-color', '#e5e7eb');
                    root.style.setProperty('--background-tertiary', '#f3f4f6');
                    document.body.style.backgroundColor = theme.backgroundSecondary;
                }
                
                this.currentTheme = themeKey;
                localStorage.setItem('wucanglu_theme', themeKey);
            }
            
            // 渲染主题预设
            renderThemePresets() {
                const container = document.getElementById('theme-presets');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.keys(this.themePresets).forEach(key => {
                    const theme = this.themePresets[key];
                    const card = document.createElement('div');
                    card.className = 'theme-preset-card';
                    card.dataset.theme = key;
                    card.style.cssText = `
                        padding: 12px;
                        border: 2px solid ${this.currentTheme === key ? theme.primary : '#e5e7eb'};
                        border-radius: 8px;
                        cursor: pointer;
                        transition: all 0.2s;
                        background: ${this.currentTheme === key ? theme.primary + '10' : 'white'};
                    `;
                    
                    card.innerHTML = `
                        <div style="display: flex; gap: 4px; margin-bottom: 8px;">
                            <div style="width: 20px; height: 20px; border-radius: 4px; background: ${theme.primary};"></div>
                            <div style="width: 20px; height: 20px; border-radius: 4px; background: ${theme.secondary};"></div>
                            <div style="width: 20px; height: 20px; border-radius: 4px; background: ${theme.accent};"></div>
                        </div>
                        <div style="font-size: 12px; font-weight: 500; color: #374151;">${theme.name}</div>
                        ${this.currentTheme === key ? '<div style="font-size: 10px; color: ' + theme.primary + '; margin-top: 4px;">✓ 使用中</div>' : ''}
                    `;
                    
                    card.addEventListener('click', () => {
                        this.applyTheme(key);
                        this.renderThemePresets();
                        this.showToast('主题已切换！', 'success');
                    });
                    
                    container.appendChild(card);
                });
            }
            
            // 切换布局
            switchLayout(layout) {
                this.currentLayout = layout;
                localStorage.setItem('wucanglu_layout', layout);
                
                const itemList = document.getElementById('item-list');
                if (!itemList) return;
                
                // 移除所有布局类
                itemList.classList.remove('layout-grid', 'layout-list', 'layout-masonry');
                
                // 添加新布局类
                itemList.classList.add(`layout-${layout}`);
                
                // 更新按钮状态
                document.querySelectorAll('.layout-option').forEach(btn => {
                    if (btn.dataset.layout === layout) {
                        btn.classList.add('active');
                        btn.style.borderColor = '#4361ee';
                        btn.style.background = '#f0f4ff';
                    } else {
                        btn.classList.remove('active');
                        btn.style.borderColor = '#e5e7eb';
                        btn.style.background = 'white';
                    }
                });
                
                // 重新渲染物品列表以应用新布局
                const activeTab = document.querySelector('.category-tab.active');
                const currentCategory = activeTab ? activeTab.dataset.category : 'all';
                this.renderItems(currentCategory);
                
                // 显示提示
                const layoutNames = { grid: '网格', list: '列表', masonry: '瀑布流' };
                this.showToast(`已切换到${layoutNames[layout]}布局`, 'success');
            }
            
            // 初始化主题和布局
            initThemeAndLayout() {
                // 加载保存的主题
                const savedTheme = localStorage.getItem('wucanglu_theme') || 'default';
                this.currentTheme = savedTheme;
                this.applyTheme(savedTheme);
                
                // 加载保存的布局
                const savedLayout = localStorage.getItem('wucanglu_layout') || 'grid';
                this.currentLayout = savedLayout;
                
                const itemList = document.getElementById('item-list');
                if (itemList) {
                    itemList.classList.add(`layout-${savedLayout}`);
                }
                
                // 更新布局按钮状态
                document.querySelectorAll('.layout-option').forEach(btn => {
                    if (btn.dataset.layout === savedLayout) {
                        btn.classList.add('active');
                        btn.style.borderColor = '#4361ee';
                        btn.style.background = '#f0f4ff';
                    } else {
                        btn.classList.remove('active');
                        btn.style.borderColor = '#e5e7eb';
                        btn.style.background = 'white';
                    }
                });
            }
            
            // 创建自定义主题
            createCustomTheme() {
                // 创建自定义主题对话框
                const dialog = document.createElement('div');
                dialog.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px);';
                
                dialog.innerHTML = `
                    <div style="background-color: white; padding: 28px; border-radius: 16px; width: 90%; max-width: 550px; max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                        <h4 style="margin-top: 0; margin-bottom: 8px; font-size: 18px; font-weight: 600;">自定义主题</h4>
                        <p style="margin-bottom: 20px; font-size: 13px; color: #6b7280;">选择颜色来创建你的专属主题配色方案</p>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">主题名称</label>
                            <input type="text" id="custom-theme-name" placeholder="我的主题" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">主色调</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">用于按钮、标签、激活状态等主要元素</p>
                            <input type="color" id="custom-primary-color" value="#4361ee" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">次要色</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">用于渐变效果、头部背景等辅助元素</p>
                            <input type="color" id="custom-secondary-color" value="#3f37c9" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">强调色</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">用于高亮、悬停效果等需要突出的元素</p>
                            <input type="color" id="custom-accent-color" value="#4cc9f0" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 4px; font-weight: 500; font-size: 14px;">背景色</label>
                            <p style="margin: 0 0 8px 0; font-size: 12px; color: #6b7280;">用于页面整体背景色</p>
                            <input type="color" id="custom-background-color" value="#f9fafb" style="width: 100%; height: 50px; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                        </div>
                        
                        <!-- 预览区域 -->
                        <div style="margin-bottom: 20px; padding: 16px; border: 1px solid #e5e7eb; border-radius: 8px; background: #f9fafb;">
                            <div style="font-size: 12px; font-weight: 600; color: #374151; margin-bottom: 12px;">预览效果</div>
                            <div id="theme-preview" style="display: flex; gap: 8px; align-items: center;">
                                <div id="preview-primary" style="width: 60px; height: 40px; border-radius: 6px; background: #4361ee; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 500;">主色</div>
                                <div id="preview-secondary" style="width: 60px; height: 40px; border-radius: 6px; background: #3f37c9; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 500;">次要</div>
                                <div id="preview-accent" style="width: 60px; height: 40px; border-radius: 6px; background: #4cc9f0; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 500;">强调</div>
                                <div id="preview-background" style="width: 60px; height: 40px; border-radius: 6px; background: #f9fafb; border: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; color: #374151; font-size: 10px; font-weight: 500;">背景</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: flex-end; gap: 12px;">
                            <button id="cancel-custom-theme" class="btn btn-secondary">取消</button>
                            <button id="save-custom-theme" class="btn btn-primary">保存主题</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(dialog);
                
                // 实时预览功能
                const primaryInput = dialog.querySelector('#custom-primary-color');
                const secondaryInput = dialog.querySelector('#custom-secondary-color');
                const accentInput = dialog.querySelector('#custom-accent-color');
                const backgroundInput = dialog.querySelector('#custom-background-color');
                
                const previewPrimary = dialog.querySelector('#preview-primary');
                const previewSecondary = dialog.querySelector('#preview-secondary');
                const previewAccent = dialog.querySelector('#preview-accent');
                const previewBackground = dialog.querySelector('#preview-background');
                
                // 更新预览
                const updatePreview = () => {
                    previewPrimary.style.background = primaryInput.value;
                    previewSecondary.style.background = secondaryInput.value;
                    previewAccent.style.background = accentInput.value;
                    previewBackground.style.background = backgroundInput.value;
                };
                
                primaryInput.addEventListener('input', updatePreview);
                secondaryInput.addEventListener('input', updatePreview);
                accentInput.addEventListener('input', updatePreview);
                backgroundInput.addEventListener('input', updatePreview);
                
                // 取消按钮
                dialog.querySelector('#cancel-custom-theme').addEventListener('click', () => {
                    document.body.removeChild(dialog);
                });
                
                // 保存按钮
                dialog.querySelector('#save-custom-theme').addEventListener('click', () => {
                    const name = dialog.querySelector('#custom-theme-name').value.trim() || '自定义主题';
                    const primaryColor = dialog.querySelector('#custom-primary-color').value;
                    const secondaryColor = dialog.querySelector('#custom-secondary-color').value;
                    const accentColor = dialog.querySelector('#custom-accent-color').value;
                    const backgroundColor = dialog.querySelector('#custom-background-color').value;
                    
                    // 创建自定义主题对象（匹配预设主题的结构）
                    const customTheme = {
                        name: name,
                        primary: primaryColor,
                        secondary: secondaryColor,
                        accent: accentColor,
                        background: '#ffffff',
                        backgroundSecondary: backgroundColor
                    };
                    
                    // 保存到主题预设中
                    const customKey = 'custom_' + Date.now();
                    this.themePresets[customKey] = customTheme;
                    
                    // 应用主题
                    this.applyTheme(customKey);
                    
                    // 重新渲染主题预设
                    this.renderThemePresets();
                    
                    // 保存自定义主题到localStorage
                    const customThemes = JSON.parse(localStorage.getItem('wucanglu_custom_themes') || '{}');
                    customThemes[customKey] = customTheme;
                    localStorage.setItem('wucanglu_custom_themes', JSON.stringify(customThemes));
                    
                    // 关闭对话框
                    document.body.removeChild(dialog);
                    
                    this.showToast('自定义主题已保存！', 'success');
                });
                
                // 自动聚焦到名称输入框
                setTimeout(() => {
                    dialog.querySelector('#custom-theme-name').focus();
                }, 100);
            }
            
            // 获取图标的中文名称
            getIconName(icon) {
                const iconNames = {
                    '📦': '盒子', '📁': '文件夹', '🗂️': '卡片盒', '📋': '剪贴板', '📌': '图钉', '🔖': '书签', '🏷️': '标签', 
                    '✨': '星光', '⭐': '星星', '🌟': '闪星', '💫': '流星', '🎯': '靶心', '🎪': '马戏团', '🎨': '调色板', 
                    '🎭': '面具', '🎬': '场记板', '🎮': '游戏机', '🎲': '骰子', '🎰': '老虎机', '🎳': '保龄球',
                    '💻': '笔记本', '⌨️': '键盘', '🖥️': '台式机', '🖨️': '打印机', '🖱️': '鼠标', '💾': '软盘', '💿': '光盘', 
                    '📱': '手机', '☎️': '电话', '📞': '话筒', '📟': '传呼机', '📠': '传真机', '📺': '电视', '📻': '收音机', 
                    '🎙️': '麦克风', '🎚️': '推子', '🎛️': '旋钮', '⏱️': '秒表', '⏰': '闹钟', '⏲️': '计时器', '🔋': '电池', 
                    '🔌': '插头', '💡': '灯泡', '🔦': '手电筒', '🕯️': '蜡烛', '📷': '相机', '📸': '快照', '📹': '摄像机', 
                    '📼': '录像带', '🔍': '放大镜', '🔎': '搜索', '🔬': '显微镜', '🔭': '望远镜', '📡': '卫星天线', '🕹️': '摇杆',
                    '👕': 'T恤', '👔': '领带', '👗': '连衣裙', '👙': '比基尼', '👚': '女装', '👛': '钱包', 
                    '👜': '手提包', '👝': '手拿包', '🎒': '书包', '👞': '皮鞋', '👟': '运动鞋', '👠': '高跟鞋', '👡': '凉鞋', 
                    '👢': '靴子', '👑': '皇冠', '👒': '女帽', '🎩': '礼帽', '🎓': '学士帽', '🧢': '鸭舌帽', '⛑️': '救援帽', 
                    '🧣': '围巾', '🧤': '手套', '🧥': '外套', '🧦': '袜子', '👓': '眼镜', '🕶️': '墨镜', '🥽': '护目镜', '🥼': '实验服',
                    '🏠': '房子', '🏡': '小屋', '🏘️': '住宅', '🏚️': '废屋', '🏗️': '建筑', '🏭': '工厂', '🏢': '办公楼', 
                    '🏬': '商场', '🏣': '邮局', '🏤': '邮政', '🏥': '医院', '🏦': '银行', '🏨': '酒店', '🏪': '便利店', 
                    '🏫': '学校', '🏩': '情人旅馆', '💒': '婚礼', '🛏️': '床', '🛋️': '沙发', '🚪': '门', '🪑': '椅子', 
                    '🚿': '淋浴', '🛁': '浴缸', '🚽': '马桶', '🧻': '卫生纸', '🧼': '肥皂', '🧽': '海绵', '🧹': '扫帚', 
                    '🧺': '篮子', '🔑': '钥匙', '🗝️': '老钥匙', '🔨': '锤子', '🪓': '斧头', '⛏️': '镐', '🔧': '扳手', 
                    '🔩': '螺母', '⚙️': '齿轮', '🗜️': '夹具', '⚖️': '天平', '🔗': '链接', '⛓️': '链条', '🧰': '工具箱', '🧲': '磁铁',
                    '💄': '口红', '💅': '指甲油', '💍': '戒指', '💎': '宝石', '🔔': '铃铛', '🔕': '静音', '📿': '念珠', 
                    '🧴': '乳液', '🧵': '线', '🧶': '毛线', '🪡': '针', '🪢': '绳结', '🧿': '护身符', '🪬': '法蒂玛之手', 
                    '💈': '理发店', '🪮': '梳子', '🪥': '牙刷', '🪒': '剃须刀', '🧖': '桑拿', '🧗': '攀岩', '🧘': '瑜伽',
                    '🪔': '油灯', '🧯': '灭火器', '🛢️': '油桶', '💸': '飞钱', '💵': '美元', '💴': '日元', '💶': '欧元', 
                    '💷': '英镑', '🪙': '硬币', '💰': '钱袋', '💳': '银行卡', '🧾': '收据',
                    '🎸': '吉他', '🎹': '钢琴', '🎺': '小号', '🎻': '小提琴', '🪕': '班卓琴', '🥁': '鼓', '🪘': '长鼓', 
                    '🎷': '萨克斯', '🎤': '话筒', '🎧': '耳机', '🎼': '乐谱', '🎵': '音符', '🎶': '音乐', '📯': '号角',
                    '⌚': '手表', '🖲️': '轨迹球', '⏳': '沙漏', '⌛': '计时', '🧭': '指南针', '🎥': '摄影', '📽️': '放映机', 
                    '🎞️': '胶片', '📀': 'DVD',
                    '🌱': '幼苗', '🌿': '草本', '☘️': '三叶草', '🍀': '四叶草', '🎍': '松竹', '🎋': '许愿树', '🍃': '叶子', 
                    '🍂': '落叶', '🍁': '枫叶', '🌾': '稻穗', '🌺': '木槿', '🌻': '向日葵', '🌼': '雏菊', '🌷': '郁金香', 
                    '🌹': '玫瑰', '🥀': '枯萎', '🏵️': '花环', '💐': '花束', '🌸': '樱花', '💮': '白花', '🏔️': '雪山', 
                    '⛰️': '山', '🌋': '火山', '🗻': '富士山', '🏕️': '露营', '🏖️': '海滩', '🏜️': '沙漠', '🏝️': '荒岛', 
                    '🏞️': '国家公园', '🪨': '石头', '🪵': '木头', '🛖': '小屋',
                    '👶': '婴儿', '👧': '女孩', '🧒': '儿童', '👦': '男孩', '🍼': '奶瓶', '🧷': '安全别针', '🧸': '泰迪熊', 
                    '🪀': '悠悠球', '🪁': '风筝', '🎈': '气球', '🎀': '蝴蝶结', '🎁': '礼物', '🎊': '彩球', '🎉': '彩带', 
                    '🪅': '皮纳塔', '🪆': '套娃', '🧃': '果汁盒', '🍭': '棒棒糖', '🍬': '糖果', '🍫': '巧克力', '🎂': '蛋糕', '🧁': '纸杯蛋糕',
                    '🐶': '狗', '🐕': '犬', '🦮': '导盲犬', '🐕‍🦺': '服务犬', '🐩': '贵宾犬', '🐺': '狼', '🦊': '狐狸', 
                    '🦝': '浣熊', '🐱': '猫', '🐈': '家猫', '🐈‍⬛': '黑猫', '🦁': '狮子', '🐯': '虎脸', '🐅': '老虎', 
                    '🐆': '豹子', '🐴': '马脸', '🐎': '马', '🦄': '独角兽', '🦓': '斑马', '🦌': '鹿', '🦬': '野牛', 
                    '🐮': '牛脸', '🐂': '公牛', '🐃': '水牛', '🐄': '奶牛', '🐷': '猪脸', '🐖': '猪', '🐗': '野猪', 
                    '🐽': '猪鼻', '🐏': '公羊', '🐑': '绵羊', '🐐': '山羊', '🐪': '单峰驼', '🐫': '双峰驼', '🦙': '羊驼', 
                    '🦒': '长颈鹿', '🐘': '大象', '🦣': '猛犸象', '🦏': '犀牛', '🦛': '河马', '🐭': '鼠脸', '🐁': '老鼠', 
                    '🐀': '大鼠', '🐹': '仓鼠', '🐰': '兔脸', '🐇': '兔子', '🐿️': '松鼠', '🦫': '海狸', '🦔': '刺猬', 
                    '🦇': '蝙蝠', '🐻': '熊', '🐨': '考拉', '🐼': '熊猫', '🦥': '树懒', '🦦': '水獭', '🦨': '臭鼬', 
                    '🦘': '袋鼠', '🦡': '獾', '🐾': '爪印',
                    '🧩': '拼图', '📚': '书籍', '📖': '书本', '📕': '红书', '📗': '绿书', '📘': '蓝书', '📙': '橙书', 
                    '📓': '笔记本', '📔': '日记本', '📒': '账本', '📃': '文档', '📜': '卷轴', '📄': '页面', '📰': '报纸', 
                    '🗞️': '新闻', '📑': '书签标签', '✉️': '信封', '📧': '电子邮件', '📨': '收件', '📩': '发件', 
                    '📤': '发件箱', '📥': '收件箱', '📫': '邮箱', '📪': '邮箱关', '📬': '邮箱开', '📭': '邮箱空', 
                    '📮': '邮筒', '🗳️': '投票箱'
                };
                return iconNames[icon] || icon;
            }

            // 获取订阅图标的中文名称
            getSubscriptionIconName(icon) {
                const iconNames = {
                    '🎬': '场记板', '🎞️': '胶片', '📺': '电视', '🎵': '音符', '🎤': '话筒', '🎧': '耳机', '🎸': '吉他', '🎹': '钢琴', '🎺': '小号',
                    '🎻': '小提琴', '🪕': '班卓琴', '🥁': '鼓', '🪘': '长鼓', '🎷': '萨克斯', '🎮': '游戏机', '🕹️': '摇杆',
                    '🎰': '老虎机', '🎲': '骰子', '🎳': '保龄球', '🃏': '国际象棋', '🀄': '围棋', '🎱': '台球', '🎯': '靶心',
                    '📚': '书籍', '📖': '书本', '💻': '电脑', '⌨️': '键盘', '🖥️': '显示器', '🖨️': '打印机', '💾': '软盘',
                    '🏠': '房子', '✈️': '飞机', '🍔': '汉堡', '☕': '咖啡', '💊': '药丸', '👕': 'T恤', '⚽': '足球',
                    '🏋️': '举重', '🎨': '调色板', '🔧': '扳手', '🎁': '礼物', '🎈': '气球', '🎉': '拉炮', '🎊': '糖果',
                    '🔔': '铃铛', '🔕': '静音', '📿': '念珠', '⭐': '星星', '🌟': '闪星', '💫': '流星', '✨': '星光',
                    '💰': '钱袋', '💵': '美元', '💴': '日元', '💶': '欧元', '💷': '英镑', '💳': '银行卡', '🧾': '收据',
                    '⏱️': '秒表', '⏰': '闹钟', '🏦': '银行', '🏥': '医院', '🚗': '汽车', '🚕': '出租车', '🚌': '公交车',
                    '🛒': '购物车', '🛍️': '购物袋', '👑': '皇冠', '💍': '戒指', '💎': '宝石', '💄': '口红',
                    '🔮': '水晶球', '🎪': '马戏团', '🎭': '面具', '🏆': '奖杯', '🏅': '奖牌'
                };
                return iconNames[icon] || icon;
            }

            // 添加分类
            addCategory() {
                try {
                    console.log('开始添加分类');
                    
                    // 预制图标库（带名称）
                    const iconLibrary = {
                        '全部': ['📦', '📁', '🗂️', '📋', '📌', '🔖', '🏷️', '✨', '⭐', '🌟', '💫', '🎯', '🎪', '🎨', '🎭', '🎬', '🎮', '🎲', '🎰', '🎳'],
                        '数码': ['💻', '⌨️', '🖥️', '🖨️', '🖱️', '💾', '💿', '📱', '☎️', '📞', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '⏱️', '⏰', '⏲️', '🔋', '🔌', '💡', '🔦', '🕯️', '📷', '📸', '📹', '📼', '🔍', '🔎', '🔬', '🔭', '📡', '🎮', '🕹️', '🎰'],
                        '服饰': ['👕', '👔', '👗', '👙', '👚', '👛', '👜', '👝', '🎒', '👞', '👟', '👠', '👡', '👢', '👑', '👒', '🎩', '🎓', '🧢', '⛑️', '🧣', '🧤', '🧥', '🧦', '👓', '🕶️', '🥽', '🥼'],
                        '生活': ['🏠', '🏡', '🏘️', '🏚️', '🏗️', '🏭', '🏢', '🏬', '🏣', '🏤', '🏥', '🏦', '🏨', '🏪', '🏫', '🏩', '💒', '🛏️', '🛋️', '🚪', '🪑', '🚿', '🛁', '🚽', '🧻', '🧼', '🧽', '🧹', '🧺', '🔑', '🗝️', '🔨', '🪓', '⛏️', '🔧', '🔩', '⚙️', '🗜️', '⚖️', '🔗', '⛓️', '🧰', '🧲'],
                        '美妆': ['💄', '💅', '💍', '💎', '🔔', '🔕', '📿', '🧴', '🧵', '🧶', '🪡', '🪢', '🧿', '🪬', '💈', '🪮', '🪥', '🪒', '🧖', '🧗', '🧘'],
                        '家电': ['📺', '📻', '📞', '☎️', '📟', '📠', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '💸', '💵', '💴', '💶', '💷', '🪙', '💰', '💳', '🧾'],
                        '乐器': ['🎸', '🎹', '🎺', '🎻', '🪕', '🥁', '🪘', '🎷', '🎤', '🎧', '🎼', '🎵', '🎶', '🎙️', '📻', '📯', '🔔', '🔕', '🎚️', '🎛️'],
                        '配饰': ['⌚', '📱', '💻', '⌨️', '🖥️', '🖨️', '🖱️', '🖲️', '🕹️', '🗜️', '💾', '💿', '📀', '📼', '📷', '📸', '📹', '🎥', '📽️', '🎞️', '📞', '☎️', '📟', '📠', '📺', '📻', '🎙️', '🎚️', '🎛️', '🧭', '⏱️', '⏰', '⏲️', '⏳', '⌛', '📡', '🔋', '🔌', '💡', '🔦', '🕯️', '🪔', '🧯', '🛢️', '💸'],
                        '园艺': ['🌱', '🌿', '☘️', '🍀', '🎍', '🎋', '🍃', '🍂', '🍁', '🌾', '🌺', '🌻', '🌼', '🌷', '🌹', '🥀', '🏵️', '💐', '🌸', '💮', '🏔️', '⛰️', '🌋', '🗻', '🏕️', '🏖️', '🏜️', '🏝️', '🏞️', '🪨', '🪵', '🛖'],
                        '母婴': ['👶', '👧', '🧒', '👦', '🍼', '🧷', '🧸', '🪀', '🪁', '🎈', '🎀', '🎁', '🎊', '🎉', '🪅', '🪆', '🧃', '🍭', '🍬', '🍫', '🎂', '🧁'],
                        '宠物': ['🐶', '🐕', '🦮', '🐕‍🦺', '🐩', '🐺', '🦊', '🦝', '🐱', '🐈', '🐈‍⬛', '🦁', '🐯', '🐅', '🐆', '🐴', '🐎', '🦄', '🦓', '🦌', '🦬', '🐮', '🐂', '🐃', '🐄', '🐷', '🐖', '🐗', '🐽', '🐏', '🐑', '🐐', '🐪', '🐫', '🦙', '🦒', '🐘', '🦣', '🦏', '🦛', '🐭', '🐁', '🐀', '🐹', '🐰', '🐇', '🐿️', '🦫', '🦔', '🦇', '🐻', '🐨', '🐼', '🦥', '🦦', '🦨', '🦘', '🦡', '🐾'],
                        '其他': ['🎯', '🎪', '🎨', '🎭', '🎬', '🎮', '🎲', '🎰', '🎳', '🧩', '🧸', '🪀', '🪁', '🎈', '🎀', '🎁', '🎊', '🎉', '🪅', '🪆', '📚', '📖', '📕', '📗', '📘', '📙', '📓', '📔', '📒', '📃', '📜', '📄', '📰', '🗞️', '📑', '🔖', '🏷️', '💰', '💴', '💵', '💶', '💷', '💸', '💳', '🧾', '✉️', '📧', '📨', '📩', '📤', '📥', '📦', '📫', '📪', '📬', '📭', '📮', '🗳️']
                    };
                    
                    // 创建自定义对话框
                    const dialog = document.createElement('div');
                    dialog.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px);';
                    
                    dialog.innerHTML = `
                        <div style="background-color: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);">
                            <h4 style="margin-top: 0; margin-bottom: 16px; font-size: 18px; font-weight: 600;">添加分类</h4>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">分类名称</label>
                                <input type="text" id="category-name-input" placeholder="请输入分类名称" style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; font-size: 14px;">分类图标</label>
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                    <div id="selected-icon-display" style="width: 48px; height: 48px; border: 2px solid #4361ee; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 28px; background: #f0f4ff;">📦</div>
                                    <div style="flex: 1;">
                                        <div style="font-weight: 500; color: #374151; font-size: 14px;" id="selected-icon-name">盒子</div>
                                        <div style="color: #9ca3af; font-size: 12px;">点击下方图标选择</div>
                                    </div>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <div id="icon-category-tabs" style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 12px;">
                                        ${Object.keys(iconLibrary).map(cat => 
                                            `<button class="icon-category-tab ${cat === '全部' ? 'active' : ''}" data-category="${cat}" style="padding: 6px 12px; border: 1px solid #e5e7eb; border-radius: 16px; background: ${cat === '全部' ? '#4361ee' : 'white'}; color: ${cat === '全部' ? 'white' : '#374151'}; font-size: 12px; cursor: pointer; transition: all 0.2s;">${cat}</button>`
                                        ).join('')}
                                    </div>
                                </div>
                                <div id="icon-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 8px; max-height: 240px; overflow-y: auto; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    ${iconLibrary['全部'].map(icon => 
                                        `<div class="icon-option" data-icon="${icon}" style="display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; border: 2px solid transparent;">
                                            <div style="font-size: 28px; margin-bottom: 2px;">${icon}</div>
                                            <div style="font-size: 11px; color: #6b7280; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.getIconName(icon)}</div>
                                        </div>`
                                    ).join('')}
                                </div>
                            </div>
                            <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
                                <button id="category-cancel-btn" class="btn btn-secondary">取消</button>
                                <button id="category-confirm-btn" class="btn btn-primary">确定</button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(dialog);
                    
                    const nameInput = dialog.querySelector('#category-name-input');
                    const iconDisplay = dialog.querySelector('#selected-icon-display');
                    const iconNameDisplay = dialog.querySelector('#selected-icon-name');
                    const iconGrid = dialog.querySelector('#icon-grid');
                    const categoryTabs = dialog.querySelectorAll('.icon-category-tab');
                    const cancelBtn = dialog.querySelector('#category-cancel-btn');
                    const confirmBtn = dialog.querySelector('#category-confirm-btn');
                    
                    let selectedIcon = '📦';
                    
                    // 自动聚焦到名称输入框
                    setTimeout(() => nameInput.focus(), 100);
                    
                    // 图标分类切换
                    categoryTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            // 更新激活状态
                            categoryTabs.forEach(t => {
                                t.classList.remove('active');
                                t.style.background = 'white';
                                t.style.color = '#374151';
                            });
                            tab.classList.add('active');
                            tab.style.background = '#4361ee';
                            tab.style.color = 'white';
                            
                            // 更新图标网格
                            const category = tab.dataset.category;
                            iconGrid.innerHTML = iconLibrary[category].map(icon => 
                                `<div class="icon-option" data-icon="${icon}" style="display: flex; flex-direction: column; align-items: center; padding: 6px; cursor: pointer; border-radius: 6px; transition: all 0.2s; border: 2px solid transparent;">
                                    <div style="font-size: 28px; margin-bottom: 2px;">${icon}</div>
                                    <div style="font-size: 11px; color: #6b7280; text-align: center; line-height: 1.2; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.getIconName(icon)}</div>
                                </div>`
                            ).join('');
                            
                            // 重新绑定图标点击事件
                            bindIconClickEvents();
                        });
                    });
                    
                    // 绑定图标点击事件
                    function bindIconClickEvents() {
                        const iconOptions = dialog.querySelectorAll('.icon-option');
                        iconOptions.forEach(option => {
                            option.addEventListener('click', () => {
                                selectedIcon = option.dataset.icon;
                                iconDisplay.textContent = selectedIcon;
                                iconNameDisplay.textContent = this.getIconName(selectedIcon);
                                
                                // 更新选中状态
                                iconOptions.forEach(opt => {
                                    opt.style.border = '2px solid transparent';
                                    opt.style.background = 'transparent';
                                });
                                option.style.border = '2px solid #4361ee';
                                option.style.background = '#f0f4ff';
                            });
                            
                            // 悬停效果
                            option.addEventListener('mouseenter', () => {
                                if (option.dataset.icon !== selectedIcon) {
                                    option.style.background = '#e5e7eb';
                                }
                            });
                            option.addEventListener('mouseleave', () => {
                                if (option.dataset.icon !== selectedIcon) {
                                    option.style.background = 'transparent';
                                }
                            });
                        });
                    }
                    
                    bindIconClickEvents();
                    
                    // 取消按钮
                    cancelBtn.addEventListener('click', () => {
                        document.body.removeChild(dialog);
                    });
                    
                    // 确定按钮
                    confirmBtn.addEventListener('click', () => {
                        const categoryName = nameInput.value.trim();
                        
                        // 清除之前的错误
                        this.clearInputError(nameInput);
                        
                        if (!categoryName) {
                            this.showInputError(nameInput, '请输入分类名称');
                            return;
                        }
                        
                        console.log('开始添加分类:', categoryName, selectedIcon);
                        const result = this.storage.addCategory({ name: categoryName, icon: selectedIcon });
                        console.log('添加分类结果:', result);
                        
                        if (result) {
                            // 重新渲染分类列表
                            this.renderCategories();
                            
                            // 重新渲染分类标签
                            this.renderCategoryTabs();
                            
                            // 重新初始化下拉框，显示新添加的分类
                            this.initCustomSelects();
                            
                            console.log('分类添加完成');
                            this.showToast('分类添加成功！', 'success');
                            
                            document.body.removeChild(dialog);
                        } else {
                            console.error('分类添加失败');
                            this.showToast('分类添加失败，请重试！', 'error');
                        }
                    });
                    
                    // 支持回车键确认
                    nameInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            confirmBtn.click();
                        }
                    });
                    
                } catch (error) {
                    console.error('addCategory方法执行失败:', error);
                    this.showToast('添加分类时发生错误，请重试！', 'error');
                }
            }
            
            // 导出数据
            exportData() {
                const data = this.storage.exportData();
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `物藏录数据_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            }
            
            // 导入数据
            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const result = this.storage.importData(event.target.result);
                            if (result) {
                                alert('数据导入成功！');
                                this.renderItems();
                                this.renderCategories();
                                this.renderChannels();
                                this.initChannelSelects();
                                this.renderCategoryTabs();
                                this.updateStats();
                            } else {
                                alert('数据导入失败，请检查文件格式！');
                            }
                        };
                        reader.readAsText(file);
                    }
                });
                input.click();
            }
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('DOM加载完成，开始初始化应用');
                const app = new App();
                app.init();

                // 暴露订阅 UI 为全局变量，供 HTML 中的 onclick 事件使用
                window.subscriptionUI = app.subscriptionUI;

                console.log('应用初始化完成');
            } catch (error) {
                console.error('应用初始化失败:', error);
            }
        });
    </script>
</body>
</html>